<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WBS Terminal v1.0</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'JetBrains Mono', monospace;
            box-sizing: border-box;
        }
        
        body {
            background: #0a0a0a;
            color: #ffd700;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        /* Terminal Window */
        .terminal {
            border: 2px solid #ffd700;
            background: #0d0d0d;
        }
        
        .terminal-header {
            background: #ffd700;
            color: #000;
            padding: 8px 16px;
            font-weight: 700;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
        }
        
        .terminal-header .btn {
            margin: 0;
            font-size: 12px;
            padding: 6px 12px;
            white-space: nowrap;
        }
        
        .terminal-header .btn-primary {
            background: #000;
            color: #ffd700;
            border-color: #000;
        }
        
        .terminal-header .btn-primary:hover {
            background: #333;
            border-color: #333;
        }
        
        .terminal-header .btn:not(.btn-primary) {
            background: transparent;
            color: #000;
            border-color: #000;
        }
        
        .terminal-header .btn:not(.btn-primary):hover {
            background: #000;
            color: #ffd700;
        }
        
        .terminal-body {
            padding: 24px;
        }
        
        /* Progress Bar */
        .progress-bar {
            display: flex;
            gap: 4px;
            margin-bottom: 24px;
            font-size: 12px;
        }
        
        .progress-step {
            flex: 1;
            text-align: center;
            padding: 8px 4px;
            border: 1px solid #333;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .progress-step.active {
            background: #ffd700;
            color: #000;
            border-color: #ffd700;
        }
        
        .progress-step.completed {
            background: #2d2d00;
            color: #ffd700;
            border-color: #ffd700;
        }
        
        .progress-step:hover {
            border-color: #ffd700;
        }
        
        /* Section */
        .section-title {
            color: #fff;
            font-size: 18px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-title::before {
            content: ">";
            color: #ffd700;
        }
        
        .section-desc {
            color: #888;
            font-size: 13px;
            margin-bottom: 20px;
        }
        
        /* Inputs */
        input[type="text"],
        input[type="number"],
        input[type="date"],
        select {
            background: #000;
            border: 1px solid #444;
            color: #ffd700;
            padding: 12px;
            width: 100%;
            font-size: 14px;
            outline: none;
        }
        
        input:focus,
        select:focus {
            border-color: #ffd700;
        }
        
        input::placeholder {
            color: #555;
        }
        
        /* Buttons */
        .btn {
            background: transparent;
            border: 2px solid #ffd700;
            color: #ffd700;
            padding: 12px 24px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .btn:hover {
            background: #ffd700;
            color: #000;
        }
        
        .btn-primary {
            background: #ffd700;
            color: #000;
        }
        
        .btn-primary:hover {
            background: #fff;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        /* Discipline Grid */
        .disc-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .disc-item {
            border: 1px solid #333;
            padding: 10px 12px;
            cursor: pointer;
            font-size: 13px;
            color: #fff;
            transition: all 0.2s;
        }
        
        .disc-item:hover {
            border-color: #ffd700;
            color: #ffd700;
        }
        
        .disc-item.selected {
            background: #ffd700;
            color: #000;
            border-color: #ffd700;
        }
        
        .disc-item::before {
            content: "[ ] ";
        }
        
        .disc-item.selected::before {
            content: "[X] ";
        }
        
        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        th {
            background: #1a1a00;
            color: #ffd700;
            text-align: left;
            padding: 10px 12px;
            border: 1px solid #333;
            font-weight: 600;
        }
        
        td {
            padding: 8px 12px;
            border: 1px solid #333;
            color: #ccc;
        }
        
        tr:hover td {
            background: #1a1a00;
        }
        
        .table-input {
            background: transparent;
            border: none;
            color: #ffd700;
            width: 100%;
            padding: 4px;
            text-align: right;
        }
        
        .table-input:focus {
            outline: 1px solid #ffd700;
        }
        
        
        /* Hidden */
        .hidden {
            display: none !important;
        }
        
        /* Quick Tags */
        .quick-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }
        
        .quick-tag {
            background: #1a1a00;
            border: 1px solid #444;
            color: #ffd700;
            padding: 4px 10px;
            font-size: 11px;
            cursor: pointer;
        }
        
        .quick-tag:hover {
            background: #2d2d00;
            border-color: #ffd700;
        }

        /* Template Selector */
        .template-selector {
            background: #0d0d0d;
            border: 1px solid #333;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .template-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: linear-gradient(135deg, #1a1a00 0%, #0d0d0d 100%);
            border-bottom: 1px solid #333;
            cursor: pointer;
            transition: all 0.2s;
        }

        .template-header:hover {
            background: linear-gradient(135deg, #2d2d00 0%, #1a1a1a 100%);
        }

        .template-header span:first-child {
            color: #ffd700;
            font-size: 12px;
            font-weight: 600;
        }

        .template-toggle-icon {
            color: #666;
            font-size: 10px;
            transition: transform 0.3s;
        }

        .template-selector.expanded .template-toggle-icon {
            transform: rotate(180deg);
        }

        .template-body {
            padding: 16px;
            transition: all 0.3s;
        }

        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }

        .template-card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .template-card:hover {
            border-color: #ffd700;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.1);
        }

        .template-card-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .template-card-title {
            color: #ffd700;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .template-card-desc {
            color: #888;
            font-size: 11px;
            line-height: 1.4;
        }

        .template-card-stats {
            display: flex;
            gap: 12px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #333;
            font-size: 10px;
            color: #666;
        }

        .template-card-stat {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .template-card-stat span {
            color: #ffd700;
        }
        
        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .kpi-card {
            border: 1px solid #ffd700;
            padding: 16px;
            text-align: center;
        }
        
        .kpi-value {
            font-size: 24px;
            color: #ffd700;
            font-weight: 700;
        }
        
        .kpi-label {
            font-size: 11px;
            color: #888;
            margin-top: 4px;
        }
        
        /* Chart Container */
        .chart-container {
            background: #000;
            border: 1px solid #333;
            padding: 20px;
            margin-top: 24px;
        }
        
        /* Filters */
        .filters {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .filter-group label {
            display: block;
            font-size: 11px;
            color: #888;
            margin-bottom: 4px;
        }
        
        /* Status */
        .status-ok {
            color: #00ff00;
        }
        
        .status-err {
            color: #ff4444;
        }
        
        /* Results Table */
        .results-table {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #333;
        }
        
        .results-table thead {
            position: sticky;
            top: 0;
        }
        
        .results-table tfoot {
            position: sticky;
            bottom: 0;
        }
        
        .results-table tfoot td {
            background: #ffd700;
            color: #000;
            font-weight: 700;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #111;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #ffd700;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .filters {
                grid-template-columns: repeat(2, 1fr);
            }
            .disc-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .terminal-header {
                flex-wrap: wrap;
                gap: 8px;
                padding: 8px 12px;
            }
            
            .terminal-header > span {
                order: 2;
                width: 100%;
                text-align: center;
                font-size: 13px;
            }
            
            .terminal-header .btn {
                font-size: 11px;
                padding: 4px 8px;
                min-width: 60px;
            }
            
            .terminal-header > div {
                order: 3;
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
                gap: 4px;
            }
            
            .terminal-header #status-text {
                font-size: 11px;
            }
            
            .terminal-header .btn-sm {
                font-size: 10px;
                padding: 3px 6px;
                min-width: auto;
            }
            
            /* Results section header buttons on mobile */
            #results-section .terminal-header > div {
                flex-wrap: wrap;
                gap: 4px;
            }
            
            #results-section .terminal-header .btn-sm {
                font-size: 9px;
                padding: 3px 5px;
                margin-right: 4px !important;
            }
        }

        /* ASCII decorations */
        .ascii-line {
            color: #444;
            font-size: 12px;
            margin: 16px 0;
            overflow: hidden;
            white-space: nowrap;
        }
        
        /* Blinking cursor */
        .cursor::after {
            content: "_";
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        /* Budget Calculator */
        .budget-calculator {
            border: 1px solid #444;
            margin-bottom: 20px;
            background: #111;
        }

        .calculator-header {
            background: #1a1a00;
            padding: 10px 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
            transition: background 0.2s;
        }

        .calculator-header:hover {
            background: #2d2d00;
        }

        .calculator-header span:first-child {
            color: #ffd700;
            font-weight: 600;
            font-size: 13px;
        }

        .calculator-body {
            padding: 16px;
            display: block;
            overflow: hidden;
            max-height: 1000px;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
        }

        .calculator-body.collapsed {
            max-height: 0;
            padding: 0 16px;
        }

        .calc-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .calc-group label {
            display: block;
            font-size: 11px;
            color: #888;
            margin-bottom: 6px;
        }

        .calc-group input,
        .calc-group select {
            font-size: 13px;
        }

        .complexity-override-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .complexity-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .complexity-item label {
            flex: 1;
            color: #ccc;
        }

        .complexity-item select {
            flex: 0 0 100px;
            padding: 4px 8px;
            font-size: 11px;
        }

        /* Industry Indicator */
        .industry-indicator {
            display: inline-block;
            width: 16px;
            text-align: center;
            cursor: help;
            font-weight: 700;
            margin-left: 4px;
        }

        .industry-indicator.above {
            color: #ff6666;
        }

        .industry-indicator.below {
            color: #66ff66;
        }

        .industry-indicator.within {
            color: #ffd700;
        }

        /* Tooltip */
        .tooltip {
            position: relative;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 220px;
            background-color: #1a1a1a;
            color: #ffd700;
            text-align: left;
            border: 1px solid #ffd700;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            font-size: 11px;
            line-height: 1.4;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Claiming Preset Panel */
        .claiming-preset-panel {
            background-color: #0a0a0a;
            border: 1px solid #ffd700;
            border-radius: 4px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .preset-header {
            background-color: #1a1a1a;
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #ffd700;
            font-weight: bold;
            font-size: 12px;
            user-select: none;
            border-bottom: 1px solid #ffd700;
        }

        .preset-header:hover {
            background-color: #222;
        }

        .preset-body {
            padding: 20px;
            display: block;
        }

        .preset-body.hidden {
            display: none;
        }

        .preset-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .preset-option {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 12px;
            background-color: #1a1a1a;
            border: 1px solid #333;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .preset-option:hover {
            border-color: #ffd700;
            background-color: #222;
        }

        .preset-option input[type="radio"] {
            margin-top: 2px;
            cursor: pointer;
            accent-color: #ffd700;
        }

        .preset-label {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
        }

        .preset-name {
            color: #ffd700;
            font-weight: bold;
            font-size: 13px;
        }

        .preset-desc {
            color: #888;
            font-size: 11px;
            line-height: 1.4;
        }

        .preset-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .preset-actions .btn {
            flex: 1;
            padding: 10px;
            background-color: #1a1a1a;
            color: #ffd700;
            border: 1px solid #ffd700;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.2s;
        }

        .preset-actions .btn:hover {
            background-color: #ffd700;
            color: #0a0a0a;
        }

        .preset-actions .btn-primary {
            background-color: #ffd700;
            color: #0a0a0a;
        }

        .preset-actions .btn-primary:hover {
            background-color: #ffed4e;
        }

        .preset-preview {
            padding: 15px;
            background-color: #1a1a1a;
            border: 1px solid #333;
            border-radius: 4px;
            font-size: 11px;
            color: #888;
            line-height: 1.6;
        }

        .preset-preview.hidden {
            display: none;
        }

        .preset-preview strong {
            color: #ffd700;
        }

        @media (max-width: 768px) {
            .calc-grid {
                grid-template-columns: 1fr;
            }
            .complexity-override-grid {
                grid-template-columns: 1fr;
            }
            .preset-options {
                grid-template-columns: 1fr;
            }
            .preset-actions {
                flex-direction: column;
            }
        }

        /* AI Chat Assistant Styles */
        .chat-fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffd700 0%, #b8860b 100%);
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(255, 215, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
        }

        .chat-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 28px rgba(255, 215, 0, 0.6);
        }

        .chat-fab svg {
            width: 28px;
            height: 28px;
            fill: #000;
        }

        .chat-fab.has-unread::after {
            content: '';
            position: absolute;
            top: 4px;
            right: 4px;
            width: 12px;
            height: 12px;
            background: #ff4444;
            border-radius: 50%;
            border: 2px solid #0a0a0a;
        }

        .chat-panel {
            position: fixed;
            bottom: 96px;
            right: 24px;
            width: 380px;
            max-height: 520px;
            background: #0d0d0d;
            border: 2px solid #ffd700;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px) scale(0.95);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .chat-panel.open {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }

        .chat-panel.dragging {
            transition: none;
            user-select: none;
        }

        .chat-header {
            background: linear-gradient(135deg, #ffd700 0%, #b8860b 100%);
            color: #000;
            padding: 14px 16px;
            font-weight: 700;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 10px 10px 0 0;
            cursor: grab;
        }

        .chat-header:active {
            cursor: grabbing;
        }

        .chat-header-title {
            display: flex;
            align-items: center;
            gap: 8px;
            pointer-events: none;
        }

        .chat-header-title svg {
            width: 18px;
            height: 18px;
        }

        .chat-header-actions {
            display: flex;
            gap: 8px;
            pointer-events: auto;
        }

        .chat-context-badge {
            pointer-events: none;
        }

        .chat-header-btn {
            background: rgba(0, 0, 0, 0.2);
            border: none;
            color: #000;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .chat-header-btn:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        .chat-header-btn svg {
            width: 16px;
            height: 16px;
        }

        .chat-context-badge {
            background: rgba(0, 0, 0, 0.2);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 280px;
            max-height: 340px;
        }

        .chat-message {
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 13px;
            line-height: 1.5;
            animation: messageIn 0.3s ease-out;
        }

        @keyframes messageIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-message.user {
            background: linear-gradient(135deg, #ffd700 0%, #b8860b 100%);
            color: #000;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .chat-message.assistant {
            background: #1a1a1a;
            color: #e0e0e0;
            align-self: flex-start;
            border: 1px solid #333;
            border-bottom-left-radius: 4px;
        }

        .chat-message.assistant code {
            background: #2a2a2a;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            color: #ffd700;
        }

        .chat-message.system {
            background: transparent;
            color: #666;
            font-size: 11px;
            text-align: center;
            align-self: center;
            padding: 6px 12px;
        }

        .chat-message.streaming {
            border-color: #ffd700;
        }

        .streaming-cursor {
            color: #ffd700;
            animation: blink 0.8s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .chat-typing {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
            background: #1a1a1a;
            border-radius: 12px;
            align-self: flex-start;
            border: 1px solid #333;
        }

        .chat-typing span {
            width: 8px;
            height: 8px;
            background: #ffd700;
            border-radius: 50%;
            animation: typingBounce 1.4s infinite ease-in-out;
        }

        .chat-typing span:nth-child(1) { animation-delay: 0s; }
        .chat-typing span:nth-child(2) { animation-delay: 0.2s; }
        .chat-typing span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-8px); opacity: 1; }
        }

        .chat-input-area {
            padding: 12px;
            border-top: 1px solid #333;
            display: flex;
            gap: 8px;
        }

        .chat-input {
            flex: 1;
            background: #1a1a1a;
            border: 1px solid #444;
            color: #ffd700;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 13px;
            outline: none;
            resize: none;
            min-height: 42px;
            max-height: 100px;
            font-family: inherit;
        }

        .chat-input:focus {
            border-color: #ffd700;
        }

        .chat-input::placeholder {
            color: #666;
        }

        .chat-send-btn {
            background: linear-gradient(135deg, #ffd700 0%, #b8860b 100%);
            border: none;
            color: #000;
            width: 42px;
            height: 42px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .chat-send-btn:hover:not(:disabled) {
            transform: scale(1.05);
        }

        .chat-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .chat-send-btn svg {
            width: 20px;
            height: 20px;
        }

        /* API Key Modal */
        .chat-api-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1002;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .chat-api-modal.open {
            opacity: 1;
            visibility: visible;
        }

        .chat-api-modal-content {
            background: #0d0d0d;
            border: 2px solid #ffd700;
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            transform: scale(0.9);
            transition: transform 0.3s;
        }

        .chat-api-modal.open .chat-api-modal-content {
            transform: scale(1);
        }

        .chat-api-modal h3 {
            color: #ffd700;
            margin: 0 0 8px 0;
            font-size: 16px;
        }

        .chat-api-modal p {
            color: #888;
            font-size: 12px;
            margin: 0 0 16px 0;
            line-height: 1.5;
        }

        .chat-api-modal input {
            width: 100%;
            background: #1a1a1a;
            border: 1px solid #444;
            color: #ffd700;
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
            margin-bottom: 16px;
        }

        .chat-api-modal input:focus {
            outline: none;
            border-color: #ffd700;
        }

        .chat-api-modal-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .chat-api-modal .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        /* Recovery Modal */
        .recovery-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1003;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .recovery-modal.open {
            opacity: 1;
            visibility: visible;
        }

        .recovery-modal-content {
            background: #0d0d0d;
            border: 2px solid #ffd700;
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 500px;
            transform: scale(0.9);
            transition: transform 0.3s;
        }

        .recovery-modal.open .recovery-modal-content {
            transform: scale(1);
        }

        .recovery-modal h3 {
            color: #ffd700;
            margin: 0 0 8px 0;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .recovery-modal p {
            color: #888;
            font-size: 13px;
            margin: 0 0 16px 0;
            line-height: 1.6;
        }

        .recovery-preview {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
            font-size: 12px;
        }

        .recovery-preview-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #222;
        }

        .recovery-preview-item:last-child {
            border-bottom: none;
        }

        .recovery-preview-label {
            color: #888;
        }

        .recovery-preview-value {
            color: #ffd700;
            font-weight: 500;
        }

        .recovery-modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .recovery-modal .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .recovery-modal .btn-danger {
            background: transparent;
            border: 1px solid #ff4444;
            color: #ff4444;
        }

        .recovery-modal .btn-danger:hover {
            background: #ff4444;
            color: #000;
        }

        /* Autosave indicator */
        .autosave-indicator {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 11px;
            color: #888;
            display: flex;
            align-items: center;
            gap: 8px;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s;
            z-index: 100;
        }

        .autosave-indicator.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .autosave-indicator.saving {
            color: #ffd700;
            border-color: #ffd700;
        }

        .autosave-indicator.saved {
            color: #00ff00;
            border-color: #00ff00;
        }

        /* Projects Manager Modal */
        .projects-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1003;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .projects-modal.open {
            opacity: 1;
            visibility: visible;
        }

        .projects-modal-content {
            background: #0d0d0d;
            border: 2px solid #ffd700;
            border-radius: 12px;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transform: scale(0.9);
            transition: transform 0.3s;
        }

        .projects-modal.open .projects-modal-content {
            transform: scale(1);
        }

        .projects-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: #ffd700;
            color: #000;
        }

        .projects-modal-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }

        .projects-close-btn {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 4px 8px;
            color: #000;
        }

        .projects-close-btn:hover {
            background: rgba(0,0,0,0.1);
            border-radius: 4px;
        }

        .projects-modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .projects-section {
            margin-bottom: 24px;
        }

        .projects-section-title {
            color: #ffd700;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .projects-save-form {
            display: flex;
            gap: 12px;
        }

        .projects-save-form input {
            flex: 1;
            background: #1a1a1a;
            border: 1px solid #333;
            color: #ffd700;
            padding: 10px 14px;
            border-radius: 6px;
            font-size: 13px;
        }

        .projects-save-form input:focus {
            outline: none;
            border-color: #ffd700;
        }

        .projects-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
        }

        .project-item {
            display: flex;
            align-items: center;
            gap: 12px;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 14px 16px;
            transition: all 0.2s;
        }

        .project-item:hover {
            border-color: #ffd700;
        }

        .project-item-checkbox {
            width: 18px;
            height: 18px;
            accent-color: #ffd700;
        }

        .project-item-info {
            flex: 1;
        }

        .project-item-name {
            color: #ffd700;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .project-item-meta {
            color: #666;
            font-size: 11px;
            display: flex;
            gap: 16px;
        }

        .project-item-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .project-item-actions {
            display: flex;
            gap: 8px;
        }

        .project-item-btn {
            background: transparent;
            border: 1px solid #444;
            color: #888;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .project-item-btn:hover {
            border-color: #ffd700;
            color: #ffd700;
        }

        .project-item-btn.delete:hover {
            border-color: #ff4444;
            color: #ff4444;
        }

        .projects-empty {
            text-align: center;
            color: #666;
            padding: 40px 20px;
            font-size: 13px;
        }

        .compare-view {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }

        .compare-card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 16px;
        }

        .compare-card-title {
            color: #ffd700;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #333;
        }

        .compare-stat {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 12px;
        }

        .compare-stat-label {
            color: #888;
        }

        .compare-stat-value {
            color: #fff;
        }

        /* AI Schedule Generator */
        .ai-schedule-section {
            background: linear-gradient(135deg, #1a0a2e 0%, #0d0d1a 100%);
            border: 1px solid #6b21a8;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .btn-ai {
            background: linear-gradient(135deg, #6b21a8 0%, #4c1d95 100%);
            border: 1px solid #7c3aed;
            color: #fff;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn-ai:hover {
            background: linear-gradient(135deg, #7c3aed 0%, #6b21a8 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
        }

        .btn-ai:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .ai-btn-icon {
            font-size: 16px;
        }

        .ai-schedule-options {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .ai-schedule-options label {
            color: #a78bfa;
            font-size: 11px;
        }

        .ai-schedule-options input,
        .ai-schedule-options select {
            background: #1a1a2e;
            border: 1px solid #4c1d95;
            color: #e9d5ff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
        }

        .ai-schedule-options input:focus,
        .ai-schedule-options select:focus {
            outline: none;
            border-color: #7c3aed;
        }

        .ai-schedule-loading {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 12px;
            color: #a78bfa;
            font-size: 12px;
        }

        .ai-loading-spinner {
            animation: spin 1s linear infinite;
            font-size: 16px;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* AI Insights Panel */
        .insights-panel {
            background: linear-gradient(135deg, #0a1628 0%, #0d0d1a 100%);
            border: 1px solid #1e3a5f;
            border-radius: 12px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .insights-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: linear-gradient(135deg, #1e3a5f 0%, #0a1628 100%);
            cursor: pointer;
            transition: all 0.2s;
        }

        .insights-header:hover {
            background: linear-gradient(135deg, #2a4a6f 0%, #1a2638 100%);
        }

        .insights-header span:first-child {
            color: #60a5fa;
            font-size: 13px;
            font-weight: 600;
        }

        .insights-toggle-icon {
            color: #60a5fa;
            font-size: 10px;
            transition: transform 0.3s;
        }

        .insights-panel.expanded .insights-toggle-icon {
            transform: rotate(180deg);
        }

        .insights-body {
            padding: 20px;
        }

        .insights-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }

        .insight-card {
            background: rgba(30, 58, 95, 0.3);
            border: 1px solid #1e3a5f;
            border-radius: 8px;
            padding: 16px;
        }

        .insight-card-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .insight-icon {
            font-size: 16px;
        }

        .insight-title {
            color: #60a5fa;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .insight-value {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #fff;
        }

        .insight-value.risk-low {
            color: #4ade80;
        }

        .insight-value.risk-medium {
            color: #fbbf24;
        }

        .insight-value.risk-high {
            color: #f87171;
        }

        .insight-details {
            color: #94a3b8;
            font-size: 11px;
            line-height: 1.5;
        }

        .insights-suggestions {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 16px;
        }

        .suggestions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .suggestions-header span {
            color: #ffd700;
            font-size: 12px;
            font-weight: 600;
        }

        .suggestions-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .suggestion-placeholder {
            color: #64748b;
            font-size: 12px;
            text-align: center;
            padding: 20px;
        }

        .suggestion-item {
            background: rgba(30, 58, 95, 0.3);
            border: 1px solid #1e3a5f;
            border-radius: 6px;
            padding: 12px;
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .suggestion-icon {
            font-size: 18px;
            flex-shrink: 0;
        }

        .suggestion-content {
            flex: 1;
        }

        .suggestion-title {
            color: #fff;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .suggestion-desc {
            color: #94a3b8;
            font-size: 11px;
            line-height: 1.5;
        }

        @media (max-width: 768px) {
            .insights-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .chat-panel {
                right: 12px;
                left: 12px;
                width: auto;
                bottom: 88px;
                max-height: 60vh;
            }

            .chat-fab {
                right: 16px;
                bottom: 16px;
            }
        }

        /* Gantt Chart Styles */
        .gantt-container {
            overflow-x: auto;
            padding: 16px 0;
        }

        .gantt-chart {
            min-width: 100%;
            position: relative;
        }

        .gantt-header {
            display: flex;
            border-bottom: 1px solid #444;
            position: sticky;
            top: 0;
            background: #0d0d0d;
            z-index: 10;
        }

        .gantt-label-col {
            width: 200px;
            min-width: 200px;
            padding: 8px 12px;
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-right: 1px solid #333;
        }

        .gantt-timeline-header {
            flex: 1;
            display: flex;
            min-width: 600px;
        }

        .gantt-month {
            flex: 1;
            min-width: 60px;
            text-align: center;
            padding: 8px 4px;
            font-size: 10px;
            color: #888;
            border-right: 1px solid #222;
        }

        .gantt-month.current {
            background: rgba(255, 215, 0, 0.1);
            color: #ffd700;
        }

        .gantt-body {
            position: relative;
        }

        .gantt-row {
            display: flex;
            border-bottom: 1px solid #222;
            transition: background 0.2s;
        }

        .gantt-row:hover {
            background: rgba(255, 215, 0, 0.03);
        }

        .gantt-row.discipline-row {
            background: #1a1a1a;
        }

        .gantt-row.discipline-row:hover {
            background: #222;
        }

        .gantt-row.package-row {
            background: #0d0d0d;
        }

        .gantt-row.package-row.hidden {
            display: none;
        }

        .gantt-row-label {
            width: 200px;
            min-width: 200px;
            padding: 10px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            border-right: 1px solid #333;
            font-size: 12px;
        }

        .gantt-row.discipline-row .gantt-row-label {
            color: #ffd700;
            font-weight: 600;
            cursor: pointer;
        }

        .gantt-row.package-row .gantt-row-label {
            color: #888;
            padding-left: 32px;
            font-size: 11px;
        }

        .gantt-expand-icon {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
            color: #ffd700;
            font-size: 10px;
        }

        .gantt-expand-icon.expanded {
            transform: rotate(90deg);
        }

        .gantt-row-timeline {
            flex: 1;
            position: relative;
            min-width: 600px;
            display: flex;
        }

        .gantt-cell {
            flex: 1;
            min-width: 60px;
            border-right: 1px solid #222;
            position: relative;
        }

        .gantt-cell.current {
            background: rgba(255, 215, 0, 0.05);
        }

        .gantt-bar-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            pointer-events: none;
        }

        .gantt-bar {
            position: absolute;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: 600;
            color: #000;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            pointer-events: auto;
            cursor: default;
            transition: transform 0.15s, box-shadow 0.15s;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding: 0 6px;
        }

        .gantt-bar:hover {
            transform: scaleY(1.15);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
            z-index: 5;
        }

        .gantt-bar.discipline-bar {
            background: linear-gradient(135deg, #ffd700 0%, #b8860b 100%);
            height: 28px;
        }

        .gantt-bar.package-bar {
            background: linear-gradient(135deg, #4a90d9 0%, #2c5aa0 100%);
            height: 20px;
            font-size: 8px;
        }

        .gantt-tooltip {
            position: absolute;
            background: #1a1a1a;
            border: 1px solid #ffd700;
            border-radius: 6px;
            padding: 10px 12px;
            font-size: 11px;
            z-index: 100;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            min-width: 180px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }

        .gantt-tooltip.visible {
            opacity: 1;
        }

        .gantt-tooltip-title {
            color: #ffd700;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .gantt-tooltip-row {
            display: flex;
            justify-content: space-between;
            gap: 16px;
            color: #ccc;
            margin-top: 4px;
        }

        .gantt-tooltip-label {
            color: #888;
        }

        .gantt-legend {
            display: flex;
            gap: 24px;
            margin-top: 16px;
            font-size: 11px;
            color: #888;
        }

        .gantt-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .gantt-legend-color {
            width: 24px;
            height: 12px;
            border-radius: 3px;
        }

        .gantt-legend-color.discipline {
            background: linear-gradient(135deg, #ffd700 0%, #b8860b 100%);
        }

        .gantt-legend-color.package {
            background: linear-gradient(135deg, #4a90d9 0%, #2c5aa0 100%);
        }

        .gantt-no-data {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 13px;
        }

        @media (max-width: 768px) {
            .gantt-label-col,
            .gantt-row-label {
                width: 140px;
                min-width: 140px;
            }

            .gantt-row.package-row .gantt-row-label {
                padding-left: 24px;
            }
        }

        /* Collapsible WBS Table Styles */
        .wbs-discipline-row {
            background: #1a1a1a;
            cursor: pointer;
            transition: background 0.2s;
        }

        .wbs-discipline-row:hover {
            background: #252525;
        }

        .wbs-discipline-row td {
            font-weight: 600;
            color: #ffd700;
            padding: 12px 8px;
        }

        .wbs-discipline-row td:first-child {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .wbs-expand-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            font-size: 10px;
            transition: transform 0.2s;
            color: #ffd700;
        }

        .wbs-expand-icon.expanded {
            transform: rotate(90deg);
        }

        .wbs-package-row {
            background: #0d0d0d;
        }

        .wbs-package-row.hidden {
            display: none;
        }

        .wbs-package-row td:first-child {
            padding-left: 32px;
        }

        .wbs-phase-header {
            background: #2a2a00;
            font-weight: 700;
        }

        .wbs-phase-header td {
            color: #ffd700;
            padding: 10px 8px;
            font-size: 13px;
            letter-spacing: 0.5px;
        }

        .wbs-table-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        /* RFP Wizard Modal Styles */
        .rfp-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .rfp-modal.open {
            opacity: 1;
            visibility: visible;
        }

        .rfp-modal-content {
            background: #0d0d0d;
            border: 2px solid #ffd700;
            border-radius: 12px;
            width: 95%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s;
        }

        .rfp-modal.open .rfp-modal-content {
            transform: scale(1);
        }

        .rfp-modal-header {
            background: linear-gradient(135deg, #ffd700 0%, #b8860b 100%);
            color: #000;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 10px 10px 0 0;
        }

        .rfp-modal-header h2 {
            margin: 0;
            font-size: 16px;
            font-weight: 700;
        }

        .rfp-modal-close {
            background: rgba(0, 0, 0, 0.2);
            border: none;
            color: #000;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .rfp-modal-close:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        .rfp-modal-body {
            padding: 24px;
        }

        .rfp-stage-indicator {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
        }

        .rfp-stage {
            flex: 1;
            text-align: center;
            padding: 10px;
            background: #1a1a1a;
            border: 1px solid #333;
            color: #666;
            font-size: 12px;
            border-radius: 6px;
            transition: all 0.3s;
        }

        .rfp-stage.active {
            background: #ffd700;
            color: #000;
            border-color: #ffd700;
            font-weight: 600;
        }

        .rfp-stage.completed {
            background: #2a2a00;
            color: #ffd700;
            border-color: #ffd700;
        }

        .rfp-stage-content {
            display: none;
        }

        .rfp-stage-content.active {
            display: block;
        }

        /* Stage 1: Upload */
        .rfp-dropzone {
            border: 2px dashed #444;
            border-radius: 12px;
            padding: 48px 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #1a1a1a;
        }

        .rfp-dropzone:hover,
        .rfp-dropzone.dragover {
            border-color: #ffd700;
            background: #1a1a00;
        }

        .rfp-dropzone-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .rfp-dropzone-text {
            color: #888;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .rfp-dropzone-hint {
            color: #666;
            font-size: 11px;
        }

        .rfp-file-info {
            display: none;
            background: #1a1a1a;
            border: 1px solid #ffd700;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }

        .rfp-file-info.visible {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .rfp-file-icon {
            font-size: 32px;
        }

        .rfp-file-details {
            flex: 1;
        }

        .rfp-file-name {
            color: #ffd700;
            font-weight: 600;
            font-size: 14px;
        }

        .rfp-file-meta {
            color: #888;
            font-size: 12px;
            margin-top: 4px;
        }

        .rfp-file-remove {
            background: transparent;
            border: 1px solid #ff4444;
            color: #ff4444;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }

        .rfp-file-remove:hover {
            background: #ff4444;
            color: #000;
        }

        /* Stage 2: Page Selection */
        .rfp-page-info {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .rfp-page-count {
            color: #ffd700;
            font-size: 24px;
            font-weight: 700;
        }

        .rfp-page-label {
            color: #888;
            font-size: 12px;
            margin-top: 4px;
        }

        .rfp-page-input-group {
            margin-top: 20px;
        }

        .rfp-page-input-group label {
            display: block;
            color: #ffd700;
            font-size: 12px;
            margin-bottom: 8px;
        }

        .rfp-page-input-group input {
            width: 100%;
            background: #000;
            border: 1px solid #444;
            color: #ffd700;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
        }

        .rfp-page-input-group input:focus {
            outline: none;
            border-color: #ffd700;
        }

        .rfp-page-hint {
            color: #666;
            font-size: 11px;
            margin-top: 8px;
        }

        /* Stage 3: Preview */
        .rfp-preview-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .rfp-preview-card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 16px;
        }

        .rfp-preview-card.full-width {
            grid-column: span 2;
        }

        .rfp-preview-card h4 {
            color: #ffd700;
            font-size: 12px;
            margin: 0 0 12px 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .rfp-confidence {
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 400;
        }

        .rfp-confidence.high {
            background: #00ff00;
            color: #000;
        }

        .rfp-confidence.medium {
            background: #ffd700;
            color: #000;
        }

        .rfp-confidence.low {
            background: #ff4444;
            color: #fff;
        }

        .rfp-preview-card textarea,
        .rfp-preview-card input[type="text"] {
            width: 100%;
            background: #000;
            border: 1px solid #444;
            color: #e0e0e0;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            font-family: inherit;
            resize: vertical;
        }

        .rfp-preview-card textarea:focus,
        .rfp-preview-card input[type="text"]:focus {
            outline: none;
            border-color: #ffd700;
        }

        .rfp-preview-card textarea {
            min-height: 80px;
        }

        .rfp-discipline-scope-item {
            background: #000;
            border: 1px solid #444;
            border-radius: 6px;
            padding: 12px;
        }

        .rfp-discipline-scope-name {
            color: #ffd700;
            font-weight: 600;
            font-size: 12px;
            margin-bottom: 6px;
        }

        .rfp-discipline-scope-text {
            color: #e0e0e0;
            font-size: 11px;
            line-height: 1.5;
            margin: 0;
        }

        .rfp-discipline-scope-textarea {
            width: 100%;
            background: #0a0a0a;
            border: 1px solid #444;
            color: #e0e0e0;
            padding: 8px;
            border-radius: 4px;
            font-size: 11px;
            font-family: inherit;
            resize: vertical;
            min-height: 60px;
        }

        .rfp-discipline-scope-textarea:focus {
            outline: none;
            border-color: #ffd700;
        }

        .rfp-notes {
            background: #1a1a00;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }

        .rfp-notes h4 {
            color: #ffd700;
            font-size: 12px;
            margin: 0 0 8px 0;
        }

        .rfp-notes p {
            color: #888;
            font-size: 12px;
            margin: 0;
            line-height: 1.5;
        }

        #rfp-truncation-notice {
            background: #2a1a00;
            border-color: #ff8800;
        }

        /* RFP Risks Section */
        .rfp-risks-section {
            background: linear-gradient(135deg, #2a0a0a 0%, #1a0a0a 100%);
            border: 1px solid #ff4444;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }

        .rfp-risks-section h4 {
            color: #ff6b6b;
            font-size: 14px;
            margin: 0 0 12px 0;
        }

        .rfp-risks-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .rfp-risk-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            padding: 12px;
            border-left: 3px solid;
        }

        .rfp-risk-item.severity-high {
            border-left-color: #ff4444;
        }

        .rfp-risk-item.severity-medium {
            border-left-color: #ff8800;
        }

        .rfp-risk-item.severity-low {
            border-left-color: #ffd700;
        }

        .rfp-risk-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 6px;
        }

        .rfp-risk-category {
            font-size: 10px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .rfp-risk-severity {
            font-size: 10px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .rfp-risk-severity.high {
            background: #ff4444;
            color: #fff;
        }

        .rfp-risk-severity.medium {
            background: #ff8800;
            color: #000;
        }

        .rfp-risk-severity.low {
            background: #ffd700;
            color: #000;
        }

        .rfp-risk-description {
            color: #e0e0e0;
            font-size: 12px;
            margin-bottom: 6px;
        }

        .rfp-risk-mitigation {
            color: #888;
            font-size: 11px;
            font-style: italic;
        }

        .rfp-risk-mitigation::before {
            content: " ";
        }

        #rfp-truncation-notice h4 {
            color: #ff8800;
        }

        #rfp-truncation-notice p {
            color: #ffaa44;
        }

        /* Usage Statistics Styles */
        #rfp-usage-stats {
            background: linear-gradient(135deg, #0a1a0a 0%, #1a2a1a 100%);
            border-color: #00cc66;
        }

        #rfp-usage-stats h4 {
            color: #00cc66;
        }

        .rfp-usage-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 12px;
        }

        .rfp-usage-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(0, 204, 102, 0.1);
            border-radius: 4px;
            border: 1px solid rgba(0, 204, 102, 0.2);
        }

        .rfp-usage-item.full-width {
            grid-column: span 2;
        }

        .rfp-usage-label {
            color: #888;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .rfp-usage-value {
            color: #00cc66;
            font-size: 14px;
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }

        .rfp-usage-value.cost {
            color: #ffd700;
            font-size: 16px;
        }

        .rfp-usage-value.time {
            color: #00aaff;
        }

        /* Loading State */
        .rfp-loading {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 48px;
        }

        .rfp-loading.visible {
            display: flex;
        }

        .rfp-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid #333;
            border-top-color: #ffd700;
            border-radius: 50%;
            animation: rfpSpin 1s linear infinite;
        }

        @keyframes rfpSpin {
            to { transform: rotate(360deg); }
        }

        .rfp-loading-text {
            color: #888;
            font-size: 14px;
            margin-top: 16px;
        }

        /* Modal Actions */
        .rfp-modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid #333;
        }

        .rfp-btn {
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #444;
            background: #1a1a1a;
            color: #ffd700;
        }

        .rfp-btn:hover {
            border-color: #ffd700;
        }

        .rfp-btn-primary {
            background: linear-gradient(135deg, #ffd700 0%, #b8860b 100%);
            color: #000;
            border: none;
        }

        .rfp-btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
        }

        .rfp-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* RFP Button in Header */
        .rfp-header-btn {
            background: linear-gradient(135deg, #4a90d9 0%, #2c5aa0 100%);
            color: #fff;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .rfp-header-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(74, 144, 217, 0.4);
        }

        @media (max-width: 768px) {
            .rfp-preview-grid {
                grid-template-columns: 1fr;
            }

            .rfp-preview-card.full-width {
                grid-column: span 1;
            }

            .rfp-modal-content {
                width: 100%;
                max-height: 100vh;
                border-radius: 0;
            }

            .rfp-modal-header {
                border-radius: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="terminal" style="margin-bottom: 20px;">
            <div class="terminal-header">
                <button id="prev-btn" class="btn btn-sm hidden" onclick="prevStep()"> BACK</button>
                <span> WBS TERMINAL v1.0</span>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <button class="rfp-header-btn" onclick="openProjectManager()"> PROJECTS</button>
                    <button class="rfp-header-btn" onclick="openRfpWizard()"> RFP WIZARD</button>
                    <span id="status-text">READY</span>
                    <button id="next-btn" class="btn btn-sm btn-primary" onclick="nextStep()">NEXT </button>
                    <button id="generate-btn" class="btn btn-sm btn-primary hidden" onclick="generateWBS()">GENERATE WBS</button>
                </div>
            </div>
        </div>

        <!-- Main Terminal -->
        <div id="wizard-terminal" class="terminal">
            <div class="terminal-body">
                <!-- Progress Bar -->
                <div id="progress-section" class="progress-bar">
                    <div class="progress-step active" onclick="goToStep(1)">1:PHASES</div>
                    <div class="progress-step" onclick="goToStep(2)">2:DISCIPLINES</div>
                    <div class="progress-step" onclick="goToStep(3)">3:PACKAGES</div>
                    <div class="progress-step" onclick="goToStep(4)">4:BUDGET</div>
                    <div class="progress-step" onclick="goToStep(5)">5:CLAIMING</div>
                    <div class="progress-step" onclick="goToStep(6)">6:SCHEDULE</div>
                </div>

                <!-- Step 1: Phases -->
                <div id="step1" class="step-content">
                    <!-- Template Selector -->
                    <div class="template-selector">
                        <div class="template-header" onclick="toggleTemplateSelector()">
                            <span> START FROM TEMPLATE</span>
                            <span class="template-toggle-icon"></span>
                        </div>
                        <div id="template-body" class="template-body hidden">
                            <div class="template-grid" id="template-grid">
                                <!-- Templates populated by JS -->
                            </div>
                        </div>
                    </div>

                    <div class="section-title">PROJECT PHASES</div>
                    <div class="section-desc">Enter project phases separated by commas</div>
                    
                    <input type="text" id="phases-input" value="Base,">
                    
                    <div class="quick-tags">
                        <span class="quick-tag" onclick="addQuickPhase('Base')">+Base Design</span>
                        <span class="quick-tag" onclick="addQuickPhase('ESDC')">+ESDC</span>
                        <span class="quick-tag" onclick="addQuickPhase('TSCD')">+TSCD</span>
                        <span class="quick-tag" onclick="addQuickPhase('As-Builts')">+As-Builts</span>
                        <span class="quick-tag" onclick="addQuickPhase('Closeout')">+Closeout</span>
                    </div>
                </div>

                <!-- Step 2: Disciplines -->
                <div id="step2" class="step-content hidden">
                    <div class="section-title">PROJECT DISCIPLINES</div>
                    <div class="section-desc">Select disciplines involved in the project</div>
                    
                    <div class="disc-grid" id="disciplines-grid"></div>
                    
                    <div style="display: flex; gap: 8px; margin-top: 16px;">
                        <input type="text" id="custom-discipline" placeholder="Custom discipline..." style="flex: 1;">
                        <button class="btn btn-sm" onclick="addCustomDiscipline()">ADD</button>
                        <button class="btn btn-sm" onclick="selectAllDisciplines()">ALL</button>
                    </div>
                    
                    <div style="margin-top: 12px; color: #888; font-size: 12px;">
                        Selected: <span id="selected-count" style="color: #ffd700;">0</span>
                    </div>
                </div>

                <!-- Step 3: Packages -->
                <div id="step3" class="step-content hidden">
                    <div class="section-title">DELIVERABLE PACKAGES</div>
                    <div class="section-desc">Enter package milestones separated by commas</div>
                    
                    <input type="text" id="packages-input" value="Preliminary, Interim, Final, RFC, As-Buit">
                    
                    <div class="quick-tags">
                        <span class="quick-tag" onclick="addQuickPackage('Preliminary')">+Preliminary</span>
                        <span class="quick-tag" onclick="addQuickPackage('Interim')">+Interim</span>
                        <span class="quick-tag" onclick="addQuickPackage('Final')">+Final</span>
                        <span class="quick-tag" onclick="addQuickPackage('RFC')">+RFC</span>
                        <span class="quick-tag" onclick="addQuickPackage('As-Built')">+As-Built</span>
                    </div>
                </div>

                <!-- Step 4: Budget -->
                <div id="step4" class="step-content hidden">
                    <div class="section-title">DISCIPLINE BUDGETS</div>
                    <div class="section-desc">Enter total budget per discipline (distributed by claiming %)</div>

                    <!-- CALCULATOR SECTION -->
                    <div id="budget-calculator" class="budget-calculator">
                        <div class="calculator-header" onclick="toggleCalculator()">
                            <span> COST ESTIMATOR</span>
                            <span id="calculator-status" style="color: #888; font-size: 11px;">Configure inputs below</span>
                        </div>

                        <div id="calculator-body" class="calculator-body">
                            <div class="calc-grid">
                                <div class="calc-group">
                                    <label>Total Construction Cost ($)</label>
                                    <input type="text" id="calc-construction-cost" placeholder="5,000,000" inputmode="numeric">
                                </div>

                                <div class="calc-group">
                                    <label>Design Fee (% of Construction)</label>
                                    <input type="number" id="calc-design-fee-pct" value="15" min="1" max="30" step="0.5">
                                </div>

                                <div class="calc-group">
                                    <label>Project Type</label>
                                    <select id="calc-project-type" onchange="updateComplexityDefaults()">
                                        <option value="Bridge">Bridge</option>
                                        <option value="Highway/Roadway" selected>Highway/Roadway</option>
                                        <option value="Drainage/Utilities">Drainage/Utilities</option>
                                    </select>
                                </div>

                                <div class="calc-group">
                                    <label>Project Complexity (Reference)</label>
                                    <select id="calc-global-complexity">
                                        <option value="Low">Low</option>
                                        <option value="Medium" selected>Medium</option>
                                        <option value="High">High</option>
                                    </select>
                                </div>
                            </div>

                            <div style="margin-top: 12px; padding: 8px; background: #1a1a00; border: 1px solid #333; font-size: 12px;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Total Design Fee:</span>
                                    <span id="calc-total-fee" style="color: #ffd700; font-weight: 600;">$0</span>
                                </div>
                            </div>

                            <div style="margin-top: 12px; display: flex; gap: 8px; justify-content: flex-end;">
                                <button class="btn btn-sm" onclick="showComplexityOverrides()">Advanced Settings</button>
                                <button class="btn btn-primary btn-sm" onclick="calculateBudgets()">Calculate Estimates</button>
                            </div>

                            <!-- Advanced Complexity Overrides (hidden by default) -->
                            <div id="complexity-overrides" class="hidden" style="margin-top: 16px; border-top: 1px solid #333; padding-top: 16px;">
                                <div style="font-size: 11px; color: #888; margin-bottom: 8px;">
                                    Override auto-assigned complexity levels per discipline:
                                </div>
                                <div id="complexity-grid" class="complexity-override-grid"></div>
                            </div>
                        </div>
                    </div>

                    <div class="ascii-line"></div>

                    <div style="max-height: 350px; overflow-y: auto;">
                        <table id="budget-table"></table>
                    </div>

                    <div class="ascii-line"></div>

                    <div style="display: flex; justify-content: space-between; color: #fff;">
                        <span>TOTAL PROJECT BUDGET:</span>
                        <span id="total-budget" style="color: #ffd700; font-size: 18px;">$0</span>
                    </div>
                </div>

                <!-- Step 5: Claiming -->
                <div id="step5" class="step-content hidden">
                    <div class="section-title">CLAIMING SCHEME</div>
                    <div class="section-desc">Set claiming % per package (must total 100%)</div>

                    <!-- PRESET SELECTOR PANEL -->
                    <div class="claiming-preset-panel">
                        <div class="preset-header" onclick="toggleClaimingPresets()">
                            <span> SCHEME PRESETS</span>
                            <span id="preset-status" style="color: #888; font-size: 11px;">Click to apply a preset</span>
                        </div>

                        <div id="preset-body" class="preset-body">
                            <div class="preset-options">
                                <label class="preset-option">
                                    <input type="radio" name="claiming-scheme" value="frontLoaded">
                                    <div class="preset-label">
                                        <span class="preset-name">Front-Loaded</span>
                                        <span class="preset-desc">Higher % early, declining (3010%)</span>
                                    </div>
                                </label>

                                <label class="preset-option">
                                    <input type="radio" name="claiming-scheme" value="backLoaded">
                                    <div class="preset-label">
                                        <span class="preset-name">Back-Loaded</span>
                                        <span class="preset-desc">Lower % early, increasing (1030%)</span>
                                    </div>
                                </label>

                                <label class="preset-option">
                                    <input type="radio" name="claiming-scheme" value="bellCurve">
                                    <div class="preset-label">
                                        <span class="preset-name">Bell Curve</span>
                                        <span class="preset-desc">Peak in middle (10-20-40-20-10)</span>
                                    </div>
                                </label>

                                <label class="preset-option">
                                    <input type="radio" name="claiming-scheme" value="linear">
                                    <div class="preset-label">
                                        <span class="preset-name">Linear/Even</span>
                                        <span class="preset-desc">Equal distribution across all</span>
                                    </div>
                                </label>
                            </div>

                            <div class="preset-actions">
                                <button class="btn btn-sm" onclick="previewScheme()">Preview</button>
                                <button class="btn btn-primary btn-sm" onclick="applyClaimingScheme()">Apply to All Disciplines</button>
                            </div>

                            <div id="preview-display" class="preset-preview hidden"></div>
                        </div>
                    </div>

                    <div style="max-height: 350px; overflow-y: auto;">
                        <table id="claiming-table"></table>
                    </div>
                </div>

                <!-- Step 6: Schedule -->
                <div id="step6" class="step-content hidden">
                    <div class="section-title">PROJECT SCHEDULE</div>
                    <div class="section-desc">Set start/end dates per package</div>
                    
                    <!-- AI Schedule Generator -->
                    <div class="ai-schedule-section">
                        <button class="btn btn-ai" onclick="generateAISchedule()" id="ai-schedule-btn">
                            <span class="ai-btn-icon"></span>
                            <span>AI GENERATE SCHEDULE</span>
                        </button>
                        <div class="ai-schedule-options">
                            <label>Project Start:</label>
                            <input type="date" id="ai-schedule-start" value="">
                            <label>Duration Target:</label>
                            <select id="ai-schedule-duration">
                                <option value="6">6 months</option>
                                <option value="9">9 months</option>
                                <option value="12" selected>12 months</option>
                                <option value="18">18 months</option>
                                <option value="24">24 months</option>
                            </select>
                        </div>
                        <div id="ai-schedule-loading" class="ai-schedule-loading hidden">
                            <span class="ai-loading-spinner"></span>
                            <span>Analyzing project scope and generating schedule...</span>
                        </div>
                    </div>
                    
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table id="dates-table"></table>
                    </div>
                </div>

            </div>
        </div>

        <!-- Results Section -->
        <div id="results-section" class="hidden" style="margin-top: 20px;">
            <!-- KPIs -->
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-value" id="kpi-budget">$0</div>
                    <div class="kpi-label">TOTAL BUDGET</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="kpi-wbs">0</div>
                    <div class="kpi-label">WBS ELEMENTS</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="kpi-disc">0</div>
                    <div class="kpi-label">DISCIPLINES</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="kpi-months">0</div>
                    <div class="kpi-label">MONTHS</div>
                </div>
            </div>

            <!-- AI Insights Panel -->
            <div class="insights-panel">
                <div class="insights-header" onclick="toggleInsightsPanel()">
                    <span> AI INSIGHTS & FORECASTING</span>
                    <span class="insights-toggle-icon"></span>
                </div>
                <div id="insights-body" class="insights-body hidden">
                    <div class="insights-grid">
                        <!-- Risk Score -->
                        <div class="insight-card">
                            <div class="insight-card-header">
                                <span class="insight-icon"></span>
                                <span class="insight-title">Risk Assessment</span>
                            </div>
                            <div id="insight-risk-score" class="insight-value risk-medium">MEDIUM</div>
                            <div id="insight-risk-details" class="insight-details">Analyzing project complexity...</div>
                        </div>

                        <!-- Cost Forecast -->
                        <div class="insight-card">
                            <div class="insight-card-header">
                                <span class="insight-icon"></span>
                                <span class="insight-title">Cost Forecast</span>
                            </div>
                            <div id="insight-cost-forecast" class="insight-value">$0</div>
                            <div id="insight-cost-details" class="insight-details">Projected final cost...</div>
                        </div>

                        <!-- Schedule Forecast -->
                        <div class="insight-card">
                            <div class="insight-card-header">
                                <span class="insight-icon"></span>
                                <span class="insight-title">Schedule Forecast</span>
                            </div>
                            <div id="insight-schedule-forecast" class="insight-value">On Track</div>
                            <div id="insight-schedule-details" class="insight-details">Completion estimate...</div>
                        </div>

                        <!-- Budget Health -->
                        <div class="insight-card">
                            <div class="insight-card-header">
                                <span class="insight-icon"></span>
                                <span class="insight-title">Budget Distribution</span>
                            </div>
                            <div id="insight-budget-health" class="insight-value">Balanced</div>
                            <div id="insight-budget-details" class="insight-details">Analyzing discipline allocation...</div>
                        </div>
                    </div>

                    <!-- AI Suggestions -->
                    <div class="insights-suggestions">
                        <div class="suggestions-header">
                            <span> AI Optimization Suggestions</span>
                            <button class="btn btn-sm btn-ai" onclick="generateAIInsights()" id="generate-insights-btn">
                                Generate Insights
                            </button>
                        </div>
                        <div id="ai-suggestions-list" class="suggestions-list">
                            <div class="suggestion-placeholder">
                                Click "Generate Insights" to get AI-powered recommendations for your project.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- WBS Table -->
            <div class="terminal">
                <div class="terminal-header">
                    <span> WBS COST TABLE</span>
                    <div>
                        <button class="btn btn-sm" onclick="expandAllWBS()">EXPAND ALL</button>
                        <button class="btn btn-sm" onclick="collapseAllWBS()" style="margin-left: 8px;">COLLAPSE ALL</button>
                        <span style="margin: 0 12px; color: #666;">|</span>
                        <button class="btn btn-sm" onclick="printReport()">PRINT</button>
                        <button class="btn btn-sm" onclick="exportProjectSummary()" style="margin-left: 8px;">EXPORT SUMMARY</button>
                        <button class="btn btn-sm" onclick="exportAllDataCSV()" style="margin-left: 8px;">EXPORT DATA</button>
                        <button class="btn btn-sm" onclick="exportCSV()" style="margin-left: 8px;">EXPORT WBS</button>
                        <button class="btn btn-sm" onclick="importData()" style="margin-left: 8px;">IMPORT</button>
                        <button class="btn btn-sm" onclick="editWBS()" style="margin-left: 8px;">EDIT</button>
                    </div>
                </div>
                <div class="terminal-body">
                    <div class="results-table">
                        <table id="wbs-table"></table>
                    </div>
                </div>
            </div>

            <!-- Chart -->
            <div class="terminal" style="margin-top: 20px;">
                <div class="terminal-header">
                    <span> PERFORMANCE CHART</span>
                </div>
                <div class="terminal-body">
                    <div class="filters">
                        <div class="filter-group">
                            <label>PHASE</label>
                            <select id="filter-phase" onchange="updateChart()">
                                <option value="all">All Phases</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>DISCIPLINE</label>
                            <select id="filter-discipline" onchange="updateChart()">
                                <option value="all">All Disciplines</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>VIEW</label>
                            <select id="view-type" onchange="updateChart()">
                                <option value="cumulative">Cumulative</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>CHART</label>
                            <select id="chart-type" onchange="updateChart()">
                                <option value="line">Line</option>
                                <option value="bar">Bar</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="performance-chart" height="300"></canvas>
                    </div>
                    
                    <div style="margin-top: 16px; font-size: 12px; display: flex; gap: 24px;">
                        <span><span style="color: #ffd700;"></span> PLANNED (BCWS)</span>
                        <span><span style="color: #00ff00;"></span> ACTUAL (ACWP) - TBD</span>
                    </div>
                </div>
            </div>

            <!-- Gantt Chart -->
            <div class="terminal" style="margin-top: 20px;">
                <div class="terminal-header">
                    <span> PROJECT SCHEDULE</span>
                    <div>
                        <button class="btn btn-sm" onclick="expandAllGantt()">EXPAND ALL</button>
                        <button class="btn btn-sm" onclick="collapseAllGantt()" style="margin-left: 8px;">COLLAPSE ALL</button>
                    </div>
                </div>
                <div class="terminal-body">
                    <div id="gantt-container" class="gantt-container">
                        <!-- Gantt chart will be rendered here -->
                    </div>
                    <div class="gantt-legend">
                        <div class="gantt-legend-item">
                            <div class="gantt-legend-color discipline"></div>
                            <span>Discipline Timeline</span>
                        </div>
                        <div class="gantt-legend-item">
                            <div class="gantt-legend-color package"></div>
                            <span>Package Deliverable</span>
                        </div>
                        <div class="gantt-legend-item" style="margin-left: auto; color: #666;">
                            <span>Click discipline rows to expand/collapse</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data
        let projectData = {
            phases: [],
            disciplines: [],
            packages: [],
            budgets: {},
            claiming: {},
            dates: {},
            calculator: {
                totalConstructionCost: 0,
                designFeePercent: 15,
                projectType: 'Highway/Roadway',
                totalDesignFee: 0,
                complexityOverrides: {},
                isCalculated: false,
                manualEdits: {}
            },
            // RFP-extracted data for export
            projectScope: '',
            scheduleNotes: '',
            disciplineScopes: {}
        };

        let currentStep = 1;
        let chart = null;

        // ============================================
        // PERSISTENCE SYSTEM
        // ============================================
        
        const STORAGE_KEY = 'wbs_project_autosave';
        const STORAGE_VERSION = 1;
        let autosaveTimeout = null;
        let lastSaveTime = null;

        /**
         * Debounce utility for autosave
         */
        function debounce(func, wait) {
            return function executedFunction(...args) {
                clearTimeout(autosaveTimeout);
                autosaveTimeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        /**
         * Shows the autosave indicator
         */
        function showAutosaveIndicator(status) {
            const indicator = document.getElementById('autosave-indicator');
            const icon = document.getElementById('autosave-icon');
            const text = document.getElementById('autosave-text');
            
            if (!indicator) return;
            
            indicator.classList.remove('saving', 'saved');
            
            if (status === 'saving') {
                indicator.classList.add('visible', 'saving');
                icon.textContent = '';
                text.textContent = 'Saving...';
            } else if (status === 'saved') {
                indicator.classList.add('visible', 'saved');
                icon.textContent = '';
                text.textContent = 'Saved';
                setTimeout(() => {
                    indicator.classList.remove('visible');
                }, 2000);
            }
        }

        /**
         * Saves project data to localStorage
         */
        function saveToLocalStorage() {
            try {
                showAutosaveIndicator('saving');
                
                const saveData = {
                    version: STORAGE_VERSION,
                    timestamp: Date.now(),
                    currentStep: currentStep,
                    projectData: projectData,
                    // Also save form values that might not be in projectData yet
                    formState: {
                        phases: document.getElementById('phases-input')?.value || '',
                        packages: document.getElementById('packages-input')?.value || ''
                    }
                };
                
                localStorage.setItem(STORAGE_KEY, JSON.stringify(saveData));
                lastSaveTime = Date.now();
                
                setTimeout(() => showAutosaveIndicator('saved'), 300);
                console.log('Project autosaved:', new Date().toLocaleTimeString());
            } catch (error) {
                console.error('Autosave failed:', error);
            }
        }

        /**
         * Debounced autosave function - saves 1 second after last change
         */
        const autosave = debounce(saveToLocalStorage, 1000);

        /**
         * Triggers autosave on any data change
         */
        function triggerAutosave() {
            autosave();
        }

        /**
         * Loads saved data from localStorage
         * @returns {object|null} The saved data or null if none exists
         */
        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (!saved) return null;
                
                const data = JSON.parse(saved);
                
                // Check version compatibility
                if (data.version !== STORAGE_VERSION) {
                    console.warn('Saved data version mismatch, discarding');
                    return null;
                }
                
                return data;
            } catch (error) {
                console.error('Failed to load saved data:', error);
                return null;
            }
        }

        /**
         * Checks if saved data has meaningful content worth recovering
         */
        function hasMeaningfulData(data) {
            if (!data || !data.projectData) return false;
            
            const pd = data.projectData;
            return (
                pd.phases.length > 0 ||
                pd.disciplines.length > 0 ||
                pd.packages.length > 0 ||
                Object.keys(pd.budgets).length > 0 ||
                pd.projectScope
            );
        }

        /**
         * Formats a timestamp for display
         */
        function formatTimestamp(ts) {
            const date = new Date(ts);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
            return date.toLocaleDateString();
        }

        /**
         * Formats currency for recovery modal (local version)
         */
        function formatCurrencySimple(amount) {
            return '$' + Math.round(amount || 0).toLocaleString('en-US');
        }

        /**
         * Shows the recovery modal with saved data preview
         */
        function showRecoveryModal(savedData) {
            const modal = document.getElementById('recovery-modal');
            const preview = document.getElementById('recovery-preview');
            
            if (!modal || !preview) return;
            
            const pd = savedData.projectData;
            const totalBudget = Object.values(pd.budgets || {}).reduce((sum, b) => sum + (parseFloat(b) || 0), 0);
            
            preview.innerHTML = `
                <div class="recovery-preview-item">
                    <span class="recovery-preview-label">Last saved:</span>
                    <span class="recovery-preview-value">${formatTimestamp(savedData.timestamp)}</span>
                </div>
                <div class="recovery-preview-item">
                    <span class="recovery-preview-label">Step:</span>
                    <span class="recovery-preview-value">${savedData.currentStep} of 6</span>
                </div>
                <div class="recovery-preview-item">
                    <span class="recovery-preview-label">Phases:</span>
                    <span class="recovery-preview-value">${pd.phases.length > 0 ? pd.phases.join(', ') : 'None'}</span>
                </div>
                <div class="recovery-preview-item">
                    <span class="recovery-preview-label">Disciplines:</span>
                    <span class="recovery-preview-value">${pd.disciplines.length || 0} selected</span>
                </div>
                <div class="recovery-preview-item">
                    <span class="recovery-preview-label">Packages:</span>
                    <span class="recovery-preview-value">${pd.packages.length > 0 ? pd.packages.join(', ') : 'None'}</span>
                </div>
                <div class="recovery-preview-item">
                    <span class="recovery-preview-label">Total Budget:</span>
                    <span class="recovery-preview-value">${totalBudget > 0 ? formatCurrencySimple(totalBudget) : 'Not set'}</span>
                </div>
                ${pd.projectScope ? `
                <div class="recovery-preview-item">
                    <span class="recovery-preview-label">Project Scope:</span>
                    <span class="recovery-preview-value"> From RFP Analysis</span>
                </div>
                ` : ''}
            `;
            
            modal.classList.add('open');
        }

        /**
         * Dismisses the recovery modal without action
         */
        function dismissRecovery() {
            document.getElementById('recovery-modal')?.classList.remove('open');
        }

        /**
         * Discards saved data and starts fresh
         */
        function discardRecovery() {
            localStorage.removeItem(STORAGE_KEY);
            dismissRecovery();
            console.log('Saved data discarded');
        }

        /**
         * Restores saved data
         */
        function restoreRecovery() {
            const savedData = loadFromLocalStorage();
            if (!savedData) {
                dismissRecovery();
                return;
            }
            
            // Restore projectData
            projectData = { ...projectData, ...savedData.projectData };
            
            // Restore form values
            if (savedData.formState) {
                const phasesInput = document.getElementById('phases-input');
                const packagesInput = document.getElementById('packages-input');
                if (phasesInput && savedData.formState.phases) {
                    phasesInput.value = savedData.formState.phases;
                }
                if (packagesInput && savedData.formState.packages) {
                    packagesInput.value = savedData.formState.packages;
                }
            }
            
            // Restore discipline selections
            if (savedData.projectData.disciplines.length > 0) {
                allDisciplines.forEach(d => {
                    d.selected = savedData.projectData.disciplines.includes(d.name);
                });
                initDisciplines();
            }
            
            // Navigate to saved step
            currentStep = savedData.currentStep || 1;
            showStep(currentStep);
            updateProgress();
            
            dismissRecovery();
            updateStatus('SESSION RESTORED');
            console.log('Session restored from:', new Date(savedData.timestamp).toLocaleString());
        }

        /**
         * Clears all saved data (for use after successful WBS generation or manual clear)
         */
        function clearSavedData() {
            localStorage.removeItem(STORAGE_KEY);
            console.log('Saved data cleared');
        }

        /**
         * Checks for saved data on page load
         */
        function checkForSavedData() {
            const savedData = loadFromLocalStorage();
            if (savedData && hasMeaningfulData(savedData)) {
                // Only show recovery if data is less than 7 days old
                const ageMs = Date.now() - savedData.timestamp;
                const maxAgeMs = 7 * 24 * 60 * 60 * 1000; // 7 days
                
                if (ageMs < maxAgeMs) {
                    showRecoveryModal(savedData);
                } else {
                    console.log('Saved data too old, discarding');
                    clearSavedData();
                }
            }
        }

        // ============================================
        // MULTI-PROJECT MANAGER
        // ============================================
        
        const PROJECTS_STORAGE_KEY = 'wbs_saved_projects';

        /**
         * Opens the project manager modal
         */
        function openProjectManager() {
            document.getElementById('projects-modal').classList.add('open');
            populateProjectsList();
            
            // Pre-fill save name if project has meaningful data
            const saveInput = document.getElementById('project-save-name');
            if (projectData.phases.length > 0) {
                const defaultName = projectData.phases[0] + ' Project';
                saveInput.placeholder = defaultName;
            }
        }

        /**
         * Closes the project manager modal
         */
        function closeProjectManager() {
            document.getElementById('projects-modal').classList.remove('open');
        }

        /**
         * Gets all saved projects from localStorage
         */
        function getSavedProjects() {
            try {
                const saved = localStorage.getItem(PROJECTS_STORAGE_KEY);
                return saved ? JSON.parse(saved) : [];
            } catch (e) {
                console.error('Failed to load saved projects:', e);
                return [];
            }
        }

        /**
         * Saves the projects list to localStorage
         */
        function saveProjectsList(projects) {
            localStorage.setItem(PROJECTS_STORAGE_KEY, JSON.stringify(projects));
        }

        /**
         * Saves the current project with a name
         */
        function saveNamedProject() {
            const nameInput = document.getElementById('project-save-name');
            let name = nameInput.value.trim();
            
            if (!name) {
                name = projectData.phases.length > 0 
                    ? projectData.phases[0] + ' Project' 
                    : 'Untitled Project';
            }
            
            // Check if project has data
            if (!hasMeaningfulData({ projectData })) {
                alert('No project data to save. Please complete some wizard steps first.');
                return;
            }
            
            const projects = getSavedProjects();
            
            // Check for existing project with same name
            const existingIdx = projects.findIndex(p => p.name === name);
            if (existingIdx >= 0) {
                if (!confirm(`A project named "${name}" already exists. Overwrite it?`)) {
                    return;
                }
                projects.splice(existingIdx, 1);
            }
            
            // Create project snapshot
            const totalBudget = Object.values(projectData.budgets).reduce((sum, b) => sum + (parseFloat(b) || 0), 0);
            
            const projectSnapshot = {
                id: Date.now().toString(),
                name: name,
                savedAt: Date.now(),
                currentStep: currentStep,
                projectData: JSON.parse(JSON.stringify(projectData)), // Deep clone
                summary: {
                    phases: projectData.phases.length,
                    disciplines: projectData.disciplines.length,
                    packages: projectData.packages.length,
                    totalBudget: totalBudget
                }
            };
            
            projects.unshift(projectSnapshot);
            saveProjectsList(projects);
            
            nameInput.value = '';
            populateProjectsList();
            
            updateStatus(`SAVED: ${name}`);
        }

        /**
         * Populates the projects list in the modal
         */
        function populateProjectsList() {
            const list = document.getElementById('projects-list');
            const projects = getSavedProjects();
            
            if (projects.length === 0) {
                list.innerHTML = `
                    <div class="projects-empty">
                        <div style="font-size: 24px; margin-bottom: 8px;"></div>
                        No saved projects yet.<br>
                        Save your current project using the form above.
                    </div>
                `;
                return;
            }
            
            list.innerHTML = projects.map(project => `
                <div class="project-item" data-id="${project.id}">
                    <input type="checkbox" class="project-item-checkbox" onchange="updateCompareView()">
                    <div class="project-item-info">
                        <div class="project-item-name">${escapeHtml(project.name)}</div>
                        <div class="project-item-meta">
                            <span> ${formatTimestamp(project.savedAt)}</span>
                            <span> ${project.summary.disciplines} disciplines</span>
                            <span> ${formatCurrencySimple(project.summary.totalBudget)}</span>
                        </div>
                    </div>
                    <div class="project-item-actions">
                        <button class="project-item-btn" onclick="loadProject('${project.id}')">Load</button>
                        <button class="project-item-btn" onclick="duplicateProject('${project.id}')">Clone</button>
                        <button class="project-item-btn delete" onclick="deleteProject('${project.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        /**
         * Loads a saved project
         */
        function loadProject(projectId) {
            const projects = getSavedProjects();
            const project = projects.find(p => p.id === projectId);
            
            if (!project) {
                alert('Project not found.');
                return;
            }
            
            // Confirm if there's current data
            if (hasMeaningfulData({ projectData })) {
                if (!confirm(`Load "${project.name}"? Your current unsaved work will be lost.`)) {
                    return;
                }
            }
            
            // Load project data
            projectData = JSON.parse(JSON.stringify(project.projectData));
            currentStep = project.currentStep || 1;
            
            // Update UI
            document.getElementById('phases-input').value = projectData.phases.join(', ');
            document.getElementById('packages-input').value = projectData.packages.join(', ');
            
            // Update discipline selections
            allDisciplines.forEach(d => {
                d.selected = projectData.disciplines.includes(d.name);
            });
            initDisciplines();
            
            // Navigate to saved step
            showStep(currentStep);
            updateProgress();
            
            closeProjectManager();
            triggerAutosave();
            updateStatus(`LOADED: ${project.name}`);
        }

        /**
         * Duplicates a saved project
         */
        function duplicateProject(projectId) {
            const projects = getSavedProjects();
            const project = projects.find(p => p.id === projectId);
            
            if (!project) return;
            
            const newProject = JSON.parse(JSON.stringify(project));
            newProject.id = Date.now().toString();
            newProject.name = project.name + ' (Copy)';
            newProject.savedAt = Date.now();
            
            projects.unshift(newProject);
            saveProjectsList(projects);
            populateProjectsList();
        }

        /**
         * Deletes a saved project
         */
        function deleteProject(projectId) {
            const projects = getSavedProjects();
            const project = projects.find(p => p.id === projectId);
            
            if (!project) return;
            
            if (!confirm(`Delete "${project.name}"? This cannot be undone.`)) {
                return;
            }
            
            const filtered = projects.filter(p => p.id !== projectId);
            saveProjectsList(filtered);
            populateProjectsList();
            updateCompareView();
        }

        /**
         * Updates the compare view based on selected projects
         */
        function updateCompareView() {
            const checkboxes = document.querySelectorAll('.project-item-checkbox:checked');
            const compareSection = document.getElementById('compare-section');
            const compareView = document.getElementById('compare-view');
            
            if (checkboxes.length < 2) {
                compareSection.classList.add('hidden');
                return;
            }
            
            compareSection.classList.remove('hidden');
            
            const projects = getSavedProjects();
            const selectedProjects = [];
            
            checkboxes.forEach(cb => {
                const projectItem = cb.closest('.project-item');
                const projectId = projectItem.dataset.id;
                const project = projects.find(p => p.id === projectId);
                if (project) selectedProjects.push(project);
            });
            
            compareView.innerHTML = selectedProjects.map(project => `
                <div class="compare-card">
                    <div class="compare-card-title">${escapeHtml(project.name)}</div>
                    <div class="compare-stat">
                        <span class="compare-stat-label">Total Budget</span>
                        <span class="compare-stat-value">${formatCurrencySimple(project.summary.totalBudget)}</span>
                    </div>
                    <div class="compare-stat">
                        <span class="compare-stat-label">Phases</span>
                        <span class="compare-stat-value">${project.summary.phases}</span>
                    </div>
                    <div class="compare-stat">
                        <span class="compare-stat-label">Disciplines</span>
                        <span class="compare-stat-value">${project.summary.disciplines}</span>
                    </div>
                    <div class="compare-stat">
                        <span class="compare-stat-label">Packages</span>
                        <span class="compare-stat-value">${project.summary.packages}</span>
                    </div>
                    <div class="compare-stat">
                        <span class="compare-stat-label">Saved</span>
                        <span class="compare-stat-value">${formatTimestamp(project.savedAt)}</span>
                    </div>
                </div>
            `).join('');
        }

        /**
         * Escapes HTML characters to prevent XSS
         */
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Discipline list with pre-selected items
        const allDisciplines = [
            { name: 'Structures', selected: true },
            { name: 'Design PM', selected: true },
            { name: 'Civil', selected: false },
            { name: 'Drainage', selected: false },
            { name: 'Electrical', selected: false },
            { name: 'Environmental', selected: false },
            { name: 'Traffic', selected: false },
            { name: 'ITS', selected: false },
            { name: 'Mechanical', selected: false },
            { name: 'Geotechnical', selected: false },
            { name: 'Survey', selected: false },
            { name: 'Landscape', selected: false },
            { name: 'Utilities', selected: false },
            { name: 'Lighting', selected: false },
            { name: 'Pavement', selected: false },
            { name: 'Bridges', selected: false },
            { name: 'H&H', selected: false },
            { name: 'Communications', selected: false },
            { name: 'Architecture', selected: false },
            { name: 'Systems', selected: false }
        ];

        // Example budgets [in the future we will use a database to get the budgets]
        const exampleBudgets = {
            'Structures': 450000,
            'Design PM': 180000,
            'Civil': 320000,
            'Drainage': 95000,
            'Electrical': 210000,
            'Environmental': 85000,
            'Traffic': 140000,
            'ITS': 125000,
            'Mechanical': 175000,
            'Geotechnical': 110000,
            'Survey': 65000,
            'Landscape': 55000,
            'Utilities': 90000,
            'Lighting': 75000,
            'Pavement': 280000,
            'Bridges': 520000,
            'H&H': 120000,
            'Communications': 95000,
            'Architecture': 150000,
            'Systems': 180000
        };

        // Default claiming scheme
        const defaultClaiming = [10, 15, 25, 30, 20];

        // Claiming scheme presets
        const claimingSchemes = {
            frontLoaded: {
                name: 'Front-Loaded',
                description: 'Higher % early, declining',
                baseline: [30, 25, 20, 15, 10],
                pattern: 'descending'
            },
            backLoaded: {
                name: 'Back-Loaded',
                description: 'Lower % early, increasing',
                baseline: [10, 15, 20, 25, 30],
                pattern: 'ascending'
            },
            bellCurve: {
                name: 'Bell Curve',
                description: 'Peak in middle',
                baseline: [10, 20, 40, 20, 10],
                pattern: 'bell'
            },
            linear: {
                name: 'Linear/Even',
                description: 'Equal distribution',
                baseline: [20, 20, 20, 20, 20],
                pattern: 'equal'
            }
        };

        // ============================================
        // PROJECT TEMPLATES
        // ============================================
        
        const projectTemplates = {
            highway: {
                id: 'highway',
                name: 'Highway Reconstruction',
                icon: '',
                description: 'Highway widening, reconstruction, or improvement project',
                projectType: 'Highway/Roadway',
                phases: ['Base Design', 'ESDC', 'TSCD'],
                disciplines: ['Design PM', 'Civil', 'Drainage', 'Traffic', 'Survey', 'Pavement', 'Utilities', 'Environmental', 'Lighting'],
                packages: ['Preliminary', 'Interim', 'Final', 'RFC'],
                constructionCost: 10000000,
                designFeePercent: 12,
                claimingScheme: 'bellCurve'
            },
            bridge: {
                id: 'bridge',
                name: 'Bridge Replacement',
                icon: '',
                description: 'Bridge design, replacement, or rehabilitation project',
                projectType: 'Bridge',
                phases: ['Base Design', 'ESDC', 'TSCD'],
                disciplines: ['Design PM', 'Structures', 'Bridges', 'Geotechnical', 'Civil', 'Drainage', 'H&H', 'Survey', 'Environmental'],
                packages: ['Preliminary', 'Interim', 'Final', 'RFC'],
                constructionCost: 15000000,
                designFeePercent: 15,
                claimingScheme: 'bellCurve'
            },
            drainage: {
                id: 'drainage',
                name: 'Drainage Improvement',
                icon: '',
                description: 'Stormwater management or drainage infrastructure project',
                projectType: 'Drainage/Utilities',
                phases: ['Base Design', 'Final Design'],
                disciplines: ['Design PM', 'Drainage', 'H&H', 'Civil', 'Environmental', 'Survey', 'Utilities', 'Geotechnical'],
                packages: ['Preliminary', 'Final', 'RFC'],
                constructionCost: 5000000,
                designFeePercent: 12,
                claimingScheme: 'linear'
            },
            intersection: {
                id: 'intersection',
                name: 'Intersection Improvement',
                icon: '',
                description: 'Traffic signal, intersection, or safety improvement project',
                projectType: 'Highway/Roadway',
                phases: ['Base Design', 'Final Design'],
                disciplines: ['Design PM', 'Civil', 'Traffic', 'Lighting', 'Electrical', 'Drainage', 'Survey', 'Utilities'],
                packages: ['Preliminary', 'Final', 'RFC'],
                constructionCost: 3000000,
                designFeePercent: 15,
                claimingScheme: 'bellCurve'
            },
            multiDiscipline: {
                id: 'multiDiscipline',
                name: 'Multi-Discipline Infrastructure',
                icon: '',
                description: 'Large-scale project with multiple engineering disciplines',
                projectType: 'Highway/Roadway',
                phases: ['Base Design', 'ESDC', 'TSCD', 'Closeout'],
                disciplines: ['Design PM', 'Structures', 'Civil', 'Drainage', 'Traffic', 'ITS', 'Electrical', 'Environmental', 'Survey', 'Utilities', 'Lighting', 'Pavement', 'Geotechnical'],
                packages: ['Preliminary', 'Interim', 'Final', 'RFC', 'As-Built'],
                constructionCost: 50000000,
                designFeePercent: 10,
                claimingScheme: 'bellCurve'
            },
            transit: {
                id: 'transit',
                name: 'Transit/Rail Station',
                icon: '',
                description: 'Transit station, rail crossing, or transit infrastructure',
                projectType: 'Bridge',
                phases: ['Conceptual Design', 'Preliminary Design', 'Final Design'],
                disciplines: ['Design PM', 'Structures', 'Architecture', 'Civil', 'Electrical', 'Mechanical', 'Systems', 'Traffic', 'Environmental'],
                packages: ['30% Design', '60% Design', '90% Design', 'Final'],
                constructionCost: 25000000,
                designFeePercent: 12,
                claimingScheme: 'bellCurve'
            }
        };

        /**
         * Toggles the template selector visibility
         */
        function toggleTemplateSelector() {
            const selector = document.querySelector('.template-selector');
            const body = document.getElementById('template-body');
            
            selector.classList.toggle('expanded');
            body.classList.toggle('hidden');
            
            // Populate templates on first open
            if (!body.classList.contains('hidden') && body.innerHTML.trim() === '') {
                populateTemplates();
            }
        }

        /**
         * Populates the template grid with available templates
         */
        function populateTemplates() {
            const grid = document.getElementById('template-grid');
            
            grid.innerHTML = Object.values(projectTemplates).map(template => `
                <div class="template-card" onclick="applyTemplate('${template.id}')">
                    <div class="template-card-icon">${template.icon}</div>
                    <div class="template-card-title">${template.name}</div>
                    <div class="template-card-desc">${template.description}</div>
                    <div class="template-card-stats">
                        <div class="template-card-stat">
                            <span>${template.phases.length}</span> phases
                        </div>
                        <div class="template-card-stat">
                            <span>${template.disciplines.length}</span> disciplines
                        </div>
                        <div class="template-card-stat">
                            <span>${template.packages.length}</span> packages
                        </div>
                    </div>
                </div>
            `).join('');
        }

        /**
         * Applies a template to populate the wizard
         */
        function applyTemplate(templateId) {
            const template = projectTemplates[templateId];
            if (!template) return;
            
            // Confirm if there's existing data
            const hasData = projectData.phases.length > 0 || 
                           projectData.disciplines.length > 0 || 
                           Object.keys(projectData.budgets).length > 0;
            
            if (hasData) {
                if (!confirm(`This will replace your current project data with the "${template.name}" template. Continue?`)) {
                    return;
                }
            }
            
            // Apply template data
            projectData.phases = [...template.phases];
            projectData.packages = [...template.packages];
            projectData.disciplines = [...template.disciplines];
            
            // Set calculator values
            projectData.calculator.totalConstructionCost = template.constructionCost;
            projectData.calculator.designFeePercent = template.designFeePercent;
            projectData.calculator.projectType = template.projectType;
            projectData.calculator.isCalculated = false;
            
            // Update form inputs
            document.getElementById('phases-input').value = template.phases.join(', ');
            document.getElementById('packages-input').value = template.packages.join(', ');
            
            // Update discipline grid
            allDisciplines.forEach(d => {
                d.selected = template.disciplines.includes(d.name);
            });
            initDisciplines();
            
            // Initialize claiming with the template's scheme
            const scheme = claimingSchemes[template.claimingScheme];
            if (scheme) {
                const adjustedScheme = adjustSchemeToPackageCount(template.claimingScheme, template.packages.length);
                template.disciplines.forEach(disc => {
                    template.packages.forEach((pkg, i) => {
                        const key = `${disc}-${pkg}`;
                        projectData.claiming[key] = adjustedScheme[i];
                    });
                });
            }
            
            // Initialize dates (spread across typical project duration)
            const today = new Date();
            const monthsPerPhase = Math.ceil(12 / template.phases.length);
            template.disciplines.forEach(disc => {
                template.packages.forEach((pkg, i) => {
                    const key = `${disc}-${pkg}`;
                    const startOffset = i * (monthsPerPhase * 30 / template.packages.length);
                    const endOffset = startOffset + (monthsPerPhase * 30 / template.packages.length) - 1;
                    
                    const startDate = new Date(today);
                    startDate.setDate(startDate.getDate() + startOffset);
                    const endDate = new Date(today);
                    endDate.setDate(endDate.getDate() + endOffset);
                    
                    projectData.dates[key] = {
                        start: startDate.toISOString().split('T')[0],
                        end: endDate.toISOString().split('T')[0]
                    };
                });
            });
            
            // Initialize budgets to 0 (user will use calculator)
            projectData.budgets = {};
            template.disciplines.forEach(disc => {
                projectData.budgets[disc] = 0;
            });
            
            // Collapse template selector
            toggleTemplateSelector();
            
            // Trigger autosave
            triggerAutosave();
            
            // Update UI
            updateStatus(`TEMPLATE: ${template.name}`);
            
            // Show success message
            alert(` Template "${template.name}" applied!\n\n ${template.phases.length} phases\n ${template.disciplines.length} disciplines\n ${template.packages.length} packages\n\nConstruction cost pre-set to $${(template.constructionCost / 1000000).toFixed(1)}M.\nUse the Cost Estimator in Step 4 to calculate budgets.`);
        }

        // Project complexity mapping per project type
        const projectComplexityMap = {
            'Bridge': {
                'Structures': 'High', 'Design PM': 'Medium', 'Civil': 'High',
                'Drainage': 'Medium', 'Electrical': 'Low', 'Environmental': 'Medium',
                'Traffic': 'Low', 'ITS': 'Low', 'Mechanical': 'Medium',
                'Geotechnical': 'High', 'Survey': 'Medium', 'Landscape': 'Low',
                'Utilities': 'Medium', 'Lighting': 'Low', 'Pavement': 'Low',
                'Bridges': 'High', 'H&H': 'Medium', 'Communications': 'Low',
                'Architecture': 'Medium', 'Systems': 'Medium'
            },
            'Highway/Roadway': {
                'Structures': 'Medium', 'Design PM': 'High', 'Civil': 'High',
                'Drainage': 'High', 'Electrical': 'Medium', 'Environmental': 'Medium',
                'Traffic': 'High', 'ITS': 'Medium', 'Mechanical': 'Low',
                'Geotechnical': 'Medium', 'Survey': 'High', 'Landscape': 'Medium',
                'Utilities': 'High', 'Lighting': 'Medium', 'Pavement': 'High',
                'Bridges': 'Medium', 'H&H': 'High', 'Communications': 'Medium',
                'Architecture': 'Low', 'Systems': 'Medium'
            },
            'Drainage/Utilities': {
                'Structures': 'Low', 'Design PM': 'Medium', 'Civil': 'Medium',
                'Drainage': 'High', 'Electrical': 'Medium', 'Environmental': 'High',
                'Traffic': 'Low', 'ITS': 'Low', 'Mechanical': 'Low',
                'Geotechnical': 'Medium', 'Survey': 'Medium', 'Landscape': 'Low',
                'Utilities': 'High', 'Lighting': 'Low', 'Pavement': 'Medium',
                'Bridges': 'Low', 'H&H': 'High', 'Communications': 'Low',
                'Architecture': 'Low', 'Systems': 'Low'
            }
        };

        // Industry standard design fee distribution percentages
        const industryDistribution = {
            'Bridge': {
                'Structures': { Low: 18, Medium: 22, High: 28 },
                'Design PM': { Low: 8, Medium: 10, High: 13 },
                'Civil': { Low: 10, Medium: 12, High: 15 },
                'Drainage': { Low: 3, Medium: 5, High: 7 },
                'Electrical': { Low: 2, Medium: 3, High: 5 },
                'Environmental': { Low: 3, Medium: 4, High: 6 },
                'Traffic': { Low: 2, Medium: 3, High: 4 },
                'ITS': { Low: 1, Medium: 2, High: 3 },
                'Mechanical': { Low: 2, Medium: 3, High: 4 },
                'Geotechnical': { Low: 6, Medium: 8, High: 10 },
                'Survey': { Low: 3, Medium: 4, High: 5 },
                'Landscape': { Low: 1, Medium: 2, High: 3 },
                'Utilities': { Low: 2, Medium: 3, High: 4 },
                'Lighting': { Low: 1, Medium: 2, High: 3 },
                'Pavement': { Low: 2, Medium: 3, High: 4 },
                'Bridges': { Low: 18, Medium: 22, High: 28 },
                'H&H': { Low: 4, Medium: 6, High: 8 },
                'Communications': { Low: 2, Medium: 3, High: 4 },
                'Architecture': { Low: 3, Medium: 4, High: 6 },
                'Systems': { Low: 3, Medium: 5, High: 7 }
            },
            'Highway/Roadway': {
                'Structures': { Low: 10, Medium: 15, High: 20 },
                'Design PM': { Low: 10, Medium: 12, High: 15 },
                'Civil': { Low: 15, Medium: 18, High: 22 },
                'Drainage': { Low: 8, Medium: 10, High: 12 },
                'Electrical': { Low: 4, Medium: 6, High: 8 },
                'Environmental': { Low: 4, Medium: 5, High: 7 },
                'Traffic': { Low: 8, Medium: 10, High: 12 },
                'ITS': { Low: 3, Medium: 5, High: 7 },
                'Mechanical': { Low: 2, Medium: 3, High: 4 },
                'Geotechnical': { Low: 4, Medium: 6, High: 8 },
                'Survey': { Low: 5, Medium: 7, High: 9 },
                'Landscape': { Low: 3, Medium: 4, High: 6 },
                'Utilities': { Low: 6, Medium: 8, High: 10 },
                'Lighting': { Low: 3, Medium: 4, High: 6 },
                'Pavement': { Low: 10, Medium: 12, High: 15 },
                'Bridges': { Low: 8, Medium: 10, High: 12 },
                'H&H': { Low: 6, Medium: 8, High: 10 },
                'Communications': { Low: 3, Medium: 4, High: 6 },
                'Architecture': { Low: 2, Medium: 3, High: 4 },
                'Systems': { Low: 4, Medium: 5, High: 7 }
            },
            'Drainage/Utilities': {
                'Structures': { Low: 5, Medium: 8, High: 10 },
                'Design PM': { Low: 8, Medium: 10, High: 12 },
                'Civil': { Low: 12, Medium: 15, High: 18 },
                'Drainage': { Low: 18, Medium: 22, High: 26 },
                'Electrical': { Low: 4, Medium: 6, High: 8 },
                'Environmental': { Low: 8, Medium: 10, High: 14 },
                'Traffic': { Low: 2, Medium: 3, High: 4 },
                'ITS': { Low: 1, Medium: 2, High: 3 },
                'Mechanical': { Low: 2, Medium: 3, High: 4 },
                'Geotechnical': { Low: 5, Medium: 7, High: 9 },
                'Survey': { Low: 4, Medium: 6, High: 8 },
                'Landscape': { Low: 2, Medium: 3, High: 4 },
                'Utilities': { Low: 16, Medium: 20, High: 24 },
                'Lighting': { Low: 2, Medium: 3, High: 4 },
                'Pavement': { Low: 6, Medium: 8, High: 10 },
                'Bridges': { Low: 4, Medium: 6, High: 8 },
                'H&H': { Low: 8, Medium: 10, High: 12 },
                'Communications': { Low: 2, Medium: 3, High: 4 },
                'Architecture': { Low: 1, Medium: 2, High: 3 },
                'Systems': { Low: 3, Medium: 4, High: 5 }
            }
        };

        // Industry benchmark ranges for variance indicators
        const industryBenchmarks = {
            'Bridge': {
                'Structures': { min: 0.18, max: 0.30, typical: 0.24 },
                'Design PM': { min: 0.08, max: 0.15, typical: 0.11 },
                'Civil': { min: 0.10, max: 0.16, typical: 0.13 },
                'Geotechnical': { min: 0.06, max: 0.12, typical: 0.09 }
            },
            'Highway/Roadway': {
                'Structures': { min: 0.10, max: 0.22, typical: 0.16 },
                'Design PM': { min: 0.10, max: 0.16, typical: 0.13 },
                'Civil': { min: 0.15, max: 0.24, typical: 0.19 },
                'Drainage': { min: 0.08, max: 0.14, typical: 0.11 },
                'Traffic': { min: 0.08, max: 0.14, typical: 0.11 },
                'Pavement': { min: 0.10, max: 0.17, typical: 0.13 }
            },
            'Drainage/Utilities': {
                'Structures': { min: 0.05, max: 0.12, typical: 0.08 },
                'Design PM': { min: 0.08, max: 0.13, typical: 0.10 },
                'Drainage': { min: 0.18, max: 0.28, typical: 0.23 },
                'Utilities': { min: 0.16, max: 0.26, typical: 0.21 },
                'Environmental': { min: 0.08, max: 0.16, typical: 0.12 }
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initDisciplines();
            updateStatus('READY');
            
            // Check for saved data after a brief delay to let UI initialize
            setTimeout(checkForSavedData, 500);
            
            // Set up input listeners for autosave
            setupAutosaveListeners();
        });

        /**
         * Sets up event listeners for autosave on all inputs
         */
        function setupAutosaveListeners() {
            // Listen for input changes on form fields
            document.querySelectorAll('input, select, textarea').forEach(el => {
                el.addEventListener('change', triggerAutosave);
                el.addEventListener('input', triggerAutosave);
            });
            
            // Listen for discipline grid clicks
            const discGrid = document.getElementById('disciplines-grid');
            if (discGrid) {
                discGrid.addEventListener('click', () => setTimeout(triggerAutosave, 100));
            }
        }

        /**
         * Updates the status indicator in the terminal header
         * @param {string} text - Status text to display
         */
        function updateStatus(text) {
            document.getElementById('status-text').textContent = text;
        }

        /**
         * Initializes the discipline selection grid with all available disciplines
         */
        function initDisciplines() {
            const grid = document.getElementById('disciplines-grid');
            grid.innerHTML = allDisciplines.map(d => 
                `<div class="disc-item ${d.selected ? 'selected' : ''}" onclick="toggleDisc(this)" data-name="${d.name}">${d.name}</div>`
            ).join('');
            updateSelectedCount();
        }

        /**
         * Toggles the selection state of a discipline item
         * @param {HTMLElement} el - The discipline element to toggle
         */
        function toggleDisc(el) {
            el.classList.toggle('selected');
            updateSelectedCount();
        }

        /**
         * Selects all disciplines in the grid
         */
        function selectAllDisciplines() {
            document.querySelectorAll('.disc-item').forEach(el => el.classList.add('selected'));
            updateSelectedCount();
        }

        /**
         * Updates the selected discipline count display
         */
        function updateSelectedCount() {
            const count = document.querySelectorAll('.disc-item.selected').length;
            document.getElementById('selected-count').textContent = count;
        }

        /**
         * Adds a custom discipline to the grid from the input field
         */
        function addCustomDiscipline() {
            const input = document.getElementById('custom-discipline');
            const name = input.value.trim();
            if (name) {
                const grid = document.getElementById('disciplines-grid');
                grid.innerHTML += `<div class="disc-item selected" onclick="toggleDisc(this)" data-name="${name}">${name}</div>`;
                exampleBudgets[name] = 100000;
                input.value = '';
                updateSelectedCount();
            }
        }

        /**
         * Adds a phase to the phases input if not already present
         * @param {string} phase - Phase name to add
         */
        function addQuickPhase(phase) {
            const input = document.getElementById('phases-input');
            const phases = input.value.split(',').map(p => p.trim()).filter(p => p);
            if (!phases.includes(phase)) {
                phases.push(phase);
                input.value = phases.join(', ');
            }
        }

        /**
         * Adds a package to the packages input if not already present
         * @param {string} pkg - Package name to add
         */
        function addQuickPackage(pkg) {
            const input = document.getElementById('packages-input');
            const packages = input.value.split(',').map(p => p.trim()).filter(p => p);
            if (!packages.includes(pkg)) {
                packages.push(pkg);
                input.value = packages.join(', ');
            }
        }

        /**
         * Updates the progress bar visual state based on current step
         */
        function updateProgress() {
            document.querySelectorAll('.progress-step').forEach((el, i) => {
                el.classList.remove('active', 'completed');
                if (i + 1 < currentStep) el.classList.add('completed');
                if (i + 1 === currentStep) el.classList.add('active');
            });
        }

        /**
         * Shows the specified wizard step and updates navigation buttons
         * @param {number} step - Step number (1-6)
         */
        function showStep(step) {
            document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`step${step}`).classList.remove('hidden');
            
            document.getElementById('prev-btn').classList.toggle('hidden', step === 1);
            document.getElementById('next-btn').classList.toggle('hidden', step === 6);
            document.getElementById('generate-btn').classList.toggle('hidden', step !== 6);
            
            updateProgress();
            updateStatus(`STEP ${step}/6`);
        }

        /**
         * Navigates to a previous step in the wizard (backward navigation only)
         * @param {number} step - Step number to navigate to
         */
        function goToStep(step) {
            if (step < currentStep) {
                saveCurrentStep();
                currentStep = step;
                showStep(step);
            }
        }

        /**
         * Saves data from the current wizard step to projectData object
         */
        function saveCurrentStep() {
            switch(currentStep) {
                case 1:
                    projectData.phases = document.getElementById('phases-input').value.split(',').map(p => p.trim()).filter(p => p);
                    break;
                case 2:
                    projectData.disciplines = Array.from(document.querySelectorAll('.disc-item.selected')).map(el => el.dataset.name);
                    break;
                case 3:
                    projectData.packages = document.getElementById('packages-input').value.split(',').map(p => p.trim()).filter(p => p);
                    break;
                case 4:
                    document.querySelectorAll('.budget-input').forEach(input => {
                        // Remove commas before parsing
                        const value = parseFloat(input.value.replace(/,/g, '')) || 0;
                        projectData.budgets[input.dataset.disc] = value;
                    });
                    break;
                case 5:
                    document.querySelectorAll('.claiming-input').forEach(input => {
                        projectData.claiming[input.dataset.key] = parseFloat(input.value) || 0;
                    });
                    break;
                case 6:
                    document.querySelectorAll('.date-start').forEach(input => {
                        const key = input.dataset.key;
                        const endInput = document.querySelector(`.date-end[data-key="${key}"]`);
                        projectData.dates[key] = { start: input.value, end: endInput.value };
                    });
                    break;
            }
            
            // Trigger autosave after any step save
            triggerAutosave();
        }

        /**
         * Validates the current wizard step before allowing progression
         * @returns {boolean} True if validation passes, false otherwise
         */
        function validate() {
            switch(currentStep) {
                case 1:
                    if (!document.getElementById('phases-input').value.trim()) {
                        alert('Enter at least one phase.');
                        return false;
                    }
                    break;
                case 2:
                    if (document.querySelectorAll('.disc-item.selected').length === 0) {
                        alert('Select at least one discipline.');
                        return false;
                    }
                    break;
                case 3:
                    if (!document.getElementById('packages-input').value.trim()) {
                        alert('Enter at least one package.');
                        return false;
                    }
                    break;
            }
            return true;
        }

        /**
         * Advances to the next wizard step after validation
         */
        function nextStep() {
            if (!validate()) return;
            saveCurrentStep();
            
            if (currentStep < 6) {
                currentStep++;
                showStep(currentStep);
                
                if (currentStep === 4) buildBudgetTable();
                if (currentStep === 5) buildClaimingTable();
                if (currentStep === 6) buildDatesTable();
            }
        }

        /**
         * Returns to the previous wizard step
         */
        function prevStep() {
            saveCurrentStep();
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
            }
        }

        /**
         * Builds the budget input table for Step 4
         * Generates rows for each selected discipline with budget inputs and industry indicators
         */
        function buildBudgetTable() {
            const table = document.getElementById('budget-table');
            let html = `
                <thead>
                    <tr>
                        <th>DISCIPLINE</th>
                        <th style="text-align: right; width: 200px;">TOTAL BUDGET</th>
                        <th style="text-align: center; width: 40px;">IND</th>
                    </tr>
                </thead>
                <tbody>
            `;

            projectData.disciplines.forEach(disc => {
                const budget = projectData.budgets[disc] || exampleBudgets[disc] || 100000;
                const formattedBudget = Math.round(budget).toLocaleString('en-US', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                });
                html += `
                    <tr data-disc="${disc}">
                        <td>${disc}</td>
                        <td>
                            <input type="text" class="table-input budget-input" data-disc="${disc}" value="${formattedBudget}">
                        </td>
                        <td class="indicator-cell" style="text-align: center;"></td>
                    </tr>
                `;
            });

            html += '</tbody>';
            table.innerHTML = html;

            // Add input listeners with manual edit tracking and formatting
            document.querySelectorAll('.budget-input').forEach(input => {
                // Validate input to only allow numbers and commas
                input.addEventListener('keydown', function(event) {
                    const allowedKeys = ['Backspace', 'Delete', 'Tab', 'Escape', 'Enter', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'];
                    if (allowedKeys.includes(event.key)) {
                        return;
                    }
                    if (event.ctrlKey || event.metaKey) {
                        if (['a', 'c', 'v', 'x'].includes(event.key.toLowerCase())) {
                            return;
                        }
                    }
                    if (!/[\d,]/.test(event.key)) {
                        event.preventDefault();
                    }
                });
                
                // Format on blur
                input.addEventListener('blur', function() {
                    const value = parseFloat(this.value.replace(/,/g, '')) || 0;
                    if (value > 0) {
                        this.value = Math.round(value).toLocaleString('en-US', {
                            minimumFractionDigits: 0,
                            maximumFractionDigits: 0
                        });
                    } else {
                        this.value = '';
                    }
                });
                
                // Remove formatting on focus for easier editing
                input.addEventListener('focus', function() {
                    const value = parseFloat(this.value.replace(/,/g, '')) || 0;
                    this.value = value > 0 ? value.toString() : '';
                });
                
                // Track manual edits and update total
                input.addEventListener('input', function() {
                    // Mark as manually edited
                    projectData.calculator.manualEdits[this.dataset.disc] = true;
                    updateTotalBudget();
                });
            });

            // Initialize calculator if first time
            if (!projectData.calculator.isCalculated) {
                initCalculator();
            } else {
                // Re-populate calculator values
                const costInput = document.getElementById('calc-construction-cost');
                const cost = projectData.calculator.totalConstructionCost || 0;
                costInput.value = cost > 0 ? Math.round(cost).toLocaleString('en-US', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }) : '';
                document.getElementById('calc-design-fee-pct').value = projectData.calculator.designFeePercent;
                document.getElementById('calc-project-type').value = projectData.calculator.projectType;
                
                // Re-initialize calculator to set up event listeners
                initCalculator();
                updateIndustryIndicators();
            }

            updateTotalBudget();
        }

        /**
         * Updates the total budget display and triggers industry indicator updates if needed
         */
        function updateTotalBudget() {
            let total = 0;
            document.querySelectorAll('.budget-input').forEach(input => {
                // Remove commas before parsing
                const value = parseFloat(input.value.replace(/,/g, '')) || 0;
                total += value;
            });
            document.getElementById('total-budget').textContent = formatCurrency(total);

            // Update indicators if calculation was performed
            if (projectData.calculator.isCalculated) {
                updateIndustryIndicators();
            }
        }

        // Calculator Functions
        
        /**
         * Toggles the calculator section expand/collapse state
         */
        function toggleCalculator() {
            const body = document.getElementById('calculator-body');
            const header = document.querySelector('.calculator-header span:first-child');

            if (body.classList.contains('collapsed')) {
                body.classList.remove('collapsed');
                header.textContent = ' COST ESTIMATOR';
            } else {
                body.classList.add('collapsed');
                header.textContent = ' COST ESTIMATOR';
            }
        }

        function showComplexityOverrides() {
            const overrideSection = document.getElementById('complexity-overrides');

            if (overrideSection.classList.contains('hidden')) {
                buildComplexityOverrideGrid();
                overrideSection.classList.remove('hidden');
            } else {
                overrideSection.classList.add('hidden');
            }
        }

        function buildComplexityOverrideGrid() {
            const grid = document.getElementById('complexity-grid');
            const projectType = document.getElementById('calc-project-type').value;

            let html = '';
            projectData.disciplines.forEach(disc => {
                const autoComplexity = projectComplexityMap[projectType][disc] || 'Medium';
                const savedOverride = projectData.calculator.complexityOverrides[disc];
                const currentValue = savedOverride || autoComplexity;

                html += `
                    <div class="complexity-item">
                        <label>${disc}</label>
                        <select class="complexity-override" data-disc="${disc}" onchange="saveComplexityOverride(this)">
                            <option value="Low" ${currentValue === 'Low' ? 'selected' : ''}>Low</option>
                            <option value="Medium" ${currentValue === 'Medium' ? 'selected' : ''}>Medium</option>
                            <option value="High" ${currentValue === 'High' ? 'selected' : ''}>High</option>
                        </select>
                        ${savedOverride ? '<span style="color: #ffd700;">*</span>' : ''}
                    </div>
                `;
            });

            grid.innerHTML = html;
        }

        function saveComplexityOverride(selectEl) {
            const disc = selectEl.dataset.disc;
            const value = selectEl.value;
            const projectType = document.getElementById('calc-project-type').value;
            const autoValue = projectComplexityMap[projectType][disc];

            // Only save if different from auto-assigned
            if (value !== autoValue) {
                projectData.calculator.complexityOverrides[disc] = value;
            } else {
                delete projectData.calculator.complexityOverrides[disc];
            }
        }

        function updateComplexityDefaults() {
            // Clear overrides when project type changes
            projectData.calculator.complexityOverrides = {};

            // Rebuild override grid if visible
            const overrideSection = document.getElementById('complexity-overrides');
            if (!overrideSection.classList.contains('hidden')) {
                buildComplexityOverrideGrid();
            }

            // Recalculate total design fee
            updateCalculatorTotal();
        }

        /**
         * Calculates and displays the total design fee based on construction cost and design fee percentage
         */
        function updateCalculatorTotal() {
            const costInput = document.getElementById('calc-construction-cost');
            // Remove commas before parsing
            const constructionCost = parseFloat(costInput.value.replace(/,/g, '')) || 0;
            const designFeePct = parseFloat(document.getElementById('calc-design-fee-pct').value) || 0;
            const totalFee = constructionCost * (designFeePct / 100);

            document.getElementById('calc-total-fee').textContent = formatCurrency(totalFee);
            projectData.calculator.totalConstructionCost = constructionCost;
            projectData.calculator.designFeePercent = designFeePct;
            projectData.calculator.totalDesignFee = totalFee;
        }

        /**
         * Formats construction cost input with commas on blur
         */
        function formatConstructionCostInput(event) {
            const input = event ? event.target : document.getElementById('calc-construction-cost');
            const value = parseFloat(input.value.replace(/,/g, '')) || 0;
            if (value > 0) {
                input.value = Math.round(value).toLocaleString('en-US', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                });
            } else {
                input.value = '';
            }
        }

        /**
         * Removes formatting from construction cost input on focus for easier editing
         */
        function unformatConstructionCostInput(event) {
            const input = event ? event.target : document.getElementById('calc-construction-cost');
            const value = parseFloat(input.value.replace(/,/g, '')) || 0;
            input.value = value > 0 ? value.toString() : '';
        }

        /**
         * Validates construction cost input to only allow numbers and commas
         */
        function validateConstructionCostInput(event) {
            const input = event.target;
            // Allow: numbers, commas, backspace, delete, tab, escape, enter, and arrow keys
            const allowedKeys = ['Backspace', 'Delete', 'Tab', 'Escape', 'Enter', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'];
            if (allowedKeys.includes(event.key)) {
                return;
            }
            // Allow Ctrl/Cmd + A, C, V, X
            if (event.ctrlKey || event.metaKey) {
                if (['a', 'c', 'v', 'x'].includes(event.key.toLowerCase())) {
                    return;
                }
            }
            // Only allow numbers and commas
            if (!/[\d,]/.test(event.key)) {
                event.preventDefault();
            }
        }

        /**
         * Initializes calculator event listeners for real-time total updates
         */
        function initCalculator() {
            const costInput = document.getElementById('calc-construction-cost');
            
            // Add event listeners (check if already initialized to prevent duplicates)
            if (!costInput.dataset.initialized) {
                costInput.addEventListener('input', () => {
                    updateCalculatorTotal();
                });
                costInput.addEventListener('blur', formatConstructionCostInput);
                costInput.addEventListener('focus', unformatConstructionCostInput);
                costInput.addEventListener('keydown', validateConstructionCostInput);
                costInput.dataset.initialized = 'true';
            }
            
            // Format initial value if present
            if (costInput.value && parseFloat(costInput.value.replace(/,/g, '')) > 0) {
                const value = parseFloat(costInput.value.replace(/,/g, '')) || 0;
                if (value > 0) {
                    costInput.value = Math.round(value).toLocaleString('en-US', {
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 0
                    });
                }
            }
            
            const feeInput = document.getElementById('calc-design-fee-pct');
            if (!feeInput.dataset.initialized) {
                feeInput.addEventListener('input', updateCalculatorTotal);
                feeInput.dataset.initialized = 'true';
            }
            
            updateCalculatorTotal();
        }

        /**
         * Validates calculator inputs before budget calculation
         * @param {number} constructionCost - Total construction cost
         * @param {number} designFeePct - Design fee percentage
         * @returns {boolean} True if validation passes
         */
        function validateCalculatorInputs(constructionCost, designFeePct) {
            if (!constructionCost || constructionCost <= 0) {
                alert('Enter a valid construction cost.');
                return false;
            }
            if (!designFeePct || designFeePct <= 0 || designFeePct > 30) {
                alert('Design fee must be between 1% and 30%.');
                return false;
            }
            return true;
        }

        /**
         * Calculates raw industry distribution percentages for selected disciplines
         * @param {string} projectType - Project type (Bridge, Highway/Roadway, Drainage/Utilities)
         * @param {Array<string>} disciplines - Selected disciplines
         * @returns {{percentages: Object, total: number}} Raw percentages and total
         */
        function calculateRawPercentages(projectType, disciplines) {
            const rawPercentages = {};
            let totalRawPercentage = 0;

            disciplines.forEach(discipline => {
                // Get complexity (override or auto-assigned)
                const complexity = projectData.calculator.complexityOverrides[discipline] ||
                    projectComplexityMap[projectType][discipline] ||
                    'Medium';

                // Get industry percentage
                const distribution = industryDistribution[projectType];
                const percentage = distribution[discipline] ? distribution[discipline][complexity] : 5;

                rawPercentages[discipline] = percentage;
                totalRawPercentage += percentage;
            });

            return { percentages: rawPercentages, total: totalRawPercentage };
        }

        /**
         * Normalizes raw percentages to sum to 100% and calculates budgets
         * @param {Object} rawPercentages - Raw percentage values per discipline
         * @param {number} totalRawPercentage - Sum of raw percentages
         * @param {number} totalDesignFee - Total design fee amount
         * @param {Array<string>} disciplines - Selected disciplines
         * @returns {Object} Normalized budget amounts per discipline
         */
        function normalizeBudgets(rawPercentages, totalRawPercentage, totalDesignFee, disciplines) {
            const normalizedBudgets = {};
            disciplines.forEach(discipline => {
                const normalizedPct = (rawPercentages[discipline] / totalRawPercentage) * 100;
                normalizedBudgets[discipline] = totalDesignFee * (normalizedPct / 100);
            });
            return normalizedBudgets;
        }

        /**
         * Applies calculated budgets to the budget table inputs
         * @param {Object} normalizedBudgets - Budget amounts per discipline
         * @param {Array<string>} disciplines - Selected disciplines
         */
        function applyBudgetsToTable(normalizedBudgets, disciplines) {
            disciplines.forEach(discipline => {
                const input = document.querySelector(`.budget-input[data-disc="${discipline}"]`);
                if (input && !projectData.calculator.manualEdits[discipline]) {
                    const rounded = Math.round(normalizedBudgets[discipline]);
                    // Format with commas
                    input.value = rounded.toLocaleString('en-US', {
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 0
                    });
                    projectData.budgets[discipline] = normalizedBudgets[discipline];
                }
            });
        }

        /**
         * Updates calculator UI after successful calculation
         * @param {string} projectType - Project type used in calculation
         */
        function updateCalculatorUI(projectType) {
            projectData.calculator.isCalculated = true;
            projectData.calculator.projectType = projectType;

            // Collapse calculator and update status
            document.getElementById('calculator-body').classList.add('collapsed');
            document.querySelector('.calculator-header span:first-child').textContent = ' COST ESTIMATOR';
            document.getElementById('calculator-status').textContent = 'Estimates applied  Click to edit';
            document.getElementById('calculator-status').style.color = '#00ff00';

            updateTotalBudget();
            updateIndustryIndicators();
            updateStatus('BUDGETS CALCULATED');
        }

        /**
         * Main function to calculate discipline budgets based on construction cost and industry standards
         * Validates inputs, calculates normalized budgets, and updates the UI
         */
        function calculateBudgets() {
            const costInput = document.getElementById('calc-construction-cost');
            // Remove commas before parsing
            const constructionCost = parseFloat(costInput.value.replace(/,/g, ''));
            const designFeePct = parseFloat(document.getElementById('calc-design-fee-pct').value);
            const projectType = document.getElementById('calc-project-type').value;

            // Validate inputs
            if (!validateCalculatorInputs(constructionCost, designFeePct)) {
                return;
            }

            const totalDesignFee = constructionCost * (designFeePct / 100);
            const selectedDisciplines = projectData.disciplines;

            // Calculate raw percentages
            const { percentages: rawPercentages, total: totalRawPercentage } = 
                calculateRawPercentages(projectType, selectedDisciplines);

            // Normalize and calculate budgets
            const normalizedBudgets = normalizeBudgets(
                rawPercentages, 
                totalRawPercentage, 
                totalDesignFee, 
                selectedDisciplines
            );

            // Apply to table
            applyBudgetsToTable(normalizedBudgets, selectedDisciplines);

            // Update UI
            updateCalculatorUI(projectType);
        }

        function updateIndustryIndicators() {
            if (!projectData.calculator.isCalculated) return;

            const totalBudget = Object.values(projectData.budgets).reduce((sum, val) => sum + val, 0);
            const projectType = projectData.calculator.projectType;

            projectData.disciplines.forEach(disc => {
                const budget = projectData.budgets[disc] || 0;
                const ratio = budget / totalBudget;

                // Get industry benchmark (if exists)
                const benchmark = industryBenchmarks[projectType] && industryBenchmarks[projectType][disc];

                if (!benchmark) {
                    // No benchmark available, use neutral indicator
                    const cell = document.querySelector(`tr[data-disc="${disc}"] .indicator-cell`);
                    if (cell) cell.innerHTML = '<span class="industry-indicator within"></span>';
                    return;
                }

                // Determine variance
                let indicator = '';
                let variance = 0;

                if (ratio > benchmark.max) {
                    variance = ((ratio - benchmark.typical) / benchmark.typical * 100).toFixed(1);
                    indicator = `
                        <span class="industry-indicator above tooltip">
                            <span class="tooltiptext">
                                Above industry range<br>
                                Your ratio: ${(ratio * 100).toFixed(1)}%<br>
                                Industry range: ${(benchmark.min * 100).toFixed(1)}% - ${(benchmark.max * 100).toFixed(1)}%<br>
                                Variance: +${variance}%
                            </span>
                        </span>
                    `;
                } else if (ratio < benchmark.min) {
                    variance = ((benchmark.typical - ratio) / benchmark.typical * 100).toFixed(1);
                    indicator = `
                        <span class="industry-indicator below tooltip">
                            <span class="tooltiptext">
                                Below industry range<br>
                                Your ratio: ${(ratio * 100).toFixed(1)}%<br>
                                Industry range: ${(benchmark.min * 100).toFixed(1)}% - ${(benchmark.max * 100).toFixed(1)}%<br>
                                Variance: -${variance}%
                            </span>
                        </span>
                    `;
                } else {
                    indicator = `
                        <span class="industry-indicator within tooltip">
                            <span class="tooltiptext">
                                Within industry range<br>
                                Your ratio: ${(ratio * 100).toFixed(1)}%<br>
                                Industry range: ${(benchmark.min * 100).toFixed(1)}% - ${(benchmark.max * 100).toFixed(1)}%
                            </span>
                        </span>
                    `;
                }

                const cell = document.querySelector(`tr[data-disc="${disc}"] .indicator-cell`);
                if (cell) cell.innerHTML = indicator;
            });
        }

        /**
         * Builds the claiming percentage table for Step 5
         * Generates a grid of inputs for each discipline-package combination
         */
        function buildClaimingTable() {
            const table = document.getElementById('claiming-table');
            const numPkgs = projectData.packages.length;
            
            let html = `
                <thead>
                    <tr>
                        <th>DISCIPLINE</th>
                        ${projectData.packages.map(p => `<th style="text-align: center;">${p}</th>`).join('')}
                        <th style="text-align: center;">TOTAL</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            projectData.disciplines.forEach(disc => {
                html += `<tr><td>${disc}</td>`;
                
                projectData.packages.forEach((pkg, i) => {
                    const key = `${disc}-${pkg}`;
                    const defaultVal = defaultClaiming[i] || Math.floor(100 / numPkgs);
                    const val = projectData.claiming[key] !== undefined ? projectData.claiming[key] : defaultVal;
                    
                    html += `
                        <td style="text-align: center;">
                            <input type="number" class="table-input claiming-input" style="text-align: center; width: 60px;" 
                                data-key="${key}" data-disc="${disc}" value="${val}" min="0" max="100">%
                        </td>
                    `;
                });
                
                html += `<td class="claiming-total" data-disc="${disc}" style="text-align: center;">0%</td></tr>`;
            });
            
            html += '</tbody>';
            table.innerHTML = html;
            
            document.querySelectorAll('.claiming-input').forEach(input => {
                input.addEventListener('input', updateClaimingTotals);
            });
            updateClaimingTotals();
        }

        /**
         * Updates claiming percentage totals for each discipline and validates they sum to 100%
         */
        function updateClaimingTotals() {
            projectData.disciplines.forEach(disc => {
                let total = 0;
                document.querySelectorAll(`.claiming-input[data-disc="${disc}"]`).forEach(input => {
                    total += parseFloat(input.value) || 0;
                });

                const cell = document.querySelector(`.claiming-total[data-disc="${disc}"]`);
                cell.textContent = total + '%';
                cell.className = `claiming-total ${total === 100 ? 'status-ok' : 'status-err'}`;
            });
        }

        // ============ CLAIMING PRESET FUNCTIONS ============

        // Normalize array to sum to 100%
        function normalizeToHundred(arr) {
            const sum = arr.reduce((a, b) => a + b, 0);
            if (sum === 0) return arr;

            const normalized = arr.map(val => (val / sum) * 100);
            const rounded = normalized.map(val => Math.round(val));

            // Adjust for rounding errors
            const roundedSum = rounded.reduce((a, b) => a + b, 0);
            if (roundedSum !== 100) {
                const diff = 100 - roundedSum;
                const maxIndex = rounded.indexOf(Math.max(...rounded));
                rounded[maxIndex] += diff;
            }

            return rounded;
        }

        // Linear/Even distribution
        function distributeEvenly(count) {
            if (count <= 0) return [];
            const base = Math.floor(100 / count);
            const remainder = 100 - (base * count);
            const result = new Array(count).fill(base);
            result[result.length - 1] += remainder;
            return result;
        }

        // Front-Loaded (descending) pattern
        function createDescendingPattern(count) {
            if (count === 1) return [100];
            if (count === 2) return [60, 40];

            const maxVal = 30;
            const minVal = 10;
            const step = (maxVal - minVal) / (count - 1);

            const result = [];
            for (let i = 0; i < count; i++) {
                result.push(maxVal - (step * i));
            }

            return normalizeToHundred(result);
        }

        // Back-Loaded (ascending) pattern
        function createAscendingPattern(count) {
            if (count === 1) return [100];
            if (count === 2) return [40, 60];

            const minVal = 10;
            const maxVal = 30;
            const step = (maxVal - minVal) / (count - 1);

            const result = [];
            for (let i = 0; i < count; i++) {
                result.push(minVal + (step * i));
            }

            return normalizeToHundred(result);
        }

        // Bell Curve pattern
        function createBellPattern(count) {
            if (count === 1) return [100];
            if (count === 2) return [50, 50];
            if (count === 3) return [25, 50, 25];

            const result = [];
            const midpoint = (count - 1) / 2;
            const peakValue = 40;
            const edgeValue = 8;

            for (let i = 0; i < count; i++) {
                const distanceFromMid = Math.abs(i - midpoint);
                const maxDistance = midpoint;
                const ratio = 1 - (distanceFromMid / maxDistance);
                const value = edgeValue + (ratio * (peakValue - edgeValue));
                result.push(value);
            }

            return normalizeToHundred(result);
        }

        // Adjust scheme to package count
        function adjustSchemeToPackageCount(schemeKey, packageCount) {
            if (packageCount <= 0) return [];

            const scheme = claimingSchemes[schemeKey];
            if (!scheme) return [];

            switch (scheme.pattern) {
                case 'equal':
                    return distributeEvenly(packageCount);
                case 'descending':
                    return createDescendingPattern(packageCount);
                case 'ascending':
                    return createAscendingPattern(packageCount);
                case 'bell':
                    return createBellPattern(packageCount);
                default:
                    return distributeEvenly(packageCount);
            }
        }

        // Toggle claiming presets panel
        function toggleClaimingPresets() {
            const body = document.getElementById('preset-body');
            const header = document.querySelector('.preset-header span:first-child');

            if (body.classList.contains('hidden')) {
                body.classList.remove('hidden');
                header.textContent = ' SCHEME PRESETS';
            } else {
                body.classList.add('hidden');
                header.textContent = ' SCHEME PRESETS';
            }
        }

        // Get selected scheme from radio buttons
        function getSelectedScheme() {
            const selected = document.querySelector('input[name="claiming-scheme"]:checked');
            return selected ? selected.value : null;
        }

        // Preview scheme percentages
        function previewScheme() {
            const schemeKey = getSelectedScheme();
            if (!schemeKey) {
                alert('Please select a claiming scheme first.');
                return;
            }

            const packageCount = projectData.packages.length;
            if (packageCount === 0) {
                alert('Please add packages first (Step 3).');
                return;
            }

            const percentages = adjustSchemeToPackageCount(schemeKey, packageCount);
            const scheme = claimingSchemes[schemeKey];

            const previewDiv = document.getElementById('preview-display');
            let previewHTML = `<strong>Preview: ${scheme.name}</strong><br>`;

            projectData.packages.forEach((pkg, i) => {
                previewHTML += `${pkg}: <strong>${percentages[i]}%</strong>`;
                if (i < projectData.packages.length - 1) {
                    previewHTML += ' | ';
                }
            });

            const total = percentages.reduce((a, b) => a + b, 0);
            previewHTML += `<br>Total: <strong style="color: ${total === 100 ? '#00ff00' : '#ff4444'}">${total}%</strong>`;

            previewDiv.innerHTML = previewHTML;
            previewDiv.classList.remove('hidden');
        }

        // Apply claiming scheme to all disciplines
        function applyClaimingScheme() {
            const schemeKey = getSelectedScheme();
            if (!schemeKey) {
                alert('Please select a claiming scheme first.');
                return;
            }

            if (projectData.disciplines.length === 0) {
                alert('Please add disciplines first (Step 2).');
                return;
            }

            if (projectData.packages.length === 0) {
                alert('Please add packages first (Step 3).');
                return;
            }

            const packageCount = projectData.packages.length;
            const percentages = adjustSchemeToPackageCount(schemeKey, packageCount);
            const scheme = claimingSchemes[schemeKey];

            // Apply to all disciplines
            projectData.disciplines.forEach(disc => {
                percentages.forEach((pct, i) => {
                    const pkg = projectData.packages[i];
                    const key = `${disc}-${pkg}`;
                    projectData.claiming[key] = pct;
                });
            });

            // Update UI
            buildClaimingTable();

            // Update status
            const statusSpan = document.getElementById('preset-status');
            statusSpan.textContent = `Applied: ${scheme.name}`;
            statusSpan.style.color = '#00ff00';

            // Collapse panel
            const body = document.getElementById('preset-body');
            const header = document.querySelector('.preset-header span:first-child');
            body.classList.add('hidden');
            header.textContent = ' SCHEME PRESETS';

            // Clear preview
            document.getElementById('preview-display').classList.add('hidden');
        }

        /**
         * Builds the schedule dates table for Step 6
         * Generates date inputs for each discipline-package combination with duration calculation
         */
        function buildDatesTable() {
            const table = document.getElementById('dates-table');
            const today = new Date();
            const fmt = d => d.toISOString().split('T')[0];
            
            let html = `
                <thead>
                    <tr>
                        <th>DISCIPLINE</th>
                        <th>PACKAGE</th>
                        <th>START</th>
                        <th>END</th>
                        <th style="text-align: center;">DAYS</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            projectData.disciplines.forEach(disc => {
                projectData.packages.forEach((pkg, i) => {
                    const key = `${disc}-${pkg}`;
                    
                    const startDate = new Date(today);
                    startDate.setDate(startDate.getDate() + (i * 45));
                    const endDate = new Date(startDate);
                    endDate.setDate(endDate.getDate() + 42);
                    
                    const saved = projectData.dates[key] || {};
                    
                    html += `
                        <tr>
                            <td>${i === 0 ? disc : ''}</td>
                            <td style="color: #ffd700;">${pkg}</td>
                            <td><input type="date" class="table-input date-start" data-key="${key}" value="${saved.start || fmt(startDate)}"></td>
                            <td><input type="date" class="table-input date-end" data-key="${key}" value="${saved.end || fmt(endDate)}"></td>
                            <td class="duration-cell" data-key="${key}" style="text-align: center;">--</td>
                        </tr>
                    `;
                });
            });
            
            html += '</tbody>';
            table.innerHTML = html;
            
            document.querySelectorAll('.date-start, .date-end').forEach(input => {
                input.addEventListener('change', updateDurations);
            });
            updateDurations();
        }

        /**
         * Calculates and displays duration in days for each date range in the schedule table
         */
        function updateDurations() {
            document.querySelectorAll('.duration-cell').forEach(cell => {
                const key = cell.dataset.key;
                const start = document.querySelector(`.date-start[data-key="${key}"]`).value;
                const end = document.querySelector(`.date-end[data-key="${key}"]`).value;
                
                if (start && end) {
                    const days = Math.ceil((new Date(end) - new Date(start)) / (1000 * 60 * 60 * 24));
                    cell.textContent = days > 0 ? days : 'ERR';
                    cell.className = `duration-cell ${days > 0 ? 'status-ok' : 'status-err'}`;
                }
            });
        }

        function generateWBS() {
            saveCurrentStep();
            
            // Hide the wizard terminal (keeps header visible)
            document.getElementById('wizard-terminal').style.display = 'none';
            document.getElementById('results-section').classList.remove('hidden');
            
            buildWBSTable();
            populateFilters();
            createChart();
            buildGanttChart();
            updateKPIs();
            updateStatus('WBS GENERATED');
        }

        function updateKPIs() {
            let total = 0;
            let wbsCount = 0;
            let minDate = null, maxDate = null;
            
            projectData.disciplines.forEach(disc => {
                total += projectData.budgets[disc] || 0;
                wbsCount += projectData.packages.length * projectData.phases.length;
                
                projectData.packages.forEach(pkg => {
                    const d = projectData.dates[`${disc}-${pkg}`];
                    if (d) {
                        const s = new Date(d.start), e = new Date(d.end);
                        if (!minDate || s < minDate) minDate = s;
                        if (!maxDate || e > maxDate) maxDate = e;
                    }
                });
            });
            
            const months = minDate && maxDate ? Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24 * 30)) : 0;
            
            document.getElementById('kpi-budget').textContent = '$' + total.toLocaleString();
            document.getElementById('kpi-wbs').textContent = wbsCount;
            document.getElementById('kpi-disc').textContent = projectData.disciplines.length;
            document.getElementById('kpi-months').textContent = months;
        }

        // Track expanded disciplines in WBS table
        const wbsTableState = {
            expandedDisciplines: new Set()
        };

        /**
         * Generates WBS table header HTML
         * @returns {string} HTML string for table header
         */
        function generateWBSTableHeader() {
            return `
                <thead>
                    <tr>
                        <th>WBS#</th>
                        <th>PHASE</th>
                        <th>DISCIPLINE</th>
                        <th>PACKAGE</th>
                        <th style="text-align: right;">BUDGET</th>
                        <th style="text-align: center;">%</th>
                        <th>START</th>
                        <th>END</th>
                        <th style="text-align: right;">ACTUAL</th>
                        <th style="text-align: right;">VAR</th>
                    </tr>
                </thead>
            `;
        }

        /**
         * Generates a discipline summary row (parent row)
         */
        function generateWBSDisciplineRow(wbsPrefix, phase, discipline, totalBudget, startDate, endDate, phaseIndex, disciplineIndex) {
            const rowId = `wbs-disc-${phaseIndex}-${disciplineIndex}`;
            const isExpanded = wbsTableState.expandedDisciplines.has(rowId);
            return `
                <tr class="wbs-discipline-row" data-row-id="${rowId}" onclick="toggleWBSDiscipline('${rowId}')">
                    <td><span class="wbs-expand-icon ${isExpanded ? 'expanded' : ''}"></span> ${wbsPrefix}</td>
                    <td>${phase}</td>
                    <td>${discipline}</td>
                    <td style="color: #888; font-weight: 400;">${projectData.packages.length} packages</td>
                    <td style="text-align: right;">$${Math.round(totalBudget).toLocaleString()}</td>
                    <td style="text-align: center;">100%</td>
                    <td>${startDate}</td>
                    <td>${endDate}</td>
                    <td style="text-align: right; color: #666;">$0</td>
                    <td style="text-align: right; color: #00ff00;">$${Math.round(totalBudget).toLocaleString()}</td>
                </tr>
            `;
        }

        /**
         * Generates a single WBS package row (child row)
         */
        function generateWBSPackageRow(wbsNumber, phase, discipline, packageName, packageBudget, claimPercent, dates, rowId) {
            const isExpanded = wbsTableState.expandedDisciplines.has(rowId);
            return `
                <tr class="wbs-package-row ${isExpanded ? '' : 'hidden'}" data-parent="${rowId}">
                    <td style="color: #888;">${wbsNumber}</td>
                    <td style="color: #666;">${phase}</td>
                    <td style="color: #666;">${discipline}</td>
                    <td style="color: #ffd700;">${packageName}</td>
                    <td style="text-align: right;">$${Math.round(packageBudget).toLocaleString()}</td>
                    <td style="text-align: center;">${claimPercent}%</td>
                    <td>${dates.start}</td>
                    <td>${dates.end}</td>
                    <td style="text-align: right; color: #666;">$0</td>
                    <td style="text-align: right; color: #00ff00;">$${Math.round(packageBudget).toLocaleString()}</td>
                </tr>
            `;
        }

        /**
         * Generates WBS table footer with grand total
         * @param {number} grandTotal - Total budget across all WBS elements
         * @returns {string} HTML string for table footer
         */
        function generateWBSTableFooter(grandTotal) {
            return `
                <tfoot>
                    <tr>
                        <td colspan="4">GRAND TOTAL</td>
                        <td style="text-align: right;">$${Math.round(grandTotal).toLocaleString()}</td>
                        <td></td>
                        <td colspan="2"></td>
                        <td style="text-align: right;">$0</td>
                        <td style="text-align: right;">$${Math.round(grandTotal).toLocaleString()}</td>
                    </tr>
                </tfoot>
            `;
        }

        /**
         * Toggles a discipline row's expanded state
         */
        function toggleWBSDiscipline(rowId) {
            if (wbsTableState.expandedDisciplines.has(rowId)) {
                wbsTableState.expandedDisciplines.delete(rowId);
            } else {
                wbsTableState.expandedDisciplines.add(rowId);
            }
            
            // Toggle visibility of child rows
            document.querySelectorAll(`.wbs-package-row[data-parent="${rowId}"]`).forEach(row => {
                row.classList.toggle('hidden');
            });
            
            // Toggle expand icon
            const discRow = document.querySelector(`.wbs-discipline-row[data-row-id="${rowId}"]`);
            if (discRow) {
                const icon = discRow.querySelector('.wbs-expand-icon');
                icon.classList.toggle('expanded');
            }
        }

        /**
         * Expands all discipline rows in WBS table
         */
        function expandAllWBS() {
            document.querySelectorAll('.wbs-discipline-row').forEach(row => {
                const rowId = row.dataset.rowId;
                wbsTableState.expandedDisciplines.add(rowId);
            });
            document.querySelectorAll('.wbs-package-row').forEach(row => row.classList.remove('hidden'));
            document.querySelectorAll('.wbs-expand-icon').forEach(icon => icon.classList.add('expanded'));
        }

        /**
         * Collapses all discipline rows in WBS table
         */
        function collapseAllWBS() {
            wbsTableState.expandedDisciplines.clear();
            document.querySelectorAll('.wbs-package-row').forEach(row => row.classList.add('hidden'));
            document.querySelectorAll('.wbs-expand-icon').forEach(icon => icon.classList.remove('expanded'));
        }

        /**
         * Builds the complete WBS table with collapsible discipline groups
         * Generates hierarchical WBS numbering and calculates budget distribution
         */
        function buildWBSTable() {
            const table = document.getElementById('wbs-table');
            let grandTotal = 0;
            let html = generateWBSTableHeader() + '<tbody>';
            
            projectData.phases.forEach((phase, phaseIndex) => {
                projectData.disciplines.forEach((discipline, disciplineIndex) => {
                    const disciplineBudget = projectData.budgets[discipline] || 0;
                    const wbsPrefix = `${phaseIndex + 1}.${disciplineIndex + 1}`;
                    const rowId = `wbs-disc-${phaseIndex}-${disciplineIndex}`;
                    
                    // Calculate discipline date range
                    let minStart = null, maxEnd = null;
                    projectData.packages.forEach(pkg => {
                        const key = `${discipline}-${pkg}`;
                        const dates = projectData.dates[key];
                        if (dates) {
                            if (dates.start && (!minStart || dates.start < minStart)) minStart = dates.start;
                            if (dates.end && (!maxEnd || dates.end > maxEnd)) maxEnd = dates.end;
                        }
                    });
                    
                    // Add discipline summary row
                    html += generateWBSDisciplineRow(
                        wbsPrefix,
                        phase,
                        discipline,
                        disciplineBudget,
                        minStart || '-',
                        maxEnd || '-',
                        phaseIndex,
                        disciplineIndex
                    );
                    
                    // Add package rows (children)
                    projectData.packages.forEach((packageName, packageIndex) => {
                        const key = `${discipline}-${packageName}`;
                        const claimPercent = projectData.claiming[key] || 0;
                        const packageBudget = disciplineBudget * (claimPercent / 100);
                        const dates = projectData.dates[key] || { start: '-', end: '-' };
                        const wbsNumber = `${phaseIndex + 1}.${disciplineIndex + 1}.${packageIndex + 1}`;
                        
                        grandTotal += packageBudget;
                        
                        html += generateWBSPackageRow(
                            wbsNumber, 
                            phase, 
                            discipline, 
                            packageName, 
                            packageBudget, 
                            claimPercent, 
                            dates,
                            rowId
                        );
                    });
                });
            });
            
            html += '</tbody>' + generateWBSTableFooter(grandTotal);
            table.innerHTML = html;
        }

        function populateFilters() {
            document.getElementById('filter-phase').innerHTML = '<option value="all">All Phases</option>' +
                projectData.phases.map(p => `<option value="${p}">${p}</option>`).join('');
            
            document.getElementById('filter-discipline').innerHTML = '<option value="all">All Disciplines</option>' +
                projectData.disciplines.map(d => `<option value="${d}">${d}</option>`).join('');
        }

        /**
         * Creates and configures the Chart.js chart
         * Handles both line charts and stacked bar charts with percentage labels
         */
        function createChart() {
            const ctx = document.getElementById('performance-chart').getContext('2d');
            if (chart) chart.destroy();
            
            const data = getChartData();
            const type = document.getElementById('chart-type').value;
            const isStackedBar = type === 'bar' && data.datasets;
            
            // Configure chart options based on chart type
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        display: isStackedBar,
                        position: 'bottom',
                        labels: {
                            color: '#ffd700',
                            font: { size: 11 },
                            padding: 10,
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        backgroundColor: '#1a1a1a',
                        titleColor: '#ffd700',
                        bodyColor: '#fff',
                        borderColor: '#ffd700',
                        borderWidth: 1,
                        callbacks: {
                            label: (context) => {
                                const label = context.dataset.label || '';
                                const value = '$' + context.raw.toLocaleString();
                                
                                if (isStackedBar && data.totals) {
                                    const total = data.totals[context.dataIndex];
                                    const percentage = total > 0 
                                        ? ((context.raw / total) * 100).toFixed(1) 
                                        : '0.0';
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                                
                                return label + ': ' + value;
                            },
                            footer: (tooltipItems) => {
                                if (isStackedBar && data.totals) {
                                    const index = tooltipItems[0].dataIndex;
                                    return 'Total: $' + data.totals[index].toLocaleString();
                                }
                                return '';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        stacked: isStackedBar,
                        grid: { color: '#333' },
                        ticks: {
                            color: '#888',
                            callback: v => '$' + (v/1000).toFixed(0) + 'K'
                        }
                    },
                    x: {
                        stacked: isStackedBar,
                        grid: { color: '#222' },
                        ticks: { color: '#888' }
                    }
                }
            };
            
            // Store totals for percentage calculation in plugin
            let chartTotals = null;
            if (isStackedBar && data.totals) {
                chartTotals = data.totals;
            }
            
            // Configure datasets based on chart type
            let datasets;
            if (isStackedBar) {
                datasets = data.datasets;
            } else {
                datasets = [
                    {
                        label: 'PLANNED',
                        data: data.planned,
                        borderColor: '#ffd700',
                        backgroundColor: 'rgba(255, 215, 0, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3
                    },
                    {
                        label: 'ACTUAL',
                        data: data.actual,
                        borderColor: '#00ff00',
                        backgroundColor: 'rgba(0, 255, 0, 0.1)',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        fill: false,
                        tension: 0.3
                    }
                ];
            }
            
            chart = new Chart(ctx, {
                type: type,
                data: {
                    labels: data.labels,
                    datasets: datasets
                },
                options: chartOptions,
                plugins: isStackedBar ? [{
                    id: 'percentageLabels',
                    afterDatasetsDraw: (chart) => {
                        if (!chartTotals) return;
                        
                        const ctx = chart.ctx;
                        
                        chart.data.datasets.forEach((dataset, datasetIndex) => {
                            const meta = chart.getDatasetMeta(datasetIndex);
                            meta.data.forEach((bar, index) => {
                                const value = dataset.data[index];
                                const total = chartTotals[index];
                                
                                if (total > 0 && value > 0) {
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    
                                    // Only show label if segment is large enough (>= 5%)
                                    if (percentage >= 5) {
                                        const x = bar.x;
                                        // For stacked bars, bar.y is the top and bar.base is the bottom
                                        const segmentHeight = Math.abs(bar.base - bar.y);
                                        
                                        // Only show if segment is tall enough to be readable
                                        if (segmentHeight > 15) {
                                            const y = bar.y + (segmentHeight / 2);
                                            
                                            ctx.save();
                                            ctx.fillStyle = '#fff';
                                            ctx.strokeStyle = '#000';
                                            ctx.lineWidth = 2;
                                            ctx.font = 'bold 10px JetBrains Mono';
                                            ctx.textAlign = 'center';
                                            ctx.textBaseline = 'middle';
                                            
                                            // Add text stroke for better visibility
                                            ctx.strokeText(percentage + '%', x, y);
                                            ctx.fillText(percentage + '%', x, y);
                                            ctx.restore();
                                        }
                                    }
                                }
                            });
                        });
                    }
                }] : []
            });
        }

        /**
         * Generates a color palette for disciplines with distinct, visible colors
         * @param {number} count - Number of colors needed
         * @returns {Array<string>} Array of color hex codes
         */
        function generateDisciplineColors(count) {
            // Distinct color palette optimized for visibility and contrast
            const colors = [
                '#ffd700', // Gold (primary)
                '#00ff88', // Green
                '#00aaff', // Blue
                '#ff6b6b', // Red
                '#9b59b6', // Purple
                '#f39c12', // Orange
                '#1abc9c', // Turquoise
                '#e74c3c', // Dark Red
                '#3498db', // Light Blue
                '#2ecc71', // Dark Green
                '#e67e22', // Dark Orange
                '#16a085', // Dark Turquoise
                '#c0392b', // Darker Red
                '#8e44ad', // Dark Purple
                '#2980b9', // Dark Blue
                '#27ae60', // Darker Green
                '#d35400', // Very Dark Orange
                '#7f8c8d'  // Gray
            ];
            return colors.slice(0, count);
        }

        /**
         * Collects chart items grouped by discipline
         * @param {string} disciplineFilter - Selected discipline filter ('all' or discipline name)
         * @returns {Object} Object with items per discipline and all dates
         */
        function collectChartItemsByDiscipline(disciplineFilter) {
            const itemsByDiscipline = {};
            const allDates = [];
            const disciplinesToShow = disciplineFilter === 'all' 
                ? projectData.disciplines 
                : [disciplineFilter];

            disciplinesToShow.forEach(discipline => {
                itemsByDiscipline[discipline] = [];
                const disciplineBudget = projectData.budgets[discipline] || 0;
                
                projectData.packages.forEach(packageName => {
                    const key = `${discipline}-${packageName}`;
                    const dates = projectData.dates[key];
                    const claimPct = projectData.claiming[key] || 0;
                    const packageBudget = disciplineBudget * (claimPct / 100);
                    
                    if (dates && dates.start && dates.end) {
                        const startDate = new Date(dates.start);
                        const endDate = new Date(dates.end);
                        itemsByDiscipline[discipline].push({
                            start: startDate,
                            end: endDate,
                            budget: packageBudget
                        });
                        allDates.push(startDate, endDate);
                    }
                });
            });

            return { itemsByDiscipline, allDates };
        }

        /**
         * Collects chart items from project data based on discipline filter
         * @param {string} disciplineFilter - Selected discipline filter ('all' or discipline name)
         * @returns {Array<Object>} Array of items with start, end dates and budget
         */
        function collectChartItems(disciplineFilter) {
            const items = [];
            const allDates = [];

            projectData.disciplines.forEach(discipline => {
                if (disciplineFilter !== 'all' && discipline !== disciplineFilter) return;
                const disciplineBudget = projectData.budgets[discipline] || 0;
                
                projectData.packages.forEach(packageName => {
                    const key = `${discipline}-${packageName}`;
                    const dates = projectData.dates[key];
                    const claimPct = projectData.claiming[key] || 0;
                    const packageBudget = disciplineBudget * (claimPct / 100);
                    
                    if (dates && dates.start && dates.end) {
                        const startDate = new Date(dates.start);
                        const endDate = new Date(dates.end);
                        items.push({
                            start: startDate,
                            end: endDate,
                            budget: packageBudget
                        });
                        allDates.push(startDate, endDate);
                    }
                });
            });

            return { items, allDates };
        }

        /**
         * Calculates the date range for chart display
         * @param {Array<Date>} allDates - Array of all start and end dates
         * @returns {{start: Date, end: Date}} Start and end dates for chart
         */
        function calculateChartDateRange(allDates) {
            if (!allDates.length) return null;

            allDates.sort((a, b) => a - b);
            const startDate = new Date(allDates[0].getFullYear(), allDates[0].getMonth(), 1);
            const endDate = new Date(
                allDates[allDates.length - 1].getFullYear(), 
                allDates[allDates.length - 1].getMonth() + 1, 
                1
            );
            return { start: startDate, end: endDate };
        }

        /**
         * Calculates monthly budget for a given month
         * @param {Date} currentMonth - Current month being calculated
         * @param {Array<Object>} items - Chart items with dates and budgets
         * @returns {number} Monthly budget amount
         */
        function calculateMonthlyBudget(currentMonth, items) {
            let monthly = 0;
            items.forEach(item => {
                const months = Math.max(1, Math.ceil((item.end - item.start) / (1000 * 60 * 60 * 24 * 30)));
                if (currentMonth >= item.start && currentMonth <= item.end) {
                    monthly += item.budget / months;
                }
            });
            return monthly;
        }

        /**
         * Generates chart data points (labels, planned, actual) for the date range
         * @param {Date} startDate - Chart start date
         * @param {Date} endDate - Chart end date
         * @param {Array<Object>} items - Chart items with dates and budgets
         * @param {string} viewType - 'cumulative' or 'monthly'
         * @returns {{labels: Array<string>, planned: Array<number>, actual: Array<number>}}
         */
        function generateChartDataPoints(startDate, endDate, items, viewType) {
            const labels = [];
            const planned = [];
            const actual = [];
            let cumulative = 0;
            const current = new Date(startDate);

            while (current <= endDate) {
                labels.push(current.toLocaleDateString('en-US', { year: '2-digit', month: 'short' }));
                
                const monthly = calculateMonthlyBudget(current, items);
                
                if (viewType === 'cumulative') {
                    cumulative += monthly;
                    planned.push(Math.round(cumulative));
                } else {
                    planned.push(Math.round(monthly));
                }
                actual.push(0);
                
                current.setMonth(current.getMonth() + 1);
            }

            return { labels, planned, actual };
        }

        /**
         * Generates stacked chart data points per discipline
         * @param {Date} startDate - Chart start date
         * @param {Date} endDate - Chart end date
         * @param {Object} itemsByDiscipline - Items grouped by discipline
         * @param {string} viewType - 'cumulative' or 'monthly'
         * @returns {{labels: Array<string>, datasets: Array<Object>}}
         */
        /**
         * Generates stacked chart data with discipline colors
         * @param {Date} startDate - Chart start date
         * @param {Date} endDate - Chart end date
         * @param {Object} itemsByDiscipline - Items grouped by discipline
         * @param {string} viewType - 'cumulative' or 'monthly'
         * @returns {{labels: Array<string>, datasets: Array<Object>, totals: Array<number>}}
         */
        function generateStackedChartData(startDate, endDate, itemsByDiscipline, viewType) {
            const labels = [];
            const disciplines = Object.keys(itemsByDiscipline);
            const colors = generateDisciplineColors(disciplines.length);
            const datasets = disciplines.map((discipline, index) => ({
                label: discipline,
                data: [],
                backgroundColor: colors[index],
                borderColor: colors[index],
                borderWidth: 1
            }));
            
            const totals = []; // Store total for each month to calculate percentages
            let cumulativeByDiscipline = {};
            disciplines.forEach(disc => cumulativeByDiscipline[disc] = 0);
            
            const current = new Date(startDate);
            while (current <= endDate) {
                labels.push(current.toLocaleDateString('en-US', { year: '2-digit', month: 'short' }));
                
                let monthTotal = 0;
                disciplines.forEach((discipline, index) => {
                    const monthly = calculateMonthlyBudget(current, itemsByDiscipline[discipline]);
                    let value = monthly;
                    
                    if (viewType === 'cumulative') {
                        cumulativeByDiscipline[discipline] += monthly;
                        value = cumulativeByDiscipline[discipline];
                    }
                    
                    const rounded = Math.round(value);
                    datasets[index].data.push(rounded);
                    monthTotal += rounded;
                });
                
                totals.push(monthTotal);
                current.setMonth(current.getMonth() + 1);
            }
            
            return { labels, datasets, totals };
        }

        /**
         * Gets chart data based on current filters and view type
         * @returns {{labels: Array<string>, planned: Array<number>, actual: Array<number>} | {labels: Array<string>, datasets: Array<Object>}}
         */
        function getChartData() {
            const disciplineFilter = document.getElementById('filter-discipline').value;
            const viewType = document.getElementById('view-type').value;
            const chartType = document.getElementById('chart-type').value;
            
            // For stacked bar charts, use discipline-grouped data
            if (chartType === 'bar') {
                const { itemsByDiscipline, allDates } = collectChartItemsByDiscipline(disciplineFilter);
                
                if (!allDates.length) {
                    return { labels: ['N/A'], datasets: [] };
                }
                
                const dateRange = calculateChartDateRange(allDates);
                if (!dateRange) {
                    return { labels: ['N/A'], datasets: [] };
                }
                
                return generateStackedChartData(dateRange.start, dateRange.end, itemsByDiscipline, viewType);
            } else {
                // For line charts, use original format
                const { items, allDates } = collectChartItems(disciplineFilter);
                
                if (!allDates.length) {
                    return { labels: ['N/A'], planned: [0], actual: [0] };
                }
                
                const dateRange = calculateChartDateRange(allDates);
                if (!dateRange) {
                    return { labels: ['N/A'], planned: [0], actual: [0] };
                }
                
                return generateChartDataPoints(dateRange.start, dateRange.end, items, viewType);
            }
        }

        function updateChart() {
            createChart();
        }

        function editWBS() {
            document.getElementById('wizard-terminal').style.display = 'block';
            document.getElementById('results-section').classList.add('hidden');
            currentStep = 1;
            showStep(1);
        }

        /**
         * Exports WBS structure to CSV (output format)
         */
        function exportCSV() {
            let csv = 'WBS,Phase,Discipline,Package,Budget,Claim%,Start,End,Actual,Variance\n';
            
            projectData.phases.forEach((phase, pi) => {
                projectData.disciplines.forEach((disc, di) => {
                    const discBudget = projectData.budgets[disc] || 0;
                    
                    projectData.packages.forEach((pkg, ki) => {
                        const key = `${disc}-${pkg}`;
                        const claimPct = projectData.claiming[key] || 0;
                        const pkgBudget = discBudget * (claimPct / 100);
                        const dates = projectData.dates[key] || { start: '', end: '' };
                        
                        csv += `${pi+1}.${di+1}.${ki+1},"${phase}","${disc}","${pkg}",${pkgBudget},${claimPct},${dates.start},${dates.end},0,${pkgBudget}\n`;
                    });
                });
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'wbs_structure.csv';
            a.click();
        }

        /**
         * Exports all input data to CSV in a format that can be imported back
         * Includes: phases, disciplines, packages, budgets, claiming, dates, calculator settings
         */
        function exportAllDataCSV() {
            let csv = '# IPC Builder Project Data Export\n';
            csv += '# This file can be imported to restore project settings\n';
            csv += '# Format: Section,Key,Value\n\n';
            
            // Phases
            csv += '[PHASES]\n';
            projectData.phases.forEach(phase => {
                csv += `Phase,${phase}\n`;
            });
            csv += '\n';
            
            // Disciplines
            csv += '[DISCIPLINES]\n';
            projectData.disciplines.forEach(discipline => {
                csv += `Discipline,${discipline}\n`;
            });
            csv += '\n';
            
            // Packages
            csv += '[PACKAGES]\n';
            projectData.packages.forEach(packageName => {
                csv += `Package,${packageName}\n`;
            });
            csv += '\n';
            
            // Budgets
            csv += '[BUDGETS]\n';
            csv += 'Discipline,Budget\n';
            projectData.disciplines.forEach(discipline => {
                const budget = projectData.budgets[discipline] || 0;
                csv += `${discipline},${budget}\n`;
            });
            csv += '\n';
            
            // Claiming Percentages
            csv += '[CLAIMING]\n';
            csv += 'Discipline,Package,Percentage\n';
            projectData.disciplines.forEach(discipline => {
                projectData.packages.forEach(packageName => {
                    const key = `${discipline}-${packageName}`;
                    const percentage = projectData.claiming[key] || 0;
                    csv += `${discipline},${packageName},${percentage}\n`;
                });
            });
            csv += '\n';
            
            // Dates
            csv += '[DATES]\n';
            csv += 'Discipline,Package,Start,End\n';
            projectData.disciplines.forEach(discipline => {
                projectData.packages.forEach(packageName => {
                    const key = `${discipline}-${packageName}`;
                    const dates = projectData.dates[key] || { start: '', end: '' };
                    csv += `${discipline},${packageName},${dates.start},${dates.end}\n`;
                });
            });
            csv += '\n';
            
            // Calculator Settings
            csv += '[CALCULATOR]\n';
            csv += 'Setting,Value\n';
            csv += `TotalConstructionCost,${projectData.calculator.totalConstructionCost}\n`;
            csv += `DesignFeePercent,${projectData.calculator.designFeePercent}\n`;
            csv += `ProjectType,${projectData.calculator.projectType}\n`;
            csv += `TotalDesignFee,${projectData.calculator.totalDesignFee}\n`;
            csv += `IsCalculated,${projectData.calculator.isCalculated}\n`;
            
            // Complexity Overrides
            if (Object.keys(projectData.calculator.complexityOverrides).length > 0) {
                csv += '\n[COMPLEXITY_OVERRIDES]\n';
                csv += 'Discipline,Complexity\n';
                Object.entries(projectData.calculator.complexityOverrides).forEach(([disc, complexity]) => {
                    csv += `${disc},${complexity}\n`;
                });
            }
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'ipc_builder_project_data.csv';
            a.click();
        }

        /**
         * Exports a comprehensive project summary with scope, disciplines, and WBS breakdown
         * Formatted as a professional PDF document
         */
        function exportProjectSummary() {
            const today = new Date().toLocaleDateString();
            const assumptions = getCostEstimateAssumptions();
            
            // Calculate totals
            let totalBudget = 0;
            projectData.disciplines.forEach(disc => {
                totalBudget += projectData.budgets[disc] || 0;
            });
            
            // Find date range
            let minDate = null, maxDate = null;
            Object.values(projectData.dates).forEach(d => {
                if (d.start && (!minDate || d.start < minDate)) minDate = d.start;
                if (d.end && (!maxDate || d.end > maxDate)) maxDate = d.end;
            });
            
            let durationMonths = 0;
            if (minDate && maxDate) {
                durationMonths = Math.ceil((new Date(maxDate) - new Date(minDate)) / (1000 * 60 * 60 * 24 * 30));
            }
            
            let html = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Project Summary Report</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            color: #333;
            background: #fff;
            font-size: 11pt;
            line-height: 1.5;
        }
        .page { padding: 40px; max-width: 8.5in; }
        .header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            padding: 35px 40px;
            margin: -40px -40px 30px -40px;
        }
        .header h1 {
            font-size: 26pt;
            font-weight: 300;
            margin-bottom: 8px;
            letter-spacing: 1px;
        }
        .header .subtitle { font-size: 11pt; opacity: 0.7; margin-bottom: 20px; }
        .header-info {
            display: flex;
            gap: 50px;
            font-size: 10pt;
        }
        .header-info-item { }
        .header-info-label { opacity: 0.6; font-size: 9pt; text-transform: uppercase; }
        .header-info-value { font-size: 13pt; font-weight: 600; margin-top: 2px; }
        
        h2 {
            color: #1a1a2e;
            font-size: 14pt;
            font-weight: 600;
            margin: 28px 0 14px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid #e0e0e0;
        }
        h3 {
            color: #444;
            font-size: 12pt;
            font-weight: 600;
            margin: 18px 0 10px 0;
        }
        
        .kpi-row {
            display: flex;
            gap: 15px;
            margin: 20px 0;
        }
        .kpi-box {
            flex: 1;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 16px;
            text-align: center;
        }
        .kpi-box .value { font-size: 20pt; font-weight: 700; color: #1a1a2e; }
        .kpi-box .label { font-size: 8pt; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; }
        
        .scope-box {
            background: #f0f7ff;
            border: 1px solid #b8d4f0;
            border-radius: 6px;
            padding: 18px;
            margin: 18px 0;
        }
        .scope-box h3 { color: #1a5490; margin-top: 0; }
        .scope-text { color: #444; }
        
        .assumptions-box {
            background: linear-gradient(135deg, #fffde7 0%, #fff9c4 100%);
            border: 1px solid #e6d9a8;
            border-radius: 6px;
            padding: 18px;
            margin: 18px 0;
        }
        .assumptions-box h3 { color: #856404; margin-top: 0; font-size: 11pt; }
        .assumptions-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 12px;
        }
        .assumption-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 10px;
            background: rgba(255,255,255,0.7);
            border-radius: 4px;
            font-size: 10pt;
        }
        .assumption-label { color: #666; }
        .assumption-value { font-weight: 600; }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 12px 0;
            font-size: 10pt;
        }
        thead th {
            background: #1a1a2e;
            color: #fff;
            padding: 10px 8px;
            text-align: left;
            font-weight: 500;
            font-size: 9pt;
            text-transform: uppercase;
        }
        tbody td {
            padding: 8px;
            border-bottom: 1px solid #e0e0e0;
        }
        tbody tr:nth-child(even) { background: #f8f9fa; }
        tfoot th {
            background: #e8ecef;
            padding: 10px 8px;
            font-weight: 600;
        }
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        
        .complexity-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 9pt;
            font-weight: 500;
        }
        .complexity-low { background: #d4edda; color: #155724; }
        .complexity-medium { background: #fff3cd; color: #856404; }
        .complexity-high { background: #f8d7da; color: #721c24; }
        
        .discipline-card {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 16px;
            margin: 14px 0;
            page-break-inside: avoid;
        }
        .discipline-card h3 {
            margin: 0 0 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .discipline-card .budget-tag {
            font-size: 12pt;
            color: #1a1a2e;
        }
        .discipline-scope {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 12px;
            margin: 10px 0;
            font-size: 10pt;
            color: #555;
        }
        
        .list-section { margin: 12px 0; }
        .list-section ul { margin: 0; padding-left: 20px; }
        .list-section li { margin: 4px 0; }
        
        .footer {
            margin-top: 30px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
            font-size: 9pt;
            color: #888;
            text-align: center;
        }
        
        .page-break { page-break-before: always; }
    </style>
</head>
<body>
    <div class="page">
        <div class="header">
            <h1>Project Summary Report</h1>
            <div class="subtitle">Comprehensive Work Breakdown Structure Analysis</div>
            <div class="header-info">
                <div class="header-info-item">
                    <div class="header-info-label">Report Date</div>
                    <div class="header-info-value">${today}</div>
                </div>
                <div class="header-info-item">
                    <div class="header-info-label">Total Budget</div>
                    <div class="header-info-value">${formatCurrency(totalBudget)}</div>
                </div>
                <div class="header-info-item">
                    <div class="header-info-label">Duration</div>
                    <div class="header-info-value">${durationMonths > 0 ? durationMonths + ' Months' : 'Not Set'}</div>
                </div>
            </div>
        </div>
        
        <div class="kpi-row">
            <div class="kpi-box">
                <div class="value">${formatCurrency(totalBudget)}</div>
                <div class="label">Total Design Fee</div>
            </div>
            <div class="kpi-box">
                <div class="value">${projectData.disciplines.length}</div>
                <div class="label">Disciplines</div>
            </div>
            <div class="kpi-box">
                <div class="value">${projectData.phases.length}</div>
                <div class="label">Phases</div>
            </div>
            <div class="kpi-box">
                <div class="value">${projectData.packages.length}</div>
                <div class="label">Packages</div>
            </div>
        </div>
`;

            // Project Scope
            if (projectData.projectScope) {
                html += `
        <div class="scope-box">
            <h3>Project Scope</h3>
            <div class="scope-text">${projectData.projectScope.replace(/\n/g, '<br>')}</div>
        </div>
`;
            }

            // Cost Estimate Assumptions
            if (assumptions.isCalculated) {
                html += `
        <div class="assumptions-box">
            <h3> Cost Estimate Assumptions</h3>
            <div class="assumptions-grid">
                <div class="assumption-item">
                    <span class="assumption-label">Construction Cost</span>
                    <span class="assumption-value">${formatCurrency(assumptions.constructionCost)}</span>
                </div>
                <div class="assumption-item">
                    <span class="assumption-label">Design Fee %</span>
                    <span class="assumption-value">${assumptions.designFeePercent}%</span>
                </div>
                <div class="assumption-item">
                    <span class="assumption-label">Total Design Fee</span>
                    <span class="assumption-value">${formatCurrency(assumptions.totalDesignFee)}</span>
                </div>
                <div class="assumption-item">
                    <span class="assumption-label">Project Type</span>
                    <span class="assumption-value">${assumptions.projectType}</span>
                </div>
            </div>
        </div>
`;
            }

            // Project Structure
            html += `
        <h2>Project Structure</h2>
        <div class="list-section">
            <h3>Phases</h3>
            <ul>${projectData.phases.map(p => `<li>${p}</li>`).join('')}</ul>
        </div>
        <div class="list-section">
            <h3>Deliverable Packages</h3>
            <ul>${projectData.packages.map(p => `<li>${p}</li>`).join('')}</ul>
        </div>
        
        <h2>Discipline Budget Summary</h2>
        <table>
            <thead>
                <tr>
                    <th>Discipline</th>
                    <th class="text-center">Complexity</th>
                    <th class="text-right">Industry %</th>
                    <th class="text-right">Actual %</th>
                    <th class="text-right">Budget</th>
                </tr>
            </thead>
            <tbody>
`;

            assumptions.disciplines.forEach(disc => {
                const complexityClass = disc.complexity.toLowerCase();
                html += `
                <tr>
                    <td><strong>${disc.name}</strong></td>
                    <td class="text-center"><span class="complexity-badge complexity-${complexityClass}">${disc.complexity}</span></td>
                    <td class="text-right">${disc.industryBasePct}%</td>
                    <td class="text-right">${disc.percentOfTotal}%</td>
                    <td class="text-right"><strong>${formatCurrency(disc.budget)}</strong></td>
                </tr>`;
            });

            html += `
            </tbody>
            <tfoot>
                <tr>
                    <th colspan="3">Total</th>
                    <th class="text-right">100%</th>
                    <th class="text-right">${formatCurrency(totalBudget)}</th>
                </tr>
            </tfoot>
        </table>
        
        <div class="page-break"></div>
        <h2>Discipline Details</h2>
`;

            // Discipline Cards with Scope
            projectData.disciplines.forEach(disc => {
                const budget = projectData.budgets[disc] || 0;
                const pct = totalBudget > 0 ? ((budget / totalBudget) * 100).toFixed(1) : 0;
                const scope = projectData.disciplineScopes && projectData.disciplineScopes[disc] ? projectData.disciplineScopes[disc] : null;
                const discAssumption = assumptions.disciplines.find(d => d.name === disc);
                
                html += `
        <div class="discipline-card">
            <h3>
                <span>${disc}</span>
                <span class="budget-tag">${formatCurrency(budget)} (${pct}%)</span>
            </h3>
`;
                if (scope) {
                    html += `
            <div class="discipline-scope">
                <strong>Scope of Work:</strong><br>
                ${scope.replace(/\n/g, '<br>')}
            </div>
`;
                }
                
                if (discAssumption) {
                    html += `
            <div style="font-size: 9pt; color: #666; margin-bottom: 10px;">
                Complexity: <span class="complexity-badge complexity-${discAssumption.complexity.toLowerCase()}">${discAssumption.complexity}</span>
                &nbsp;|&nbsp; Industry Base: ${discAssumption.industryBasePct}%
                ${discAssumption.hasComplexityOverride ? '&nbsp;|&nbsp; <em>Complexity Override Applied</em>' : ''}
                ${discAssumption.isManualEdit ? '&nbsp;|&nbsp; <em>Manually Edited</em>' : ''}
            </div>
`;
                }

                html += `
            <table style="font-size: 9pt;">
                <thead>
                    <tr>
                        <th>Package</th>
                        <th class="text-center">Claim %</th>
                        <th class="text-right">Budget</th>
                        <th>Start</th>
                        <th>End</th>
                    </tr>
                </thead>
                <tbody>
`;
                projectData.packages.forEach(pkg => {
                    const key = `${disc}-${pkg}`;
                    const claimPct = projectData.claiming[key] || 0;
                    const pkgBudget = budget * (claimPct / 100);
                    const dates = projectData.dates[key] || {};
                    
                    html += `
                    <tr>
                        <td>${pkg}</td>
                        <td class="text-center">${claimPct}%</td>
                        <td class="text-right">${formatCurrency(pkgBudget)}</td>
                        <td>${dates.start || ''}</td>
                        <td>${dates.end || ''}</td>
                    </tr>`;
                });

                html += `
                </tbody>
            </table>
        </div>
`;
            });

            html += `
        <div class="footer">
            Generated by WBS Terminal  ${today}  Industry-standard cost distributions based on ${assumptions.projectType} project benchmarks
        </div>
    </div>
</body>
</html>`;

            // Generate PDF
            const container = document.createElement('div');
            container.innerHTML = html;
            document.body.appendChild(container);
            
            const opt = {
                margin: [0.25, 0.25, 0.25, 0.25],
                filename: `project_summary_${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' },
                pagebreak: { mode: ['css', 'legacy'] }
            };
            
            html2pdf().set(opt).from(container).save().then(() => {
                document.body.removeChild(container);
            }).catch(err => {
                console.error('PDF generation failed:', err);
                document.body.removeChild(container);
                alert('PDF generation failed. Please try again.');
            });
        }

        /**
         * Imports project data from CSV file
         */
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const csv = event.target.result;
                        parseImportCSV(csv);
                        alert('Data imported successfully! Returning to wizard...');
                        editWBS();
                    } catch (error) {
                        alert('Error importing data: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        /**
         * Parses imported CSV and populates projectData
         * @param {string} csv - CSV file content
         */
        function parseImportCSV(csv) {
            const lines = csv.split('\n').map(line => line.trim()).filter(line => line && !line.startsWith('#'));
            
            let currentSection = '';
            const data = {
                phases: [],
                disciplines: [],
                packages: [],
                budgets: {},
                claiming: {},
                dates: {},
                calculator: {
                    totalConstructionCost: 0,
                    designFeePercent: 15,
                    projectType: 'Highway/Roadway',
                    totalDesignFee: 0,
                    complexityOverrides: {},
                    isCalculated: false,
                    manualEdits: {}
                }
            };
            
            lines.forEach(line => {
                // Check for section headers
                if (line.startsWith('[') && line.endsWith(']')) {
                    currentSection = line.slice(1, -1);
                    return;
                }
                
                const parts = line.split(',').map(p => p.trim());
                if (parts.length < 2) return;
                
                switch (currentSection) {
                    case 'PHASES':
                        if (parts[0] === 'Phase') {
                            data.phases.push(parts[1]);
                        }
                        break;
                    case 'DISCIPLINES':
                        if (parts[0] === 'Discipline') {
                            data.disciplines.push(parts[1]);
                        }
                        break;
                    case 'PACKAGES':
                        if (parts[0] === 'Package') {
                            data.packages.push(parts[1]);
                        }
                        break;
                    case 'BUDGETS':
                        if (parts[0] !== 'Discipline') {
                            data.budgets[parts[0]] = parseFloat(parts[1]) || 0;
                        }
                        break;
                    case 'CLAIMING':
                        if (parts[0] !== 'Discipline') {
                            const key = `${parts[0]}-${parts[1]}`;
                            data.claiming[key] = parseFloat(parts[2]) || 0;
                        }
                        break;
                    case 'DATES':
                        if (parts[0] !== 'Discipline') {
                            const key = `${parts[0]}-${parts[1]}`;
                            data.dates[key] = {
                                start: parts[2] || '',
                                end: parts[3] || ''
                            };
                        }
                        break;
                    case 'CALCULATOR':
                        if (parts[0] !== 'Setting') {
                            const setting = parts[0];
                            const value = parts[1];
                            if (setting === 'TotalConstructionCost') {
                                data.calculator.totalConstructionCost = parseFloat(value) || 0;
                            } else if (setting === 'DesignFeePercent') {
                                data.calculator.designFeePercent = parseFloat(value) || 15;
                            } else if (setting === 'ProjectType') {
                                data.calculator.projectType = value;
                            } else if (setting === 'TotalDesignFee') {
                                data.calculator.totalDesignFee = parseFloat(value) || 0;
                            } else if (setting === 'IsCalculated') {
                                data.calculator.isCalculated = value === 'true';
                            }
                        }
                        break;
                    case 'COMPLEXITY_OVERRIDES':
                        if (parts[0] !== 'Discipline') {
                            data.calculator.complexityOverrides[parts[0]] = parts[1];
                        }
                        break;
                }
            });
            
            // Apply imported data to projectData
            projectData = data;
            
            // Update UI if we're in the wizard
            if (currentStep >= 1 && currentStep <= 6) {
                loadImportedData();
            }
        }

        /**
         * Loads imported data into the wizard forms
         */
        function loadImportedData() {
            // Step 1: Phases
            if (projectData.phases.length > 0) {
                document.getElementById('phases-input').value = projectData.phases.join(', ');
            }
            
            // Step 2: Disciplines - restore selections
            if (projectData.disciplines.length > 0) {
                // Rebuild discipline grid with imported selections
                const grid = document.getElementById('disciplines-grid');
                let html = '';
                
                // First, mark all existing disciplines
                allDisciplines.forEach(d => {
                    const isSelected = projectData.disciplines.includes(d.name);
                    html += `<div class="disc-item ${isSelected ? 'selected' : ''}" onclick="toggleDisc(this)" data-name="${d.name}">${d.name}</div>`;
                });
                
                // Add any custom disciplines that aren't in allDisciplines
                projectData.disciplines.forEach(discipline => {
                    if (!allDisciplines.find(d => d.name === discipline)) {
                        html += `<div class="disc-item selected" onclick="toggleDisc(this)" data-name="${discipline}">${discipline}</div>`;
                    }
                });
                
                grid.innerHTML = html;
                updateSelectedCount();
            }
            
            // Step 3: Packages
            if (projectData.packages.length > 0) {
                document.getElementById('packages-input').value = projectData.packages.join(', ');
            }
            
            // Steps 4-6 will be populated when those steps are shown via buildBudgetTable, etc.
        }

        /**
         * Generates cost estimate assumptions data for reports
         */
        function getCostEstimateAssumptions() {
            const calc = projectData.calculator;
            const projectType = calc.projectType || 'Highway/Roadway';
            const totalBudget = calculateTotalBudget();
            
            const assumptions = {
                constructionCost: calc.totalConstructionCost || 0,
                designFeePercent: calc.designFeePercent || 15,
                totalDesignFee: calc.totalDesignFee || totalBudget,
                projectType: projectType,
                isCalculated: calc.isCalculated,
                disciplines: []
            };
            
            projectData.disciplines.forEach(discipline => {
                const budget = projectData.budgets[discipline] || 0;
                const pctOfTotal = totalBudget > 0 ? ((budget / totalBudget) * 100) : 0;
                
                // Get complexity (override or auto-assigned)
                const complexity = calc.complexityOverrides[discipline] ||
                    (projectComplexityMap[projectType] ? projectComplexityMap[projectType][discipline] : null) ||
                    'Medium';
                
                // Get industry base percentage
                const distribution = industryDistribution[projectType];
                const industryPct = distribution && distribution[discipline] ? 
                    distribution[discipline][complexity] : 5;
                
                // Check if manually edited
                const isManualEdit = calc.manualEdits && calc.manualEdits[discipline];
                const hasComplexityOverride = calc.complexityOverrides && calc.complexityOverrides[discipline];
                
                assumptions.disciplines.push({
                    name: discipline,
                    budget: budget,
                    percentOfTotal: pctOfTotal.toFixed(1),
                    complexity: complexity,
                    industryBasePct: industryPct,
                    isManualEdit: isManualEdit,
                    hasComplexityOverride: hasComplexityOverride
                });
            });
            
            return assumptions;
        }

        /**
         * Opens print-friendly report view with charts
         */
        function printReport() {
            const printWindow = window.open('', '_blank');
            const today = new Date().toLocaleDateString();
            const assumptions = getCostEstimateAssumptions();
            
            // Capture the Performance Chart as an image
            let performanceChartImg = '';
            const chartCanvas = document.getElementById('performance-chart');
            if (chartCanvas && chart) {
                try {
                    performanceChartImg = chartCanvas.toDataURL('image/png');
                } catch (e) {
                    console.error('Could not capture chart:', e);
                }
            }
            
            // Capture the Gantt chart HTML
            const ganttContainer = document.getElementById('gantt-container');
            let ganttHtml = '';
            if (ganttContainer) {
                ganttHtml = ganttContainer.innerHTML;
            }
            
            // Calculate date range
            let minDate = null, maxDate = null;
            Object.values(projectData.dates).forEach(d => {
                if (d.start && (!minDate || d.start < minDate)) minDate = d.start;
                if (d.end && (!maxDate || d.end > maxDate)) maxDate = d.end;
            });
            
            let html = `
<!DOCTYPE html>
<html>
<head>
    <title>Project Cost Estimate Report</title>
    <style>
        @media print {
            @page { margin: 0.75in; size: letter; }
            .page-break { page-break-before: always; }
            .no-break { page-break-inside: avoid; }
        }
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            padding: 0;
            margin: 0;
            color: #333;
            background: #fff;
            font-size: 11pt;
            line-height: 1.4;
        }
        .header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            padding: 30px 40px;
            margin-bottom: 30px;
        }
        .header h1 {
            margin: 0 0 10px 0;
            font-size: 28pt;
            font-weight: 300;
            letter-spacing: 1px;
        }
        .header .subtitle {
            font-size: 12pt;
            opacity: 0.8;
            margin-bottom: 20px;
        }
        .header-meta {
            display: flex;
            gap: 40px;
            font-size: 10pt;
        }
        .header-meta-item { display: flex; flex-direction: column; }
        .header-meta-label { opacity: 0.6; font-size: 9pt; text-transform: uppercase; letter-spacing: 0.5px; }
        .header-meta-value { font-size: 14pt; font-weight: 600; }
        
        .content { padding: 0 40px 40px 40px; }
        
        h2 {
            color: #1a1a2e;
            font-size: 14pt;
            font-weight: 600;
            margin: 30px 0 15px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid #e0e0e0;
        }
        h3 {
            color: #444;
            font-size: 12pt;
            font-weight: 600;
            margin: 20px 0 10px 0;
        }
        
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin: 25px 0;
        }
        .kpi-card {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }
        .kpi-card .value {
            font-size: 24pt;
            font-weight: 700;
            color: #1a1a2e;
            margin-bottom: 5px;
        }
        .kpi-card .label {
            font-size: 9pt;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .summary-box {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .summary-row {
            display: flex;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .summary-row:last-child { border-bottom: none; }
        .summary-label { flex: 0 0 180px; color: #666; font-weight: 500; }
        .summary-value { flex: 1; color: #333; }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 10pt;
        }
        thead th {
            background: #1a1a2e;
            color: #fff;
            padding: 12px 10px;
            text-align: left;
            font-weight: 500;
            font-size: 9pt;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        tbody td {
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
        }
        tbody tr:nth-child(even) { background: #f8f9fa; }
        tbody tr:hover { background: #f0f4f8; }
        tfoot th {
            background: #e8ecef;
            padding: 12px 10px;
            font-weight: 600;
            border-top: 2px solid #1a1a2e;
        }
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        
        .assumptions-box {
            background: linear-gradient(135deg, #fff9e6 0%, #fff5d6 100%);
            border: 1px solid #e6d9a8;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .assumptions-box h3 {
            color: #856404;
            margin-top: 0;
        }
        .assumptions-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        .assumption-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            background: rgba(255,255,255,0.7);
            border-radius: 4px;
        }
        .assumption-label { color: #666; }
        .assumption-value { font-weight: 600; color: #333; }
        
        .complexity-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 9pt;
            font-weight: 500;
        }
        .complexity-low { background: #d4edda; color: #155724; }
        .complexity-medium { background: #fff3cd; color: #856404; }
        .complexity-high { background: #f8d7da; color: #721c24; }
        
        .chart-section {
            margin: 25px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .chart-section img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
        }
        .chart-legend {
            display: flex;
            gap: 30px;
            margin-top: 15px;
            font-size: 10pt;
            color: #666;
        }
        
        /* Gantt chart print styles */
        .gantt-header { display: flex; background: #1a1a2e; color: #fff; font-size: 9pt; border-radius: 4px 4px 0 0; }
        .gantt-header-label { width: 150px; padding: 8px 12px; font-weight: 500; }
        .gantt-header-months { display: flex; flex: 1; }
        .gantt-month { flex: 1; padding: 8px 4px; text-align: center; border-left: 1px solid rgba(255,255,255,0.2); font-size: 8pt; }
        .gantt-row { display: flex; background: #fff; border-bottom: 1px solid #e0e0e0; min-height: 28px; }
        .gantt-row-label { width: 150px; padding: 6px 12px; font-weight: 500; background: #f8f9fa; border-right: 1px solid #e0e0e0; font-size: 10pt; }
        .gantt-row-timeline { display: flex; flex: 1; position: relative; align-items: center; }
        .gantt-bar { height: 16px; border-radius: 3px; position: absolute; }
        .gantt-bar.discipline { background: linear-gradient(90deg, #4a90d9, #357abd); }
        .gantt-bar.package { background: linear-gradient(90deg, #ffd700, #e6c200); height: 10px; }
        .gantt-packages { display: none; }
        .gantt-package-row { display: flex; background: #fafafa; border-bottom: 1px solid #eee; min-height: 24px; }
        .gantt-package-label { width: 150px; padding: 4px 12px 4px 24px; font-size: 9pt; background: #fafafa; border-right: 1px solid #e0e0e0; }
        .gantt-no-data { padding: 30px; text-align: center; color: #888; font-style: italic; }
        .gantt-legend { display: flex; gap: 30px; margin-top: 15px; font-size: 10pt; }
        .gantt-legend-item { display: flex; align-items: center; gap: 8px; }
        .gantt-legend-color { width: 24px; height: 12px; border-radius: 3px; }
        .gantt-legend-color.discipline { background: linear-gradient(90deg, #4a90d9, #357abd); }
        .gantt-legend-color.package { background: linear-gradient(90deg, #ffd700, #e6c200); }
        
        .footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
            font-size: 9pt;
            color: #888;
            text-align: center;
        }
        
        .scope-section {
            background: #f0f7ff;
            border: 1px solid #b8d4f0;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .scope-section h3 { color: #1a5490; margin-top: 0; }
        .scope-text { color: #444; line-height: 1.6; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Project Cost Estimate Report</h1>
        <div class="subtitle">Work Breakdown Structure Analysis</div>
        <div class="header-meta">
            <div class="header-meta-item">
                <span class="header-meta-label">Report Date</span>
                <span class="header-meta-value">${today}</span>
            </div>
            <div class="header-meta-item">
                <span class="header-meta-label">Total Budget</span>
                <span class="header-meta-value">${formatCurrency(calculateTotalBudget())}</span>
            </div>
            <div class="header-meta-item">
                <span class="header-meta-label">Project Duration</span>
                <span class="header-meta-value">${minDate && maxDate ? minDate + ' to ' + maxDate : 'Not Set'}</span>
            </div>
        </div>
    </div>
    
    <div class="content">
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="value">${formatCurrency(calculateTotalBudget())}</div>
                <div class="label">Total Design Fee</div>
            </div>
            <div class="kpi-card">
                <div class="value">${projectData.disciplines.length}</div>
                <div class="label">Disciplines</div>
            </div>
            <div class="kpi-card">
                <div class="value">${projectData.phases.length}</div>
                <div class="label">Project Phases</div>
            </div>
            <div class="kpi-card">
                <div class="value">${projectData.packages.length}</div>
                <div class="label">Deliverable Packages</div>
            </div>
        </div>
`;

        // Add Project Scope if available
        if (projectData.projectScope) {
            html += `
        <div class="scope-section no-break">
            <h3>Project Scope</h3>
            <div class="scope-text">${projectData.projectScope.replace(/\n/g, '<br>')}</div>
        </div>
`;
        }

        // Cost Estimate Assumptions
        if (assumptions.isCalculated) {
            html += `
        <div class="assumptions-box no-break">
            <h3> Cost Estimate Assumptions</h3>
            <div class="assumptions-grid">
                <div class="assumption-item">
                    <span class="assumption-label">Construction Cost</span>
                    <span class="assumption-value">${formatCurrency(assumptions.constructionCost)}</span>
                </div>
                <div class="assumption-item">
                    <span class="assumption-label">Design Fee Percentage</span>
                    <span class="assumption-value">${assumptions.designFeePercent}%</span>
                </div>
                <div class="assumption-item">
                    <span class="assumption-label">Total Design Fee</span>
                    <span class="assumption-value">${formatCurrency(assumptions.totalDesignFee)}</span>
                </div>
                <div class="assumption-item">
                    <span class="assumption-label">Project Type</span>
                    <span class="assumption-value">${assumptions.projectType}</span>
                </div>
            </div>
            <p style="margin: 15px 0 0 0; font-size: 9pt; color: #666;">
                Budget allocations are based on industry-standard distribution percentages for ${assumptions.projectType} projects, 
                adjusted for complexity levels assigned to each discipline.
            </p>
        </div>
`;
        }

        html += `
        <h2>Discipline Budget Breakdown</h2>
        <table>
            <thead>
                <tr>
                    <th>Discipline</th>
                    <th class="text-center">Complexity</th>
                    <th class="text-right">Industry %</th>
                    <th class="text-right">Actual %</th>
                    <th class="text-right">Budget</th>
                    <th class="text-center">Notes</th>
                </tr>
            </thead>
            <tbody>
`;
        
        const totalBudget = calculateTotalBudget();
        assumptions.disciplines.forEach(disc => {
            const complexityClass = disc.complexity.toLowerCase();
            const notes = [];
            if (disc.hasComplexityOverride) notes.push('Complexity Override');
            if (disc.isManualEdit) notes.push('Manual Edit');
            
            html += `
                <tr>
                    <td><strong>${disc.name}</strong></td>
                    <td class="text-center"><span class="complexity-badge complexity-${complexityClass}">${disc.complexity}</span></td>
                    <td class="text-right">${disc.industryBasePct}%</td>
                    <td class="text-right">${disc.percentOfTotal}%</td>
                    <td class="text-right"><strong>${formatCurrency(disc.budget)}</strong></td>
                    <td class="text-center" style="font-size: 9pt; color: #888;">${notes.join(', ') || ''}</td>
                </tr>`;
        });
        
        html += `
            </tbody>
            <tfoot>
                <tr>
                    <th colspan="3">Total</th>
                    <th class="text-right">100%</th>
                    <th class="text-right">${formatCurrency(totalBudget)}</th>
                    <th></th>
                </tr>
            </tfoot>
        </table>
        
        <div class="summary-box no-break">
            <div class="summary-row">
                <span class="summary-label">Project Phases</span>
                <span class="summary-value">${projectData.phases.join(', ')}</span>
            </div>
            <div class="summary-row">
                <span class="summary-label">Deliverable Packages</span>
                <span class="summary-value">${projectData.packages.join(', ')}</span>
            </div>
            <div class="summary-row">
                <span class="summary-label">Selected Disciplines</span>
                <span class="summary-value">${projectData.disciplines.join(', ')}</span>
            </div>
        </div>
`;

        // Add Performance Chart
        if (performanceChartImg) {
            html += `
        <div class="page-break"></div>
        <h2>Budget Distribution Over Time</h2>
        <div class="chart-section">
            <img src="${performanceChartImg}" alt="Performance Chart" />
            <div class="chart-legend">
                <span> <strong>BCWS</strong> - Budgeted Cost of Work Scheduled (Planned Value)</span>
            </div>
        </div>
`;
        }
        
        // Add Gantt Chart
        if (ganttHtml && !ganttHtml.includes('No schedule data')) {
            html += `
        <h2>Project Schedule</h2>
        <div class="chart-section">
            ${ganttHtml}
            <div class="gantt-legend">
                <div class="gantt-legend-item">
                    <div class="gantt-legend-color discipline"></div>
                    <span>Discipline Timeline</span>
                </div>
                <div class="gantt-legend-item">
                    <div class="gantt-legend-color package"></div>
                    <span>Package Deliverable</span>
                </div>
            </div>
        </div>
`;
        }

        html += `
        <div class="page-break"></div>
        <h2>Complete Work Breakdown Structure</h2>
        <table>
            <thead>
                <tr>
                    <th style="width: 60px;">WBS #</th>
                    <th>Phase</th>
                    <th>Discipline</th>
                    <th>Package</th>
                    <th class="text-right" style="width: 100px;">Budget</th>
                    <th class="text-center" style="width: 60px;">Claim %</th>
                    <th style="width: 90px;">Start</th>
                    <th style="width: 90px;">End</th>
                </tr>
            </thead>
            <tbody>
`;
        
        let grandTotal = 0;
        projectData.phases.forEach((phase, pi) => {
            projectData.disciplines.forEach((discipline, di) => {
                const discBudget = projectData.budgets[discipline] || 0;
                projectData.packages.forEach((packageName, ki) => {
                    const key = `${discipline}-${packageName}`;
                    const claimPct = projectData.claiming[key] || 0;
                    const pkgBudget = discBudget * (claimPct / 100);
                    const dates = projectData.dates[key] || { start: '', end: '' };
                    const wbs = `${pi+1}.${di+1}.${ki+1}`;
                    grandTotal += pkgBudget;
                    
                    html += `
                <tr>
                    <td><strong>${wbs}</strong></td>
                    <td>${phase}</td>
                    <td>${discipline}</td>
                    <td>${packageName}</td>
                    <td class="text-right">${formatCurrency(pkgBudget)}</td>
                    <td class="text-center">${claimPct}%</td>
                    <td>${dates.start || ''}</td>
                    <td>${dates.end || ''}</td>
                </tr>`;
                });
            });
        });
        
        html += `
            </tbody>
            <tfoot>
                <tr>
                    <th colspan="4">Grand Total</th>
                    <th class="text-right">${formatCurrency(grandTotal)}</th>
                    <th colspan="3"></th>
                </tr>
            </tfoot>
        </table>
        
        <div class="footer">
            Generated by WBS Terminal  ${today}  Industry-standard cost distributions based on ${assumptions.projectType} project benchmarks
        </div>
    </div>
</body>
</html>`;
            
            // Create a temporary container for PDF generation
            const container = document.createElement('div');
            container.innerHTML = html;
            document.body.appendChild(container);
            
            // Configure PDF options
            const opt = {
                margin: [0.3, 0.3, 0.3, 0.3],
                filename: `project_report_${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2, 
                    useCORS: true,
                    letterRendering: true
                },
                jsPDF: { 
                    unit: 'in', 
                    format: 'letter', 
                    orientation: 'portrait' 
                },
                pagebreak: { mode: ['css', 'legacy'] }
            };
            
            // Generate and download PDF
            html2pdf().set(opt).from(container).save().then(() => {
                document.body.removeChild(container);
            }).catch(err => {
                console.error('PDF generation failed:', err);
                document.body.removeChild(container);
                // Fallback to print dialog
                const printWindow = window.open('', '_blank');
                printWindow.document.write(html);
                printWindow.document.close();
                printWindow.focus();
                setTimeout(() => printWindow.print(), 500);
            });
        }

        /**
         * Calculates total budget from projectData
         * @returns {number} Total budget amount
         */
        function calculateTotalBudget() {
            return Object.values(projectData.budgets).reduce((sum, val) => sum + (val || 0), 0);
        }

        /**
         * Formats number as currency string
         * @param {number} amount - Amount to format
         * @returns {string} Formatted currency string
         */
        /**
         * Formats currency value with commas and no decimal places
         * @param {number} amount - Currency value to format
         * @returns {string} Formatted currency string (e.g., "$1,234,567")
         */
        function formatCurrency(amount) {
            return '$' + Math.round(amount || 0).toLocaleString('en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
        }

        // ============================================
        // GANTT CHART
        // ============================================

        const ganttState = {
            expandedDisciplines: new Set()
        };

        /**
         * Builds and renders the Gantt chart
         */
        function buildGanttChart() {
            const container = document.getElementById('gantt-container');
            
            // Get all dates to determine timeline range
            const allDates = [];
            Object.values(projectData.dates).forEach(d => {
                if (d.start) allDates.push(new Date(d.start));
                if (d.end) allDates.push(new Date(d.end));
            });
            
            if (allDates.length === 0) {
                container.innerHTML = '<div class="gantt-no-data">No schedule data available. Please set dates in Step 6.</div>';
                return;
            }
            
            // Find min and max dates
            const minDate = new Date(Math.min(...allDates));
            const maxDate = new Date(Math.max(...allDates));
            
            // Extend range by 1 month on each side
            minDate.setDate(1);
            maxDate.setMonth(maxDate.getMonth() + 1);
            maxDate.setDate(0);
            
            // Generate months array
            const months = [];
            const currentDate = new Date(minDate);
            while (currentDate <= maxDate) {
                months.push({
                    date: new Date(currentDate),
                    label: currentDate.toLocaleDateString('en-US', { month: 'short', year: '2-digit' })
                });
                currentDate.setMonth(currentDate.getMonth() + 1);
            }
            
            // Today marker
            const today = new Date();
            const todayMonthIndex = months.findIndex(m => 
                m.date.getMonth() === today.getMonth() && 
                m.date.getFullYear() === today.getFullYear()
            );
            
            // Build discipline schedule data
            const disciplineSchedules = projectData.disciplines.map(discipline => {
                const packages = projectData.packages.map(pkg => {
                    const key = `${discipline}-${pkg}`;
                    const dates = projectData.dates[key] || {};
                    return {
                        name: pkg,
                        start: dates.start ? new Date(dates.start) : null,
                        end: dates.end ? new Date(dates.end) : null,
                        claiming: projectData.claiming[key] || 0
                    };
                }).filter(p => p.start && p.end);
                
                // Calculate discipline overall timeline
                const pkgDates = packages.flatMap(p => [p.start, p.end]).filter(d => d);
                const discStart = pkgDates.length > 0 ? new Date(Math.min(...pkgDates)) : null;
                const discEnd = pkgDates.length > 0 ? new Date(Math.max(...pkgDates)) : null;
                
                return {
                    name: discipline,
                    start: discStart,
                    end: discEnd,
                    packages: packages,
                    budget: projectData.budgets[discipline] || 0
                };
            }).filter(d => d.start && d.end);
            
            // Render
            let html = `
                <div class="gantt-chart">
                    <div class="gantt-header">
                        <div class="gantt-label-col">Discipline / Package</div>
                        <div class="gantt-timeline-header">
                            ${months.map((m, i) => `
                                <div class="gantt-month ${i === todayMonthIndex ? 'current' : ''}">${m.label}</div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="gantt-body">
            `;
            
            disciplineSchedules.forEach(disc => {
                const isExpanded = ganttState.expandedDisciplines.has(disc.name);
                
                // Discipline row
                html += `
                    <div class="gantt-row discipline-row" onclick="toggleGanttDiscipline('${disc.name}')">
                        <div class="gantt-row-label">
                            <span class="gantt-expand-icon ${isExpanded ? 'expanded' : ''}"></span>
                            <span>${disc.name}</span>
                        </div>
                        <div class="gantt-row-timeline">
                            ${months.map((m, i) => `<div class="gantt-cell ${i === todayMonthIndex ? 'current' : ''}"></div>`).join('')}
                            <div class="gantt-bar-container">
                                ${renderGanttBar(disc, minDate, maxDate, months.length, true)}
                            </div>
                        </div>
                    </div>
                `;
                
                // Package rows
                disc.packages.forEach(pkg => {
                    html += `
                        <div class="gantt-row package-row ${isExpanded ? '' : 'hidden'}" data-discipline="${disc.name}">
                            <div class="gantt-row-label">
                                <span>${pkg.name}</span>
                            </div>
                            <div class="gantt-row-timeline">
                                ${months.map((m, i) => `<div class="gantt-cell ${i === todayMonthIndex ? 'current' : ''}"></div>`).join('')}
                                <div class="gantt-bar-container">
                                    ${renderGanttBar(pkg, minDate, maxDate, months.length, false)}
                                </div>
                            </div>
                        </div>
                    `;
                });
            });
            
            html += `
                    </div>
                </div>
                <div id="gantt-tooltip" class="gantt-tooltip"></div>
            `;
            
            container.innerHTML = html;
            
            // Add tooltip event listeners
            container.querySelectorAll('.gantt-bar').forEach(bar => {
                bar.addEventListener('mouseenter', showGanttTooltip);
                bar.addEventListener('mouseleave', hideGanttTooltip);
                bar.addEventListener('mousemove', moveGanttTooltip);
            });
        }

        /**
         * Renders a Gantt bar for a discipline or package
         */
        function renderGanttBar(item, minDate, maxDate, monthCount, isDiscipline) {
            if (!item.start || !item.end) return '';
            
            const totalDays = (maxDate - minDate) / (1000 * 60 * 60 * 24);
            const startOffset = (item.start - minDate) / (1000 * 60 * 60 * 24);
            const duration = (item.end - item.start) / (1000 * 60 * 60 * 24);
            
            const leftPercent = (startOffset / totalDays) * 100;
            const widthPercent = (duration / totalDays) * 100;
            
            const barClass = isDiscipline ? 'discipline-bar' : 'package-bar';
            const label = isDiscipline ? item.name : `${item.claiming}%`;
            
            const startStr = item.start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const endStr = item.end.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const durationDays = Math.ceil(duration);
            
            return `
                <div class="gantt-bar ${barClass}" 
                     style="left: ${leftPercent}%; width: ${Math.max(widthPercent, 2)}%;"
                     data-name="${item.name}"
                     data-start="${startStr}"
                     data-end="${endStr}"
                     data-duration="${durationDays}"
                     data-budget="${item.budget || ''}"
                     data-claiming="${item.claiming || ''}"
                     data-is-discipline="${isDiscipline}">
                    ${widthPercent > 8 ? label : ''}
                </div>
            `;
        }

        /**
         * Toggles a discipline's expanded state in the Gantt chart
         */
        function toggleGanttDiscipline(discipline) {
            if (ganttState.expandedDisciplines.has(discipline)) {
                ganttState.expandedDisciplines.delete(discipline);
            } else {
                ganttState.expandedDisciplines.add(discipline);
            }
            
            // Toggle visibility of package rows
            document.querySelectorAll(`.package-row[data-discipline="${discipline}"]`).forEach(row => {
                row.classList.toggle('hidden');
            });
            
            // Toggle expand icon
            const discRow = document.querySelector(`.discipline-row .gantt-row-label span:last-child`);
            document.querySelectorAll('.discipline-row').forEach(row => {
                const label = row.querySelector('.gantt-row-label span:last-child');
                if (label && label.textContent === discipline) {
                    const icon = row.querySelector('.gantt-expand-icon');
                    icon.classList.toggle('expanded');
                }
            });
        }

        /**
         * Expands all disciplines in the Gantt chart
         */
        function expandAllGantt() {
            projectData.disciplines.forEach(disc => {
                ganttState.expandedDisciplines.add(disc);
            });
            document.querySelectorAll('.package-row').forEach(row => row.classList.remove('hidden'));
            document.querySelectorAll('.gantt-expand-icon').forEach(icon => icon.classList.add('expanded'));
        }

        /**
         * Collapses all disciplines in the Gantt chart
         */
        function collapseAllGantt() {
            ganttState.expandedDisciplines.clear();
            document.querySelectorAll('.package-row').forEach(row => row.classList.add('hidden'));
            document.querySelectorAll('.gantt-expand-icon').forEach(icon => icon.classList.remove('expanded'));
        }

        /**
         * Shows the Gantt tooltip
         */
        function showGanttTooltip(e) {
            const bar = e.target;
            const tooltip = document.getElementById('gantt-tooltip');
            const isDiscipline = bar.dataset.isDiscipline === 'true';
            
            let content = `<div class="gantt-tooltip-title">${bar.dataset.name}</div>`;
            content += `<div class="gantt-tooltip-row"><span class="gantt-tooltip-label">Start:</span> ${bar.dataset.start}</div>`;
            content += `<div class="gantt-tooltip-row"><span class="gantt-tooltip-label">End:</span> ${bar.dataset.end}</div>`;
            content += `<div class="gantt-tooltip-row"><span class="gantt-tooltip-label">Duration:</span> ${bar.dataset.duration} days</div>`;
            
            if (isDiscipline && bar.dataset.budget) {
                content += `<div class="gantt-tooltip-row"><span class="gantt-tooltip-label">Budget:</span> ${formatCurrency(parseFloat(bar.dataset.budget))}</div>`;
            }
            
            if (!isDiscipline && bar.dataset.claiming) {
                content += `<div class="gantt-tooltip-row"><span class="gantt-tooltip-label">Claiming:</span> ${bar.dataset.claiming}%</div>`;
            }
            
            tooltip.innerHTML = content;
            tooltip.classList.add('visible');
        }

        /**
         * Hides the Gantt tooltip
         */
        function hideGanttTooltip() {
            document.getElementById('gantt-tooltip').classList.remove('visible');
        }

        /**
         * Moves the Gantt tooltip with the cursor
         */
        function moveGanttTooltip(e) {
            const tooltip = document.getElementById('gantt-tooltip');
            const container = document.getElementById('gantt-container');
            const containerRect = container.getBoundingClientRect();
            
            let x = e.clientX - containerRect.left + 15;
            let y = e.clientY - containerRect.top - 10;
            
            // Keep tooltip within container
            const tooltipRect = tooltip.getBoundingClientRect();
            if (x + tooltipRect.width > containerRect.width) {
                x = e.clientX - containerRect.left - tooltipRect.width - 15;
            }
            
            tooltip.style.left = x + 'px';
            tooltip.style.top = y + 'px';
        }

        // ============================================
        // AI CHAT ASSISTANT
        // ============================================

        const chatState = {
            isOpen: false,
            messages: [],
            isLoading: false,
            isDragging: false,
            dragOffset: { x: 0, y: 0 }
        };

        const STEP_NAMES = {
            1: 'Phases',
            2: 'Disciplines', 
            3: 'Packages',
            4: 'Budget',
            5: 'Claiming',
            6: 'Schedule'
        };

        const STEP_DESCRIPTIONS = {
            1: 'Define project phases (e.g., Base, ESDC, TSCD). These represent major project milestones or stages.',
            2: 'Select engineering disciplines involved in the project (e.g., Structures, Civil, Traffic).',
            3: 'Define deliverable packages/milestones (e.g., Preliminary, Interim, Final, RFC).',
            4: 'Set the total budget allocation per discipline. Use the cost estimator to calculate based on construction cost and industry standards.',
            5: 'Set claiming percentages per package for each discipline. Must total 100% per discipline.',
            6: 'Set start and end dates for each package delivery.'
        };

        /**
         * Gathers current application context for the AI assistant
         * @returns {object} Context object with current state information
         */
        function getChatContext() {
            const resultsVisible = !document.getElementById('results-section').classList.contains('hidden');
            
            let context = {
                currentView: resultsVisible ? 'Results/WBS View' : `Step ${currentStep}: ${STEP_NAMES[currentStep]}`,
                stepDescription: resultsVisible ? 'Viewing generated WBS table, Gantt chart, KPIs, and performance chart.' : STEP_DESCRIPTIONS[currentStep],
                projectData: {
                    phases: projectData.phases.length > 0 ? projectData.phases : ['(not yet defined)'],
                    disciplines: projectData.disciplines.length > 0 ? projectData.disciplines : ['(not yet selected)'],
                    packages: projectData.packages.length > 0 ? projectData.packages : ['(not yet defined)'],
                    totalBudget: formatCurrency(calculateTotalBudget()),
                    budgetsByDiscipline: projectData.budgets,
                    claimingScheme: projectData.claiming,
                    scheduleDates: projectData.dates
                }
            };

            // Add results-specific context when viewing WBS output
            if (resultsVisible) {
                context.wbsResults = generateWBSDataForChat();
            }

            // Add step-specific context
            if (!resultsVisible) {
                switch (currentStep) {
                    case 4:
                        context.calculatorSettings = {
                            constructionCost: document.getElementById('calc-construction-cost')?.value || 0,
                            designFeePercent: document.getElementById('calc-design-fee-pct')?.value || 15,
                            projectType: document.getElementById('calc-project-type')?.value || 'Highway/Roadway',
                            complexity: document.getElementById('calc-global-complexity')?.value || 'Medium'
                        };
                        break;
                    case 5:
                        // Check claiming totals
                        const claimingTotals = {};
                        projectData.disciplines.forEach(disc => {
                            let total = 0;
                            projectData.packages.forEach(pkg => {
                                total += projectData.claiming[`${disc}-${pkg}`] || 0;
                            });
                            claimingTotals[disc] = total;
                        });
                        context.claimingTotals = claimingTotals;
                        break;
                }
            }

            return context;
        }

        /**
         * Generates structured WBS data for the chatbot
         * @returns {object} WBS results data
         */
        function generateWBSDataForChat() {
            const wbsElements = [];
            let grandTotal = 0;
            let minDate = null, maxDate = null;
            
            // Generate all WBS elements
            projectData.phases.forEach((phase, pi) => {
                projectData.disciplines.forEach((discipline, di) => {
                    const discBudget = projectData.budgets[discipline] || 0;
                    let discMinDate = null, discMaxDate = null;
                    
                    projectData.packages.forEach((pkg, ki) => {
                        const key = `${discipline}-${pkg}`;
                        const claimPct = projectData.claiming[key] || 0;
                        const pkgBudget = discBudget * (claimPct / 100);
                        const dates = projectData.dates[key] || { start: null, end: null };
                        
                        grandTotal += pkgBudget;
                        
                        // Track dates
                        if (dates.start) {
                            if (!minDate || dates.start < minDate) minDate = dates.start;
                            if (!discMinDate || dates.start < discMinDate) discMinDate = dates.start;
                        }
                        if (dates.end) {
                            if (!maxDate || dates.end > maxDate) maxDate = dates.end;
                            if (!discMaxDate || dates.end > discMaxDate) discMaxDate = dates.end;
                        }
                        
                        wbsElements.push({
                            wbs: `${pi+1}.${di+1}.${ki+1}`,
                            phase,
                            discipline,
                            package: pkg,
                            budget: pkgBudget,
                            claimPercent: claimPct,
                            startDate: dates.start || 'Not set',
                            endDate: dates.end || 'Not set'
                        });
                    });
                });
            });
            
            // Calculate discipline summaries
            const disciplineSummaries = projectData.disciplines.map(disc => {
                const budget = projectData.budgets[disc] || 0;
                const percentage = grandTotal > 0 ? ((budget / grandTotal) * 100).toFixed(1) : 0;
                
                // Get date range for discipline
                let discStart = null, discEnd = null;
                projectData.packages.forEach(pkg => {
                    const key = `${disc}-${pkg}`;
                    const dates = projectData.dates[key];
                    if (dates) {
                        if (dates.start && (!discStart || dates.start < discStart)) discStart = dates.start;
                        if (dates.end && (!discEnd || dates.end > discEnd)) discEnd = dates.end;
                    }
                });
                
                return {
                    name: disc,
                    totalBudget: budget,
                    percentOfTotal: percentage + '%',
                    startDate: discStart || 'Not set',
                    endDate: discEnd || 'Not set',
                    packageCount: projectData.packages.length
                };
            });
            
            // Calculate project duration
            let projectDuration = 0;
            if (minDate && maxDate) {
                projectDuration = Math.ceil((new Date(maxDate) - new Date(minDate)) / (1000 * 60 * 60 * 24));
            }
            
            return {
                kpis: {
                    totalBudget: formatCurrency(grandTotal),
                    totalBudgetRaw: grandTotal,
                    wbsElementCount: wbsElements.length,
                    disciplineCount: projectData.disciplines.length,
                    phaseCount: projectData.phases.length,
                    packageCount: projectData.packages.length,
                    projectStartDate: minDate || 'Not set',
                    projectEndDate: maxDate || 'Not set',
                    projectDurationDays: projectDuration,
                    projectDurationMonths: Math.ceil(projectDuration / 30)
                },
                disciplineSummaries,
                        wbsElements: wbsElements, // Include all elements
                        totalWbsElements: wbsElements.length,
                        // Include raw data for calculations
                        rawData: {
                            grandTotal,
                            claiming: projectData.claiming,
                            dates: projectData.dates,
                            budgets: projectData.budgets
                        }
            };
        }

        /**
         * Builds the system prompt for the AI assistant
         * @returns {string} System prompt with context
         */
        function buildSystemPrompt() {
            const context = getChatContext();
            
            let prompt = `You are a helpful AI assistant embedded in WBS Terminal v1.0, a Work Breakdown Structure (WBS) generator for engineering projects.

## Your Role
- Help users understand and use the current screen/step they're viewing
- Answer questions about WBS concepts, engineering project planning, and budgeting
- Provide guidance specific to their current context and data
- Perform calculations, forecasting, and analysis when asked
- Be concise but thorough; use bullet points for lists
- Reference specific values from their project when relevant
- When on the Results page, you have FULL ACCESS to all project data for detailed analysis

## Current User Context
**View:** ${context.currentView}
**Description:** ${context.stepDescription}

## Project Data
- **Phases:** ${context.projectData.phases.join(', ')}
- **Disciplines:** ${context.projectData.disciplines.join(', ')}
- **Packages:** ${context.projectData.packages.join(', ')}
- **Total Budget:** ${context.projectData.totalBudget}
${Object.keys(context.projectData.budgetsByDiscipline).length > 0 ? `- **Budget Breakdown:** ${Object.entries(context.projectData.budgetsByDiscipline).map(([k, v]) => `${k}: ${formatCurrency(v)}`).join(', ')}` : ''}
`;

            // Add project scope if available
            if (projectData.projectScope) {
                prompt += `
## PROJECT SCOPE
${projectData.projectScope}
`;
            }
            
            // Add schedule notes if available
            if (projectData.scheduleNotes) {
                prompt += `
## SCHEDULE NOTES
${projectData.scheduleNotes}
`;
            }

            // Add WBS Results data when on results page
            if (context.wbsResults) {
                const r = context.wbsResults;
                prompt += `
## PROJECT KPIs (Generated Results)
- **Total Project Budget:** ${r.kpis.totalBudget} (raw: $${r.rawData.grandTotal.toFixed(2)})
- **Total WBS Elements:** ${r.kpis.wbsElementCount}
- **Disciplines:** ${r.kpis.disciplineCount}
- **Phases:** ${r.kpis.phaseCount}
- **Packages per Discipline:** ${r.kpis.packageCount}
- **Project Start Date:** ${r.kpis.projectStartDate}
- **Project End Date:** ${r.kpis.projectEndDate}
- **Project Duration:** ${r.kpis.projectDurationDays} days (~${r.kpis.projectDurationMonths} months)

## DISCIPLINE BREAKDOWN (with Scope of Work)
${r.disciplineSummaries.map(d => {
    const scope = projectData.disciplineScopes && projectData.disciplineScopes[d.name] ? projectData.disciplineScopes[d.name] : 'No scope defined';
    const rawBudget = projectData.budgets[d.name] || 0;
    return `### ${d.name}
- Budget: ${formatCurrency(d.totalBudget)} (raw: $${rawBudget})
- Percentage: ${d.percentOfTotal} of total
- Timeline: ${d.startDate} to ${d.endDate}
- Packages: ${d.packageCount}
- Scope: ${scope}`;
}).join('\n\n')}

## COMPLETE CLAIMING PERCENTAGES (Discipline  Package  %)
${projectData.disciplines.map(disc => {
    const claims = projectData.packages.map(pkg => {
        const key = `${disc}-${pkg}`;
        return `${pkg}: ${projectData.claiming[key] || 0}%`;
    }).join(', ');
    return `- ${disc}: ${claims}`;
}).join('\n')}

## COMPLETE DATE SCHEDULE (Discipline  Package  Start/End)
${projectData.disciplines.map(disc => {
    const dates = projectData.packages.map(pkg => {
        const key = `${disc}-${pkg}`;
        const d = projectData.dates[key] || {};
        return `${pkg}: ${d.start || 'N/A'} to ${d.end || 'N/A'}`;
    }).join('; ');
    return `- ${disc}: ${dates}`;
}).join('\n')}

## ALL WBS ELEMENTS (${r.totalWbsElements} total)
Format: WBS | Phase | Discipline | Package | Budget | Claim% | Start | End
${r.wbsElements.map(w => `${w.wbs} | ${w.phase} | ${w.discipline} | ${w.package} | $${w.budget.toFixed(2)} | ${w.claimPercent}% | ${w.startDate} | ${w.endDate}`).join('\n')}

## RAW BUDGET DATA (for calculations)
${Object.entries(projectData.budgets).map(([disc, budget]) => `${disc}: $${budget}`).join('\n')}

## ANALYSIS CAPABILITIES
You can help with:
- Budget breakdowns by discipline, phase, or package
- Schedule analysis (overlaps, critical path, gaps)
- Forecasting (burn rate, monthly spend, cash flow)
- Comparisons between disciplines
- Claiming percentage analysis
- What-if scenarios (e.g., "what if we increase Civil by 10%?")
- Monthly/quarterly cost distribution
- Resource loading analysis
- Risk identification based on schedule/budget
- Earned value calculations (if given actuals)
`;
            } else {
                prompt += `
## Application Overview (6-Step Wizard)
1. **PHASES** - Define project phases (Base, ESDC, TSCD, etc.)
2. **DISCIPLINES** - Select engineering disciplines (Structures, Civil, Traffic, etc.)
3. **PACKAGES** - Define deliverable milestones (Preliminary, Interim, Final, RFC)
4. **BUDGET** - Set budget per discipline; includes cost estimator with industry percentages
5. **CLAIMING** - Set claiming % per package (must total 100% per discipline)
6. **SCHEDULE** - Set start/end dates for each package

## Tips for Each Step
- Step 1: Phases should represent major project stages or milestones
- Step 2: Select all disciplines that will have budget allocations
- Step 3: Packages are typically deliverable milestones (30%, 60%, 90%, Final)
- Step 4: Use the cost estimator to calculate budgets based on construction cost and industry standards
- Step 5: Claiming percentages determine how budget is distributed across packages; must sum to 100%
- Step 6: Dates help generate the project schedule and performance charts
`;
            }

            if (context.calculatorSettings) {
                prompt += `
## Current Calculator Settings
- Construction Cost: $${parseInt(context.calculatorSettings.constructionCost).toLocaleString()}
- Design Fee: ${context.calculatorSettings.designFeePercent}%
- Project Type: ${context.calculatorSettings.projectType}
- Complexity: ${context.calculatorSettings.complexity}
`;
            }

            if (context.claimingTotals) {
                prompt += `
## Claiming Status
${Object.entries(context.claimingTotals).map(([disc, total]) => `- ${disc}: ${total}% ${total === 100 ? '' : `(needs ${100 - total}% more)`}`).join('\n')}
`;
            }

            prompt += `
Be helpful, friendly, and context-aware. When users are on the Results page, you have access to all the generated WBS data and can answer specific questions about budgets, schedules, disciplines, and packages.`;

            return prompt;
        }

        /**
         * Toggles the chat panel open/closed
         */
        function toggleChat() {
            chatState.isOpen = !chatState.isOpen;
            const panel = document.getElementById('chat-panel');
            const fab = document.getElementById('chat-fab');
            
            panel.classList.toggle('open', chatState.isOpen);
            fab.classList.remove('has-unread');
            
            if (chatState.isOpen && chatState.messages.length === 0) {
                // Check for API key first
                if (!localStorage.getItem('wbs_openai_key')) {
                    showApiKeyModal();
                } else {
                    addWelcomeMessage();
                }
            }
            
            if (chatState.isOpen) {
                setTimeout(() => {
                    document.getElementById('chat-input').focus();
                }, 300);
            }
        }

        /**
         * Adds the initial welcome message
         */
        function addWelcomeMessage() {
            const context = getChatContext();
            const resultsVisible = !document.getElementById('results-section').classList.contains('hidden');
            
            if (resultsVisible) {
                addMessage('assistant', ` Hi! I'm your WBS Terminal assistant. You're viewing the **Generated WBS Results**.\n\nI can **analyze your data** and **make changes** using natural language:\n\n** Analysis:**\n "Which discipline has the highest budget?"\n "Compare Civil vs Structures budgets"\n "Run a what-if scenario if we cut Traffic by 20%"\n\n** Editing (I can do this!):**\n "Add $50,000 to Structures budget"\n "Transfer 10% from Civil to Drainage"\n "Add a new QA/QC discipline with $75,000"\n "Extend all Final packages by 2 weeks"\n\nWhat would you like to do?`);
            } else {
                addMessage('assistant', ` Hi! I'm your WBS Terminal assistant. You're currently on **${context.currentView}**.\n\nAsk me anything about:\n This step and what to do\n Your project data\n WBS concepts & best practices\n\n **Tip:** Generate your WBS first, then I can help you edit budgets and schedules using natural language!\n\nHow can I help?`);
            }
        }

        /**
         * Shows the API key configuration modal
         */
        function showApiKeyModal() {
            document.getElementById('chat-api-modal').classList.add('open');
            document.getElementById('api-key-input').focus();
        }

        /**
         * Hides the API key modal
         */
        function hideApiKeyModal() {
            document.getElementById('chat-api-modal').classList.remove('open');
        }

        /**
         * Saves the API key to localStorage
         */
        function saveApiKey() {
            const key = document.getElementById('api-key-input').value.trim();
            if (key) {
                localStorage.setItem('wbs_openai_key', key);
                hideApiKeyModal();
                addWelcomeMessage();
            }
        }

        /**
         * Opens settings to change API key
         */
        function openChatSettings() {
            document.getElementById('api-key-input').value = localStorage.getItem('wbs_openai_key') || '';
            showApiKeyModal();
        }

        /**
         * Clears chat history
         */
        function clearChat() {
            chatState.messages = [];
            renderMessages();
            addWelcomeMessage();
        }

        /**
         * Resets chat panel to default position
         */
        function resetChatPosition() {
            const panel = document.getElementById('chat-panel');
            panel.style.right = '24px';
            panel.style.bottom = '96px';
            panel.style.left = 'auto';
            panel.style.top = 'auto';
            localStorage.removeItem('wbs_chat_position');
        }

        /**
         * Loads saved chat position from localStorage
         */
        function loadChatPosition() {
            const saved = localStorage.getItem('wbs_chat_position');
            if (saved) {
                try {
                    const pos = JSON.parse(saved);
                    const panel = document.getElementById('chat-panel');
                    // Validate position is still on screen
                    const maxX = window.innerWidth - 100;
                    const maxY = window.innerHeight - 100;
                    if (pos.x >= 0 && pos.x <= maxX && pos.y >= 0 && pos.y <= maxY) {
                        panel.style.left = pos.x + 'px';
                        panel.style.top = pos.y + 'px';
                        panel.style.right = 'auto';
                        panel.style.bottom = 'auto';
                    }
                } catch (e) {
                    // Invalid saved position, ignore
                }
            }
        }

        /**
         * Saves chat position to localStorage
         */
        function saveChatPosition() {
            const panel = document.getElementById('chat-panel');
            const rect = panel.getBoundingClientRect();
            localStorage.setItem('wbs_chat_position', JSON.stringify({
                x: rect.left,
                y: rect.top
            }));
        }

        /**
         * Handles mouse down on chat header for dragging
         * @param {MouseEvent} e
         */
        function handleChatDragStart(e) {
            // Don't drag if clicking on buttons
            if (e.target.closest('.chat-header-btn') || e.target.closest('.chat-header-actions')) {
                return;
            }
            
            const panel = document.getElementById('chat-panel');
            const rect = panel.getBoundingClientRect();
            
            chatState.isDragging = true;
            chatState.dragOffset = {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top
            };
            
            panel.classList.add('dragging');
            document.addEventListener('mousemove', handleChatDrag);
            document.addEventListener('mouseup', handleChatDragEnd);
            e.preventDefault();
        }

        /**
         * Handles mouse move during drag
         * @param {MouseEvent} e
         */
        function handleChatDrag(e) {
            if (!chatState.isDragging) return;
            
            const panel = document.getElementById('chat-panel');
            const panelRect = panel.getBoundingClientRect();
            
            let newX = e.clientX - chatState.dragOffset.x;
            let newY = e.clientY - chatState.dragOffset.y;
            
            // Constrain to viewport
            const minX = 0;
            const minY = 0;
            const maxX = window.innerWidth - panelRect.width;
            const maxY = window.innerHeight - panelRect.height;
            
            newX = Math.max(minX, Math.min(newX, maxX));
            newY = Math.max(minY, Math.min(newY, maxY));
            
            panel.style.left = newX + 'px';
            panel.style.top = newY + 'px';
            panel.style.right = 'auto';
            panel.style.bottom = 'auto';
        }

        /**
         * Handles mouse up to end drag
         * @param {MouseEvent} e
         */
        function handleChatDragEnd(e) {
            if (!chatState.isDragging) return;
            
            chatState.isDragging = false;
            const panel = document.getElementById('chat-panel');
            panel.classList.remove('dragging');
            
            document.removeEventListener('mousemove', handleChatDrag);
            document.removeEventListener('mouseup', handleChatDragEnd);
            
            saveChatPosition();
        }

        /**
         * Initializes chat drag functionality
         */
        function initChatDrag() {
            const header = document.querySelector('.chat-header');
            if (header) {
                header.addEventListener('mousedown', handleChatDragStart);
            }
            loadChatPosition();
        }

        // Initialize drag when DOM is ready
        document.addEventListener('DOMContentLoaded', initChatDrag);

        /**
         * Adds a message to the chat
         * @param {string} role - 'user', 'assistant', or 'system'
         * @param {string} content - Message content
         */
        function addMessage(role, content) {
            chatState.messages.push({ role, content });
            renderMessages();
        }

        /**
         * Updates the last message in place (for streaming)
         * @param {string} content - The updated content
         */
        function updateLastMessage(content) {
            if (chatState.messages.length > 0) {
                chatState.messages[chatState.messages.length - 1].content = content;
                renderMessages();
            }
        }

        /**
         * Adds a streaming message placeholder
         * @param {string} role - The role of the message
         * @returns {number} Index of the added message
         */
        function addStreamingMessage(role) {
            chatState.messages.push({ role, content: '' });
            renderMessages();
            return chatState.messages.length - 1;
        }

        /**
         * Renders all chat messages
         */
        function renderMessages() {
            const container = document.getElementById('chat-messages');
            container.innerHTML = chatState.messages.map((msg, idx) => {
                const formattedContent = msg.content
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/`(.*?)`/g, '<code>$1</code>')
                    .replace(/\n/g, '<br>')
                    .replace(/ /g, '&bull; ');
                const isStreaming = idx === chatState.messages.length - 1 && chatState.isLoading && msg.role === 'assistant';
                const streamingClass = isStreaming ? ' streaming' : '';
                return `<div class="chat-message ${msg.role}${streamingClass}">${formattedContent || '<span class="streaming-cursor"></span>'}</div>`;
            }).join('');
            
            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        /**
         * Shows/hides the typing indicator
         * @param {boolean} show - Whether to show the indicator
         */
        function showTypingIndicator(show) {
            const container = document.getElementById('chat-messages');
            const existing = container.querySelector('.chat-typing');
            
            if (show && !existing) {
                container.insertAdjacentHTML('beforeend', '<div class="chat-typing"><span></span><span></span><span></span></div>');
                container.scrollTop = container.scrollHeight;
            } else if (!show && existing) {
                existing.remove();
            }
        }

        // ============================================
        // NATURAL LANGUAGE WBS EDITING (TOOL CALLING)
        // ============================================

        /**
         * Tool definitions for OpenAI function calling
         */
        const chatTools = [
            {
                type: "function",
                function: {
                    name: "adjust_budget",
                    description: "Adjust a discipline's budget by setting a new amount or modifying by a percentage or fixed amount",
                    parameters: {
                        type: "object",
                        properties: {
                            discipline: {
                                type: "string",
                                description: "The name of the discipline to adjust (e.g., 'Structures', 'Civil')"
                            },
                            action: {
                                type: "string",
                                enum: ["set", "increase", "decrease", "transfer"],
                                description: "The type of adjustment: set absolute value, increase, decrease, or transfer to another discipline"
                            },
                            amount: {
                                type: "number",
                                description: "The amount to adjust (in dollars, or percentage if is_percentage is true)"
                            },
                            is_percentage: {
                                type: "boolean",
                                description: "If true, the amount is a percentage; if false, it's a dollar amount"
                            },
                            target_discipline: {
                                type: "string",
                                description: "For transfer action only: the discipline to transfer funds to"
                            }
                        },
                        required: ["discipline", "action", "amount"]
                    }
                }
            },
            {
                type: "function",
                function: {
                    name: "add_discipline",
                    description: "Add a new discipline to the project",
                    parameters: {
                        type: "object",
                        properties: {
                            name: {
                                type: "string",
                                description: "Name of the new discipline"
                            },
                            budget: {
                                type: "number",
                                description: "Initial budget for the discipline"
                            }
                        },
                        required: ["name"]
                    }
                }
            },
            {
                type: "function",
                function: {
                    name: "remove_discipline",
                    description: "Remove a discipline from the project",
                    parameters: {
                        type: "object",
                        properties: {
                            discipline: {
                                type: "string",
                                description: "Name of the discipline to remove"
                            }
                        },
                        required: ["discipline"]
                    }
                }
            },
            {
                type: "function",
                function: {
                    name: "modify_schedule",
                    description: "Modify the schedule dates for a discipline or package",
                    parameters: {
                        type: "object",
                        properties: {
                            discipline: {
                                type: "string",
                                description: "The discipline to modify (or 'all' for all disciplines)"
                            },
                            package: {
                                type: "string",
                                description: "The package to modify (or 'all' for all packages)"
                            },
                            action: {
                                type: "string",
                                enum: ["extend", "shorten", "shift", "set_start", "set_end"],
                                description: "Type of schedule modification"
                            },
                            days: {
                                type: "integer",
                                description: "Number of days to adjust (positive or negative)"
                            },
                            date: {
                                type: "string",
                                description: "For set_start/set_end: the new date (YYYY-MM-DD format)"
                            }
                        },
                        required: ["discipline", "action"]
                    }
                }
            },
            {
                type: "function",
                function: {
                    name: "run_what_if",
                    description: "Run a what-if scenario analysis showing impacts of proposed changes",
                    parameters: {
                        type: "object",
                        properties: {
                            scenario_description: {
                                type: "string",
                                description: "Description of the scenario to analyze"
                            },
                            changes: {
                                type: "array",
                                description: "List of proposed changes to analyze",
                                items: {
                                    type: "object",
                                    properties: {
                                        discipline: { type: "string" },
                                        budget_change: { type: "number" },
                                        is_percentage: { type: "boolean" }
                                    }
                                }
                            }
                        },
                        required: ["scenario_description"]
                    }
                }
            },
            {
                type: "function",
                function: {
                    name: "get_project_summary",
                    description: "Get detailed project statistics and KPIs",
                    parameters: {
                        type: "object",
                        properties: {
                            include_details: {
                                type: "boolean",
                                description: "Whether to include detailed breakdowns"
                            }
                        }
                    }
                }
            }
        ];

        /**
         * Executes a tool call and returns the result
         * @param {string} name - Tool function name
         * @param {object} args - Tool arguments
         * @returns {object} Result of the tool execution
         */
        function executeToolCall(name, args) {
            try {
                switch (name) {
                    case 'adjust_budget':
                        return executeAdjustBudget(args);
                    case 'add_discipline':
                        return executeAddDiscipline(args);
                    case 'remove_discipline':
                        return executeRemoveDiscipline(args);
                    case 'modify_schedule':
                        return executeModifySchedule(args);
                    case 'run_what_if':
                        return executeWhatIf(args);
                    case 'get_project_summary':
                        return executeGetProjectSummary(args);
                    default:
                        return { success: false, error: `Unknown tool: ${name}` };
                }
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        /**
         * Adjusts a discipline's budget
         */
        function executeAdjustBudget(args) {
            const { discipline, action, amount, is_percentage, target_discipline } = args;
            
            // Find the discipline (case-insensitive)
            const discKey = Object.keys(projectData.budgets).find(
                d => d.toLowerCase() === discipline.toLowerCase()
            );
            
            if (!discKey && action !== 'set') {
                return { success: false, error: `Discipline "${discipline}" not found in project` };
            }
            
            const currentBudget = projectData.budgets[discKey] || 0;
            let newBudget = currentBudget;
            let changeAmount = is_percentage ? (currentBudget * amount / 100) : amount;
            
            switch (action) {
                case 'set':
                    newBudget = amount;
                    changeAmount = amount - currentBudget;
                    break;
                case 'increase':
                    newBudget = currentBudget + changeAmount;
                    break;
                case 'decrease':
                    newBudget = Math.max(0, currentBudget - changeAmount);
                    changeAmount = currentBudget - newBudget;
                    break;
                case 'transfer':
                    if (!target_discipline) {
                        return { success: false, error: 'Target discipline required for transfer' };
                    }
                    const targetKey = Object.keys(projectData.budgets).find(
                        d => d.toLowerCase() === target_discipline.toLowerCase()
                    );
                    if (!targetKey) {
                        return { success: false, error: `Target discipline "${target_discipline}" not found` };
                    }
                    const transferAmt = is_percentage ? (currentBudget * amount / 100) : amount;
                    projectData.budgets[discKey] = currentBudget - transferAmt;
                    projectData.budgets[targetKey] = (projectData.budgets[targetKey] || 0) + transferAmt;
                    triggerAutosave();
                    return {
                        success: true,
                        message: `Transferred $${formatNumberShort(transferAmt)} from ${discKey} to ${targetKey}`,
                        changes: {
                            [discKey]: { from: currentBudget, to: projectData.budgets[discKey] },
                            [targetKey]: { from: projectData.budgets[targetKey] - transferAmt, to: projectData.budgets[targetKey] }
                        }
                    };
            }
            
            if (discKey) {
                projectData.budgets[discKey] = newBudget;
            } else {
                // Adding new discipline with set action
                projectData.budgets[discipline] = newBudget;
                if (!projectData.disciplines.includes(discipline)) {
                    projectData.disciplines.push(discipline);
                }
            }
            
            triggerAutosave();
            
            return {
                success: true,
                message: `${action === 'set' ? 'Set' : action === 'increase' ? 'Increased' : 'Decreased'} ${discKey || discipline} budget`,
                changes: {
                    discipline: discKey || discipline,
                    previous: currentBudget,
                    new: newBudget,
                    difference: newBudget - currentBudget
                },
                newTotalBudget: Object.values(projectData.budgets).reduce((sum, b) => sum + b, 0)
            };
        }

        /**
         * Adds a new discipline to the project
         */
        function executeAddDiscipline(args) {
            const { name, budget = 0 } = args;
            
            // Check if discipline already exists
            const exists = projectData.disciplines.some(
                d => d.toLowerCase() === name.toLowerCase()
            );
            
            if (exists) {
                return { success: false, error: `Discipline "${name}" already exists` };
            }
            
            // Add discipline
            projectData.disciplines.push(name);
            projectData.budgets[name] = budget;
            
            // Initialize claiming for new discipline
            projectData.packages.forEach((pkg, i) => {
                const key = `${name}-${pkg}`;
                const claimPerPackage = Math.floor(100 / projectData.packages.length);
                const remainder = 100 - (claimPerPackage * projectData.packages.length);
                projectData.claiming[key] = claimPerPackage + (i === projectData.packages.length - 1 ? remainder : 0);
            });
            
            // Initialize dates
            const today = new Date();
            projectData.packages.forEach((pkg, i) => {
                const key = `${name}-${pkg}`;
                const startDate = new Date(today);
                startDate.setDate(startDate.getDate() + i * 30);
                const endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + 28);
                projectData.dates[key] = {
                    start: startDate.toISOString().split('T')[0],
                    end: endDate.toISOString().split('T')[0]
                };
            });
            
            triggerAutosave();
            
            return {
                success: true,
                message: `Added discipline "${name}" with budget $${formatNumberShort(budget)}`,
                discipline: name,
                budget: budget,
                totalDisciplines: projectData.disciplines.length
            };
        }

        /**
         * Removes a discipline from the project
         */
        function executeRemoveDiscipline(args) {
            const { discipline } = args;
            
            const idx = projectData.disciplines.findIndex(
                d => d.toLowerCase() === discipline.toLowerCase()
            );
            
            if (idx === -1) {
                return { success: false, error: `Discipline "${discipline}" not found` };
            }
            
            const discName = projectData.disciplines[idx];
            const removedBudget = projectData.budgets[discName] || 0;
            
            // Remove discipline
            projectData.disciplines.splice(idx, 1);
            delete projectData.budgets[discName];
            
            // Remove claiming and dates entries
            Object.keys(projectData.claiming).forEach(key => {
                if (key.startsWith(`${discName}-`)) {
                    delete projectData.claiming[key];
                }
            });
            Object.keys(projectData.dates).forEach(key => {
                if (key.startsWith(`${discName}-`)) {
                    delete projectData.dates[key];
                }
            });
            
            triggerAutosave();
            
            return {
                success: true,
                message: `Removed discipline "${discName}" (freed $${formatNumberShort(removedBudget)})`,
                removedBudget: removedBudget,
                remainingDisciplines: projectData.disciplines.length
            };
        }

        /**
         * Modifies schedule dates
         */
        function executeModifySchedule(args) {
            const { discipline, package: pkg, action, days, date } = args;
            let modified = 0;
            const changes = [];
            
            // Build list of keys to modify
            const keysToModify = [];
            if (discipline.toLowerCase() === 'all') {
                projectData.disciplines.forEach(d => {
                    if (pkg && pkg.toLowerCase() !== 'all') {
                        keysToModify.push(`${d}-${pkg}`);
                    } else {
                        projectData.packages.forEach(p => keysToModify.push(`${d}-${p}`));
                    }
                });
            } else {
                const discName = projectData.disciplines.find(
                    d => d.toLowerCase() === discipline.toLowerCase()
                );
                if (!discName) {
                    return { success: false, error: `Discipline "${discipline}" not found` };
                }
                if (pkg && pkg.toLowerCase() !== 'all') {
                    keysToModify.push(`${discName}-${pkg}`);
                } else {
                    projectData.packages.forEach(p => keysToModify.push(`${discName}-${p}`));
                }
            }
            
            keysToModify.forEach(key => {
                if (!projectData.dates[key]) return;
                
                const dates = projectData.dates[key];
                const startDate = new Date(dates.start);
                const endDate = new Date(dates.end);
                
                switch (action) {
                    case 'extend':
                        endDate.setDate(endDate.getDate() + (days || 7));
                        break;
                    case 'shorten':
                        endDate.setDate(endDate.getDate() - (days || 7));
                        break;
                    case 'shift':
                        startDate.setDate(startDate.getDate() + (days || 0));
                        endDate.setDate(endDate.getDate() + (days || 0));
                        break;
                    case 'set_start':
                        if (date) {
                            const newStart = new Date(date);
                            const duration = (endDate - startDate) / (1000 * 60 * 60 * 24);
                            startDate.setTime(newStart.getTime());
                            endDate.setTime(newStart.getTime() + duration * 24 * 60 * 60 * 1000);
                        }
                        break;
                    case 'set_end':
                        if (date) {
                            endDate.setTime(new Date(date).getTime());
                        }
                        break;
                }
                
                projectData.dates[key] = {
                    start: startDate.toISOString().split('T')[0],
                    end: endDate.toISOString().split('T')[0]
                };
                
                modified++;
                changes.push({
                    key,
                    newStart: projectData.dates[key].start,
                    newEnd: projectData.dates[key].end
                });
            });
            
            triggerAutosave();
            
            return {
                success: true,
                message: `Modified ${modified} schedule entries`,
                action: action,
                daysChanged: days || 0,
                modifiedCount: modified,
                changes: changes.slice(0, 5) // Limit to first 5 for readability
            };
        }

        /**
         * Runs a what-if scenario analysis
         */
        function executeWhatIf(args) {
            const { scenario_description, changes = [] } = args;
            
            const currentTotal = Object.values(projectData.budgets).reduce((sum, b) => sum + b, 0);
            let projectedTotal = currentTotal;
            const impacts = [];
            
            changes.forEach(change => {
                const discKey = Object.keys(projectData.budgets).find(
                    d => d.toLowerCase() === change.discipline?.toLowerCase()
                );
                if (discKey) {
                    const current = projectData.budgets[discKey] || 0;
                    const changeAmt = change.is_percentage 
                        ? (current * change.budget_change / 100) 
                        : change.budget_change;
                    projectedTotal += changeAmt;
                    impacts.push({
                        discipline: discKey,
                        currentBudget: current,
                        projectedBudget: current + changeAmt,
                        change: changeAmt,
                        percentageChange: ((changeAmt / current) * 100).toFixed(1) + '%'
                    });
                }
            });
            
            return {
                success: true,
                scenario: scenario_description,
                currentTotalBudget: currentTotal,
                projectedTotalBudget: projectedTotal,
                netChange: projectedTotal - currentTotal,
                percentageChange: ((projectedTotal - currentTotal) / currentTotal * 100).toFixed(1) + '%',
                impacts: impacts,
                note: "This is a simulation. No changes have been applied."
            };
        }

        /**
         * Gets project summary and KPIs
         */
        function executeGetProjectSummary(args) {
            const { include_details = false } = args || {};
            
            const totalBudget = Object.values(projectData.budgets).reduce((sum, b) => sum + b, 0);
            const wbsCount = projectData.phases.length * projectData.disciplines.length * projectData.packages.length;
            
            // Find date range
            let minDate = null, maxDate = null;
            Object.values(projectData.dates).forEach(d => {
                if (d.start && (!minDate || d.start < minDate)) minDate = d.start;
                if (d.end && (!maxDate || d.end > maxDate)) maxDate = d.end;
            });
            
            const durationDays = minDate && maxDate 
                ? Math.ceil((new Date(maxDate) - new Date(minDate)) / (1000 * 60 * 60 * 24))
                : 0;
            
            const summary = {
                success: true,
                kpis: {
                    totalBudget: totalBudget,
                    formattedBudget: formatCurrencySimple(totalBudget),
                    wbsElementCount: wbsCount,
                    phaseCount: projectData.phases.length,
                    disciplineCount: projectData.disciplines.length,
                    packageCount: projectData.packages.length,
                    projectStart: minDate,
                    projectEnd: maxDate,
                    durationDays: durationDays,
                    durationMonths: Math.ceil(durationDays / 30)
                },
                phases: projectData.phases,
                disciplines: projectData.disciplines,
                packages: projectData.packages
            };
            
            if (include_details) {
                summary.budgetBreakdown = {};
                projectData.disciplines.forEach(d => {
                    summary.budgetBreakdown[d] = {
                        amount: projectData.budgets[d] || 0,
                        percentage: totalBudget > 0 
                            ? ((projectData.budgets[d] || 0) / totalBudget * 100).toFixed(1) + '%'
                            : '0%'
                    };
                });
            }
            
            return summary;
        }

        /**
         * Helper to format numbers with K/M suffix
         */
        function formatNumberShort(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(0) + 'K';
            return num.toFixed(0);
        }

        // ============================================
        // PREDICTIVE ANALYTICS / AI INSIGHTS
        // ============================================

        /**
         * Toggles the insights panel visibility
         */
        function toggleInsightsPanel() {
            const panel = document.querySelector('.insights-panel');
            const body = document.getElementById('insights-body');
            
            panel.classList.toggle('expanded');
            body.classList.toggle('hidden');
            
            // Calculate basic insights when opened for the first time
            if (!body.classList.contains('hidden')) {
                calculateBasicInsights();
            }
        }

        /**
         * Calculates basic insights without AI
         */
        function calculateBasicInsights() {
            const totalBudget = Object.values(projectData.budgets).reduce((sum, b) => sum + b, 0);
            const disciplineCount = projectData.disciplines.length;
            const packageCount = projectData.packages.length;
            
            // Risk Score Calculation
            let riskScore = 50; // Base medium
            const riskFactors = [];
            
            // Factor 1: Number of disciplines (more = more coordination risk)
            if (disciplineCount > 10) {
                riskScore += 15;
                riskFactors.push(`${disciplineCount} disciplines increases coordination complexity`);
            } else if (disciplineCount < 5) {
                riskScore -= 10;
                riskFactors.push('Manageable number of disciplines');
            }
            
            // Factor 2: Budget concentration
            const budgetValues = Object.values(projectData.budgets).filter(b => b > 0);
            if (budgetValues.length > 0) {
                const maxBudget = Math.max(...budgetValues);
                const concentration = maxBudget / totalBudget;
                if (concentration > 0.4) {
                    riskScore += 10;
                    riskFactors.push('High budget concentration in one discipline');
                }
            }
            
            // Factor 3: Schedule density
            let minDate = null, maxDate = null;
            Object.values(projectData.dates).forEach(d => {
                if (d.start && (!minDate || d.start < minDate)) minDate = d.start;
                if (d.end && (!maxDate || d.end > maxDate)) maxDate = d.end;
            });
            
            if (minDate && maxDate) {
                const durationDays = Math.ceil((new Date(maxDate) - new Date(minDate)) / (1000 * 60 * 60 * 24));
                const monthsPerMillion = durationDays / 30 / (totalBudget / 1000000);
                if (monthsPerMillion < 3) {
                    riskScore += 15;
                    riskFactors.push('Aggressive schedule relative to budget');
                }
            }
            
            // Clamp risk score
            riskScore = Math.max(0, Math.min(100, riskScore));
            
            // Determine risk level
            let riskLevel, riskClass;
            if (riskScore < 35) {
                riskLevel = 'LOW';
                riskClass = 'risk-low';
            } else if (riskScore < 65) {
                riskLevel = 'MEDIUM';
                riskClass = 'risk-medium';
            } else {
                riskLevel = 'HIGH';
                riskClass = 'risk-high';
            }
            
            // Update risk display
            const riskValue = document.getElementById('insight-risk-score');
            riskValue.textContent = riskLevel;
            riskValue.className = `insight-value ${riskClass}`;
            document.getElementById('insight-risk-details').textContent = 
                riskFactors.length > 0 ? riskFactors[0] : 'Project parameters within normal ranges';
            
            // Cost Forecast (simple projection with contingency)
            const contingencyRate = riskScore > 65 ? 0.15 : riskScore > 35 ? 0.10 : 0.05;
            const projectedCost = totalBudget * (1 + contingencyRate);
            document.getElementById('insight-cost-forecast').textContent = formatCurrencySimple(projectedCost);
            document.getElementById('insight-cost-details').textContent = 
                `Includes ${(contingencyRate * 100).toFixed(0)}% risk contingency (${formatCurrencySimple(totalBudget * contingencyRate)})`;
            
            // Schedule Forecast
            if (minDate && maxDate) {
                const today = new Date();
                const endDate = new Date(maxDate);
                const daysRemaining = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
                
                if (daysRemaining < 0) {
                    document.getElementById('insight-schedule-forecast').textContent = 'Complete';
                    document.getElementById('insight-schedule-forecast').style.color = '#4ade80';
                    document.getElementById('insight-schedule-details').textContent = 'Project end date has passed';
                } else if (daysRemaining < 30) {
                    document.getElementById('insight-schedule-forecast').textContent = 'Final Phase';
                    document.getElementById('insight-schedule-forecast').style.color = '#fbbf24';
                    document.getElementById('insight-schedule-details').textContent = `${daysRemaining} days until scheduled completion`;
                } else {
                    document.getElementById('insight-schedule-forecast').textContent = 'On Track';
                    document.getElementById('insight-schedule-forecast').style.color = '#4ade80';
                    document.getElementById('insight-schedule-details').textContent = 
                        `Completion: ${new Date(maxDate).toLocaleDateString()} (${Math.ceil(daysRemaining / 30)} months)`;
                }
            }
            
            // Budget Health Analysis
            const avgBudget = totalBudget / disciplineCount;
            const variance = budgetValues.reduce((sum, b) => sum + Math.pow(b - avgBudget, 2), 0) / budgetValues.length;
            const stdDev = Math.sqrt(variance);
            const coeffVar = stdDev / avgBudget;
            
            if (coeffVar < 0.5) {
                document.getElementById('insight-budget-health').textContent = 'Balanced';
                document.getElementById('insight-budget-health').style.color = '#4ade80';
                document.getElementById('insight-budget-details').textContent = 'Budget evenly distributed across disciplines';
            } else if (coeffVar < 1.0) {
                document.getElementById('insight-budget-health').textContent = 'Moderate';
                document.getElementById('insight-budget-health').style.color = '#fbbf24';
                document.getElementById('insight-budget-details').textContent = 'Some disciplines have significantly higher budgets';
            } else {
                document.getElementById('insight-budget-health').textContent = 'Concentrated';
                document.getElementById('insight-budget-health').style.color = '#f87171';
                document.getElementById('insight-budget-details').textContent = 'Budget heavily weighted toward few disciplines';
            }
        }

        /**
         * Generates AI-powered insights and optimization suggestions
         */
        async function generateAIInsights() {
            const apiKey = localStorage.getItem('wbs_openai_key');
            if (!apiKey) {
                alert('Please set your OpenAI API key first. Click the chat button and enter your key.');
                return;
            }
            
            const btn = document.getElementById('generate-insights-btn');
            const suggestionsList = document.getElementById('ai-suggestions-list');
            
            btn.disabled = true;
            btn.textContent = 'Analyzing...';
            suggestionsList.innerHTML = '<div class="suggestion-placeholder"> Analyzing project data with AI...</div>';
            
            try {
                const totalBudget = Object.values(projectData.budgets).reduce((sum, b) => sum + b, 0);
                
                const prompt = `You are a project management expert analyzing an engineering design project. Provide 4-5 specific, actionable optimization suggestions.

PROJECT DATA:
- Total Budget: $${totalBudget.toLocaleString()}
- Phases: ${projectData.phases.join(', ')}
- Disciplines: ${projectData.disciplines.join(', ')}
- Packages: ${projectData.packages.join(', ')}

BUDGET BY DISCIPLINE:
${projectData.disciplines.map(d => `- ${d}: $${(projectData.budgets[d] || 0).toLocaleString()} (${((projectData.budgets[d] || 0) / totalBudget * 100).toFixed(1)}%)`).join('\n')}

${projectData.projectScope ? `PROJECT SCOPE: ${projectData.projectScope.substring(0, 500)}` : ''}

Provide suggestions as a JSON array:
[{"icon":"emoji","title":"short title","description":"specific actionable recommendation"}]

Focus on:
1. Budget optimization opportunities
2. Schedule efficiency improvements
3. Risk mitigation strategies
4. Resource allocation recommendations
5. Discipline coordination tips

Return ONLY the JSON array, no markdown.`;

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-5.2',
                        messages: [{ role: 'user', content: prompt }],
                        max_completion_tokens: 1500,
                        temperature: 0.7
                    })
                });
                
                if (!response.ok) {
                    throw new Error('API error');
                }
                
                const data = await response.json();
                const content = data.choices[0]?.message?.content || '';
                
                // Parse suggestions
                let suggestions = [];
                try {
                    const jsonMatch = content.match(/\[[\s\S]*\]/);
                    if (jsonMatch) {
                        suggestions = JSON.parse(jsonMatch[0]);
                    }
                } catch (e) {
                    console.error('Failed to parse AI suggestions:', e);
                }
                
                if (suggestions.length > 0) {
                    suggestionsList.innerHTML = suggestions.map(s => `
                        <div class="suggestion-item">
                            <span class="suggestion-icon">${s.icon || ''}</span>
                            <div class="suggestion-content">
                                <div class="suggestion-title">${escapeHtml(s.title || 'Suggestion')}</div>
                                <div class="suggestion-desc">${escapeHtml(s.description || '')}</div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    suggestionsList.innerHTML = '<div class="suggestion-placeholder">No specific suggestions generated. Try again.</div>';
                }
                
            } catch (error) {
                console.error('AI Insights error:', error);
                suggestionsList.innerHTML = '<div class="suggestion-placeholder">Failed to generate insights. Check your API key and try again.</div>';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Generate Insights';
            }
        }

        // ============================================
        // AI SCHEDULE GENERATION
        // ============================================

        /**
         * Generates an AI-powered schedule based on project scope and disciplines
         */
        async function generateAISchedule() {
            const apiKey = localStorage.getItem('wbs_openai_key');
            if (!apiKey) {
                alert('Please set your OpenAI API key first. Click the chat button and enter your key.');
                return;
            }
            
            // Get schedule parameters
            const startDateInput = document.getElementById('ai-schedule-start');
            const durationSelect = document.getElementById('ai-schedule-duration');
            
            // Default to today if no start date selected
            let startDate = startDateInput.value;
            if (!startDate) {
                const today = new Date();
                startDate = today.toISOString().split('T')[0];
                startDateInput.value = startDate;
            }
            
            const targetDuration = parseInt(durationSelect.value) || 12;
            
            // Show loading state
            const btn = document.getElementById('ai-schedule-btn');
            const loading = document.getElementById('ai-schedule-loading');
            btn.disabled = true;
            loading.classList.remove('hidden');
            
            try {
                // Build context for AI
                const totalBudget = Object.values(projectData.budgets).reduce((sum, b) => sum + b, 0);
                
                const contextPrompt = `You are a project scheduling expert for engineering design projects. Generate a realistic schedule for the following project:

**PROJECT DETAILS:**
- Phases: ${projectData.phases.join(', ')}
- Disciplines: ${projectData.disciplines.join(', ')}
- Packages/Milestones: ${projectData.packages.join(', ')}
- Total Budget: $${totalBudget.toLocaleString()}
- Project Start Date: ${startDate}
- Target Duration: ${targetDuration} months

**BUDGET DISTRIBUTION:**
${projectData.disciplines.map(d => `- ${d}: $${(projectData.budgets[d] || 0).toLocaleString()}`).join('\n')}

**CLAIMING PERCENTAGES:**
${projectData.disciplines.slice(0, 3).map(disc => {
    const claims = projectData.packages.map(pkg => {
        const key = `${disc}-${pkg}`;
        return `${pkg}: ${projectData.claiming[key] || 0}%`;
    }).join(', ');
    return `- ${disc}: ${claims}`;
}).join('\n')}
${projectData.disciplines.length > 3 ? `... and ${projectData.disciplines.length - 3} more disciplines with similar patterns` : ''}

${projectData.projectScope ? `**PROJECT SCOPE:**\n${projectData.projectScope.substring(0, 500)}` : ''}

**REQUIREMENTS:**
1. Schedule should fit within ${targetDuration} months starting from ${startDate}
2. Packages should overlap appropriately (engineering projects often have concurrent work)
3. Higher-budget disciplines may need more time
4. Earlier packages (Preliminary) should start first, later packages (RFC, Final) should end last
5. Consider typical engineering workflow dependencies

Return a JSON object with the schedule. Format:
{
  "schedule": {
    "discipline-package": {"start": "YYYY-MM-DD", "end": "YYYY-MM-DD", "notes": "brief note"}
  },
  "summary": "Brief explanation of the schedule approach"
}

Return ONLY the JSON, no markdown formatting.`;

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-5.2',
                        messages: [
                            { role: 'user', content: contextPrompt }
                        ],
                        max_completion_tokens: 4000,
                        temperature: 0.3
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error?.message || `API error: ${response.status}`);
                }
                
                const data = await response.json();
                const content = data.choices[0]?.message?.content || '';
                
                // Parse the JSON response
                let scheduleData;
                try {
                    // Try to extract JSON from the response
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        scheduleData = JSON.parse(jsonMatch[0]);
                    } else {
                        throw new Error('No JSON found in response');
                    }
                } catch (e) {
                    console.error('Failed to parse AI schedule response:', e, content);
                    throw new Error('Failed to parse AI response. Please try again.');
                }
                
                // Apply the generated schedule
                if (scheduleData.schedule) {
                    Object.entries(scheduleData.schedule).forEach(([key, dates]) => {
                        if (projectData.dates[key]) {
                            projectData.dates[key] = {
                                start: dates.start,
                                end: dates.end
                            };
                        } else {
                            // Handle slight key mismatches by finding closest match
                            const [disc, pkg] = key.split('-');
                            const matchedDisc = projectData.disciplines.find(d => 
                                d.toLowerCase().includes(disc.toLowerCase()) || 
                                disc.toLowerCase().includes(d.toLowerCase())
                            );
                            const matchedPkg = projectData.packages.find(p => 
                                p.toLowerCase().includes(pkg.toLowerCase()) || 
                                pkg.toLowerCase().includes(p.toLowerCase())
                            );
                            if (matchedDisc && matchedPkg) {
                                const correctKey = `${matchedDisc}-${matchedPkg}`;
                                projectData.dates[correctKey] = {
                                    start: dates.start,
                                    end: dates.end
                                };
                            }
                        }
                    });
                    
                    // Rebuild the dates table to show updated values
                    buildDatesTable();
                    triggerAutosave();
                    
                    // Show summary
                    alert(` AI Schedule Generated!\n\n${scheduleData.summary || 'Schedule has been applied to all disciplines and packages.'}\n\nReview and adjust dates as needed.`);
                }
                
            } catch (error) {
                console.error('AI Schedule generation error:', error);
                alert('Error generating schedule: ' + error.message);
            } finally {
                btn.disabled = false;
                loading.classList.add('hidden');
            }
        }

        /**
         * Sends a message to the OpenAI API with tool calling and streaming support
         */
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message || chatState.isLoading) return;
            
            const apiKey = localStorage.getItem('wbs_openai_key');
            if (!apiKey) {
                showApiKeyModal();
                return;
            }
            
            // Add user message
            addMessage('user', message);
            input.value = '';
            input.style.height = 'auto';
            
            // Show loading state
            chatState.isLoading = true;
            document.getElementById('chat-send-btn').disabled = true;
            showTypingIndicator(true);
            
            try {
                // Check if we're on the results page (tools are available)
                const resultsVisible = !document.getElementById('results-section').classList.contains('hidden');
                const useTools = resultsVisible && projectData.disciplines.length > 0;
                
                // Build messages for API
                const apiMessages = [
                    { role: 'system', content: buildSystemPrompt() + (useTools ? '\n\nYou have access to tools to modify the project. Use them when the user asks to make changes.' : '') },
                    ...chatState.messages.filter(m => m.role !== 'system').slice(-10).map(m => ({
                        role: m.role,
                        content: m.content
                    }))
                ];
                
                // Make initial API call (non-streaming to detect tool calls)
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-5.2-chat-latest',
                        messages: apiMessages,
                        max_completion_tokens: 1000,
                        tools: useTools ? chatTools : undefined,
                        tool_choice: useTools ? 'auto' : undefined
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    if (response.status === 401) {
                        throw new Error('Invalid API key. Please check your OpenAI API key in settings.');
                    } else if (response.status === 429) {
                        throw new Error('Rate limit exceeded. Please wait a moment and try again.');
                    } else {
                        throw new Error(errorData.error?.message || `API error: ${response.status}`);
                    }
                }
                
                let data = await response.json();
                let assistantMessage = data.choices[0]?.message;
                
                // Handle tool calls if present
                if (assistantMessage?.tool_calls && assistantMessage.tool_calls.length > 0) {
                    showTypingIndicator(false);
                    
                    // Execute all tool calls
                    const toolResults = [];
                    const toolSummaries = [];
                    
                    for (const toolCall of assistantMessage.tool_calls) {
                        const funcName = toolCall.function.name;
                        let funcArgs = {};
                        
                        try {
                            funcArgs = JSON.parse(toolCall.function.arguments);
                        } catch (e) {
                            console.error('Failed to parse tool arguments:', e);
                        }
                        
                        console.log(`Executing tool: ${funcName}`, funcArgs);
                        const result = executeToolCall(funcName, funcArgs);
                        
                        toolResults.push({
                            tool_call_id: toolCall.id,
                            role: 'tool',
                            content: JSON.stringify(result)
                        });
                        
                        // Build summary for display
                        if (result.success) {
                            toolSummaries.push(` ${result.message || funcName}`);
                        } else {
                            toolSummaries.push(` ${result.error || 'Tool failed'}`);
                        }
                    }
                    
                    // Show tool execution summary
                    addMessage('system', ` ${toolSummaries.join('  ')}`);
                    
                    showTypingIndicator(true);
                    
                    // Send tool results back to get final response
                    const followUpMessages = [
                        ...apiMessages,
                        assistantMessage,
                        ...toolResults
                    ];
                    
                    const followUpResponse = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-5.2-chat-latest',
                            messages: followUpMessages,
                            max_completion_tokens: 1000
                        })
                    });
                    
                    if (followUpResponse.ok) {
                        data = await followUpResponse.json();
                        assistantMessage = data.choices[0]?.message;
                    }
                }
                
                // Add assistant's final message
                const content = assistantMessage?.content || 'Done! The changes have been applied.';
                addMessage('assistant', content);
                
            } catch (error) {
                console.error('Chat error:', error);
                addMessage('system', ` ${error.message}`);
            } finally {
                chatState.isLoading = false;
                document.getElementById('chat-send-btn').disabled = false;
                showTypingIndicator(false);
            }
        }

        /**
         * Handles Enter key in chat input
         * @param {KeyboardEvent} event
         */
        function handleChatKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        /**
         * Auto-resizes the chat input textarea
         */
        function autoResizeChatInput() {
            const input = document.getElementById('chat-input');
            input.style.height = 'auto';
            input.style.height = Math.min(input.scrollHeight, 100) + 'px';
        }

        /**
         * Updates the context badge in chat header
         */
        function updateChatContextBadge() {
            const badge = document.getElementById('chat-context-badge');
            if (badge) {
                const resultsVisible = !document.getElementById('results-section').classList.contains('hidden');
                badge.textContent = resultsVisible ? 'RESULTS' : `STEP ${currentStep}`;
            }
        }

        // Update context badge when step changes
        const originalShowStep = showStep;
        showStep = function(step) {
            originalShowStep(step);
            updateChatContextBadge();
        };

        // Update context badge when WBS is generated
        const originalGenerateWBS = generateWBS;
        generateWBS = function() {
            originalGenerateWBS();
            updateChatContextBadge();
        };

        // ============================================
        // RFP WIZARD
        // ============================================

        const rfpState = {
            currentStage: 1,
            file: null,
            pageCount: 0,
            extractedText: '',
            extractedData: null,
            wasTruncated: false,
            originalLength: 0,
            analyzedLength: 0,
            chunkCount: 1,
            usageStats: {
                totalPromptTokens: 0,
                totalCompletionTokens: 0,
                totalTokens: 0,
                apiCalls: 0,
                estimatedCost: 0,
                model: '',
                startTime: null,
                endTime: null
            }
        };

        // Initialize PDF.js worker
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }

        /**
         * Opens the RFP Wizard modal
         */
        function openRfpWizard() {
            document.getElementById('rfp-modal').classList.add('open');
            resetRfpWizard();
        }

        /**
         * Closes the RFP Wizard modal
         */
        function closeRfpWizard() {
            document.getElementById('rfp-modal').classList.remove('open');
        }

        /**
         * Resets the RFP Wizard to initial state
         */
        function resetRfpWizard() {
            rfpState.currentStage = 1;
            rfpState.file = null;
            rfpState.pageCount = 0;
            rfpState.extractedText = '';
            rfpState.extractedData = null;
            rfpState.wasTruncated = false;
            rfpState.originalLength = 0;
            rfpState.analyzedLength = 0;
            rfpState.chunkCount = 1;
            
            // Reset usage stats
            rfpState.usageStats = {
                totalPromptTokens: 0,
                totalCompletionTokens: 0,
                totalTokens: 0,
                apiCalls: 0,
                estimatedCost: 0,
                model: '',
                startTime: null,
                endTime: null
            };
            
            // Reset UI
            document.getElementById('rfp-file-info').classList.remove('visible');
            document.getElementById('rfp-file-input').value = '';
            document.getElementById('rfp-next-1').disabled = true;
            document.getElementById('rfp-page-range').value = '';
            document.getElementById('rfp-loading').classList.add('visible');
            document.getElementById('rfp-preview').style.display = 'none';
            document.getElementById('rfp-truncation-notice').style.display = 'none';
            document.getElementById('rfp-usage-stats').style.display = 'none';
            
            // Reset preview section
            const previewSection = document.getElementById('rfp-text-preview-section');
            if (previewSection) previewSection.style.display = 'none';
            const previewBtn = document.getElementById('rfp-preview-text-btn');
            if (previewBtn) previewBtn.style.display = 'none';
            
            goToRfpStage(1);
        }

        /**
         * Navigates to a specific stage in the RFP wizard
         */
        function goToRfpStage(stage) {
            rfpState.currentStage = stage;
            
            // Update stage indicators
            document.querySelectorAll('.rfp-stage').forEach((el, i) => {
                el.classList.remove('active', 'completed');
                if (i + 1 < stage) el.classList.add('completed');
                if (i + 1 === stage) el.classList.add('active');
            });
            
            // Show/hide stage content
            document.querySelectorAll('.rfp-stage-content').forEach((el, i) => {
                el.classList.toggle('active', i + 1 === stage);
            });
            
            // Show preview button on stage 2 if file is loaded
            const previewBtn = document.getElementById('rfp-preview-text-btn');
            if (previewBtn) {
                previewBtn.style.display = (stage === 2 && rfpState.file && !rfpState.extractedText) ? 'inline-block' : 'none';
            }
            
            // Hide preview section when leaving stage 2
            if (stage !== 2) {
                const previewSection = document.getElementById('rfp-text-preview-section');
                if (previewSection) previewSection.style.display = 'none';
            }
        }

        /**
         * Handles file selection from input
         */
        function handleRfpFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handleRfpUpload(file);
            }
        }

        /**
         * Handles PDF file upload (from input or drag-drop)
         */
        async function handleRfpUpload(file) {
            if (file.type !== 'application/pdf') {
                alert('Please upload a PDF file.');
                return;
            }
            
            rfpState.file = file;
            
            // Display file info
            document.getElementById('rfp-file-name').textContent = file.name;
            document.getElementById('rfp-file-meta').textContent = formatFileSize(file.size);
            document.getElementById('rfp-file-info').classList.add('visible');
            
            // Get page count
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                rfpState.pageCount = pdf.numPages;
                document.getElementById('rfp-page-count').textContent = pdf.numPages;
                document.getElementById('rfp-next-1').disabled = false;
                
                // Show preview button if on stage 2
                if (rfpState.currentStage === 2) {
                    const previewBtn = document.getElementById('rfp-preview-text-btn');
                    if (previewBtn && !rfpState.extractedText) {
                        previewBtn.style.display = 'inline-block';
                    }
                }
            } catch (error) {
                console.error('Error reading PDF:', error);
                alert('Error reading PDF file. Please try another file.');
                removeRfpFile();
            }
        }

        /**
         * Removes the uploaded file
         */
        function removeRfpFile() {
            rfpState.file = null;
            rfpState.pageCount = 0;
            document.getElementById('rfp-file-info').classList.remove('visible');
            document.getElementById('rfp-file-input').value = '';
            document.getElementById('rfp-next-1').disabled = true;
        }

        /**
         * Formats file size for display
         */
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        /**
         * Formats large numbers with commas
         */
        function formatNumber(num) {
            return num.toLocaleString('en-US');
        }

        /**
         * Parses page range string into array of page numbers
         * e.g., "1-5,8,10-12"  [1,2,3,4,5,8,10,11,12]
         */
        function parsePageRange(rangeStr, maxPages) {
            if (!rangeStr || !rangeStr.trim()) {
                // Return all pages if empty
                return Array.from({ length: maxPages }, (_, i) => i + 1);
            }
            
            const pages = new Set();
            const parts = rangeStr.split(',').map(s => s.trim());
            
            for (const part of parts) {
                if (part.includes('-')) {
                    const [start, end] = part.split('-').map(n => parseInt(n.trim()));
                    if (!isNaN(start) && !isNaN(end)) {
                        for (let i = Math.max(1, start); i <= Math.min(maxPages, end); i++) {
                            pages.add(i);
                        }
                    }
                } else {
                    const num = parseInt(part);
                    if (!isNaN(num) && num >= 1 && num <= maxPages) {
                        pages.add(num);
                    }
                }
            }
            
            return Array.from(pages).sort((a, b) => a - b);
        }

        /**
         * Extracts text from PDF using PDF.js
         */
        async function extractPdfText(file, pageNumbers) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            
            let fullText = '';
            
            for (const pageNum of pageNumbers) {
                if (pageNum > pdf.numPages) continue;
                
                const page = await pdf.getPage(pageNum);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += `\n--- Page ${pageNum} ---\n${pageText}\n`;
            }
            
            return fullText;
        }

        // Drag and drop handlers
        document.addEventListener('DOMContentLoaded', () => {
            const dropzone = document.getElementById('rfp-dropzone');
            if (dropzone) {
                dropzone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropzone.classList.add('dragover');
                });
                
                dropzone.addEventListener('dragleave', () => {
                    dropzone.classList.remove('dragover');
                });
                
                dropzone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropzone.classList.remove('dragover');
                    const file = e.dataTransfer.files[0];
                    if (file) handleRfpUpload(file);
                });
            }
        });

        /**
         * Splits text into chunks of approximately MAX_CHUNK_SIZE with overlap
         */
        function splitTextIntoChunks(text, maxChunkSize) {
            const chunks = [];
            const overlapSize = 2000; // 2K char overlap - optimized to reduce redundancy while maintaining context
            
            if (text.length <= maxChunkSize) {
                return [text];
            }
            
            let start = 0;
            while (start < text.length) {
                let end = start + maxChunkSize;
                
                // If not the last chunk, try to break at a sentence boundary
                if (end < text.length) {
                    // Look for sentence endings within last 1000 chars
                    const searchStart = Math.max(start + maxChunkSize - 1000, start);
                    const searchText = text.substring(searchStart, end);
                    const lastPeriod = searchText.lastIndexOf('. ');
                    const lastNewline = searchText.lastIndexOf('\n\n');
                    const breakPoint = Math.max(lastPeriod, lastNewline);
                    
                    if (breakPoint > 0) {
                        end = searchStart + breakPoint + (lastPeriod > lastNewline ? 2 : 2);
                    }
                }
                
                chunks.push(text.substring(start, end));
                
                // Next chunk starts with overlap
                start = end - overlapSize;
                if (start < 0) start = 0;
            }
            
            return chunks;
        }

        /**
         * Analyzes a single text chunk with OpenAI
         */
        async function analyzeChunk(apiKey, chunkText, chunkIndex, totalChunks) {
            const systemPrompt = `Extract WBS info and RISKS from engineering RFP chunk ${chunkIndex + 1}/${totalChunks}. Return raw JSON only:
{"phases":[],"disciplines":[],"disciplineScopes":{},"packages":[],"budgets":{},"scope":"","schedule":"","risks":[],"confidence":{"phases":"high/medium/low","disciplines":"high/medium/low","packages":"high/medium/low","budgets":"low","scope":"high/medium/low","schedule":"high/medium/low"},"notes":""}

**PHASES**: Project stages (e.g. Base Design, ESDC, TSCD, Preliminary, Final, As-Builts, Closeout, Phase 1/2/3)
**DISCIPLINES**: Use EXACT names: Structures, Design PM, Civil, Drainage, Electrical, Environmental, Traffic, ITS, Mechanical, Geotechnical, Survey, Landscape, Utilities, Lighting, Pavement, Bridges, H&H, Communications, Architecture, Systems
**DISCIPLINE SCOPES**: {"Discipline":"scope description"} - Extract specific tasks/deliverables per discipline
**PACKAGES**: Milestones (e.g. Preliminary, Interim, Final, RFC, As-Built, 30%, 60%, 90%)
**SCOPE**: Project location, type, major work elements, requirements
**SCHEDULE**: Timeline info, durations, milestones, deadlines
**RISKS**: Array of risk objects: [{"category":"Schedule|Budget|Technical|Scope|Coordination","severity":"High|Medium|Low","description":"specific risk","mitigation":"suggested mitigation"}]
- Look for: tight deadlines, complex requirements, undefined scope, multi-agency coordination, environmental constraints, utility conflicts, ROW issues, phased construction, regulatory requirements
Confidence: "high"=explicit, "medium"=inferred, "low"=guessed`;

            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: 'gpt-5.2',
                    messages: [
                        { role: 'system', content: systemPrompt },
                        { role: 'user', content: `Analyze this portion of the RFP document (chunk ${chunkIndex + 1} of ${totalChunks}) and extract WBS information:\n\n${chunkText}` }
                    ],
                    max_completion_tokens: 32000,
                    temperature: 0.3
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error?.message || `API error: ${response.status}`);
            }
            
            const data = await response.json();
            
            // Log full API response structure for debugging
            console.log(`Chunk ${chunkIndex + 1} full API response:`, JSON.stringify(data, null, 2).substring(0, 1000));
            
            // Extract usage data from response
            const usage = data.usage || { prompt_tokens: 0, completion_tokens: 0, total_tokens: 0 };
            
            const content = data.choices?.[0]?.message?.content || data.output?.message?.content || '';
            
            // Log raw response for debugging
            console.log(`Chunk ${chunkIndex + 1} extracted content:`, content ? content.substring(0, 500) : 'EMPTY CONTENT');
            console.log(`Chunk ${chunkIndex + 1} usage:`, usage);
            
            // Parse JSON response - handle various formats
            let parsedData;
            try {
                // Try to extract JSON from markdown code blocks first
                const codeBlockMatch = content.match(/```(?:json)?\s*([\s\S]*?)```/);
                if (codeBlockMatch) {
                    const jsonContent = codeBlockMatch[1].trim();
                    const jsonMatch = jsonContent.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        parsedData = JSON.parse(jsonMatch[0]);
                    }
                }
                
                if (!parsedData) {
                    // Try to find JSON object directly
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        parsedData = JSON.parse(jsonMatch[0]);
                    } else {
                        // Last resort: try parsing the whole content
                        parsedData = JSON.parse(content);
                    }
                }
            } catch (e) {
                console.error(`JSON parse error for chunk ${chunkIndex + 1}:`, e.message);
                console.error('Content was:', content);
                throw new Error(`Could not parse AI response as JSON for chunk ${chunkIndex + 1}`);
            }
            
            // Return both parsed data and usage stats
            return {
                data: parsedData,
                usage: usage,
                model: data.model || 'gpt-5.2'
            };
        }

        /**
         * Locally merges simple array fields (phases, disciplines, packages) to reduce API cost
         * @param {Array} chunkResults - Array of {data, usage, model} objects from analyzeChunk
         */
        function localMergeSimpleFields(chunkResults) {
            const merged = {
                phases: [],
                disciplines: [],
                packages: [],
                budgets: {},
                risks: []
            };

            // Merge phases - deduplicate and preserve order
            const phasesSet = new Set();
            chunkResults.forEach(resultObj => {
                const result = resultObj.data || resultObj; // Handle both new {data, usage} and legacy formats
                if (result.phases && Array.isArray(result.phases)) {
                    result.phases.forEach(phase => {
                        if (phase && !phasesSet.has(phase)) {
                            phasesSet.add(phase);
                            merged.phases.push(phase);
                        }
                    });
                }
            });

            // Merge disciplines - deduplicate and preserve order
            const disciplinesSet = new Set();
            chunkResults.forEach(resultObj => {
                const result = resultObj.data || resultObj;
                if (result.disciplines && Array.isArray(result.disciplines)) {
                    result.disciplines.forEach(disc => {
                        if (disc && !disciplinesSet.has(disc)) {
                            disciplinesSet.add(disc);
                            merged.disciplines.push(disc);
                        }
                    });
                }
            });

            // Merge packages - deduplicate and preserve order
            const packagesSet = new Set();
            chunkResults.forEach(resultObj => {
                const result = resultObj.data || resultObj;
                if (result.packages && Array.isArray(result.packages)) {
                    result.packages.forEach(pkg => {
                        if (pkg && !packagesSet.has(pkg)) {
                            packagesSet.add(pkg);
                            merged.packages.push(pkg);
                        }
                    });
                }
            });

            // Merge risks - collect all risks, deduplicate by description similarity
            const riskDescriptions = new Set();
            chunkResults.forEach(resultObj => {
                const result = resultObj.data || resultObj;
                if (result.risks && Array.isArray(result.risks)) {
                    result.risks.forEach(risk => {
                        const descKey = (risk.description || '').toLowerCase().substring(0, 50);
                        if (descKey && !riskDescriptions.has(descKey)) {
                            riskDescriptions.add(descKey);
                            merged.risks.push(risk);
                        }
                    });
                }
            });

            return merged;
        }

        /**
         * Merges multiple chunk results into a final consolidated result (OPTIMIZED)
         * Uses local merge for simple arrays and AI only for complex fields
         */
        async function mergeChunkResults(apiKey, chunkResults) {
            // Step 1: Local merge of simple fields (no API cost)
            const localMerged = localMergeSimpleFields(chunkResults);
            console.log('Local merge complete:', localMerged);

            // Step 2: Use AI to merge only complex fields (disciplineScopes, scope, schedule, confidence, notes)
            // Extract ONLY the complex fields to reduce payload size significantly
            const complexFieldsOnly = chunkResults.map((r, idx) => {
                const data = r.data || r;
                return {
                    chunk: idx + 1,
                    disciplineScopes: data.disciplineScopes || {},
                    scope: data.scope || '',
                    schedule: data.schedule || '',
                    confidence: data.confidence || {},
                    notes: data.notes || ''
                };
            });
            
            const mergePrompt = `Merge ${chunkResults.length} WBS chunk analyses (complex fields only). Return raw JSON:
{"disciplineScopes":{},"scope":"","schedule":"","confidence":{"phases":"high/medium/low","disciplines":"high/medium/low","packages":"high/medium/low","budgets":"low","scope":"high/medium/low","schedule":"high/medium/low"},"notes":""}

Merge rules:
- disciplineScopes: Combine scope descriptions per discipline from all chunks
- scope: Comprehensive project summary combining all chunks
- schedule: Combined timeline info from all chunks
- confidence: Use highest confidence level found across chunks (high > medium > low)
- notes: Combine all notes

Chunks: ${JSON.stringify(complexFieldsOnly, null, 2)}`;

            // Retry logic for network errors (HTTP/2 protocol errors)
            let response = null;
            let retries = 3;
            let lastError = null;
            
            while (retries > 0 && !response) {
                try {
                    response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-5.2',
                            messages: [
                                { role: 'user', content: mergePrompt }
                            ],
                            max_completion_tokens: 32000,
                            temperature: 0.2
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error?.message || `API error: ${response.status}`);
                    }
                } catch (err) {
                    lastError = err;
                    retries--;
                    response = null;
                    if (retries > 0) {
                        console.log(`Merge API call failed, retrying... (${retries} attempts left):`, err.message);
                        await new Promise(r => setTimeout(r, 3000)); // Wait 3 seconds before retry
                    }
                }
            }
            
            if (!response) {
                throw lastError || new Error('Failed to merge chunk results after multiple attempts');
            }

            const data = await response.json();
            const content = data.choices[0]?.message?.content || '';
            
            // Extract usage data from merge API call
            const usage = data.usage || { prompt_tokens: 0, completion_tokens: 0, total_tokens: 0 };
            console.log('AI merge usage:', usage);

            console.log('AI merge raw response:', content.substring(0, 500));

            let aiMerged;
            try {
                // Try to extract JSON from markdown code blocks first
                const codeBlockMatch = content.match(/```(?:json)?\s*([\s\S]*?)```/);
                if (codeBlockMatch) {
                    const jsonContent = codeBlockMatch[1].trim();
                    const jsonMatch = jsonContent.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        aiMerged = JSON.parse(jsonMatch[0]);
                    }
                } else {
                    // Try to find JSON object directly
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        aiMerged = JSON.parse(jsonMatch[0]);
                    } else {
                        aiMerged = JSON.parse(content);
                    }
                }
            } catch (e) {
                console.error('Merge JSON parse error:', e.message);
                console.error('Content was:', content);
                throw new Error('Could not parse merged result as JSON');
            }

            // Step 3: Combine local merge (simple arrays) with AI merge (complex fields)
            return {
                data: {
                    phases: localMerged.phases,
                    disciplines: localMerged.disciplines,
                    packages: localMerged.packages,
                    budgets: localMerged.budgets,
                    risks: localMerged.risks || [],
                    disciplineScopes: aiMerged.disciplineScopes || {},
                    scope: aiMerged.scope || '',
                    schedule: aiMerged.schedule || '',
                    confidence: aiMerged.confidence || {},
                    notes: aiMerged.notes || ''
                },
                usage: usage,
                model: data.model || 'gpt-5.2'
            };
        }

        /**
         * Previews the extracted text before sending to AI
         */
        async function previewExtractedText() {
            if (!rfpState.file) return;
            
            const pageRange = document.getElementById('rfp-page-range').value;
            const pages = parsePageRange(pageRange, rfpState.pageCount);
            
            // Show loading state
            const previewBtn = document.getElementById('rfp-preview-text-btn');
            previewBtn.disabled = true;
            previewBtn.textContent = 'Extracting...';
            
            try {
                const text = await extractPdfText(rfpState.file, pages);
                rfpState.extractedText = text;
                
                // Update stats
                document.getElementById('rfp-preview-page-count').textContent = pages.length;
                document.getElementById('rfp-preview-char-count').textContent = formatNumber(text.length);
                document.getElementById('rfp-preview-token-est').textContent = '~' + formatNumber(Math.ceil(text.length / 4)); // Rough estimate: 1 token  4 chars
                
                // Show preview snippet (first 1000 chars)
                const snippet = text.length > 1000 ? text.substring(0, 1000) + '\n\n[... text continues ...]' : text;
                document.getElementById('rfp-text-preview-snippet').textContent = snippet;
                document.getElementById('rfp-text-preview-full').textContent = text;
                
                // Show preview section
                document.getElementById('rfp-text-preview-section').style.display = 'block';
                document.getElementById('rfp-text-preview-content').style.display = 'block';
                document.getElementById('rfp-preview-toggle-text').textContent = 'Hide';
                
                previewBtn.style.display = 'none';
                
            } catch (error) {
                console.error('Text extraction error:', error);
                alert('Error extracting text: ' + error.message);
            } finally {
                previewBtn.disabled = false;
                previewBtn.textContent = 'Preview Text';
            }
        }

        /**
         * Toggles the text preview visibility
         */
        function toggleTextPreview() {
            const content = document.getElementById('rfp-text-preview-content');
            const toggle = document.getElementById('rfp-preview-toggle-text');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = 'Hide';
            } else {
                content.style.display = 'none';
                toggle.textContent = 'Show';
            }
        }

        /**
         * Toggles between snippet and full text view
         */
        function toggleFullTextPreview() {
            const snippet = document.getElementById('rfp-text-preview-snippet');
            const full = document.getElementById('rfp-text-preview-full');
            const toggle = document.getElementById('rfp-full-text-toggle');
            
            if (full.style.display === 'none') {
                snippet.style.display = 'none';
                full.style.display = 'block';
                toggle.textContent = 'Hide';
            } else {
                snippet.style.display = 'block';
                full.style.display = 'none';
                toggle.textContent = 'Show';
            }
        }

        /**
         * Copies extracted text to clipboard
         */
        async function copyExtractedText() {
            if (!rfpState.extractedText) return;
            
            try {
                await navigator.clipboard.writeText(rfpState.extractedText);
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                btn.style.color = '#00ff00';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.color = '';
                }, 2000);
            } catch (error) {
                alert('Failed to copy text. Please select and copy manually.');
            }
        }

        /**
         * Analyzes the RFP document with OpenAI (with chunking support)
         */
        async function analyzeRfpDocument() {
            const apiKey = localStorage.getItem('wbs_openai_key');
            if (!apiKey) {
                alert('Please set your OpenAI API key first. Click the chat button and enter your key.');
                return;
            }
            
            // Go to stage 3 and show loading
            goToRfpStage(3);
            document.getElementById('rfp-loading').classList.add('visible');
            document.getElementById('rfp-preview').style.display = 'none';
            
            try {
                let text;
                
                // Use already-extracted text if available (from preview), otherwise extract now
                if (rfpState.extractedText) {
                    text = rfpState.extractedText;
                    document.querySelector('.rfp-loading-text').textContent = `Using extracted text (${formatNumber(text.length)} chars). Analyzing with AI...`;
                } else {
                    // Extract text from selected pages
                    const pageRange = document.getElementById('rfp-page-range').value;
                    const pages = parsePageRange(pageRange, rfpState.pageCount);
                    
                    document.querySelector('.rfp-loading-text').textContent = `Extracting text from ${pages.length} pages...`;
                    
                    text = await extractPdfText(rfpState.file, pages);
                    rfpState.extractedText = text;
                }
                
                // GPT-4o-mini supports 128K tokens (~500K chars), but we need buffer for system prompt + response
                // Using 400K chars (~100K tokens) leaves room for: system prompt (~1.5K tokens) + response (1.5K tokens) + buffer
                const MAX_TEXT_LENGTH = 400000;
                const needsChunking = text.length > MAX_TEXT_LENGTH;
                
                // Store truncation status for display in preview
                rfpState.wasTruncated = false; // No longer truncating, we chunk instead
                rfpState.originalLength = text.length;
                rfpState.analyzedLength = text.length; // We analyze everything now
                rfpState.chunkCount = 1;
                
                // Reset usage stats for this analysis run
                rfpState.usageStats = {
                    totalPromptTokens: 0,
                    totalCompletionTokens: 0,
                    totalTokens: 0,
                    apiCalls: 0,
                    estimatedCost: 0,
                    model: 'gpt-5.2',
                    startTime: Date.now(),
                    endTime: null
                };
                
                let extracted;
                
                if (needsChunking) {
                    // Split into chunks
                    const chunks = splitTextIntoChunks(text, MAX_TEXT_LENGTH);
                    rfpState.chunkCount = chunks.length;

                    document.querySelector('.rfp-loading-text').textContent = `Document is large (${formatNumber(text.length)} chars). Analyzing ${chunks.length} chunks with optimized processing...`;

                    // Analyze chunks sequentially to avoid HTTP/2 protocol errors
                    const chunkResults = [];
                    const analysisStartTime = Date.now();
                    for (let i = 0; i < chunks.length; i++) {
                        const avgTime = i > 0 ? ((Date.now() - analysisStartTime) / i / 1000).toFixed(1) : '?';
                        document.querySelector('.rfp-loading-text').textContent = `Analyzing chunk ${i + 1}/${chunks.length} (avg ${avgTime}s/chunk, optimized prompts)...`;

                        // Retry logic for network errors
                        let result = null;
                        let retries = 3;
                        while (retries > 0 && !result) {
                            try {
                                result = await analyzeChunk(apiKey, chunks[i], i, chunks.length);
                            } catch (err) {
                                retries--;
                                if (retries === 0) throw err;
                                console.log(`Chunk ${i + 1} failed, retrying... (${retries} attempts left)`);
                                await new Promise(r => setTimeout(r, 2000)); // Wait 2 seconds before retry
                            }
                        }
                        
                        // Accumulate usage stats from each chunk
                        if (result.usage) {
                            rfpState.usageStats.totalPromptTokens += result.usage.prompt_tokens || 0;
                            rfpState.usageStats.totalCompletionTokens += result.usage.completion_tokens || 0;
                            rfpState.usageStats.totalTokens += result.usage.total_tokens || 0;
                            rfpState.usageStats.apiCalls++;
                        }
                        if (result.model) {
                            rfpState.usageStats.model = result.model;
                        }
                        
                        chunkResults.push(result);
                    }

                    // Merge results - Step 1: Local merge (free, instant)
                    document.querySelector('.rfp-loading-text').textContent = `Merging results: Local merge of arrays (instant)...`;
                    await new Promise(r => setTimeout(r, 100)); // Brief pause to show message

                    // Step 2: AI merge for complex fields only
                    document.querySelector('.rfp-loading-text').textContent = `Merging results: AI merge of complex fields (optimized)...`;
                    const mergeResult = await mergeChunkResults(apiKey, chunkResults);
                    
                    // Accumulate usage stats from merge call
                    if (mergeResult.usage) {
                        rfpState.usageStats.totalPromptTokens += mergeResult.usage.prompt_tokens || 0;
                        rfpState.usageStats.totalCompletionTokens += mergeResult.usage.completion_tokens || 0;
                        rfpState.usageStats.totalTokens += mergeResult.usage.total_tokens || 0;
                        rfpState.usageStats.apiCalls++;
                    }
                    
                    extracted = mergeResult.data;
                    
                } else {
                    // Single chunk - use original approach
                    document.querySelector('.rfp-loading-text').textContent = `Analyzing ${formatNumber(text.length)} characters with AI...`;
                    const result = await analyzeChunk(apiKey, text, 0, 1);
                    
                    // Accumulate usage stats
                    if (result.usage) {
                        rfpState.usageStats.totalPromptTokens += result.usage.prompt_tokens || 0;
                        rfpState.usageStats.totalCompletionTokens += result.usage.completion_tokens || 0;
                        rfpState.usageStats.totalTokens += result.usage.total_tokens || 0;
                        rfpState.usageStats.apiCalls++;
                    }
                    if (result.model) {
                        rfpState.usageStats.model = result.model;
                    }
                    
                    extracted = result.data;
                }
                
                // Record end time and calculate cost
                rfpState.usageStats.endTime = Date.now();
                
                // Estimate cost based on GPT-5.2 pricing (adjust as needed)
                // Assuming: $5/1M input tokens, $15/1M output tokens
                const inputCostPer1M = 5.00;
                const outputCostPer1M = 15.00;
                rfpState.usageStats.estimatedCost = 
                    (rfpState.usageStats.totalPromptTokens / 1000000 * inputCostPer1M) + 
                    (rfpState.usageStats.totalCompletionTokens / 1000000 * outputCostPer1M);
                
                console.log('Final usage stats:', rfpState.usageStats);
                
                rfpState.extractedData = extracted;
                displayRfpPreview(extracted);
                
            } catch (error) {
                console.error('RFP analysis error:', error);
                alert('Error analyzing document: ' + error.message);
                goToRfpStage(2);
            }
        }

        /**
         * Displays the extracted data in the preview UI
         */
        function displayRfpPreview(data) {
            document.getElementById('rfp-loading').classList.remove('visible');
            document.getElementById('rfp-preview').style.display = 'block';
            
            // Populate fields
            document.getElementById('rfp-preview-phases').value = (data.phases || []).join(', ');
            document.getElementById('rfp-preview-disciplines').value = (data.disciplines || []).join(', ');
            document.getElementById('rfp-preview-packages').value = (data.packages || []).join(', ');
            
            // Discipline Scopes
            const scopesContainer = document.getElementById('rfp-discipline-scopes-container');
            scopesContainer.innerHTML = '';
            
            if (data.disciplineScopes && Object.keys(data.disciplineScopes).length > 0) {
                // Show scopes for disciplines that have scope info
                Object.entries(data.disciplineScopes).forEach(([disc, scope]) => {
                    const scopeItem = document.createElement('div');
                    scopeItem.className = 'rfp-discipline-scope-item';
                    scopeItem.innerHTML = `
                        <div class="rfp-discipline-scope-name">${disc}</div>
                        <textarea class="rfp-discipline-scope-textarea" data-discipline="${disc}" placeholder="Scope of work for ${disc}...">${scope || ''}</textarea>
                    `;
                    scopesContainer.appendChild(scopeItem);
                });
                
                // Also add disciplines that don't have scope yet (so user can add)
                const disciplinesWithScopes = Object.keys(data.disciplineScopes);
                (data.disciplines || []).forEach(disc => {
                    if (!disciplinesWithScopes.includes(disc)) {
                        const scopeItem = document.createElement('div');
                        scopeItem.className = 'rfp-discipline-scope-item';
                        scopeItem.innerHTML = `
                            <div class="rfp-discipline-scope-name">${disc}</div>
                            <textarea class="rfp-discipline-scope-textarea" data-discipline="${disc}" placeholder="No scope found for ${disc}. Add scope if known..."></textarea>
                        `;
                        scopesContainer.appendChild(scopeItem);
                    }
                });
            } else {
                // No discipline scopes extracted - show disciplines with empty fields
                (data.disciplines || []).forEach(disc => {
                    const scopeItem = document.createElement('div');
                    scopeItem.className = 'rfp-discipline-scope-item';
                    scopeItem.innerHTML = `
                        <div class="rfp-discipline-scope-name">${disc}</div>
                        <textarea class="rfp-discipline-scope-textarea" data-discipline="${disc}" placeholder="No scope found for ${disc}. Add scope if known..."></textarea>
                    `;
                    scopesContainer.appendChild(scopeItem);
                });
            }
            
            // Scope Summary
            document.getElementById('rfp-preview-scope').value = data.scope || '';
            
            // Schedule
            document.getElementById('rfp-preview-schedule').value = data.schedule || '';
            
            // Confidence indicators
            const conf = data.confidence || {};
            setConfidenceIndicator('rfp-conf-phases', conf.phases);
            setConfidenceIndicator('rfp-conf-disciplines', conf.disciplines);
            setConfidenceIndicator('rfp-conf-packages', conf.packages);
            setConfidenceIndicator('rfp-conf-scope', conf.scope);
            setConfidenceIndicator('rfp-conf-schedule', conf.schedule);
            
            // Chunking notice (if document was chunked)
            if (rfpState.chunkCount > 1) {
                const truncationNotice = document.getElementById('rfp-truncation-notice');
                const truncationText = document.getElementById('rfp-truncation-text');
                truncationNotice.style.display = 'block';
                truncationText.textContent = `Large document analyzed in ${rfpState.chunkCount} chunks (${formatNumber(rfpState.originalLength)} total characters). All content was analyzed and merged for comprehensive results.`;
            } else {
                document.getElementById('rfp-truncation-notice').style.display = 'none';
            }
            
            // Notes
            if (data.notes) {
                document.getElementById('rfp-notes').style.display = 'block';
                document.getElementById('rfp-notes-text').textContent = data.notes;
            } else {
                document.getElementById('rfp-notes').style.display = 'none';
            }
            
            // Risks
            const risksSection = document.getElementById('rfp-risks');
            const risksList = document.getElementById('rfp-risks-list');
            
            if (data.risks && data.risks.length > 0) {
                risksSection.style.display = 'block';
                risksList.innerHTML = data.risks.map(risk => {
                    const severity = (risk.severity || 'Medium').toLowerCase();
                    return `
                        <div class="rfp-risk-item severity-${severity}">
                            <div class="rfp-risk-header">
                                <span class="rfp-risk-category">${risk.category || 'General'}</span>
                                <span class="rfp-risk-severity ${severity}">${(risk.severity || 'Medium').toUpperCase()}</span>
                            </div>
                            <div class="rfp-risk-description">${escapeHtml(risk.description || '')}</div>
                            ${risk.mitigation ? `<div class="rfp-risk-mitigation">${escapeHtml(risk.mitigation)}</div>` : ''}
                        </div>
                    `;
                }).join('');
            } else {
                risksSection.style.display = 'none';
            }
            
            // Usage Statistics
            const stats = rfpState.usageStats;
            if (stats && stats.totalTokens > 0) {
                document.getElementById('rfp-usage-stats').style.display = 'block';
                document.getElementById('rfp-stats-calls').textContent = stats.apiCalls;
                document.getElementById('rfp-stats-model').textContent = stats.model || 'gpt-5.2';
                document.getElementById('rfp-stats-prompt').textContent = formatNumber(stats.totalPromptTokens);
                document.getElementById('rfp-stats-completion').textContent = formatNumber(stats.totalCompletionTokens);
                document.getElementById('rfp-stats-tokens').textContent = formatNumber(stats.totalTokens);
                
                // Calculate processing time
                if (stats.startTime && stats.endTime) {
                    const durationMs = stats.endTime - stats.startTime;
                    const durationSec = (durationMs / 1000).toFixed(1);
                    document.getElementById('rfp-stats-time').textContent = `${durationSec}s`;
                }
                
                // Format cost
                document.getElementById('rfp-stats-cost').textContent = `$${stats.estimatedCost.toFixed(4)}`;
            } else {
                document.getElementById('rfp-usage-stats').style.display = 'none';
            }
        }

        /**
         * Sets the confidence indicator styling
         */
        function setConfidenceIndicator(elementId, level) {
            const el = document.getElementById(elementId);
            if (!el) return;
            
            el.classList.remove('high', 'medium', 'low');
            
            const normalizedLevel = (level || 'low').toLowerCase();
            el.classList.add(normalizedLevel);
            el.textContent = normalizedLevel.toUpperCase();
        }

        /**
         * Applies the extracted RFP data to the project
         */
        function applyRfpData() {
            // Get values from preview fields
            const phasesStr = document.getElementById('rfp-preview-phases').value;
            const disciplinesStr = document.getElementById('rfp-preview-disciplines').value;
            const packagesStr = document.getElementById('rfp-preview-packages').value;
            const scopeStr = document.getElementById('rfp-preview-scope').value;
            const scheduleStr = document.getElementById('rfp-preview-schedule').value;
            
            // Get discipline scopes from textarea fields
            const disciplineScopes = {};
            document.querySelectorAll('.rfp-discipline-scope-textarea').forEach(textarea => {
                const disc = textarea.getAttribute('data-discipline');
                const scope = textarea.value.trim();
                if (disc && scope) {
                    disciplineScopes[disc] = scope;
                }
            });
            
            // Parse phases
            const phases = phasesStr.split(',').map(s => s.trim()).filter(s => s);
            
            // Parse disciplines
            const disciplines = disciplinesStr.split(',').map(s => s.trim()).filter(s => s);
            
            // Parse packages
            const packages = packagesStr.split(',').map(s => s.trim()).filter(s => s);
            
            // Update projectData
            projectData.phases = phases.length > 0 ? phases : ['Base'];
            projectData.disciplines = disciplines.length > 0 ? disciplines : [];
            projectData.packages = packages.length > 0 ? packages : ['Preliminary', 'Final'];
            
            // Store scope information
            projectData.projectScope = scopeStr || '';
            projectData.scheduleNotes = scheduleStr || '';
            projectData.disciplineScopes = disciplineScopes;
            
            // Set all budgets to 0 - user will set via Cost Estimator in Step 4
            projectData.budgets = {};
            disciplines.forEach(disc => {
                projectData.budgets[disc] = 0;
            });
            
            // Initialize claiming (even distribution)
            const claimPerPackage = Math.floor(100 / projectData.packages.length);
            const remainder = 100 - (claimPerPackage * projectData.packages.length);
            
            projectData.claiming = {};
            projectData.disciplines.forEach(disc => {
                projectData.packages.forEach((pkg, i) => {
                    const key = `${disc}-${pkg}`;
                    projectData.claiming[key] = claimPerPackage + (i === projectData.packages.length - 1 ? remainder : 0);
                });
            });
            
            // Initialize dates (placeholder, spread across 6 months)
            const today = new Date();
            projectData.dates = {};
            projectData.disciplines.forEach(disc => {
                projectData.packages.forEach((pkg, i) => {
                    const key = `${disc}-${pkg}`;
                    const startOffset = i * 30;
                    const endOffset = startOffset + 28;
                    
                    const startDate = new Date(today);
                    startDate.setDate(startDate.getDate() + startOffset);
                    const endDate = new Date(today);
                    endDate.setDate(endDate.getDate() + endOffset);
                    
                    projectData.dates[key] = {
                        start: startDate.toISOString().split('T')[0],
                        end: endDate.toISOString().split('T')[0]
                    };
                });
            });
            
            // Update wizard UI
            document.getElementById('phases-input').value = projectData.phases.join(', ');
            document.getElementById('packages-input').value = projectData.packages.join(', ');
            
            // Update disciplines grid
            const grid = document.getElementById('disciplines-grid');
            grid.innerHTML = '';
            
            // First add existing disciplines, marking selected ones
            allDisciplines.forEach(d => {
                const isSelected = projectData.disciplines.includes(d.name);
                grid.innerHTML += `<div class="disc-item ${isSelected ? 'selected' : ''}" onclick="toggleDisc(this)" data-name="${d.name}">${d.name}</div>`;
            });
            
            // Add any custom disciplines from RFP
            projectData.disciplines.forEach(disc => {
                if (!allDisciplines.find(d => d.name === disc)) {
                    grid.innerHTML += `<div class="disc-item selected" onclick="toggleDisc(this)" data-name="${disc}">${disc}</div>`;
                    // Add to example budgets
                    if (!exampleBudgets[disc]) {
                        exampleBudgets[disc] = budgets[disc] || 100000;
                    }
                }
            });
            
            updateSelectedCount();
            
            // Trigger autosave with RFP data
            triggerAutosave();
            
            // Close modal and go to step 1
            closeRfpWizard();
            
            // Reset to step 1
            currentStep = 1;
            showStep(1);
            
            // Show success message
            alert(`RFP data imported successfully!\n\n ${projectData.phases.length} phases\n ${projectData.disciplines.length} disciplines\n ${projectData.packages.length} packages\n\nReview and adjust the data in each step.`);
        }

        /**
         * Exports the RFP extracted data as a professional PDF
         */
        function exportRfpData() {
            const today = new Date().toLocaleDateString();
            
            // Get current values from preview fields
            const phasesStr = document.getElementById('rfp-preview-phases').value;
            const disciplinesStr = document.getElementById('rfp-preview-disciplines').value;
            const packagesStr = document.getElementById('rfp-preview-packages').value;
            const scopeStr = document.getElementById('rfp-preview-scope').value;
            const scheduleStr = document.getElementById('rfp-preview-schedule').value;
            
            // Get discipline scopes from textarea fields
            const disciplineScopes = {};
            document.querySelectorAll('.rfp-discipline-scope-textarea').forEach(textarea => {
                const disc = textarea.getAttribute('data-discipline');
                const scope = textarea.value.trim();
                if (disc && scope) {
                    disciplineScopes[disc] = scope;
                }
            });
            
            // Get notes
            const notesEl = document.getElementById('rfp-notes-text');
            const notes = notesEl ? notesEl.textContent : '';
            
            // Parse data
            const phases = phasesStr.split(',').map(s => s.trim()).filter(s => s);
            const disciplines = disciplinesStr.split(',').map(s => s.trim()).filter(s => s);
            const packages = packagesStr.split(',').map(s => s.trim()).filter(s => s);
            const stats = rfpState.usageStats;
            
            let html = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>RFP Analysis Report</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            color: #333;
            background: #fff;
            font-size: 11pt;
            line-height: 1.5;
        }
        .page { padding: 40px; max-width: 8.5in; }
        .header {
            background: linear-gradient(135deg, #0d4f3c 0%, #1a7a5c 100%);
            color: #fff;
            padding: 35px 40px;
            margin: -40px -40px 30px -40px;
        }
        .header h1 {
            font-size: 26pt;
            font-weight: 300;
            margin-bottom: 8px;
            letter-spacing: 1px;
        }
        .header .subtitle { font-size: 11pt; opacity: 0.8; margin-bottom: 20px; }
        .header-info {
            display: flex;
            gap: 40px;
            font-size: 10pt;
        }
        .header-info-item { }
        .header-info-label { opacity: 0.6; font-size: 9pt; text-transform: uppercase; }
        .header-info-value { font-size: 13pt; font-weight: 600; margin-top: 2px; }
        
        h2 {
            color: #0d4f3c;
            font-size: 14pt;
            font-weight: 600;
            margin: 28px 0 14px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid #e0e0e0;
        }
        h3 {
            color: #444;
            font-size: 12pt;
            font-weight: 600;
            margin: 18px 0 10px 0;
        }
        
        .stats-box {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border: 1px solid #a5d6a7;
            border-radius: 6px;
            padding: 18px;
            margin: 18px 0;
        }
        .stats-box h3 { color: #2e7d32; margin-top: 0; font-size: 11pt; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 12px;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 10px;
            background: rgba(255,255,255,0.7);
            border-radius: 4px;
            font-size: 10pt;
        }
        .stat-label { color: #666; }
        .stat-value { font-weight: 600; color: #2e7d32; }
        
        .scope-box {
            background: #f5f5f5;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 18px;
            margin: 18px 0;
        }
        .scope-box h3 { color: #333; margin-top: 0; }
        .scope-text { color: #444; white-space: pre-wrap; }
        
        .list-section { margin: 15px 0; }
        .list-section ul { margin: 0; padding-left: 20px; }
        .list-section li { margin: 5px 0; }
        
        .discipline-card {
            background: #fafafa;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 16px;
            margin: 12px 0;
            page-break-inside: avoid;
        }
        .discipline-card h3 { margin: 0 0 10px 0; color: #0d4f3c; }
        .discipline-scope {
            color: #555;
            font-size: 10pt;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        .no-scope { color: #999; font-style: italic; }
        
        .notes-box {
            background: #fff8e1;
            border: 1px solid #ffe082;
            border-radius: 6px;
            padding: 16px;
            margin: 18px 0;
        }
        .notes-box h3 { color: #f57c00; margin-top: 0; }
        
        .footer {
            margin-top: 30px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
            font-size: 9pt;
            color: #888;
            text-align: center;
        }
        
        .page-break { page-break-before: always; }
    </style>
</head>
<body>
    <div class="page">
        <div class="header">
            <h1>RFP Analysis Report</h1>
            <div class="subtitle">AI-Extracted Project Information</div>
            <div class="header-info">
                <div class="header-info-item">
                    <div class="header-info-label">Report Date</div>
                    <div class="header-info-value">${today}</div>
                </div>
                <div class="header-info-item">
                    <div class="header-info-label">Disciplines</div>
                    <div class="header-info-value">${disciplines.length}</div>
                </div>
                <div class="header-info-item">
                    <div class="header-info-label">Phases</div>
                    <div class="header-info-value">${phases.length}</div>
                </div>
                <div class="header-info-item">
                    <div class="header-info-label">Packages</div>
                    <div class="header-info-value">${packages.length}</div>
                </div>
            </div>
        </div>
`;

            // Usage Statistics
            if (stats && stats.totalTokens > 0) {
                const processingTime = stats.endTime && stats.startTime ? ((stats.endTime - stats.startTime) / 1000).toFixed(1) + 's' : 'N/A';
                html += `
        <div class="stats-box">
            <h3> Analysis Statistics</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-label">API Calls</span>
                    <span class="stat-value">${stats.apiCalls}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Model</span>
                    <span class="stat-value">${stats.model || 'gpt-5.2'}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Total Tokens</span>
                    <span class="stat-value">${formatNumber(stats.totalTokens)}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Processing Time</span>
                    <span class="stat-value">${processingTime}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Estimated Cost</span>
                    <span class="stat-value">$${stats.estimatedCost.toFixed(4)}</span>
                </div>
            </div>
        </div>
`;
            }

            // Project Scope
            html += `
        <h2>Project Scope Summary</h2>
        <div class="scope-box">
            <div class="scope-text">${scopeStr ? scopeStr.replace(/\n/g, '<br>') : '<em>No scope summary extracted</em>'}</div>
        </div>
`;

            // Schedule Information
            if (scheduleStr) {
                html += `
        <h2>Schedule Information</h2>
        <div class="scope-box">
            <div class="scope-text">${scheduleStr.replace(/\n/g, '<br>')}</div>
        </div>
`;
            }

            // Phases & Packages
            html += `
        <h2>Project Structure</h2>
        <div class="list-section">
            <h3>Phases</h3>
            ${phases.length > 0 ? '<ul>' + phases.map(p => `<li>${p}</li>`).join('') + '</ul>' : '<p style="color:#999;font-style:italic;">No phases extracted</p>'}
        </div>
        <div class="list-section">
            <h3>Deliverable Packages</h3>
            ${packages.length > 0 ? '<ul>' + packages.map(p => `<li>${p}</li>`).join('') + '</ul>' : '<p style="color:#999;font-style:italic;">No packages extracted</p>'}
        </div>
        
        <h2>Disciplines & Scope of Work</h2>
`;

            if (disciplines.length > 0) {
                disciplines.forEach(disc => {
                    const scope = disciplineScopes[disc];
                    html += `
        <div class="discipline-card">
            <h3>${disc}</h3>
            ${scope ? `<div class="discipline-scope">${scope.replace(/\n/g, '<br>')}</div>` : '<div class="no-scope">No specific scope extracted for this discipline</div>'}
        </div>
`;
                });
            } else {
                html += `<p style="color:#999;font-style:italic;">No disciplines extracted</p>`;
            }

            // AI Notes
            if (notes && notes !== 'Analysis notes will appear here...') {
                html += `
        <div class="notes-box">
            <h3> AI Analysis Notes</h3>
            <div>${notes.replace(/\n/g, '<br>')}</div>
        </div>
`;
            }

            html += `
        <div class="footer">
            Generated by WBS Terminal RFP Wizard  ${today}  Powered by AI Document Analysis
        </div>
    </div>
</body>
</html>`;

            // Generate PDF
            const container = document.createElement('div');
            container.innerHTML = html;
            document.body.appendChild(container);
            
            const opt = {
                margin: [0.25, 0.25, 0.25, 0.25],
                filename: `rfp_analysis_${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' },
                pagebreak: { mode: ['css', 'legacy'] }
            };
            
            html2pdf().set(opt).from(container).save().then(() => {
                document.body.removeChild(container);
            }).catch(err => {
                console.error('PDF generation failed:', err);
                document.body.removeChild(container);
                alert('PDF generation failed. Please try again.');
            });
        }
    </script>

    <!-- RFP Wizard Modal -->
    <div id="rfp-modal" class="rfp-modal" onclick="if(event.target===this)closeRfpWizard()">
        <div class="rfp-modal-content">
            <div class="rfp-modal-header">
                <h2> RFP Wizard - Extract Project Data</h2>
                <button class="rfp-modal-close" onclick="closeRfpWizard()"></button>
            </div>
            <div class="rfp-modal-body">
                <!-- Stage Indicator -->
                <div class="rfp-stage-indicator">
                    <div class="rfp-stage active" data-stage="1">1. Upload PDF</div>
                    <div class="rfp-stage" data-stage="2">2. Select Pages</div>
                    <div class="rfp-stage" data-stage="3">3. Review & Apply</div>
                </div>

                <!-- Stage 1: Upload -->
                <div id="rfp-stage-1" class="rfp-stage-content active">
                    <div class="rfp-dropzone" id="rfp-dropzone" onclick="document.getElementById('rfp-file-input').click()">
                        <div class="rfp-dropzone-icon"></div>
                        <div class="rfp-dropzone-text">Drag & drop your RFP PDF here</div>
                        <div class="rfp-dropzone-hint">or click to browse</div>
                    </div>
                    <input type="file" id="rfp-file-input" accept=".pdf" style="display: none;" onchange="handleRfpFileSelect(event)">
                    
                    <div id="rfp-file-info" class="rfp-file-info">
                        <div class="rfp-file-icon"></div>
                        <div class="rfp-file-details">
                            <div id="rfp-file-name" class="rfp-file-name">document.pdf</div>
                            <div id="rfp-file-meta" class="rfp-file-meta">2.4 MB</div>
                        </div>
                        <button class="rfp-file-remove" onclick="removeRfpFile()">Remove</button>
                    </div>

                    <div class="rfp-modal-actions">
                        <button class="rfp-btn" onclick="closeRfpWizard()">Cancel</button>
                        <button id="rfp-next-1" class="rfp-btn rfp-btn-primary" onclick="goToRfpStage(2)" disabled>Next: Select Pages </button>
                    </div>
                </div>

                <!-- Stage 2: Page Selection -->
                <div id="rfp-stage-2" class="rfp-stage-content">
                    <div class="rfp-page-info">
                        <div class="rfp-page-count" id="rfp-page-count">0</div>
                        <div class="rfp-page-label">Total pages in document</div>
                    </div>

                    <div class="rfp-page-input-group">
                        <label>Which pages contain scope/project information?</label>
                        <input type="text" id="rfp-page-range" placeholder="e.g., 1-10 or 5,7,12-15 or leave blank for all">
                        <div class="rfp-page-hint">
                            Tip: Usually the scope of work, deliverables, and schedule are in the first 10-20 pages. 
                            Leave blank to analyze all pages.
                        </div>
                    </div>

                    <!-- Text Preview Section -->
                    <div id="rfp-text-preview-section" style="display: none; margin-top: 20px;">
                        <div class="rfp-preview-card" style="background: #1a1a1a; border: 1px solid #333;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <h4 style="margin: 0; color: #ffd700;">Extracted Text Preview</h4>
                                <button class="rfp-btn" style="padding: 6px 12px; font-size: 11px;" onclick="toggleTextPreview()">
                                    <span id="rfp-preview-toggle-text">Show</span> Preview
                                </button>
                            </div>
                            <div id="rfp-text-preview-stats" style="display: flex; gap: 16px; margin-bottom: 12px; font-size: 11px; color: #888;">
                                <span>Pages: <strong id="rfp-preview-page-count" style="color: #ffd700;">0</strong></span>
                                <span>Characters: <strong id="rfp-preview-char-count" style="color: #ffd700;">0</strong></span>
                                <span>Est. Tokens: <strong id="rfp-preview-token-est" style="color: #ffd700;">~0</strong></span>
                            </div>
                            <div id="rfp-text-preview-content" style="display: none;">
                                <div style="background: #000; border: 1px solid #444; border-radius: 4px; padding: 12px; max-height: 300px; overflow-y: auto; font-size: 11px; color: #ccc; line-height: 1.6; font-family: 'Courier New', monospace; white-space: pre-wrap; word-wrap: break-word;">
                                    <div id="rfp-text-preview-snippet"></div>
                                    <div id="rfp-text-preview-full" style="display: none;"></div>
                                </div>
                                <div style="margin-top: 8px; display: flex; justify-content: space-between; align-items: center;">
                                    <button class="rfp-btn" style="padding: 6px 12px; font-size: 11px;" onclick="toggleFullTextPreview()">
                                        <span id="rfp-full-text-toggle">Show</span> Full Text
                                    </button>
                                    <button class="rfp-btn" style="padding: 6px 12px; font-size: 11px; background: transparent; border-color: #666; color: #888;" onclick="copyExtractedText()">Copy Text</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="rfp-modal-actions">
                        <button class="rfp-btn" onclick="goToRfpStage(1)"> Back</button>
                        <button id="rfp-preview-text-btn" class="rfp-btn" onclick="previewExtractedText()" style="display: none;">Preview Text</button>
                        <button class="rfp-btn rfp-btn-primary" onclick="analyzeRfpDocument()">Analyze with AI </button>
                    </div>
                </div>

                <!-- Stage 3: Preview -->
                <div id="rfp-stage-3" class="rfp-stage-content">
                    <!-- Loading State -->
                    <div id="rfp-loading" class="rfp-loading visible">
                        <div class="rfp-spinner"></div>
                        <div class="rfp-loading-text">Analyzing document with AI...</div>
                    </div>

                    <!-- Preview Content -->
                    <div id="rfp-preview" style="display: none;">
                        <div class="rfp-preview-grid">
                            <div class="rfp-preview-card">
                                <h4>Phases <span id="rfp-conf-phases" class="rfp-confidence high">HIGH</span></h4>
                                <textarea id="rfp-preview-phases" placeholder="e.g., Base, ESDC, TSCD"></textarea>
                            </div>
                            <div class="rfp-preview-card">
                                <h4>Disciplines <span id="rfp-conf-disciplines" class="rfp-confidence high">HIGH</span></h4>
                                <textarea id="rfp-preview-disciplines" placeholder="e.g., Structures, Civil, Traffic"></textarea>
                            </div>
                            <div class="rfp-preview-card full-width">
                                <h4>Discipline-Specific Scopes <span id="rfp-conf-disciplines-scope" class="rfp-confidence medium">MED</span></h4>
                                <div style="color: #666; font-size: 10px; margin-bottom: 12px; font-style: italic;">
                                    Detailed scope of work for each discipline. Edit as needed for accuracy.
                                </div>
                                <div id="rfp-discipline-scopes-container" style="display: flex; flex-direction: column; gap: 12px;">
                                    <!-- Discipline scopes will be dynamically added here -->
                                </div>
                            </div>
                            <div class="rfp-preview-card">
                                <h4>Packages <span id="rfp-conf-packages" class="rfp-confidence medium">MED</span></h4>
                                <textarea id="rfp-preview-packages" placeholder="e.g., Preliminary, Interim, Final, RFC"></textarea>
                            </div>
                            <div class="rfp-preview-card">
                                <h4>Budgets</h4>
                                <div style="color: #666; font-size: 11px; padding: 10px; background: #000; border-radius: 4px;">
                                    Budgets will be set to $0 initially. Use the Cost Estimator in Step 4 to calculate budgets based on construction cost.
                                </div>
                            </div>
                            <div class="rfp-preview-card full-width">
                                <h4>Scope Summary <span id="rfp-conf-scope" class="rfp-confidence medium">MED</span></h4>
                                <textarea id="rfp-preview-scope" placeholder="Project scope and work description extracted from RFP..."></textarea>
                            </div>
                            <div class="rfp-preview-card full-width">
                                <h4>Schedule Notes <span id="rfp-conf-schedule" class="rfp-confidence medium">MED</span></h4>
                                <textarea id="rfp-preview-schedule" placeholder="Schedule information extracted from RFP..."></textarea>
                            </div>
                        </div>

                        <div id="rfp-truncation-notice" class="rfp-notes" style="display: none; background: #2a1a00; border-color: #ff8800;">
                            <h4> Document Truncated</h4>
                            <p id="rfp-truncation-text">Only the first portion of the document was analyzed due to size limits.</p>
                        </div>

                        <div id="rfp-notes" class="rfp-notes" style="display: none;">
                            <h4> AI Notes</h4>
                            <p id="rfp-notes-text">Analysis notes will appear here...</p>
                        </div>

                        <div id="rfp-risks" class="rfp-risks-section" style="display: none;">
                            <h4> Identified Risks</h4>
                            <div id="rfp-risks-list" class="rfp-risks-list">
                                <!-- Populated by JS -->
                            </div>
                        </div>

                        <div id="rfp-usage-stats" class="rfp-notes" style="display: none;">
                            <h4> Usage Statistics</h4>
                            <div class="rfp-usage-grid">
                                <div class="rfp-usage-item">
                                    <span class="rfp-usage-label">API Calls</span>
                                    <span class="rfp-usage-value" id="rfp-stats-calls">0</span>
                                </div>
                                <div class="rfp-usage-item">
                                    <span class="rfp-usage-label">Model</span>
                                    <span class="rfp-usage-value" id="rfp-stats-model">-</span>
                                </div>
                                <div class="rfp-usage-item">
                                    <span class="rfp-usage-label">Prompt Tokens</span>
                                    <span class="rfp-usage-value" id="rfp-stats-prompt">0</span>
                                </div>
                                <div class="rfp-usage-item">
                                    <span class="rfp-usage-label">Completion Tokens</span>
                                    <span class="rfp-usage-value" id="rfp-stats-completion">0</span>
                                </div>
                                <div class="rfp-usage-item">
                                    <span class="rfp-usage-label">Total Tokens</span>
                                    <span class="rfp-usage-value" id="rfp-stats-tokens">0</span>
                                </div>
                                <div class="rfp-usage-item">
                                    <span class="rfp-usage-label">Processing Time</span>
                                    <span class="rfp-usage-value time" id="rfp-stats-time">0s</span>
                                </div>
                                <div class="rfp-usage-item full-width">
                                    <span class="rfp-usage-label">Estimated Cost</span>
                                    <span class="rfp-usage-value cost" id="rfp-stats-cost">$0.0000</span>
                                </div>
                            </div>
                        </div>

                        <div class="rfp-modal-actions">
                            <button class="rfp-btn" onclick="goToRfpStage(2)"> Re-analyze</button>
                            <button class="rfp-btn" onclick="exportRfpData()"> Export</button>
                            <button class="rfp-btn rfp-btn-primary" onclick="applyRfpData()">Apply to Project </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat FAB Button -->
    <button id="chat-fab" class="chat-fab" onclick="toggleChat()" title="AI Assistant">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
        </svg>
    </button>

    <!-- Chat Panel -->
    <div id="chat-panel" class="chat-panel">
        <div class="chat-header">
            <div class="chat-header-title">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                </svg>
                <span>WBS Assistant</span>
            </div>
            <span id="chat-context-badge" class="chat-context-badge">STEP 1</span>
            <div class="chat-header-actions">
                <button class="chat-header-btn" onclick="resetChatPosition()" title="Reset position">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                        <polyline points="9 22 9 12 15 12 15 22"/>
                    </svg>
                </button>
                <button class="chat-header-btn" onclick="clearChat()" title="Clear chat">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"/>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                    </svg>
                </button>
                <button class="chat-header-btn" onclick="openChatSettings()" title="Settings">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                </button>
                <button class="chat-header-btn" onclick="toggleChat()" title="Close">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
        </div>
        <div id="chat-messages" class="chat-messages"></div>
        <div class="chat-input-area">
            <textarea 
                id="chat-input" 
                class="chat-input" 
                placeholder="Ask about this step..." 
                rows="1"
                onkeydown="handleChatKeydown(event)"
                oninput="autoResizeChatInput()"
            ></textarea>
            <button id="chat-send-btn" class="chat-send-btn" onclick="sendMessage()" title="Send">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- Projects Manager Modal -->
    <div id="projects-modal" class="projects-modal" onclick="if(event.target===this)closeProjectManager()">
        <div class="projects-modal-content">
            <div class="projects-modal-header">
                <h3> Project Manager</h3>
                <button class="projects-close-btn" onclick="closeProjectManager()"></button>
            </div>
            
            <div class="projects-modal-body">
                <!-- Save Current Project -->
                <div class="projects-section">
                    <div class="projects-section-title">Save Current Project</div>
                    <div class="projects-save-form">
                        <input type="text" id="project-save-name" placeholder="Enter project name...">
                        <button class="btn btn-primary btn-sm" onclick="saveNamedProject()">SAVE</button>
                    </div>
                </div>
                
                <!-- Saved Projects List -->
                <div class="projects-section">
                    <div class="projects-section-title">Saved Projects</div>
                    <div id="projects-list" class="projects-list">
                        <!-- Populated by JS -->
                    </div>
                </div>
                
                <!-- Compare Projects -->
                <div id="compare-section" class="projects-section hidden">
                    <div class="projects-section-title">Compare Selected Projects</div>
                    <div id="compare-view" class="compare-view">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recovery Modal -->
    <div id="recovery-modal" class="recovery-modal" onclick="if(event.target===this)dismissRecovery()">
        <div class="recovery-modal-content">
            <h3> Recover Previous Session?</h3>
            <p>We found unsaved work from a previous session. Would you like to restore it?</p>
            <div class="recovery-preview" id="recovery-preview">
                <!-- Populated dynamically -->
            </div>
            <div class="recovery-modal-actions">
                <button class="btn btn-danger" onclick="discardRecovery()">Start Fresh</button>
                <button class="btn btn-primary" onclick="restoreRecovery()">Restore Session</button>
            </div>
        </div>
    </div>

    <!-- Autosave Indicator -->
    <div id="autosave-indicator" class="autosave-indicator">
        <span id="autosave-icon"></span>
        <span id="autosave-text">Saved</span>
    </div>

    <!-- API Key Modal -->
    <div id="chat-api-modal" class="chat-api-modal" onclick="if(event.target===this)hideApiKeyModal()">
        <div class="chat-api-modal-content">
            <h3> OpenAI API Key Required</h3>
            <p>Enter your OpenAI API key to enable the AI assistant. Your key is stored locally in your browser and never sent anywhere except OpenAI.</p>
            <input 
                type="password" 
                id="api-key-input" 
                placeholder="sk-..." 
                onkeydown="if(event.key==='Enter')saveApiKey()"
            >
            <div class="chat-api-modal-actions">
                <button class="btn" onclick="hideApiKeyModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveApiKey()">Save Key</button>
            </div>
        </div>
    </div>
</body>
</html>
