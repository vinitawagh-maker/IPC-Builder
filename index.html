<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WBS Terminal v1.0</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'JetBrains Mono', monospace;
            box-sizing: border-box;
        }
        
        body {
            background: #0a0a0a;
            color: #ffd700;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        /* Terminal Window */
        .terminal {
            border: 2px solid #ffd700;
            background: #0d0d0d;
        }
        
        .terminal-header {
            background: #ffd700;
            color: #000;
            padding: 8px 16px;
            font-weight: 700;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
        }
        
        .terminal-header .btn {
            margin: 0;
            font-size: 12px;
            padding: 6px 12px;
            white-space: nowrap;
        }
        
        .terminal-header .btn-primary {
            background: #000;
            color: #ffd700;
            border-color: #000;
        }
        
        .terminal-header .btn-primary:hover {
            background: #333;
            border-color: #333;
        }
        
        .terminal-header .btn:not(.btn-primary) {
            background: transparent;
            color: #000;
            border-color: #000;
        }
        
        .terminal-header .btn:not(.btn-primary):hover {
            background: #000;
            color: #ffd700;
        }
        
        .terminal-body {
            padding: 24px;
        }
        
        /* Progress Bar */
        .progress-bar {
            display: flex;
            gap: 4px;
            margin-bottom: 24px;
            font-size: 12px;
        }
        
        .progress-step {
            flex: 1;
            text-align: center;
            padding: 8px 4px;
            border: 1px solid #333;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .progress-step.active {
            background: #ffd700;
            color: #000;
            border-color: #ffd700;
        }
        
        .progress-step.completed {
            background: #2d2d00;
            color: #ffd700;
            border-color: #ffd700;
        }
        
        .progress-step:hover {
            border-color: #ffd700;
        }
        
        /* Section */
        .section-title {
            color: #fff;
            font-size: 18px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-title::before {
            content: ">";
            color: #ffd700;
        }
        
        .section-desc {
            color: #888;
            font-size: 13px;
            margin-bottom: 20px;
        }
        
        /* Inputs */
        input[type="text"],
        input[type="number"],
        input[type="date"],
        select {
            background: #000;
            border: 1px solid #444;
            color: #ffd700;
            padding: 12px;
            width: 100%;
            font-size: 14px;
            outline: none;
        }
        
        input:focus,
        select:focus {
            border-color: #ffd700;
        }
        
        input::placeholder {
            color: #555;
        }
        
        /* Buttons */
        .btn {
            background: transparent;
            border: 2px solid #ffd700;
            color: #ffd700;
            padding: 12px 24px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .btn:hover {
            background: #ffd700;
            color: #000;
        }
        
        .btn-primary {
            background: #ffd700;
            color: #000;
        }
        
        .btn-primary:hover {
            background: #fff;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        /* Discipline Grid */
        .disc-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .disc-item {
            border: 1px solid #333;
            padding: 10px 12px;
            cursor: pointer;
            font-size: 13px;
            color: #888;
            transition: all 0.2s;
        }
        
        .disc-item:hover {
            border-color: #ffd700;
            color: #ffd700;
        }
        
        .disc-item.selected {
            background: #ffd700;
            color: #000;
            border-color: #ffd700;
        }
        
        .disc-item::before {
            content: "[ ] ";
        }
        
        .disc-item.selected::before {
            content: "[X] ";
        }
        
        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        th {
            background: #1a1a00;
            color: #ffd700;
            text-align: left;
            padding: 10px 12px;
            border: 1px solid #333;
            font-weight: 600;
        }
        
        td {
            padding: 8px 12px;
            border: 1px solid #333;
            color: #ccc;
        }
        
        tr:hover td {
            background: #1a1a00;
        }
        
        .table-input {
            background: transparent;
            border: none;
            color: #ffd700;
            width: 100%;
            padding: 4px;
            text-align: right;
        }
        
        .table-input:focus {
            outline: 1px solid #ffd700;
        }
        
        
        /* Hidden */
        .hidden {
            display: none !important;
        }
        
        /* Quick Tags */
        .quick-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }
        
        .quick-tag {
            background: #1a1a00;
            border: 1px solid #444;
            color: #ffd700;
            padding: 4px 10px;
            font-size: 11px;
            cursor: pointer;
        }
        
        .quick-tag:hover {
            background: #2d2d00;
            border-color: #ffd700;
        }
        
        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .kpi-card {
            border: 1px solid #ffd700;
            padding: 16px;
            text-align: center;
        }
        
        .kpi-value {
            font-size: 24px;
            color: #ffd700;
            font-weight: 700;
        }
        
        .kpi-label {
            font-size: 11px;
            color: #888;
            margin-top: 4px;
        }
        
        /* Chart Container */
        .chart-container {
            background: #000;
            border: 1px solid #333;
            padding: 20px;
            margin-top: 24px;
        }
        
        /* Filters */
        .filters {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .filter-group label {
            display: block;
            font-size: 11px;
            color: #888;
            margin-bottom: 4px;
        }
        
        /* Status */
        .status-ok {
            color: #00ff00;
        }
        
        .status-err {
            color: #ff4444;
        }
        
        /* Results Table */
        .results-table {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #333;
        }
        
        .results-table thead {
            position: sticky;
            top: 0;
        }
        
        .results-table tfoot {
            position: sticky;
            bottom: 0;
        }
        
        .results-table tfoot td {
            background: #ffd700;
            color: #000;
            font-weight: 700;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #111;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #ffd700;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .filters {
                grid-template-columns: repeat(2, 1fr);
            }
            .disc-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .terminal-header {
                flex-wrap: wrap;
                gap: 8px;
                padding: 8px 12px;
            }
            
            .terminal-header > span {
                order: 2;
                width: 100%;
                text-align: center;
                font-size: 13px;
            }
            
            .terminal-header .btn {
                font-size: 11px;
                padding: 4px 8px;
                min-width: 60px;
            }
            
            .terminal-header > div {
                order: 3;
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .terminal-header #status-text {
                font-size: 11px;
            }
        }

        /* ASCII decorations */
        .ascii-line {
            color: #444;
            font-size: 12px;
            margin: 16px 0;
            overflow: hidden;
            white-space: nowrap;
        }
        
        /* Blinking cursor */
        .cursor::after {
            content: "_";
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        /* Budget Calculator */
        .budget-calculator {
            border: 1px solid #444;
            margin-bottom: 20px;
            background: #111;
        }

        .calculator-header {
            background: #1a1a00;
            padding: 10px 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
            transition: background 0.2s;
        }

        .calculator-header:hover {
            background: #2d2d00;
        }

        .calculator-header span:first-child {
            color: #ffd700;
            font-weight: 600;
            font-size: 13px;
        }

        .calculator-body {
            padding: 16px;
            display: block;
            overflow: hidden;
            max-height: 1000px;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
        }

        .calculator-body.collapsed {
            max-height: 0;
            padding: 0 16px;
        }

        .calc-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .calc-group label {
            display: block;
            font-size: 11px;
            color: #888;
            margin-bottom: 6px;
        }

        .calc-group input,
        .calc-group select {
            font-size: 13px;
        }

        .complexity-override-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .complexity-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .complexity-item label {
            flex: 1;
            color: #ccc;
        }

        .complexity-item select {
            flex: 0 0 100px;
            padding: 4px 8px;
            font-size: 11px;
        }

        /* Industry Indicator */
        .industry-indicator {
            display: inline-block;
            width: 16px;
            text-align: center;
            cursor: help;
            font-weight: 700;
            margin-left: 4px;
        }

        .industry-indicator.above {
            color: #ff6666;
        }

        .industry-indicator.below {
            color: #66ff66;
        }

        .industry-indicator.within {
            color: #ffd700;
        }

        /* Tooltip */
        .tooltip {
            position: relative;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 220px;
            background-color: #1a1a1a;
            color: #ffd700;
            text-align: left;
            border: 1px solid #ffd700;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            font-size: 11px;
            line-height: 1.4;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Claiming Preset Panel */
        .claiming-preset-panel {
            background-color: #0a0a0a;
            border: 1px solid #ffd700;
            border-radius: 4px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .preset-header {
            background-color: #1a1a1a;
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #ffd700;
            font-weight: bold;
            font-size: 12px;
            user-select: none;
            border-bottom: 1px solid #ffd700;
        }

        .preset-header:hover {
            background-color: #222;
        }

        .preset-body {
            padding: 20px;
            display: block;
        }

        .preset-body.hidden {
            display: none;
        }

        .preset-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .preset-option {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 12px;
            background-color: #1a1a1a;
            border: 1px solid #333;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .preset-option:hover {
            border-color: #ffd700;
            background-color: #222;
        }

        .preset-option input[type="radio"] {
            margin-top: 2px;
            cursor: pointer;
            accent-color: #ffd700;
        }

        .preset-label {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
        }

        .preset-name {
            color: #ffd700;
            font-weight: bold;
            font-size: 13px;
        }

        .preset-desc {
            color: #888;
            font-size: 11px;
            line-height: 1.4;
        }

        .preset-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .preset-actions .btn {
            flex: 1;
            padding: 10px;
            background-color: #1a1a1a;
            color: #ffd700;
            border: 1px solid #ffd700;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.2s;
        }

        .preset-actions .btn:hover {
            background-color: #ffd700;
            color: #0a0a0a;
        }

        .preset-actions .btn-primary {
            background-color: #ffd700;
            color: #0a0a0a;
        }

        .preset-actions .btn-primary:hover {
            background-color: #ffed4e;
        }

        .preset-preview {
            padding: 15px;
            background-color: #1a1a1a;
            border: 1px solid #333;
            border-radius: 4px;
            font-size: 11px;
            color: #888;
            line-height: 1.6;
        }

        .preset-preview.hidden {
            display: none;
        }

        .preset-preview strong {
            color: #ffd700;
        }

        @media (max-width: 768px) {
            .calc-grid {
                grid-template-columns: 1fr;
            }
            .complexity-override-grid {
                grid-template-columns: 1fr;
            }
            .preset-options {
                grid-template-columns: 1fr;
            }
            .preset-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="terminal" style="margin-bottom: 20px;">
            <div class="terminal-header">
                <button id="prev-btn" class="btn btn-sm hidden" onclick="prevStep()">← BACK</button>
                <span>■ WBS TERMINAL v1.0</span>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span id="status-text">READY</span>
                    <button id="next-btn" class="btn btn-sm btn-primary" onclick="nextStep()">NEXT →</button>
                    <button id="generate-btn" class="btn btn-sm btn-primary hidden" onclick="generateWBS()">GENERATE WBS</button>
                </div>
            </div>
        </div>

        <!-- Main Terminal -->
        <div class="terminal">
            <div class="terminal-body">
                <!-- Progress Bar -->
                <div id="progress-section" class="progress-bar">
                    <div class="progress-step active" onclick="goToStep(1)">1:PHASES</div>
                    <div class="progress-step" onclick="goToStep(2)">2:DISCIPLINES</div>
                    <div class="progress-step" onclick="goToStep(3)">3:PACKAGES</div>
                    <div class="progress-step" onclick="goToStep(4)">4:BUDGET</div>
                    <div class="progress-step" onclick="goToStep(5)">5:CLAIMING</div>
                    <div class="progress-step" onclick="goToStep(6)">6:SCHEDULE</div>
                </div>

                <!-- Step 1: Phases -->
                <div id="step1" class="step-content">
                    <div class="section-title">PROJECT PHASES</div>
                    <div class="section-desc">Enter project phases separated by commas</div>
                    
                    <input type="text" id="phases-input" value="Base,">
                    
                    <div class="quick-tags">
                        <span class="quick-tag" onclick="addQuickPhase('Base')">+Base Design</span>
                        <span class="quick-tag" onclick="addQuickPhase('ESDC')">+ESDC</span>
                        <span class="quick-tag" onclick="addQuickPhase('TSCD')">+TSCD</span>
                        <span class="quick-tag" onclick="addQuickPhase('As-Builts')">+As-Builts</span>
                        <span class="quick-tag" onclick="addQuickPhase('Closeout')">+Closeout</span>
                    </div>
                </div>

                <!-- Step 2: Disciplines -->
                <div id="step2" class="step-content hidden">
                    <div class="section-title">PROJECT DISCIPLINES</div>
                    <div class="section-desc">Select disciplines involved in the project</div>
                    
                    <div class="disc-grid" id="disciplines-grid"></div>
                    
                    <div style="display: flex; gap: 8px; margin-top: 16px;">
                        <input type="text" id="custom-discipline" placeholder="Custom discipline..." style="flex: 1;">
                        <button class="btn btn-sm" onclick="addCustomDiscipline()">ADD</button>
                        <button class="btn btn-sm" onclick="selectAllDisciplines()">ALL</button>
                    </div>
                    
                    <div style="margin-top: 12px; color: #888; font-size: 12px;">
                        Selected: <span id="selected-count" style="color: #ffd700;">0</span>
                    </div>
                </div>

                <!-- Step 3: Packages -->
                <div id="step3" class="step-content hidden">
                    <div class="section-title">DELIVERABLE PACKAGES</div>
                    <div class="section-desc">Enter package milestones separated by commas</div>
                    
                    <input type="text" id="packages-input" value="Preliminary, Interim, Final, RFC, As-Buit">
                    
                    <div class="quick-tags">
                        <span class="quick-tag" onclick="addQuickPackage('Preliminary')">+Preliminary</span>
                        <span class="quick-tag" onclick="addQuickPackage('Interim')">+Interim</span>
                        <span class="quick-tag" onclick="addQuickPackage('Final')">+Final</span>
                        <span class="quick-tag" onclick="addQuickPackage('RFC')">+RFC</span>
                        <span class="quick-tag" onclick="addQuickPackage('As-Built')">+As-Built</span>
                    </div>
                </div>

                <!-- Step 4: Budget -->
                <div id="step4" class="step-content hidden">
                    <div class="section-title">DISCIPLINE BUDGETS</div>
                    <div class="section-desc">Enter total budget per discipline (distributed by claiming %)</div>

                    <!-- CALCULATOR SECTION -->
                    <div id="budget-calculator" class="budget-calculator">
                        <div class="calculator-header" onclick="toggleCalculator()">
                            <span>▼ COST ESTIMATOR</span>
                            <span id="calculator-status" style="color: #888; font-size: 11px;">Configure inputs below</span>
                        </div>

                        <div id="calculator-body" class="calculator-body">
                            <div class="calc-grid">
                                <div class="calc-group">
                                    <label>Total Construction Cost ($)</label>
                                    <input type="number" id="calc-construction-cost" placeholder="5000000" min="0" step="10000">
                                </div>

                                <div class="calc-group">
                                    <label>Design Fee (% of Construction)</label>
                                    <input type="number" id="calc-design-fee-pct" value="15" min="1" max="30" step="0.5">
                                </div>

                                <div class="calc-group">
                                    <label>Project Type</label>
                                    <select id="calc-project-type" onchange="updateComplexityDefaults()">
                                        <option value="Bridge">Bridge</option>
                                        <option value="Highway/Roadway" selected>Highway/Roadway</option>
                                        <option value="Drainage/Utilities">Drainage/Utilities</option>
                                    </select>
                                </div>

                                <div class="calc-group">
                                    <label>Project Complexity (Reference)</label>
                                    <select id="calc-global-complexity">
                                        <option value="Low">Low</option>
                                        <option value="Medium" selected>Medium</option>
                                        <option value="High">High</option>
                                    </select>
                                </div>
                            </div>

                            <div style="margin-top: 12px; padding: 8px; background: #1a1a00; border: 1px solid #333; font-size: 12px;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Total Design Fee:</span>
                                    <span id="calc-total-fee" style="color: #ffd700; font-weight: 600;">$0</span>
                                </div>
                            </div>

                            <div style="margin-top: 12px; display: flex; gap: 8px; justify-content: flex-end;">
                                <button class="btn btn-sm" onclick="showComplexityOverrides()">Advanced Settings</button>
                                <button class="btn btn-primary btn-sm" onclick="calculateBudgets()">Calculate Estimates</button>
                            </div>

                            <!-- Advanced Complexity Overrides (hidden by default) -->
                            <div id="complexity-overrides" class="hidden" style="margin-top: 16px; border-top: 1px solid #333; padding-top: 16px;">
                                <div style="font-size: 11px; color: #888; margin-bottom: 8px;">
                                    Override auto-assigned complexity levels per discipline:
                                </div>
                                <div id="complexity-grid" class="complexity-override-grid"></div>
                            </div>
                        </div>
                    </div>

                    <div class="ascii-line">────────────────────────────────────────────────────</div>

                    <div style="max-height: 350px; overflow-y: auto;">
                        <table id="budget-table"></table>
                    </div>

                    <div class="ascii-line">────────────────────────────────────────────────────</div>

                    <div style="display: flex; justify-content: space-between; color: #fff;">
                        <span>TOTAL PROJECT BUDGET:</span>
                        <span id="total-budget" style="color: #ffd700; font-size: 18px;">$0</span>
                    </div>
                </div>

                <!-- Step 5: Claiming -->
                <div id="step5" class="step-content hidden">
                    <div class="section-title">CLAIMING SCHEME</div>
                    <div class="section-desc">Set claiming % per package (must total 100%)</div>

                    <!-- PRESET SELECTOR PANEL -->
                    <div class="claiming-preset-panel">
                        <div class="preset-header" onclick="toggleClaimingPresets()">
                            <span>▼ SCHEME PRESETS</span>
                            <span id="preset-status" style="color: #888; font-size: 11px;">Click to apply a preset</span>
                        </div>

                        <div id="preset-body" class="preset-body">
                            <div class="preset-options">
                                <label class="preset-option">
                                    <input type="radio" name="claiming-scheme" value="frontLoaded">
                                    <div class="preset-label">
                                        <span class="preset-name">Front-Loaded</span>
                                        <span class="preset-desc">Higher % early, declining (30→10%)</span>
                                    </div>
                                </label>

                                <label class="preset-option">
                                    <input type="radio" name="claiming-scheme" value="backLoaded">
                                    <div class="preset-label">
                                        <span class="preset-name">Back-Loaded</span>
                                        <span class="preset-desc">Lower % early, increasing (10→30%)</span>
                                    </div>
                                </label>

                                <label class="preset-option">
                                    <input type="radio" name="claiming-scheme" value="bellCurve">
                                    <div class="preset-label">
                                        <span class="preset-name">Bell Curve</span>
                                        <span class="preset-desc">Peak in middle (10-20-40-20-10)</span>
                                    </div>
                                </label>

                                <label class="preset-option">
                                    <input type="radio" name="claiming-scheme" value="linear">
                                    <div class="preset-label">
                                        <span class="preset-name">Linear/Even</span>
                                        <span class="preset-desc">Equal distribution across all</span>
                                    </div>
                                </label>
                            </div>

                            <div class="preset-actions">
                                <button class="btn btn-sm" onclick="previewScheme()">Preview</button>
                                <button class="btn btn-primary btn-sm" onclick="applyClaimingScheme()">Apply to All Disciplines</button>
                            </div>

                            <div id="preview-display" class="preset-preview hidden"></div>
                        </div>
                    </div>

                    <div style="max-height: 350px; overflow-y: auto;">
                        <table id="claiming-table"></table>
                    </div>
                </div>

                <!-- Step 6: Schedule -->
                <div id="step6" class="step-content hidden">
                    <div class="section-title">PROJECT SCHEDULE</div>
                    <div class="section-desc">Set start/end dates per package</div>
                    
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table id="dates-table"></table>
                    </div>
                </div>

            </div>
        </div>

        <!-- Results Section -->
        <div id="results-section" class="hidden" style="margin-top: 20px;">
            <!-- KPIs -->
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-value" id="kpi-budget">$0</div>
                    <div class="kpi-label">TOTAL BUDGET</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="kpi-wbs">0</div>
                    <div class="kpi-label">WBS ELEMENTS</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="kpi-disc">0</div>
                    <div class="kpi-label">DISCIPLINES</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="kpi-months">0</div>
                    <div class="kpi-label">MONTHS</div>
                </div>
            </div>

            <!-- WBS Table -->
            <div class="terminal">
                <div class="terminal-header">
                    <span>■ WBS COST TABLE</span>
                    <div>
                        <button class="btn btn-sm" onclick="exportCSV()" style="margin-right: 8px;">EXPORT CSV</button>
                        <button class="btn btn-sm" onclick="editWBS()">EDIT</button>
                    </div>
                </div>
                <div class="terminal-body">
                    <div class="results-table">
                        <table id="wbs-table"></table>
                    </div>
                </div>
            </div>

            <!-- Chart -->
            <div class="terminal" style="margin-top: 20px;">
                <div class="terminal-header">
                    <span>■ PERFORMANCE CHART</span>
                </div>
                <div class="terminal-body">
                    <div class="filters">
                        <div class="filter-group">
                            <label>PHASE</label>
                            <select id="filter-phase" onchange="updateChart()">
                                <option value="all">All Phases</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>DISCIPLINE</label>
                            <select id="filter-discipline" onchange="updateChart()">
                                <option value="all">All Disciplines</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>VIEW</label>
                            <select id="view-type" onchange="updateChart()">
                                <option value="cumulative">Cumulative</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>CHART</label>
                            <select id="chart-type" onchange="updateChart()">
                                <option value="line">Line</option>
                                <option value="bar">Bar</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="performance-chart" height="300"></canvas>
                    </div>
                    
                    <div style="margin-top: 16px; font-size: 12px; display: flex; gap: 24px;">
                        <span><span style="color: #ffd700;">━━</span> PLANNED (BCWS)</span>
                        <span><span style="color: #00ff00;">┅┅</span> ACTUAL (ACWP) - TBD</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data
        let projectData = {
            phases: [],
            disciplines: [],
            packages: [],
            budgets: {},
            claiming: {},
            dates: {},
            calculator: {
                totalConstructionCost: 0,
                designFeePercent: 15,
                projectType: 'Highway/Roadway',
                totalDesignFee: 0,
                complexityOverrides: {},
                isCalculated: false,
                manualEdits: {}
            }
        };

        let currentStep = 1;
        let chart = null;

        // Discipline list with pre-selected items
        const allDisciplines = [
            { name: 'Structures', selected: true },
            { name: 'Design Management', selected: true },
            { name: 'Civil', selected: false },
            { name: 'Drainage', selected: false },
            { name: 'Electrical', selected: false },
            { name: 'Environmental', selected: false },
            { name: 'Traffic', selected: false },
            { name: 'ITS', selected: false },
            { name: 'Mechanical', selected: false },
            { name: 'Geotechnical', selected: false },
            { name: 'Survey', selected: false },
            { name: 'Landscape', selected: false },
            { name: 'Utilities', selected: false },
            { name: 'Lighting', selected: false },
            { name: 'Pavement', selected: false },
            { name: 'Bridges', selected: false },
            { name: 'Safety', selected: false },
            { name: 'QA/QC', selected: false }
        ];

        // Example budgets [in the future we will use a database to get the budgets]
        const exampleBudgets = {
            'Structures': 450000,
            'Design Management': 180000,
            'Civil': 320000,
            'Drainage': 95000,
            'Electrical': 210000,
            'Environmental': 85000,
            'Traffic': 140000,
            'ITS': 125000,
            'Mechanical': 175000,
            'Geotechnical': 110000,
            'Survey': 65000,
            'Landscape': 55000,
            'Utilities': 90000,
            'Lighting': 75000,
            'Pavement': 280000,
            'Bridges': 520000,
            'Safety': 60000,
            'QA/QC': 95000
        };

        // Default claiming scheme
        const defaultClaiming = [10, 15, 25, 30, 20];

        // Claiming scheme presets
        const claimingSchemes = {
            frontLoaded: {
                name: 'Front-Loaded',
                description: 'Higher % early, declining',
                baseline: [30, 25, 20, 15, 10],
                pattern: 'descending'
            },
            backLoaded: {
                name: 'Back-Loaded',
                description: 'Lower % early, increasing',
                baseline: [10, 15, 20, 25, 30],
                pattern: 'ascending'
            },
            bellCurve: {
                name: 'Bell Curve',
                description: 'Peak in middle',
                baseline: [10, 20, 40, 20, 10],
                pattern: 'bell'
            },
            linear: {
                name: 'Linear/Even',
                description: 'Equal distribution',
                baseline: [20, 20, 20, 20, 20],
                pattern: 'equal'
            }
        };

        // Project complexity mapping per project type
        const projectComplexityMap = {
            'Bridge': {
                'Structures': 'High', 'Design Management': 'Medium', 'Civil': 'High',
                'Drainage': 'Medium', 'Electrical': 'Low', 'Environmental': 'Medium',
                'Traffic': 'Low', 'ITS': 'Low', 'Mechanical': 'Medium',
                'Geotechnical': 'High', 'Survey': 'Medium', 'Landscape': 'Low',
                'Utilities': 'Medium', 'Lighting': 'Low', 'Pavement': 'Low',
                'Bridges': 'High', 'Safety': 'Medium', 'QA/QC': 'Medium'
            },
            'Highway/Roadway': {
                'Structures': 'Medium', 'Design Management': 'High', 'Civil': 'High',
                'Drainage': 'High', 'Electrical': 'Medium', 'Environmental': 'Medium',
                'Traffic': 'High', 'ITS': 'Medium', 'Mechanical': 'Low',
                'Geotechnical': 'Medium', 'Survey': 'High', 'Landscape': 'Medium',
                'Utilities': 'High', 'Lighting': 'Medium', 'Pavement': 'High',
                'Bridges': 'Medium', 'Safety': 'High', 'QA/QC': 'Medium'
            },
            'Drainage/Utilities': {
                'Structures': 'Low', 'Design Management': 'Medium', 'Civil': 'Medium',
                'Drainage': 'High', 'Electrical': 'Medium', 'Environmental': 'High',
                'Traffic': 'Low', 'ITS': 'Low', 'Mechanical': 'Low',
                'Geotechnical': 'Medium', 'Survey': 'Medium', 'Landscape': 'Low',
                'Utilities': 'High', 'Lighting': 'Low', 'Pavement': 'Medium',
                'Bridges': 'Low', 'Safety': 'Low', 'QA/QC': 'Medium'
            }
        };

        // Industry standard design fee distribution percentages
        const industryDistribution = {
            'Bridge': {
                'Structures': { Low: 18, Medium: 22, High: 28 },
                'Design Management': { Low: 8, Medium: 10, High: 13 },
                'Civil': { Low: 10, Medium: 12, High: 15 },
                'Drainage': { Low: 3, Medium: 5, High: 7 },
                'Electrical': { Low: 2, Medium: 3, High: 5 },
                'Environmental': { Low: 3, Medium: 4, High: 6 },
                'Traffic': { Low: 2, Medium: 3, High: 4 },
                'ITS': { Low: 1, Medium: 2, High: 3 },
                'Mechanical': { Low: 2, Medium: 3, High: 4 },
                'Geotechnical': { Low: 6, Medium: 8, High: 10 },
                'Survey': { Low: 3, Medium: 4, High: 5 },
                'Landscape': { Low: 1, Medium: 2, High: 3 },
                'Utilities': { Low: 2, Medium: 3, High: 4 },
                'Lighting': { Low: 1, Medium: 2, High: 3 },
                'Pavement': { Low: 2, Medium: 3, High: 4 },
                'Bridges': { Low: 18, Medium: 22, High: 28 },
                'Safety': { Low: 2, Medium: 3, High: 4 },
                'QA/QC': { Low: 3, Medium: 4, High: 6 }
            },
            'Highway/Roadway': {
                'Structures': { Low: 10, Medium: 15, High: 20 },
                'Design Management': { Low: 10, Medium: 12, High: 15 },
                'Civil': { Low: 15, Medium: 18, High: 22 },
                'Drainage': { Low: 8, Medium: 10, High: 12 },
                'Electrical': { Low: 4, Medium: 6, High: 8 },
                'Environmental': { Low: 4, Medium: 5, High: 7 },
                'Traffic': { Low: 8, Medium: 10, High: 12 },
                'ITS': { Low: 3, Medium: 5, High: 7 },
                'Mechanical': { Low: 2, Medium: 3, High: 4 },
                'Geotechnical': { Low: 4, Medium: 6, High: 8 },
                'Survey': { Low: 5, Medium: 7, High: 9 },
                'Landscape': { Low: 3, Medium: 4, High: 6 },
                'Utilities': { Low: 6, Medium: 8, High: 10 },
                'Lighting': { Low: 3, Medium: 4, High: 6 },
                'Pavement': { Low: 10, Medium: 12, High: 15 },
                'Bridges': { Low: 8, Medium: 10, High: 12 },
                'Safety': { Low: 4, Medium: 5, High: 7 },
                'QA/QC': { Low: 3, Medium: 4, High: 6 }
            },
            'Drainage/Utilities': {
                'Structures': { Low: 5, Medium: 8, High: 10 },
                'Design Management': { Low: 8, Medium: 10, High: 12 },
                'Civil': { Low: 12, Medium: 15, High: 18 },
                'Drainage': { Low: 18, Medium: 22, High: 26 },
                'Electrical': { Low: 4, Medium: 6, High: 8 },
                'Environmental': { Low: 8, Medium: 10, High: 14 },
                'Traffic': { Low: 2, Medium: 3, High: 4 },
                'ITS': { Low: 1, Medium: 2, High: 3 },
                'Mechanical': { Low: 2, Medium: 3, High: 4 },
                'Geotechnical': { Low: 5, Medium: 7, High: 9 },
                'Survey': { Low: 4, Medium: 6, High: 8 },
                'Landscape': { Low: 2, Medium: 3, High: 4 },
                'Utilities': { Low: 16, Medium: 20, High: 24 },
                'Lighting': { Low: 2, Medium: 3, High: 4 },
                'Pavement': { Low: 6, Medium: 8, High: 10 },
                'Bridges': { Low: 4, Medium: 6, High: 8 },
                'Safety': { Low: 2, Medium: 3, High: 4 },
                'QA/QC': { Low: 4, Medium: 5, High: 7 }
            }
        };

        // Industry benchmark ranges for variance indicators
        const industryBenchmarks = {
            'Bridge': {
                'Structures': { min: 0.18, max: 0.30, typical: 0.24 },
                'Design Management': { min: 0.08, max: 0.15, typical: 0.11 },
                'Civil': { min: 0.10, max: 0.16, typical: 0.13 },
                'Geotechnical': { min: 0.06, max: 0.12, typical: 0.09 }
            },
            'Highway/Roadway': {
                'Structures': { min: 0.10, max: 0.22, typical: 0.16 },
                'Design Management': { min: 0.10, max: 0.16, typical: 0.13 },
                'Civil': { min: 0.15, max: 0.24, typical: 0.19 },
                'Drainage': { min: 0.08, max: 0.14, typical: 0.11 },
                'Traffic': { min: 0.08, max: 0.14, typical: 0.11 },
                'Pavement': { min: 0.10, max: 0.17, typical: 0.13 }
            },
            'Drainage/Utilities': {
                'Structures': { min: 0.05, max: 0.12, typical: 0.08 },
                'Design Management': { min: 0.08, max: 0.13, typical: 0.10 },
                'Drainage': { min: 0.18, max: 0.28, typical: 0.23 },
                'Utilities': { min: 0.16, max: 0.26, typical: 0.21 },
                'Environmental': { min: 0.08, max: 0.16, typical: 0.12 }
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initDisciplines();
            updateStatus('READY');
        });

        /**
         * Updates the status indicator in the terminal header
         * @param {string} text - Status text to display
         */
        function updateStatus(text) {
            document.getElementById('status-text').textContent = text;
        }

        /**
         * Initializes the discipline selection grid with all available disciplines
         */
        function initDisciplines() {
            const grid = document.getElementById('disciplines-grid');
            grid.innerHTML = allDisciplines.map(d => 
                `<div class="disc-item ${d.selected ? 'selected' : ''}" onclick="toggleDisc(this)" data-name="${d.name}">${d.name}</div>`
            ).join('');
            updateSelectedCount();
        }

        /**
         * Toggles the selection state of a discipline item
         * @param {HTMLElement} el - The discipline element to toggle
         */
        function toggleDisc(el) {
            el.classList.toggle('selected');
            updateSelectedCount();
        }

        /**
         * Selects all disciplines in the grid
         */
        function selectAllDisciplines() {
            document.querySelectorAll('.disc-item').forEach(el => el.classList.add('selected'));
            updateSelectedCount();
        }

        /**
         * Updates the selected discipline count display
         */
        function updateSelectedCount() {
            const count = document.querySelectorAll('.disc-item.selected').length;
            document.getElementById('selected-count').textContent = count;
        }

        /**
         * Adds a custom discipline to the grid from the input field
         */
        function addCustomDiscipline() {
            const input = document.getElementById('custom-discipline');
            const name = input.value.trim();
            if (name) {
                const grid = document.getElementById('disciplines-grid');
                grid.innerHTML += `<div class="disc-item selected" onclick="toggleDisc(this)" data-name="${name}">${name}</div>`;
                exampleBudgets[name] = 100000;
                input.value = '';
                updateSelectedCount();
            }
        }

        /**
         * Adds a phase to the phases input if not already present
         * @param {string} phase - Phase name to add
         */
        function addQuickPhase(phase) {
            const input = document.getElementById('phases-input');
            const phases = input.value.split(',').map(p => p.trim()).filter(p => p);
            if (!phases.includes(phase)) {
                phases.push(phase);
                input.value = phases.join(', ');
            }
        }

        /**
         * Adds a package to the packages input if not already present
         * @param {string} pkg - Package name to add
         */
        function addQuickPackage(pkg) {
            const input = document.getElementById('packages-input');
            const packages = input.value.split(',').map(p => p.trim()).filter(p => p);
            if (!packages.includes(pkg)) {
                packages.push(pkg);
                input.value = packages.join(', ');
            }
        }

        /**
         * Updates the progress bar visual state based on current step
         */
        function updateProgress() {
            document.querySelectorAll('.progress-step').forEach((el, i) => {
                el.classList.remove('active', 'completed');
                if (i + 1 < currentStep) el.classList.add('completed');
                if (i + 1 === currentStep) el.classList.add('active');
            });
        }

        /**
         * Shows the specified wizard step and updates navigation buttons
         * @param {number} step - Step number (1-6)
         */
        function showStep(step) {
            document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`step${step}`).classList.remove('hidden');
            
            document.getElementById('prev-btn').classList.toggle('hidden', step === 1);
            document.getElementById('next-btn').classList.toggle('hidden', step === 6);
            document.getElementById('generate-btn').classList.toggle('hidden', step !== 6);
            
            updateProgress();
            updateStatus(`STEP ${step}/6`);
        }

        /**
         * Navigates to a previous step in the wizard (backward navigation only)
         * @param {number} step - Step number to navigate to
         */
        function goToStep(step) {
            if (step < currentStep) {
                saveCurrentStep();
                currentStep = step;
                showStep(step);
            }
        }

        /**
         * Saves data from the current wizard step to projectData object
         */
        function saveCurrentStep() {
            switch(currentStep) {
                case 1:
                    projectData.phases = document.getElementById('phases-input').value.split(',').map(p => p.trim()).filter(p => p);
                    break;
                case 2:
                    projectData.disciplines = Array.from(document.querySelectorAll('.disc-item.selected')).map(el => el.dataset.name);
                    break;
                case 3:
                    projectData.packages = document.getElementById('packages-input').value.split(',').map(p => p.trim()).filter(p => p);
                    break;
                case 4:
                    document.querySelectorAll('.budget-input').forEach(input => {
                        projectData.budgets[input.dataset.disc] = parseFloat(input.value) || 0;
                    });
                    break;
                case 5:
                    document.querySelectorAll('.claiming-input').forEach(input => {
                        projectData.claiming[input.dataset.key] = parseFloat(input.value) || 0;
                    });
                    break;
                case 6:
                    document.querySelectorAll('.date-start').forEach(input => {
                        const key = input.dataset.key;
                        const endInput = document.querySelector(`.date-end[data-key="${key}"]`);
                        projectData.dates[key] = { start: input.value, end: endInput.value };
                    });
                    break;
            }
        }

        /**
         * Validates the current wizard step before allowing progression
         * @returns {boolean} True if validation passes, false otherwise
         */
        function validate() {
            switch(currentStep) {
                case 1:
                    if (!document.getElementById('phases-input').value.trim()) {
                        alert('Enter at least one phase.');
                        return false;
                    }
                    break;
                case 2:
                    if (document.querySelectorAll('.disc-item.selected').length === 0) {
                        alert('Select at least one discipline.');
                        return false;
                    }
                    break;
                case 3:
                    if (!document.getElementById('packages-input').value.trim()) {
                        alert('Enter at least one package.');
                        return false;
                    }
                    break;
            }
            return true;
        }

        /**
         * Advances to the next wizard step after validation
         */
        function nextStep() {
            if (!validate()) return;
            saveCurrentStep();
            
            if (currentStep < 6) {
                currentStep++;
                showStep(currentStep);
                
                if (currentStep === 4) buildBudgetTable();
                if (currentStep === 5) buildClaimingTable();
                if (currentStep === 6) buildDatesTable();
            }
        }

        /**
         * Returns to the previous wizard step
         */
        function prevStep() {
            saveCurrentStep();
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
            }
        }

        /**
         * Builds the budget input table for Step 4
         * Generates rows for each selected discipline with budget inputs and industry indicators
         */
        function buildBudgetTable() {
            const table = document.getElementById('budget-table');
            let html = `
                <thead>
                    <tr>
                        <th>DISCIPLINE</th>
                        <th style="text-align: right; width: 200px;">TOTAL BUDGET</th>
                        <th style="text-align: center; width: 40px;">IND</th>
                    </tr>
                </thead>
                <tbody>
            `;

            projectData.disciplines.forEach(disc => {
                const budget = projectData.budgets[disc] || exampleBudgets[disc] || 100000;
                html += `
                    <tr data-disc="${disc}">
                        <td>${disc}</td>
                        <td>
                            <input type="number" class="table-input budget-input" data-disc="${disc}" value="${budget}">
                        </td>
                        <td class="indicator-cell" style="text-align: center;">•</td>
                    </tr>
                `;
            });

            html += '</tbody>';
            table.innerHTML = html;

            // Add input listeners with manual edit tracking
            document.querySelectorAll('.budget-input').forEach(input => {
                input.addEventListener('input', () => {
                    // Mark as manually edited
                    projectData.calculator.manualEdits[input.dataset.disc] = true;
                    updateTotalBudget();
                });
            });

            // Initialize calculator if first time
            if (!projectData.calculator.isCalculated) {
                initCalculator();
            } else {
                // Re-populate calculator values
                document.getElementById('calc-construction-cost').value = projectData.calculator.totalConstructionCost;
                document.getElementById('calc-design-fee-pct').value = projectData.calculator.designFeePercent;
                document.getElementById('calc-project-type').value = projectData.calculator.projectType;
                updateCalculatorTotal();
                updateIndustryIndicators();
            }

            updateTotalBudget();
        }

        /**
         * Updates the total budget display and triggers industry indicator updates if needed
         */
        function updateTotalBudget() {
            let total = 0;
            document.querySelectorAll('.budget-input').forEach(input => {
                total += parseFloat(input.value) || 0;
            });
            document.getElementById('total-budget').textContent = '$' + total.toLocaleString();

            // Update indicators if calculation was performed
            if (projectData.calculator.isCalculated) {
                updateIndustryIndicators();
            }
        }

        // Calculator Functions
        
        /**
         * Toggles the calculator section expand/collapse state
         */
        function toggleCalculator() {
            const body = document.getElementById('calculator-body');
            const header = document.querySelector('.calculator-header span:first-child');

            if (body.classList.contains('collapsed')) {
                body.classList.remove('collapsed');
                header.textContent = '▼ COST ESTIMATOR';
            } else {
                body.classList.add('collapsed');
                header.textContent = '► COST ESTIMATOR';
            }
        }

        function showComplexityOverrides() {
            const overrideSection = document.getElementById('complexity-overrides');

            if (overrideSection.classList.contains('hidden')) {
                buildComplexityOverrideGrid();
                overrideSection.classList.remove('hidden');
            } else {
                overrideSection.classList.add('hidden');
            }
        }

        function buildComplexityOverrideGrid() {
            const grid = document.getElementById('complexity-grid');
            const projectType = document.getElementById('calc-project-type').value;

            let html = '';
            projectData.disciplines.forEach(disc => {
                const autoComplexity = projectComplexityMap[projectType][disc] || 'Medium';
                const savedOverride = projectData.calculator.complexityOverrides[disc];
                const currentValue = savedOverride || autoComplexity;

                html += `
                    <div class="complexity-item">
                        <label>${disc}</label>
                        <select class="complexity-override" data-disc="${disc}" onchange="saveComplexityOverride(this)">
                            <option value="Low" ${currentValue === 'Low' ? 'selected' : ''}>Low</option>
                            <option value="Medium" ${currentValue === 'Medium' ? 'selected' : ''}>Medium</option>
                            <option value="High" ${currentValue === 'High' ? 'selected' : ''}>High</option>
                        </select>
                        ${savedOverride ? '<span style="color: #ffd700;">*</span>' : ''}
                    </div>
                `;
            });

            grid.innerHTML = html;
        }

        function saveComplexityOverride(selectEl) {
            const disc = selectEl.dataset.disc;
            const value = selectEl.value;
            const projectType = document.getElementById('calc-project-type').value;
            const autoValue = projectComplexityMap[projectType][disc];

            // Only save if different from auto-assigned
            if (value !== autoValue) {
                projectData.calculator.complexityOverrides[disc] = value;
            } else {
                delete projectData.calculator.complexityOverrides[disc];
            }
        }

        function updateComplexityDefaults() {
            // Clear overrides when project type changes
            projectData.calculator.complexityOverrides = {};

            // Rebuild override grid if visible
            const overrideSection = document.getElementById('complexity-overrides');
            if (!overrideSection.classList.contains('hidden')) {
                buildComplexityOverrideGrid();
            }

            // Recalculate total design fee
            updateCalculatorTotal();
        }

        /**
         * Calculates and displays the total design fee based on construction cost and design fee percentage
         */
        function updateCalculatorTotal() {
            const constructionCost = parseFloat(document.getElementById('calc-construction-cost').value) || 0;
            const designFeePct = parseFloat(document.getElementById('calc-design-fee-pct').value) || 0;
            const totalFee = constructionCost * (designFeePct / 100);

            document.getElementById('calc-total-fee').textContent = '$' + totalFee.toLocaleString();
            projectData.calculator.totalConstructionCost = constructionCost;
            projectData.calculator.designFeePercent = designFeePct;
            projectData.calculator.totalDesignFee = totalFee;
        }

        /**
         * Initializes calculator event listeners for real-time total updates
         */
        function initCalculator() {
            document.getElementById('calc-construction-cost').addEventListener('input', updateCalculatorTotal);
            document.getElementById('calc-design-fee-pct').addEventListener('input', updateCalculatorTotal);
            updateCalculatorTotal();
        }

        /**
         * Validates calculator inputs before budget calculation
         * @param {number} constructionCost - Total construction cost
         * @param {number} designFeePct - Design fee percentage
         * @returns {boolean} True if validation passes
         */
        function validateCalculatorInputs(constructionCost, designFeePct) {
            if (!constructionCost || constructionCost <= 0) {
                alert('Enter a valid construction cost.');
                return false;
            }
            if (!designFeePct || designFeePct <= 0 || designFeePct > 30) {
                alert('Design fee must be between 1% and 30%.');
                return false;
            }
            return true;
        }

        /**
         * Calculates raw industry distribution percentages for selected disciplines
         * @param {string} projectType - Project type (Bridge, Highway/Roadway, Drainage/Utilities)
         * @param {Array<string>} disciplines - Selected disciplines
         * @returns {{percentages: Object, total: number}} Raw percentages and total
         */
        function calculateRawPercentages(projectType, disciplines) {
            const rawPercentages = {};
            let totalRawPercentage = 0;

            disciplines.forEach(discipline => {
                // Get complexity (override or auto-assigned)
                const complexity = projectData.calculator.complexityOverrides[discipline] ||
                    projectComplexityMap[projectType][discipline] ||
                    'Medium';

                // Get industry percentage
                const distribution = industryDistribution[projectType];
                const percentage = distribution[discipline] ? distribution[discipline][complexity] : 5;

                rawPercentages[discipline] = percentage;
                totalRawPercentage += percentage;
            });

            return { percentages: rawPercentages, total: totalRawPercentage };
        }

        /**
         * Normalizes raw percentages to sum to 100% and calculates budgets
         * @param {Object} rawPercentages - Raw percentage values per discipline
         * @param {number} totalRawPercentage - Sum of raw percentages
         * @param {number} totalDesignFee - Total design fee amount
         * @param {Array<string>} disciplines - Selected disciplines
         * @returns {Object} Normalized budget amounts per discipline
         */
        function normalizeBudgets(rawPercentages, totalRawPercentage, totalDesignFee, disciplines) {
            const normalizedBudgets = {};
            disciplines.forEach(discipline => {
                const normalizedPct = (rawPercentages[discipline] / totalRawPercentage) * 100;
                normalizedBudgets[discipline] = totalDesignFee * (normalizedPct / 100);
            });
            return normalizedBudgets;
        }

        /**
         * Applies calculated budgets to the budget table inputs
         * @param {Object} normalizedBudgets - Budget amounts per discipline
         * @param {Array<string>} disciplines - Selected disciplines
         */
        function applyBudgetsToTable(normalizedBudgets, disciplines) {
            disciplines.forEach(discipline => {
                const input = document.querySelector(`.budget-input[data-disc="${discipline}"]`);
                if (input && !projectData.calculator.manualEdits[discipline]) {
                    input.value = Math.round(normalizedBudgets[discipline]);
                    projectData.budgets[discipline] = normalizedBudgets[discipline];
                }
            });
        }

        /**
         * Updates calculator UI after successful calculation
         * @param {string} projectType - Project type used in calculation
         */
        function updateCalculatorUI(projectType) {
            projectData.calculator.isCalculated = true;
            projectData.calculator.projectType = projectType;

            // Collapse calculator and update status
            document.getElementById('calculator-body').classList.add('collapsed');
            document.querySelector('.calculator-header span:first-child').textContent = '► COST ESTIMATOR';
            document.getElementById('calculator-status').textContent = 'Estimates applied • Click to edit';
            document.getElementById('calculator-status').style.color = '#00ff00';

            updateTotalBudget();
            updateIndustryIndicators();
            updateStatus('BUDGETS CALCULATED');
        }

        /**
         * Main function to calculate discipline budgets based on construction cost and industry standards
         * Validates inputs, calculates normalized budgets, and updates the UI
         */
        function calculateBudgets() {
            const constructionCost = parseFloat(document.getElementById('calc-construction-cost').value);
            const designFeePct = parseFloat(document.getElementById('calc-design-fee-pct').value);
            const projectType = document.getElementById('calc-project-type').value;

            // Validate inputs
            if (!validateCalculatorInputs(constructionCost, designFeePct)) {
                return;
            }

            const totalDesignFee = constructionCost * (designFeePct / 100);
            const selectedDisciplines = projectData.disciplines;

            // Calculate raw percentages
            const { percentages: rawPercentages, total: totalRawPercentage } = 
                calculateRawPercentages(projectType, selectedDisciplines);

            // Normalize and calculate budgets
            const normalizedBudgets = normalizeBudgets(
                rawPercentages, 
                totalRawPercentage, 
                totalDesignFee, 
                selectedDisciplines
            );

            // Apply to table
            applyBudgetsToTable(normalizedBudgets, selectedDisciplines);

            // Update UI
            updateCalculatorUI(projectType);
        }

        function updateIndustryIndicators() {
            if (!projectData.calculator.isCalculated) return;

            const totalBudget = Object.values(projectData.budgets).reduce((sum, val) => sum + val, 0);
            const projectType = projectData.calculator.projectType;

            projectData.disciplines.forEach(disc => {
                const budget = projectData.budgets[disc] || 0;
                const ratio = budget / totalBudget;

                // Get industry benchmark (if exists)
                const benchmark = industryBenchmarks[projectType] && industryBenchmarks[projectType][disc];

                if (!benchmark) {
                    // No benchmark available, use neutral indicator
                    const cell = document.querySelector(`tr[data-disc="${disc}"] .indicator-cell`);
                    if (cell) cell.innerHTML = '<span class="industry-indicator within">•</span>';
                    return;
                }

                // Determine variance
                let indicator = '';
                let variance = 0;

                if (ratio > benchmark.max) {
                    variance = ((ratio - benchmark.typical) / benchmark.typical * 100).toFixed(1);
                    indicator = `
                        <span class="industry-indicator above tooltip">↑
                            <span class="tooltiptext">
                                Above industry range<br>
                                Your ratio: ${(ratio * 100).toFixed(1)}%<br>
                                Industry range: ${(benchmark.min * 100).toFixed(1)}% - ${(benchmark.max * 100).toFixed(1)}%<br>
                                Variance: +${variance}%
                            </span>
                        </span>
                    `;
                } else if (ratio < benchmark.min) {
                    variance = ((benchmark.typical - ratio) / benchmark.typical * 100).toFixed(1);
                    indicator = `
                        <span class="industry-indicator below tooltip">↓
                            <span class="tooltiptext">
                                Below industry range<br>
                                Your ratio: ${(ratio * 100).toFixed(1)}%<br>
                                Industry range: ${(benchmark.min * 100).toFixed(1)}% - ${(benchmark.max * 100).toFixed(1)}%<br>
                                Variance: -${variance}%
                            </span>
                        </span>
                    `;
                } else {
                    indicator = `
                        <span class="industry-indicator within tooltip">•
                            <span class="tooltiptext">
                                Within industry range<br>
                                Your ratio: ${(ratio * 100).toFixed(1)}%<br>
                                Industry range: ${(benchmark.min * 100).toFixed(1)}% - ${(benchmark.max * 100).toFixed(1)}%
                            </span>
                        </span>
                    `;
                }

                const cell = document.querySelector(`tr[data-disc="${disc}"] .indicator-cell`);
                if (cell) cell.innerHTML = indicator;
            });
        }

        /**
         * Builds the claiming percentage table for Step 5
         * Generates a grid of inputs for each discipline-package combination
         */
        function buildClaimingTable() {
            const table = document.getElementById('claiming-table');
            const numPkgs = projectData.packages.length;
            
            let html = `
                <thead>
                    <tr>
                        <th>DISCIPLINE</th>
                        ${projectData.packages.map(p => `<th style="text-align: center;">${p}</th>`).join('')}
                        <th style="text-align: center;">TOTAL</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            projectData.disciplines.forEach(disc => {
                html += `<tr><td>${disc}</td>`;
                
                projectData.packages.forEach((pkg, i) => {
                    const key = `${disc}-${pkg}`;
                    const defaultVal = defaultClaiming[i] || Math.floor(100 / numPkgs);
                    const val = projectData.claiming[key] !== undefined ? projectData.claiming[key] : defaultVal;
                    
                    html += `
                        <td style="text-align: center;">
                            <input type="number" class="table-input claiming-input" style="text-align: center; width: 60px;" 
                                data-key="${key}" data-disc="${disc}" value="${val}" min="0" max="100">%
                        </td>
                    `;
                });
                
                html += `<td class="claiming-total" data-disc="${disc}" style="text-align: center;">0%</td></tr>`;
            });
            
            html += '</tbody>';
            table.innerHTML = html;
            
            document.querySelectorAll('.claiming-input').forEach(input => {
                input.addEventListener('input', updateClaimingTotals);
            });
            updateClaimingTotals();
        }

        /**
         * Updates claiming percentage totals for each discipline and validates they sum to 100%
         */
        function updateClaimingTotals() {
            projectData.disciplines.forEach(disc => {
                let total = 0;
                document.querySelectorAll(`.claiming-input[data-disc="${disc}"]`).forEach(input => {
                    total += parseFloat(input.value) || 0;
                });

                const cell = document.querySelector(`.claiming-total[data-disc="${disc}"]`);
                cell.textContent = total + '%';
                cell.className = `claiming-total ${total === 100 ? 'status-ok' : 'status-err'}`;
            });
        }

        // ============ CLAIMING PRESET FUNCTIONS ============

        // Normalize array to sum to 100%
        function normalizeToHundred(arr) {
            const sum = arr.reduce((a, b) => a + b, 0);
            if (sum === 0) return arr;

            const normalized = arr.map(val => (val / sum) * 100);
            const rounded = normalized.map(val => Math.round(val));

            // Adjust for rounding errors
            const roundedSum = rounded.reduce((a, b) => a + b, 0);
            if (roundedSum !== 100) {
                const diff = 100 - roundedSum;
                const maxIndex = rounded.indexOf(Math.max(...rounded));
                rounded[maxIndex] += diff;
            }

            return rounded;
        }

        // Linear/Even distribution
        function distributeEvenly(count) {
            if (count <= 0) return [];
            const base = Math.floor(100 / count);
            const remainder = 100 - (base * count);
            const result = new Array(count).fill(base);
            result[result.length - 1] += remainder;
            return result;
        }

        // Front-Loaded (descending) pattern
        function createDescendingPattern(count) {
            if (count === 1) return [100];
            if (count === 2) return [60, 40];

            const maxVal = 30;
            const minVal = 10;
            const step = (maxVal - minVal) / (count - 1);

            const result = [];
            for (let i = 0; i < count; i++) {
                result.push(maxVal - (step * i));
            }

            return normalizeToHundred(result);
        }

        // Back-Loaded (ascending) pattern
        function createAscendingPattern(count) {
            if (count === 1) return [100];
            if (count === 2) return [40, 60];

            const minVal = 10;
            const maxVal = 30;
            const step = (maxVal - minVal) / (count - 1);

            const result = [];
            for (let i = 0; i < count; i++) {
                result.push(minVal + (step * i));
            }

            return normalizeToHundred(result);
        }

        // Bell Curve pattern
        function createBellPattern(count) {
            if (count === 1) return [100];
            if (count === 2) return [50, 50];
            if (count === 3) return [25, 50, 25];

            const result = [];
            const midpoint = (count - 1) / 2;
            const peakValue = 40;
            const edgeValue = 8;

            for (let i = 0; i < count; i++) {
                const distanceFromMid = Math.abs(i - midpoint);
                const maxDistance = midpoint;
                const ratio = 1 - (distanceFromMid / maxDistance);
                const value = edgeValue + (ratio * (peakValue - edgeValue));
                result.push(value);
            }

            return normalizeToHundred(result);
        }

        // Adjust scheme to package count
        function adjustSchemeToPackageCount(schemeKey, packageCount) {
            if (packageCount <= 0) return [];

            const scheme = claimingSchemes[schemeKey];
            if (!scheme) return [];

            switch (scheme.pattern) {
                case 'equal':
                    return distributeEvenly(packageCount);
                case 'descending':
                    return createDescendingPattern(packageCount);
                case 'ascending':
                    return createAscendingPattern(packageCount);
                case 'bell':
                    return createBellPattern(packageCount);
                default:
                    return distributeEvenly(packageCount);
            }
        }

        // Toggle claiming presets panel
        function toggleClaimingPresets() {
            const body = document.getElementById('preset-body');
            const header = document.querySelector('.preset-header span:first-child');

            if (body.classList.contains('hidden')) {
                body.classList.remove('hidden');
                header.textContent = '▼ SCHEME PRESETS';
            } else {
                body.classList.add('hidden');
                header.textContent = '▶ SCHEME PRESETS';
            }
        }

        // Get selected scheme from radio buttons
        function getSelectedScheme() {
            const selected = document.querySelector('input[name="claiming-scheme"]:checked');
            return selected ? selected.value : null;
        }

        // Preview scheme percentages
        function previewScheme() {
            const schemeKey = getSelectedScheme();
            if (!schemeKey) {
                alert('Please select a claiming scheme first.');
                return;
            }

            const packageCount = projectData.packages.length;
            if (packageCount === 0) {
                alert('Please add packages first (Step 3).');
                return;
            }

            const percentages = adjustSchemeToPackageCount(schemeKey, packageCount);
            const scheme = claimingSchemes[schemeKey];

            const previewDiv = document.getElementById('preview-display');
            let previewHTML = `<strong>Preview: ${scheme.name}</strong><br>`;

            projectData.packages.forEach((pkg, i) => {
                previewHTML += `${pkg}: <strong>${percentages[i]}%</strong>`;
                if (i < projectData.packages.length - 1) {
                    previewHTML += ' | ';
                }
            });

            const total = percentages.reduce((a, b) => a + b, 0);
            previewHTML += `<br>Total: <strong style="color: ${total === 100 ? '#00ff00' : '#ff4444'}">${total}%</strong>`;

            previewDiv.innerHTML = previewHTML;
            previewDiv.classList.remove('hidden');
        }

        // Apply claiming scheme to all disciplines
        function applyClaimingScheme() {
            const schemeKey = getSelectedScheme();
            if (!schemeKey) {
                alert('Please select a claiming scheme first.');
                return;
            }

            if (projectData.disciplines.length === 0) {
                alert('Please add disciplines first (Step 2).');
                return;
            }

            if (projectData.packages.length === 0) {
                alert('Please add packages first (Step 3).');
                return;
            }

            const packageCount = projectData.packages.length;
            const percentages = adjustSchemeToPackageCount(schemeKey, packageCount);
            const scheme = claimingSchemes[schemeKey];

            // Apply to all disciplines
            projectData.disciplines.forEach(disc => {
                percentages.forEach((pct, i) => {
                    const pkg = projectData.packages[i];
                    const key = `${disc}-${pkg}`;
                    projectData.claiming[key] = pct;
                });
            });

            // Update UI
            buildClaimingTable();

            // Update status
            const statusSpan = document.getElementById('preset-status');
            statusSpan.textContent = `Applied: ${scheme.name}`;
            statusSpan.style.color = '#00ff00';

            // Collapse panel
            const body = document.getElementById('preset-body');
            const header = document.querySelector('.preset-header span:first-child');
            body.classList.add('hidden');
            header.textContent = '▶ SCHEME PRESETS';

            // Clear preview
            document.getElementById('preview-display').classList.add('hidden');
        }

        /**
         * Builds the schedule dates table for Step 6
         * Generates date inputs for each discipline-package combination with duration calculation
         */
        function buildDatesTable() {
            const table = document.getElementById('dates-table');
            const today = new Date();
            const fmt = d => d.toISOString().split('T')[0];
            
            let html = `
                <thead>
                    <tr>
                        <th>DISCIPLINE</th>
                        <th>PACKAGE</th>
                        <th>START</th>
                        <th>END</th>
                        <th style="text-align: center;">DAYS</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            projectData.disciplines.forEach(disc => {
                projectData.packages.forEach((pkg, i) => {
                    const key = `${disc}-${pkg}`;
                    
                    const startDate = new Date(today);
                    startDate.setDate(startDate.getDate() + (i * 45));
                    const endDate = new Date(startDate);
                    endDate.setDate(endDate.getDate() + 42);
                    
                    const saved = projectData.dates[key] || {};
                    
                    html += `
                        <tr>
                            <td>${i === 0 ? disc : ''}</td>
                            <td style="color: #ffd700;">${pkg}</td>
                            <td><input type="date" class="table-input date-start" data-key="${key}" value="${saved.start || fmt(startDate)}"></td>
                            <td><input type="date" class="table-input date-end" data-key="${key}" value="${saved.end || fmt(endDate)}"></td>
                            <td class="duration-cell" data-key="${key}" style="text-align: center;">--</td>
                        </tr>
                    `;
                });
            });
            
            html += '</tbody>';
            table.innerHTML = html;
            
            document.querySelectorAll('.date-start, .date-end').forEach(input => {
                input.addEventListener('change', updateDurations);
            });
            updateDurations();
        }

        /**
         * Calculates and displays duration in days for each date range in the schedule table
         */
        function updateDurations() {
            document.querySelectorAll('.duration-cell').forEach(cell => {
                const key = cell.dataset.key;
                const start = document.querySelector(`.date-start[data-key="${key}"]`).value;
                const end = document.querySelector(`.date-end[data-key="${key}"]`).value;
                
                if (start && end) {
                    const days = Math.ceil((new Date(end) - new Date(start)) / (1000 * 60 * 60 * 24));
                    cell.textContent = days > 0 ? days : 'ERR';
                    cell.className = `duration-cell ${days > 0 ? 'status-ok' : 'status-err'}`;
                }
            });
        }

        function generateWBS() {
            saveCurrentStep();
            
            document.getElementById('progress-section').classList.add('hidden');
            document.querySelector('.terminal').style.display = 'none';
            document.getElementById('results-section').classList.remove('hidden');
            
            buildWBSTable();
            populateFilters();
            createChart();
            updateKPIs();
            updateStatus('WBS GENERATED');
        }

        function updateKPIs() {
            let total = 0;
            let wbsCount = 0;
            let minDate = null, maxDate = null;
            
            projectData.disciplines.forEach(disc => {
                total += projectData.budgets[disc] || 0;
                wbsCount += projectData.packages.length * projectData.phases.length;
                
                projectData.packages.forEach(pkg => {
                    const d = projectData.dates[`${disc}-${pkg}`];
                    if (d) {
                        const s = new Date(d.start), e = new Date(d.end);
                        if (!minDate || s < minDate) minDate = s;
                        if (!maxDate || e > maxDate) maxDate = e;
                    }
                });
            });
            
            const months = minDate && maxDate ? Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24 * 30)) : 0;
            
            document.getElementById('kpi-budget').textContent = '$' + total.toLocaleString();
            document.getElementById('kpi-wbs').textContent = wbsCount;
            document.getElementById('kpi-disc').textContent = projectData.disciplines.length;
            document.getElementById('kpi-months').textContent = months;
        }

        /**
         * Generates WBS table header HTML
         * @returns {string} HTML string for table header
         */
        function generateWBSTableHeader() {
            return `
                <thead>
                    <tr>
                        <th>WBS#</th>
                        <th>PHASE</th>
                        <th>DISCIPLINE</th>
                        <th>PACKAGE</th>
                        <th style="text-align: right;">BUDGET</th>
                        <th style="text-align: center;">%</th>
                        <th>START</th>
                        <th>END</th>
                        <th style="text-align: right;">ACTUAL</th>
                        <th style="text-align: right;">VAR</th>
                    </tr>
                </thead>
            `;
        }

        /**
         * Generates a single WBS table row HTML
         * @param {string} wbsNumber - WBS number (e.g., "1.1.1")
         * @param {string} phase - Project phase
         * @param {string} discipline - Engineering discipline
         * @param {string} packageName - Deliverable package
         * @param {number} packageBudget - Budget for this package
         * @param {number} claimPercent - Claiming percentage
         * @param {Object} dates - Start and end dates
         * @returns {string} HTML string for table row
         */
        function generateWBSRow(wbsNumber, phase, discipline, packageName, packageBudget, claimPercent, dates) {
            return `
                <tr>
                    <td style="color: #ffd700;">${wbsNumber}</td>
                    <td>${phase}</td>
                    <td>${discipline}</td>
                    <td>${packageName}</td>
                    <td style="text-align: right;">$${packageBudget.toLocaleString()}</td>
                    <td style="text-align: center;">${claimPercent}%</td>
                    <td>${dates.start}</td>
                    <td>${dates.end}</td>
                    <td style="text-align: right; color: #666;">$0</td>
                    <td style="text-align: right; color: #00ff00;">$${packageBudget.toLocaleString()}</td>
                </tr>
            `;
        }

        /**
         * Generates WBS table footer with grand total
         * @param {number} grandTotal - Total budget across all WBS elements
         * @returns {string} HTML string for table footer
         */
        function generateWBSTableFooter(grandTotal) {
            return `
                <tfoot>
                    <tr>
                        <td colspan="4">GRAND TOTAL</td>
                        <td style="text-align: right;">$${grandTotal.toLocaleString()}</td>
                        <td></td>
                        <td colspan="2"></td>
                        <td style="text-align: right;">$0</td>
                        <td style="text-align: right;">$${grandTotal.toLocaleString()}</td>
                    </tr>
                </tfoot>
            `;
        }

        /**
         * Builds the complete WBS table with all phases, disciplines, and packages
         * Generates hierarchical WBS numbering and calculates budget distribution
         */
        function buildWBSTable() {
            const table = document.getElementById('wbs-table');
            let grandTotal = 0;
            let html = generateWBSTableHeader() + '<tbody>';
            
            projectData.phases.forEach((phase, phaseIndex) => {
                projectData.disciplines.forEach((discipline, disciplineIndex) => {
                    const disciplineBudget = projectData.budgets[discipline] || 0;
                    
                    projectData.packages.forEach((packageName, packageIndex) => {
                        const key = `${discipline}-${packageName}`;
                        const claimPercent = projectData.claiming[key] || 0;
                        const packageBudget = disciplineBudget * (claimPercent / 100);
                        const dates = projectData.dates[key] || { start: '-', end: '-' };
                        const wbsNumber = `${phaseIndex + 1}.${disciplineIndex + 1}.${packageIndex + 1}`;
                        
                        grandTotal += packageBudget;
                        
                        html += generateWBSRow(
                            wbsNumber, 
                            phase, 
                            discipline, 
                            packageName, 
                            packageBudget, 
                            claimPercent, 
                            dates
                        );
                    });
                });
            });
            
            html += '</tbody>' + generateWBSTableFooter(grandTotal);
            table.innerHTML = html;
        }

        function populateFilters() {
            document.getElementById('filter-phase').innerHTML = '<option value="all">All Phases</option>' +
                projectData.phases.map(p => `<option value="${p}">${p}</option>`).join('');
            
            document.getElementById('filter-discipline').innerHTML = '<option value="all">All Disciplines</option>' +
                projectData.disciplines.map(d => `<option value="${d}">${d}</option>`).join('');
        }

        function createChart() {
            const ctx = document.getElementById('performance-chart').getContext('2d');
            if (chart) chart.destroy();
            
            const data = getChartData();
            const type = document.getElementById('chart-type').value;
            
            chart = new Chart(ctx, {
                type: type,
                data: {
                    labels: data.labels,
                    datasets: [
                        {
                            label: 'PLANNED',
                            data: data.planned,
                            borderColor: '#ffd700',
                            backgroundColor: type === 'bar' ? '#ffd700' : 'rgba(255, 215, 0, 0.1)',
                            borderWidth: 2,
                            fill: type === 'line',
                            tension: 0.3
                        },
                        {
                            label: 'ACTUAL',
                            data: data.actual,
                            borderColor: '#00ff00',
                            backgroundColor: type === 'bar' ? '#00ff00' : 'rgba(0, 255, 0, 0.1)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#1a1a1a',
                            titleColor: '#ffd700',
                            bodyColor: '#fff',
                            borderColor: '#ffd700',
                            borderWidth: 1,
                            callbacks: {
                                label: ctx => ctx.dataset.label + ': $' + ctx.raw.toLocaleString()
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#333' },
                            ticks: {
                                color: '#888',
                                callback: v => '$' + (v/1000).toFixed(0) + 'K'
                            }
                        },
                        x: {
                            grid: { color: '#222' },
                            ticks: { color: '#888' }
                        }
                    }
                }
            });
        }

        /**
         * Collects chart items from project data based on discipline filter
         * @param {string} disciplineFilter - Selected discipline filter ('all' or discipline name)
         * @returns {Array<Object>} Array of items with start, end dates and budget
         */
        function collectChartItems(disciplineFilter) {
            const items = [];
            const allDates = [];

            projectData.disciplines.forEach(discipline => {
                if (disciplineFilter !== 'all' && discipline !== disciplineFilter) return;
                const disciplineBudget = projectData.budgets[discipline] || 0;
                
                projectData.packages.forEach(packageName => {
                    const key = `${discipline}-${packageName}`;
                    const dates = projectData.dates[key];
                    const claimPct = projectData.claiming[key] || 0;
                    const packageBudget = disciplineBudget * (claimPct / 100);
                    
                    if (dates && dates.start && dates.end) {
                        const startDate = new Date(dates.start);
                        const endDate = new Date(dates.end);
                        items.push({
                            start: startDate,
                            end: endDate,
                            budget: packageBudget
                        });
                        allDates.push(startDate, endDate);
                    }
                });
            });

            return { items, allDates };
        }

        /**
         * Calculates the date range for chart display
         * @param {Array<Date>} allDates - Array of all start and end dates
         * @returns {{start: Date, end: Date}} Start and end dates for chart
         */
        function calculateChartDateRange(allDates) {
            if (!allDates.length) return null;

            allDates.sort((a, b) => a - b);
            const startDate = new Date(allDates[0].getFullYear(), allDates[0].getMonth(), 1);
            const endDate = new Date(
                allDates[allDates.length - 1].getFullYear(), 
                allDates[allDates.length - 1].getMonth() + 1, 
                1
            );
            return { start: startDate, end: endDate };
        }

        /**
         * Calculates monthly budget for a given month
         * @param {Date} currentMonth - Current month being calculated
         * @param {Array<Object>} items - Chart items with dates and budgets
         * @returns {number} Monthly budget amount
         */
        function calculateMonthlyBudget(currentMonth, items) {
            let monthly = 0;
            items.forEach(item => {
                const months = Math.max(1, Math.ceil((item.end - item.start) / (1000 * 60 * 60 * 24 * 30)));
                if (currentMonth >= item.start && currentMonth <= item.end) {
                    monthly += item.budget / months;
                }
            });
            return monthly;
        }

        /**
         * Generates chart data points (labels, planned, actual) for the date range
         * @param {Date} startDate - Chart start date
         * @param {Date} endDate - Chart end date
         * @param {Array<Object>} items - Chart items with dates and budgets
         * @param {string} viewType - 'cumulative' or 'monthly'
         * @returns {{labels: Array<string>, planned: Array<number>, actual: Array<number>}}
         */
        function generateChartDataPoints(startDate, endDate, items, viewType) {
            const labels = [];
            const planned = [];
            const actual = [];
            let cumulative = 0;
            const current = new Date(startDate);

            while (current <= endDate) {
                labels.push(current.toLocaleDateString('en-US', { year: '2-digit', month: 'short' }));
                
                const monthly = calculateMonthlyBudget(current, items);
                
                if (viewType === 'cumulative') {
                    cumulative += monthly;
                    planned.push(Math.round(cumulative));
                } else {
                    planned.push(Math.round(monthly));
                }
                actual.push(0);
                
                current.setMonth(current.getMonth() + 1);
            }

            return { labels, planned, actual };
        }

        /**
         * Gets chart data based on current filters and view type
         * @returns {{labels: Array<string>, planned: Array<number>, actual: Array<number>}}
         */
        function getChartData() {
            const disciplineFilter = document.getElementById('filter-discipline').value;
            const viewType = document.getElementById('view-type').value;
            
            // Collect items and dates
            const { items, allDates } = collectChartItems(disciplineFilter);
            
            if (!allDates.length) {
                return { labels: ['N/A'], planned: [0], actual: [0] };
            }
            
            // Calculate date range
            const dateRange = calculateChartDateRange(allDates);
            if (!dateRange) {
                return { labels: ['N/A'], planned: [0], actual: [0] };
            }
            
            // Generate data points
            return generateChartDataPoints(dateRange.start, dateRange.end, items, viewType);
        }

        function updateChart() {
            createChart();
        }

        function editWBS() {
            document.getElementById('progress-section').classList.remove('hidden');
            document.querySelector('.terminal').style.display = 'block';
            document.getElementById('results-section').classList.add('hidden');
            currentStep = 1;
            showStep(1);
        }

        function exportCSV() {
            let csv = 'WBS,Phase,Discipline,Package,Budget,Claim%,Start,End,Actual,Variance\n';
            
            projectData.phases.forEach((phase, pi) => {
                projectData.disciplines.forEach((disc, di) => {
                    const discBudget = projectData.budgets[disc] || 0;
                    
                    projectData.packages.forEach((pkg, ki) => {
                        const key = `${disc}-${pkg}`;
                        const claimPct = projectData.claiming[key] || 0;
                        const pkgBudget = discBudget * (claimPct / 100);
                        const dates = projectData.dates[key] || { start: '', end: '' };
                        
                        csv += `${pi+1}.${di+1}.${ki+1},"${phase}","${disc}","${pkg}",${pkgBudget},${claimPct},${dates.start},${dates.end},0,${pkgBudget}\n`;
                    });
                });
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'wbs_structure.csv';
            a.click();
        }
    </script>
</body>
</html>
