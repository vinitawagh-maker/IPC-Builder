<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WBS Terminal v1.0</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'JetBrains Mono', monospace;
            box-sizing: border-box;
        }
        
        body {
            background: #0a0a0a;
            color: #ffd700;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        /* Terminal Window */
        .terminal {
            border: 2px solid #ffd700;
            background: #0d0d0d;
        }
        
        .terminal-header {
            background: #ffd700;
            color: #000;
            padding: 8px 16px;
            font-weight: 700;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
        }
        
        .terminal-header .btn {
            margin: 0;
            font-size: 12px;
            padding: 6px 12px;
            white-space: nowrap;
        }
        
        .terminal-header .btn-primary {
            background: #000;
            color: #ffd700;
            border-color: #000;
        }
        
        .terminal-header .btn-primary:hover {
            background: #333;
            border-color: #333;
        }
        
        .terminal-header .btn:not(.btn-primary) {
            background: transparent;
            color: #000;
            border-color: #000;
        }
        
        .terminal-header .btn:not(.btn-primary):hover {
            background: #000;
            color: #ffd700;
        }
        
        .terminal-body {
            padding: 24px;
        }
        
        /* Progress Bar */
        .progress-bar {
            display: flex;
            gap: 4px;
            margin-bottom: 24px;
            font-size: 12px;
        }
        
        .progress-step {
            flex: 1;
            text-align: center;
            padding: 8px 4px;
            border: 1px solid #333;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .progress-step.active {
            background: #ffd700;
            color: #000;
            border-color: #ffd700;
        }
        
        .progress-step.completed {
            background: #2d2d00;
            color: #ffd700;
            border-color: #ffd700;
        }
        
        .progress-step:hover {
            border-color: #ffd700;
        }
        
        /* Section */
        .section-title {
            color: #fff;
            font-size: 18px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-title::before {
            content: ">";
            color: #ffd700;
        }
        
        .section-desc {
            color: #888;
            font-size: 13px;
            margin-bottom: 20px;
        }
        
        /* Inputs */
        input[type="text"],
        input[type="number"],
        input[type="date"],
        select {
            background: #000;
            border: 1px solid #444;
            color: #ffd700;
            padding: 12px;
            width: 100%;
            font-size: 14px;
            outline: none;
        }
        
        input:focus,
        select:focus {
            border-color: #ffd700;
        }
        
        input::placeholder {
            color: #555;
        }
        
        /* Buttons */
        .btn {
            background: transparent;
            border: 2px solid #ffd700;
            color: #ffd700;
            padding: 12px 24px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .btn:hover {
            background: #ffd700;
            color: #000;
        }
        
        .btn-primary {
            background: #ffd700;
            color: #000;
        }
        
        .btn-primary:hover {
            background: #fff;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        /* Discipline Grid */
        .disc-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .disc-item {
            border: 1px solid #333;
            padding: 10px 12px;
            cursor: pointer;
            font-size: 13px;
            color: #fff;
            transition: all 0.2s;
        }
        
        .disc-item:hover {
            border-color: #ffd700;
            color: #ffd700;
        }
        
        .disc-item.selected {
            background: #ffd700;
            color: #000;
            border-color: #ffd700;
        }
        
        .disc-item::before {
            content: "[ ] ";
        }
        
        .disc-item.selected::before {
            content: "[X] ";
        }
        
        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        th {
            background: #1a1a00;
            color: #ffd700;
            text-align: left;
            padding: 10px 12px;
            border: 1px solid #333;
            font-weight: 600;
        }
        
        td {
            padding: 8px 12px;
            border: 1px solid #333;
            color: #ccc;
        }
        
        tr:hover td {
            background: #1a1a00;
        }
        
        .table-input {
            background: transparent;
            border: none;
            color: #ffd700;
            width: 100%;
            padding: 4px;
            text-align: right;
        }
        
        .table-input:focus {
            outline: 1px solid #ffd700;
        }
        
        
        /* Hidden */
        .hidden {
            display: none !important;
        }
        
        /* Quick Tags */
        .quick-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }
        
        .quick-tag {
            background: #1a1a00;
            border: 1px solid #444;
            color: #ffd700;
            padding: 4px 10px;
            font-size: 11px;
            cursor: pointer;
        }
        
        .quick-tag:hover {
            background: #2d2d00;
            border-color: #ffd700;
        }
        
        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .kpi-card {
            border: 1px solid #ffd700;
            padding: 16px;
            text-align: center;
        }
        
        .kpi-value {
            font-size: 24px;
            color: #ffd700;
            font-weight: 700;
        }
        
        .kpi-label {
            font-size: 11px;
            color: #888;
            margin-top: 4px;
        }
        
        /* Chart Container */
        .chart-container {
            background: #000;
            border: 1px solid #333;
            padding: 20px;
            margin-top: 24px;
        }
        
        /* Filters */
        .filters {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .filter-group label {
            display: block;
            font-size: 11px;
            color: #888;
            margin-bottom: 4px;
        }
        
        /* Status */
        .status-ok {
            color: #00ff00;
        }
        
        .status-err {
            color: #ff4444;
        }
        
        /* Results Table */
        .results-table {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #333;
        }
        
        .results-table thead {
            position: sticky;
            top: 0;
        }
        
        .results-table tfoot {
            position: sticky;
            bottom: 0;
        }
        
        .results-table tfoot td {
            background: #ffd700;
            color: #000;
            font-weight: 700;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #111;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #ffd700;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .filters {
                grid-template-columns: repeat(2, 1fr);
            }
            .disc-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .terminal-header {
                flex-wrap: wrap;
                gap: 8px;
                padding: 8px 12px;
            }
            
            .terminal-header > span {
                order: 2;
                width: 100%;
                text-align: center;
                font-size: 13px;
            }
            
            .terminal-header .btn {
                font-size: 11px;
                padding: 4px 8px;
                min-width: 60px;
            }
            
            .terminal-header > div {
                order: 3;
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
                gap: 4px;
            }
            
            .terminal-header #status-text {
                font-size: 11px;
            }
            
            .terminal-header .btn-sm {
                font-size: 10px;
                padding: 3px 6px;
                min-width: auto;
            }
            
            /* Results section header buttons on mobile */
            #results-section .terminal-header > div {
                flex-wrap: wrap;
                gap: 4px;
            }
            
            #results-section .terminal-header .btn-sm {
                font-size: 9px;
                padding: 3px 5px;
                margin-right: 4px !important;
            }
        }

        /* ASCII decorations */
        .ascii-line {
            color: #444;
            font-size: 12px;
            margin: 16px 0;
            overflow: hidden;
            white-space: nowrap;
        }
        
        /* Blinking cursor */
        .cursor::after {
            content: "_";
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        /* Budget Calculator */
        .budget-calculator {
            border: 1px solid #444;
            margin-bottom: 20px;
            background: #111;
        }

        .calculator-header {
            background: #1a1a00;
            padding: 10px 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
            transition: background 0.2s;
        }

        .calculator-header:hover {
            background: #2d2d00;
        }

        .calculator-header span:first-child {
            color: #ffd700;
            font-weight: 600;
            font-size: 13px;
        }

        .calculator-body {
            padding: 16px;
            display: block;
            overflow: hidden;
            max-height: 1000px;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
        }

        .calculator-body.collapsed {
            max-height: 0;
            padding: 0 16px;
        }

        .calc-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .calc-group label {
            display: block;
            font-size: 11px;
            color: #888;
            margin-bottom: 6px;
        }

        .calc-group input,
        .calc-group select {
            font-size: 13px;
        }

        .complexity-override-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .complexity-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .complexity-item label {
            flex: 1;
            color: #ccc;
        }

        .complexity-item select {
            flex: 0 0 100px;
            padding: 4px 8px;
            font-size: 11px;
        }

        /* Industry Indicator */
        .industry-indicator {
            display: inline-block;
            width: 16px;
            text-align: center;
            cursor: help;
            font-weight: 700;
            margin-left: 4px;
        }

        .industry-indicator.above {
            color: #ff6666;
        }

        .industry-indicator.below {
            color: #66ff66;
        }

        .industry-indicator.within {
            color: #ffd700;
        }

        /* Tooltip */
        .tooltip {
            position: relative;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 220px;
            background-color: #1a1a1a;
            color: #ffd700;
            text-align: left;
            border: 1px solid #ffd700;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            font-size: 11px;
            line-height: 1.4;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Claiming Preset Panel */
        .claiming-preset-panel {
            background-color: #0a0a0a;
            border: 1px solid #ffd700;
            border-radius: 4px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .preset-header {
            background-color: #1a1a1a;
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #ffd700;
            font-weight: bold;
            font-size: 12px;
            user-select: none;
            border-bottom: 1px solid #ffd700;
        }

        .preset-header:hover {
            background-color: #222;
        }

        .preset-body {
            padding: 20px;
            display: block;
        }

        .preset-body.hidden {
            display: none;
        }

        .preset-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .preset-option {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 12px;
            background-color: #1a1a1a;
            border: 1px solid #333;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .preset-option:hover {
            border-color: #ffd700;
            background-color: #222;
        }

        .preset-option input[type="radio"] {
            margin-top: 2px;
            cursor: pointer;
            accent-color: #ffd700;
        }

        .preset-label {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
        }

        .preset-name {
            color: #ffd700;
            font-weight: bold;
            font-size: 13px;
        }

        .preset-desc {
            color: #888;
            font-size: 11px;
            line-height: 1.4;
        }

        .preset-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .preset-actions .btn {
            flex: 1;
            padding: 10px;
            background-color: #1a1a1a;
            color: #ffd700;
            border: 1px solid #ffd700;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.2s;
        }

        .preset-actions .btn:hover {
            background-color: #ffd700;
            color: #0a0a0a;
        }

        .preset-actions .btn-primary {
            background-color: #ffd700;
            color: #0a0a0a;
        }

        .preset-actions .btn-primary:hover {
            background-color: #ffed4e;
        }

        .preset-preview {
            padding: 15px;
            background-color: #1a1a1a;
            border: 1px solid #333;
            border-radius: 4px;
            font-size: 11px;
            color: #888;
            line-height: 1.6;
        }

        .preset-preview.hidden {
            display: none;
        }

        .preset-preview strong {
            color: #ffd700;
        }

        @media (max-width: 768px) {
            .calc-grid {
                grid-template-columns: 1fr;
            }
            .complexity-override-grid {
                grid-template-columns: 1fr;
            }
            .preset-options {
                grid-template-columns: 1fr;
            }
            .preset-actions {
                flex-direction: column;
            }
        }

        /* AI Chat Assistant Styles */
        .chat-fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffd700 0%, #b8860b 100%);
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(255, 215, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
        }

        .chat-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 28px rgba(255, 215, 0, 0.6);
        }

        .chat-fab svg {
            width: 28px;
            height: 28px;
            fill: #000;
        }

        .chat-fab.has-unread::after {
            content: '';
            position: absolute;
            top: 4px;
            right: 4px;
            width: 12px;
            height: 12px;
            background: #ff4444;
            border-radius: 50%;
            border: 2px solid #0a0a0a;
        }

        .chat-panel {
            position: fixed;
            bottom: 96px;
            right: 24px;
            width: 380px;
            max-height: 520px;
            background: #0d0d0d;
            border: 2px solid #ffd700;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px) scale(0.95);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .chat-panel.open {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }

        .chat-panel.dragging {
            transition: none;
            user-select: none;
        }

        .chat-header {
            background: linear-gradient(135deg, #ffd700 0%, #b8860b 100%);
            color: #000;
            padding: 14px 16px;
            font-weight: 700;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 10px 10px 0 0;
            cursor: grab;
        }

        .chat-header:active {
            cursor: grabbing;
        }

        .chat-header-title {
            display: flex;
            align-items: center;
            gap: 8px;
            pointer-events: none;
        }

        .chat-header-title svg {
            width: 18px;
            height: 18px;
        }

        .chat-header-actions {
            display: flex;
            gap: 8px;
            pointer-events: auto;
        }

        .chat-context-badge {
            pointer-events: none;
        }

        .chat-header-btn {
            background: rgba(0, 0, 0, 0.2);
            border: none;
            color: #000;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .chat-header-btn:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        .chat-header-btn svg {
            width: 16px;
            height: 16px;
        }

        .chat-context-badge {
            background: rgba(0, 0, 0, 0.2);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 280px;
            max-height: 340px;
        }

        .chat-message {
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 13px;
            line-height: 1.5;
            animation: messageIn 0.3s ease-out;
        }

        @keyframes messageIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-message.user {
            background: linear-gradient(135deg, #ffd700 0%, #b8860b 100%);
            color: #000;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .chat-message.assistant {
            background: #1a1a1a;
            color: #e0e0e0;
            align-self: flex-start;
            border: 1px solid #333;
            border-bottom-left-radius: 4px;
        }

        .chat-message.assistant code {
            background: #2a2a2a;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            color: #ffd700;
        }

        .chat-message.system {
            background: transparent;
            color: #666;
            font-size: 11px;
            text-align: center;
            align-self: center;
            padding: 6px 12px;
        }

        .chat-typing {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
            background: #1a1a1a;
            border-radius: 12px;
            align-self: flex-start;
            border: 1px solid #333;
        }

        .chat-typing span {
            width: 8px;
            height: 8px;
            background: #ffd700;
            border-radius: 50%;
            animation: typingBounce 1.4s infinite ease-in-out;
        }

        .chat-typing span:nth-child(1) { animation-delay: 0s; }
        .chat-typing span:nth-child(2) { animation-delay: 0.2s; }
        .chat-typing span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-8px); opacity: 1; }
        }

        .chat-input-area {
            padding: 12px;
            border-top: 1px solid #333;
            display: flex;
            gap: 8px;
        }

        .chat-input {
            flex: 1;
            background: #1a1a1a;
            border: 1px solid #444;
            color: #ffd700;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 13px;
            outline: none;
            resize: none;
            min-height: 42px;
            max-height: 100px;
            font-family: inherit;
        }

        .chat-input:focus {
            border-color: #ffd700;
        }

        .chat-input::placeholder {
            color: #666;
        }

        .chat-send-btn {
            background: linear-gradient(135deg, #ffd700 0%, #b8860b 100%);
            border: none;
            color: #000;
            width: 42px;
            height: 42px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .chat-send-btn:hover:not(:disabled) {
            transform: scale(1.05);
        }

        .chat-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .chat-send-btn svg {
            width: 20px;
            height: 20px;
        }

        /* API Key Modal */
        .chat-api-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1002;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .chat-api-modal.open {
            opacity: 1;
            visibility: visible;
        }

        .chat-api-modal-content {
            background: #0d0d0d;
            border: 2px solid #ffd700;
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            transform: scale(0.9);
            transition: transform 0.3s;
        }

        .chat-api-modal.open .chat-api-modal-content {
            transform: scale(1);
        }

        .chat-api-modal h3 {
            color: #ffd700;
            margin: 0 0 8px 0;
            font-size: 16px;
        }

        .chat-api-modal p {
            color: #888;
            font-size: 12px;
            margin: 0 0 16px 0;
            line-height: 1.5;
        }

        .chat-api-modal input {
            width: 100%;
            background: #1a1a1a;
            border: 1px solid #444;
            color: #ffd700;
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
            margin-bottom: 16px;
        }

        .chat-api-modal input:focus {
            outline: none;
            border-color: #ffd700;
        }

        .chat-api-modal-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .chat-api-modal .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        @media (max-width: 480px) {
            .chat-panel {
                right: 12px;
                left: 12px;
                width: auto;
                bottom: 88px;
                max-height: 60vh;
            }

            .chat-fab {
                right: 16px;
                bottom: 16px;
            }
        }

        /* Gantt Chart Styles */
        .gantt-container {
            overflow-x: auto;
            padding: 16px 0;
        }

        .gantt-chart {
            min-width: 100%;
            position: relative;
        }

        .gantt-header {
            display: flex;
            border-bottom: 1px solid #444;
            position: sticky;
            top: 0;
            background: #0d0d0d;
            z-index: 10;
        }

        .gantt-label-col {
            width: 200px;
            min-width: 200px;
            padding: 8px 12px;
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-right: 1px solid #333;
        }

        .gantt-timeline-header {
            flex: 1;
            display: flex;
            min-width: 600px;
        }

        .gantt-month {
            flex: 1;
            min-width: 60px;
            text-align: center;
            padding: 8px 4px;
            font-size: 10px;
            color: #888;
            border-right: 1px solid #222;
        }

        .gantt-month.current {
            background: rgba(255, 215, 0, 0.1);
            color: #ffd700;
        }

        .gantt-body {
            position: relative;
        }

        .gantt-row {
            display: flex;
            border-bottom: 1px solid #222;
            transition: background 0.2s;
        }

        .gantt-row:hover {
            background: rgba(255, 215, 0, 0.03);
        }

        .gantt-row.discipline-row {
            background: #1a1a1a;
        }

        .gantt-row.discipline-row:hover {
            background: #222;
        }

        .gantt-row.package-row {
            background: #0d0d0d;
        }

        .gantt-row.package-row.hidden {
            display: none;
        }

        .gantt-row-label {
            width: 200px;
            min-width: 200px;
            padding: 10px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            border-right: 1px solid #333;
            font-size: 12px;
        }

        .gantt-row.discipline-row .gantt-row-label {
            color: #ffd700;
            font-weight: 600;
            cursor: pointer;
        }

        .gantt-row.package-row .gantt-row-label {
            color: #888;
            padding-left: 32px;
            font-size: 11px;
        }

        .gantt-expand-icon {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
            color: #ffd700;
            font-size: 10px;
        }

        .gantt-expand-icon.expanded {
            transform: rotate(90deg);
        }

        .gantt-row-timeline {
            flex: 1;
            position: relative;
            min-width: 600px;
            display: flex;
        }

        .gantt-cell {
            flex: 1;
            min-width: 60px;
            border-right: 1px solid #222;
            position: relative;
        }

        .gantt-cell.current {
            background: rgba(255, 215, 0, 0.05);
        }

        .gantt-bar-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            pointer-events: none;
        }

        .gantt-bar {
            position: absolute;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: 600;
            color: #000;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            pointer-events: auto;
            cursor: default;
            transition: transform 0.15s, box-shadow 0.15s;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding: 0 6px;
        }

        .gantt-bar:hover {
            transform: scaleY(1.15);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
            z-index: 5;
        }

        .gantt-bar.discipline-bar {
            background: linear-gradient(135deg, #ffd700 0%, #b8860b 100%);
            height: 28px;
        }

        .gantt-bar.package-bar {
            background: linear-gradient(135deg, #4a90d9 0%, #2c5aa0 100%);
            height: 20px;
            font-size: 8px;
        }

        .gantt-tooltip {
            position: absolute;
            background: #1a1a1a;
            border: 1px solid #ffd700;
            border-radius: 6px;
            padding: 10px 12px;
            font-size: 11px;
            z-index: 100;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            min-width: 180px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }

        .gantt-tooltip.visible {
            opacity: 1;
        }

        .gantt-tooltip-title {
            color: #ffd700;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .gantt-tooltip-row {
            display: flex;
            justify-content: space-between;
            gap: 16px;
            color: #ccc;
            margin-top: 4px;
        }

        .gantt-tooltip-label {
            color: #888;
        }

        .gantt-legend {
            display: flex;
            gap: 24px;
            margin-top: 16px;
            font-size: 11px;
            color: #888;
        }

        .gantt-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .gantt-legend-color {
            width: 24px;
            height: 12px;
            border-radius: 3px;
        }

        .gantt-legend-color.discipline {
            background: linear-gradient(135deg, #ffd700 0%, #b8860b 100%);
        }

        .gantt-legend-color.package {
            background: linear-gradient(135deg, #4a90d9 0%, #2c5aa0 100%);
        }

        .gantt-no-data {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 13px;
        }

        @media (max-width: 768px) {
            .gantt-label-col,
            .gantt-row-label {
                width: 140px;
                min-width: 140px;
            }

            .gantt-row.package-row .gantt-row-label {
                padding-left: 24px;
            }
        }

        /* Collapsible WBS Table Styles */
        .wbs-discipline-row {
            background: #1a1a1a;
            cursor: pointer;
            transition: background 0.2s;
        }

        .wbs-discipline-row:hover {
            background: #252525;
        }

        .wbs-discipline-row td {
            font-weight: 600;
            color: #ffd700;
            padding: 12px 8px;
        }

        .wbs-discipline-row td:first-child {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .wbs-expand-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            font-size: 10px;
            transition: transform 0.2s;
            color: #ffd700;
        }

        .wbs-expand-icon.expanded {
            transform: rotate(90deg);
        }

        .wbs-package-row {
            background: #0d0d0d;
        }

        .wbs-package-row.hidden {
            display: none;
        }

        .wbs-package-row td:first-child {
            padding-left: 32px;
        }

        .wbs-phase-header {
            background: #2a2a00;
            font-weight: 700;
        }

        .wbs-phase-header td {
            color: #ffd700;
            padding: 10px 8px;
            font-size: 13px;
            letter-spacing: 0.5px;
        }

        .wbs-table-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        /* RFP Wizard Modal Styles */
        .rfp-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .rfp-modal.open {
            opacity: 1;
            visibility: visible;
        }

        .rfp-modal-content {
            background: #0d0d0d;
            border: 2px solid #ffd700;
            border-radius: 12px;
            width: 95%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s;
        }

        .rfp-modal.open .rfp-modal-content {
            transform: scale(1);
        }

        .rfp-modal-header {
            background: linear-gradient(135deg, #ffd700 0%, #b8860b 100%);
            color: #000;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 10px 10px 0 0;
        }

        .rfp-modal-header h2 {
            margin: 0;
            font-size: 16px;
            font-weight: 700;
        }

        .rfp-modal-close {
            background: rgba(0, 0, 0, 0.2);
            border: none;
            color: #000;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .rfp-modal-close:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        .rfp-modal-body {
            padding: 24px;
        }

        .rfp-stage-indicator {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
        }

        .rfp-stage {
            flex: 1;
            text-align: center;
            padding: 10px;
            background: #1a1a1a;
            border: 1px solid #333;
            color: #666;
            font-size: 12px;
            border-radius: 6px;
            transition: all 0.3s;
        }

        .rfp-stage.active {
            background: #ffd700;
            color: #000;
            border-color: #ffd700;
            font-weight: 600;
        }

        .rfp-stage.completed {
            background: #2a2a00;
            color: #ffd700;
            border-color: #ffd700;
        }

        .rfp-stage-content {
            display: none;
        }

        .rfp-stage-content.active {
            display: block;
        }

        /* Stage 1: Upload */
        .rfp-dropzone {
            border: 2px dashed #444;
            border-radius: 12px;
            padding: 48px 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #1a1a1a;
        }

        .rfp-dropzone:hover,
        .rfp-dropzone.dragover {
            border-color: #ffd700;
            background: #1a1a00;
        }

        .rfp-dropzone-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .rfp-dropzone-text {
            color: #888;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .rfp-dropzone-hint {
            color: #666;
            font-size: 11px;
        }

        .rfp-file-info {
            display: none;
            background: #1a1a1a;
            border: 1px solid #ffd700;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }

        .rfp-file-info.visible {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .rfp-file-icon {
            font-size: 32px;
        }

        .rfp-file-details {
            flex: 1;
        }

        .rfp-file-name {
            color: #ffd700;
            font-weight: 600;
            font-size: 14px;
        }

        .rfp-file-meta {
            color: #888;
            font-size: 12px;
            margin-top: 4px;
        }

        .rfp-file-remove {
            background: transparent;
            border: 1px solid #ff4444;
            color: #ff4444;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }

        .rfp-file-remove:hover {
            background: #ff4444;
            color: #000;
        }

        /* Stage 2: Page Selection */
        .rfp-page-info {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .rfp-page-count {
            color: #ffd700;
            font-size: 24px;
            font-weight: 700;
        }

        .rfp-page-label {
            color: #888;
            font-size: 12px;
            margin-top: 4px;
        }

        .rfp-page-input-group {
            margin-top: 20px;
        }

        .rfp-page-input-group label {
            display: block;
            color: #ffd700;
            font-size: 12px;
            margin-bottom: 8px;
        }

        .rfp-page-input-group input {
            width: 100%;
            background: #000;
            border: 1px solid #444;
            color: #ffd700;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
        }

        .rfp-page-input-group input:focus {
            outline: none;
            border-color: #ffd700;
        }

        .rfp-page-hint {
            color: #666;
            font-size: 11px;
            margin-top: 8px;
        }

        /* Stage 3: Preview */
        .rfp-preview-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .rfp-preview-card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 16px;
        }

        .rfp-preview-card.full-width {
            grid-column: span 2;
        }

        .rfp-preview-card h4 {
            color: #ffd700;
            font-size: 12px;
            margin: 0 0 12px 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .rfp-confidence {
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 400;
        }

        .rfp-confidence.high {
            background: #00ff00;
            color: #000;
        }

        .rfp-confidence.medium {
            background: #ffd700;
            color: #000;
        }

        .rfp-confidence.low {
            background: #ff4444;
            color: #fff;
        }

        .rfp-preview-card textarea,
        .rfp-preview-card input[type="text"] {
            width: 100%;
            background: #000;
            border: 1px solid #444;
            color: #e0e0e0;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            font-family: inherit;
            resize: vertical;
        }

        .rfp-preview-card textarea:focus,
        .rfp-preview-card input[type="text"]:focus {
            outline: none;
            border-color: #ffd700;
        }

        .rfp-preview-card textarea {
            min-height: 80px;
        }

        .rfp-discipline-scope-item {
            background: #000;
            border: 1px solid #444;
            border-radius: 6px;
            padding: 12px;
        }

        .rfp-discipline-scope-name {
            color: #ffd700;
            font-weight: 600;
            font-size: 12px;
            margin-bottom: 6px;
        }

        .rfp-discipline-scope-text {
            color: #e0e0e0;
            font-size: 11px;
            line-height: 1.5;
            margin: 0;
        }

        .rfp-discipline-scope-textarea {
            width: 100%;
            background: #0a0a0a;
            border: 1px solid #444;
            color: #e0e0e0;
            padding: 8px;
            border-radius: 4px;
            font-size: 11px;
            font-family: inherit;
            resize: vertical;
            min-height: 60px;
        }

        .rfp-discipline-scope-textarea:focus {
            outline: none;
            border-color: #ffd700;
        }

        .rfp-notes {
            background: #1a1a00;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }

        .rfp-notes h4 {
            color: #ffd700;
            font-size: 12px;
            margin: 0 0 8px 0;
        }

        .rfp-notes p {
            color: #888;
            font-size: 12px;
            margin: 0;
            line-height: 1.5;
        }

        #rfp-truncation-notice {
            background: #2a1a00;
            border-color: #ff8800;
        }

        #rfp-truncation-notice h4 {
            color: #ff8800;
        }

        #rfp-truncation-notice p {
            color: #ffaa44;
        }

        /* Loading State */
        .rfp-loading {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 48px;
        }

        .rfp-loading.visible {
            display: flex;
        }

        .rfp-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid #333;
            border-top-color: #ffd700;
            border-radius: 50%;
            animation: rfpSpin 1s linear infinite;
        }

        @keyframes rfpSpin {
            to { transform: rotate(360deg); }
        }

        .rfp-loading-text {
            color: #888;
            font-size: 14px;
            margin-top: 16px;
        }

        /* Modal Actions */
        .rfp-modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid #333;
        }

        .rfp-btn {
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #444;
            background: #1a1a1a;
            color: #ffd700;
        }

        .rfp-btn:hover {
            border-color: #ffd700;
        }

        .rfp-btn-primary {
            background: linear-gradient(135deg, #ffd700 0%, #b8860b 100%);
            color: #000;
            border: none;
        }

        .rfp-btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
        }

        .rfp-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* RFP Button in Header */
        .rfp-header-btn {
            background: linear-gradient(135deg, #4a90d9 0%, #2c5aa0 100%);
            color: #fff;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .rfp-header-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(74, 144, 217, 0.4);
        }

        @media (max-width: 768px) {
            .rfp-preview-grid {
                grid-template-columns: 1fr;
            }

            .rfp-preview-card.full-width {
                grid-column: span 1;
            }

            .rfp-modal-content {
                width: 100%;
                max-height: 100vh;
                border-radius: 0;
            }

            .rfp-modal-header {
                border-radius: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="terminal" style="margin-bottom: 20px;">
            <div class="terminal-header">
                <button id="prev-btn" class="btn btn-sm hidden" onclick="prevStep()">‚Üê BACK</button>
                <span>‚ñ† WBS TERMINAL v1.0</span>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <button class="rfp-header-btn" onclick="openRfpWizard()">üìÑ RFP WIZARD</button>
                    <span id="status-text">READY</span>
                    <button id="next-btn" class="btn btn-sm btn-primary" onclick="nextStep()">NEXT ‚Üí</button>
                    <button id="generate-btn" class="btn btn-sm btn-primary hidden" onclick="generateWBS()">GENERATE WBS</button>
                </div>
            </div>
        </div>

        <!-- Main Terminal -->
        <div id="wizard-terminal" class="terminal">
            <div class="terminal-body">
                <!-- Progress Bar -->
                <div id="progress-section" class="progress-bar">
                    <div class="progress-step active" onclick="goToStep(1)">1:PHASES</div>
                    <div class="progress-step" onclick="goToStep(2)">2:DISCIPLINES</div>
                    <div class="progress-step" onclick="goToStep(3)">3:PACKAGES</div>
                    <div class="progress-step" onclick="goToStep(4)">4:BUDGET</div>
                    <div class="progress-step" onclick="goToStep(5)">5:CLAIMING</div>
                    <div class="progress-step" onclick="goToStep(6)">6:SCHEDULE</div>
                </div>

                <!-- Step 1: Phases -->
                <div id="step1" class="step-content">
                    <div class="section-title">PROJECT PHASES</div>
                    <div class="section-desc">Enter project phases separated by commas</div>
                    
                    <input type="text" id="phases-input" value="Base,">
                    
                    <div class="quick-tags">
                        <span class="quick-tag" onclick="addQuickPhase('Base')">+Base Design</span>
                        <span class="quick-tag" onclick="addQuickPhase('ESDC')">+ESDC</span>
                        <span class="quick-tag" onclick="addQuickPhase('TSCD')">+TSCD</span>
                        <span class="quick-tag" onclick="addQuickPhase('As-Builts')">+As-Builts</span>
                        <span class="quick-tag" onclick="addQuickPhase('Closeout')">+Closeout</span>
                    </div>
                </div>

                <!-- Step 2: Disciplines -->
                <div id="step2" class="step-content hidden">
                    <div class="section-title">PROJECT DISCIPLINES</div>
                    <div class="section-desc">Select disciplines involved in the project</div>
                    
                    <div class="disc-grid" id="disciplines-grid"></div>
                    
                    <div style="display: flex; gap: 8px; margin-top: 16px;">
                        <input type="text" id="custom-discipline" placeholder="Custom discipline..." style="flex: 1;">
                        <button class="btn btn-sm" onclick="addCustomDiscipline()">ADD</button>
                        <button class="btn btn-sm" onclick="selectAllDisciplines()">ALL</button>
                    </div>
                    
                    <div style="margin-top: 12px; color: #888; font-size: 12px;">
                        Selected: <span id="selected-count" style="color: #ffd700;">0</span>
                    </div>
                </div>

                <!-- Step 3: Packages -->
                <div id="step3" class="step-content hidden">
                    <div class="section-title">DELIVERABLE PACKAGES</div>
                    <div class="section-desc">Enter package milestones separated by commas</div>
                    
                    <input type="text" id="packages-input" value="Preliminary, Interim, Final, RFC, As-Buit">
                    
                    <div class="quick-tags">
                        <span class="quick-tag" onclick="addQuickPackage('Preliminary')">+Preliminary</span>
                        <span class="quick-tag" onclick="addQuickPackage('Interim')">+Interim</span>
                        <span class="quick-tag" onclick="addQuickPackage('Final')">+Final</span>
                        <span class="quick-tag" onclick="addQuickPackage('RFC')">+RFC</span>
                        <span class="quick-tag" onclick="addQuickPackage('As-Built')">+As-Built</span>
                    </div>
                </div>

                <!-- Step 4: Budget -->
                <div id="step4" class="step-content hidden">
                    <div class="section-title">DISCIPLINE BUDGETS</div>
                    <div class="section-desc">Enter total budget per discipline (distributed by claiming %)</div>

                    <!-- CALCULATOR SECTION -->
                    <div id="budget-calculator" class="budget-calculator">
                        <div class="calculator-header" onclick="toggleCalculator()">
                            <span>‚ñº COST ESTIMATOR</span>
                            <span id="calculator-status" style="color: #888; font-size: 11px;">Configure inputs below</span>
                        </div>

                        <div id="calculator-body" class="calculator-body">
                            <div class="calc-grid">
                                <div class="calc-group">
                                    <label>Total Construction Cost ($)</label>
                                    <input type="text" id="calc-construction-cost" placeholder="5,000,000" inputmode="numeric">
                                </div>

                                <div class="calc-group">
                                    <label>Design Fee (% of Construction)</label>
                                    <input type="number" id="calc-design-fee-pct" value="15" min="1" max="30" step="0.5">
                                </div>

                                <div class="calc-group">
                                    <label>Project Type</label>
                                    <select id="calc-project-type" onchange="updateComplexityDefaults()">
                                        <option value="Bridge">Bridge</option>
                                        <option value="Highway/Roadway" selected>Highway/Roadway</option>
                                        <option value="Drainage/Utilities">Drainage/Utilities</option>
                                    </select>
                                </div>

                                <div class="calc-group">
                                    <label>Project Complexity (Reference)</label>
                                    <select id="calc-global-complexity">
                                        <option value="Low">Low</option>
                                        <option value="Medium" selected>Medium</option>
                                        <option value="High">High</option>
                                    </select>
                                </div>
                            </div>

                            <div style="margin-top: 12px; padding: 8px; background: #1a1a00; border: 1px solid #333; font-size: 12px;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Total Design Fee:</span>
                                    <span id="calc-total-fee" style="color: #ffd700; font-weight: 600;">$0</span>
                                </div>
                            </div>

                            <div style="margin-top: 12px; display: flex; gap: 8px; justify-content: flex-end;">
                                <button class="btn btn-sm" onclick="showComplexityOverrides()">Advanced Settings</button>
                                <button class="btn btn-primary btn-sm" onclick="calculateBudgets()">Calculate Estimates</button>
                            </div>

                            <!-- Advanced Complexity Overrides (hidden by default) -->
                            <div id="complexity-overrides" class="hidden" style="margin-top: 16px; border-top: 1px solid #333; padding-top: 16px;">
                                <div style="font-size: 11px; color: #888; margin-bottom: 8px;">
                                    Override auto-assigned complexity levels per discipline:
                                </div>
                                <div id="complexity-grid" class="complexity-override-grid"></div>
                            </div>
                        </div>
                    </div>

                    <div class="ascii-line">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</div>

                    <div style="max-height: 350px; overflow-y: auto;">
                        <table id="budget-table"></table>
                    </div>

                    <div class="ascii-line">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</div>

                    <div style="display: flex; justify-content: space-between; color: #fff;">
                        <span>TOTAL PROJECT BUDGET:</span>
                        <span id="total-budget" style="color: #ffd700; font-size: 18px;">$0</span>
                    </div>
                </div>

                <!-- Step 5: Claiming -->
                <div id="step5" class="step-content hidden">
                    <div class="section-title">CLAIMING SCHEME</div>
                    <div class="section-desc">Set claiming % per package (must total 100%)</div>

                    <!-- PRESET SELECTOR PANEL -->
                    <div class="claiming-preset-panel">
                        <div class="preset-header" onclick="toggleClaimingPresets()">
                            <span>‚ñº SCHEME PRESETS</span>
                            <span id="preset-status" style="color: #888; font-size: 11px;">Click to apply a preset</span>
                        </div>

                        <div id="preset-body" class="preset-body">
                            <div class="preset-options">
                                <label class="preset-option">
                                    <input type="radio" name="claiming-scheme" value="frontLoaded">
                                    <div class="preset-label">
                                        <span class="preset-name">Front-Loaded</span>
                                        <span class="preset-desc">Higher % early, declining (30‚Üí10%)</span>
                                    </div>
                                </label>

                                <label class="preset-option">
                                    <input type="radio" name="claiming-scheme" value="backLoaded">
                                    <div class="preset-label">
                                        <span class="preset-name">Back-Loaded</span>
                                        <span class="preset-desc">Lower % early, increasing (10‚Üí30%)</span>
                                    </div>
                                </label>

                                <label class="preset-option">
                                    <input type="radio" name="claiming-scheme" value="bellCurve">
                                    <div class="preset-label">
                                        <span class="preset-name">Bell Curve</span>
                                        <span class="preset-desc">Peak in middle (10-20-40-20-10)</span>
                                    </div>
                                </label>

                                <label class="preset-option">
                                    <input type="radio" name="claiming-scheme" value="linear">
                                    <div class="preset-label">
                                        <span class="preset-name">Linear/Even</span>
                                        <span class="preset-desc">Equal distribution across all</span>
                                    </div>
                                </label>
                            </div>

                            <div class="preset-actions">
                                <button class="btn btn-sm" onclick="previewScheme()">Preview</button>
                                <button class="btn btn-primary btn-sm" onclick="applyClaimingScheme()">Apply to All Disciplines</button>
                            </div>

                            <div id="preview-display" class="preset-preview hidden"></div>
                        </div>
                    </div>

                    <div style="max-height: 350px; overflow-y: auto;">
                        <table id="claiming-table"></table>
                    </div>
                </div>

                <!-- Step 6: Schedule -->
                <div id="step6" class="step-content hidden">
                    <div class="section-title">PROJECT SCHEDULE</div>
                    <div class="section-desc">Set start/end dates per package</div>
                    
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table id="dates-table"></table>
                    </div>
                </div>

            </div>
        </div>

        <!-- Results Section -->
        <div id="results-section" class="hidden" style="margin-top: 20px;">
            <!-- KPIs -->
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-value" id="kpi-budget">$0</div>
                    <div class="kpi-label">TOTAL BUDGET</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="kpi-wbs">0</div>
                    <div class="kpi-label">WBS ELEMENTS</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="kpi-disc">0</div>
                    <div class="kpi-label">DISCIPLINES</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="kpi-months">0</div>
                    <div class="kpi-label">MONTHS</div>
                </div>
            </div>

            <!-- WBS Table -->
            <div class="terminal">
                <div class="terminal-header">
                    <span>‚ñ† WBS COST TABLE</span>
                    <div>
                        <button class="btn btn-sm" onclick="expandAllWBS()">EXPAND ALL</button>
                        <button class="btn btn-sm" onclick="collapseAllWBS()" style="margin-left: 8px;">COLLAPSE ALL</button>
                        <span style="margin: 0 12px; color: #666;">|</span>
                        <button class="btn btn-sm" onclick="printReport()">PRINT</button>
                        <button class="btn btn-sm" onclick="exportAllDataCSV()" style="margin-left: 8px;">EXPORT DATA</button>
                        <button class="btn btn-sm" onclick="exportCSV()" style="margin-left: 8px;">EXPORT WBS</button>
                        <button class="btn btn-sm" onclick="importData()" style="margin-left: 8px;">IMPORT</button>
                        <button class="btn btn-sm" onclick="editWBS()" style="margin-left: 8px;">EDIT</button>
                    </div>
                </div>
                <div class="terminal-body">
                    <div class="results-table">
                        <table id="wbs-table"></table>
                    </div>
                </div>
            </div>

            <!-- Chart -->
            <div class="terminal" style="margin-top: 20px;">
                <div class="terminal-header">
                    <span>‚ñ† PERFORMANCE CHART</span>
                </div>
                <div class="terminal-body">
                    <div class="filters">
                        <div class="filter-group">
                            <label>PHASE</label>
                            <select id="filter-phase" onchange="updateChart()">
                                <option value="all">All Phases</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>DISCIPLINE</label>
                            <select id="filter-discipline" onchange="updateChart()">
                                <option value="all">All Disciplines</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>VIEW</label>
                            <select id="view-type" onchange="updateChart()">
                                <option value="cumulative">Cumulative</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>CHART</label>
                            <select id="chart-type" onchange="updateChart()">
                                <option value="line">Line</option>
                                <option value="bar">Bar</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="performance-chart" height="300"></canvas>
                    </div>
                    
                    <div style="margin-top: 16px; font-size: 12px; display: flex; gap: 24px;">
                        <span><span style="color: #ffd700;">‚îÅ‚îÅ</span> PLANNED (BCWS)</span>
                        <span><span style="color: #00ff00;">‚îÖ‚îÖ</span> ACTUAL (ACWP) - TBD</span>
                    </div>
                </div>
            </div>

            <!-- Gantt Chart -->
            <div class="terminal" style="margin-top: 20px;">
                <div class="terminal-header">
                    <span>‚ñ† PROJECT SCHEDULE</span>
                    <div>
                        <button class="btn btn-sm" onclick="expandAllGantt()">EXPAND ALL</button>
                        <button class="btn btn-sm" onclick="collapseAllGantt()" style="margin-left: 8px;">COLLAPSE ALL</button>
                    </div>
                </div>
                <div class="terminal-body">
                    <div id="gantt-container" class="gantt-container">
                        <!-- Gantt chart will be rendered here -->
                    </div>
                    <div class="gantt-legend">
                        <div class="gantt-legend-item">
                            <div class="gantt-legend-color discipline"></div>
                            <span>Discipline Timeline</span>
                        </div>
                        <div class="gantt-legend-item">
                            <div class="gantt-legend-color package"></div>
                            <span>Package Deliverable</span>
                        </div>
                        <div class="gantt-legend-item" style="margin-left: auto; color: #666;">
                            <span>Click discipline rows to expand/collapse</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data
        let projectData = {
            phases: [],
            disciplines: [],
            packages: [],
            budgets: {},
            claiming: {},
            dates: {},
            calculator: {
                totalConstructionCost: 0,
                designFeePercent: 15,
                projectType: 'Highway/Roadway',
                totalDesignFee: 0,
                complexityOverrides: {},
                isCalculated: false,
                manualEdits: {}
            }
        };

        let currentStep = 1;
        let chart = null;

        // Discipline list with pre-selected items
        const allDisciplines = [
            { name: 'Structures', selected: true },
            { name: 'Design PM', selected: true },
            { name: 'Civil', selected: false },
            { name: 'Drainage', selected: false },
            { name: 'Electrical', selected: false },
            { name: 'Environmental', selected: false },
            { name: 'Traffic', selected: false },
            { name: 'ITS', selected: false },
            { name: 'Mechanical', selected: false },
            { name: 'Geotechnical', selected: false },
            { name: 'Survey', selected: false },
            { name: 'Landscape', selected: false },
            { name: 'Utilities', selected: false },
            { name: 'Lighting', selected: false },
            { name: 'Pavement', selected: false },
            { name: 'Bridges', selected: false },
            { name: 'H&H', selected: false },
            { name: 'Communications', selected: false },
            { name: 'Architecture', selected: false },
            { name: 'Systems', selected: false }
        ];

        // Example budgets [in the future we will use a database to get the budgets]
        const exampleBudgets = {
            'Structures': 450000,
            'Design PM': 180000,
            'Civil': 320000,
            'Drainage': 95000,
            'Electrical': 210000,
            'Environmental': 85000,
            'Traffic': 140000,
            'ITS': 125000,
            'Mechanical': 175000,
            'Geotechnical': 110000,
            'Survey': 65000,
            'Landscape': 55000,
            'Utilities': 90000,
            'Lighting': 75000,
            'Pavement': 280000,
            'Bridges': 520000,
            'H&H': 120000,
            'Communications': 95000,
            'Architecture': 150000,
            'Systems': 180000
        };

        // Default claiming scheme
        const defaultClaiming = [10, 15, 25, 30, 20];

        // Claiming scheme presets
        const claimingSchemes = {
            frontLoaded: {
                name: 'Front-Loaded',
                description: 'Higher % early, declining',
                baseline: [30, 25, 20, 15, 10],
                pattern: 'descending'
            },
            backLoaded: {
                name: 'Back-Loaded',
                description: 'Lower % early, increasing',
                baseline: [10, 15, 20, 25, 30],
                pattern: 'ascending'
            },
            bellCurve: {
                name: 'Bell Curve',
                description: 'Peak in middle',
                baseline: [10, 20, 40, 20, 10],
                pattern: 'bell'
            },
            linear: {
                name: 'Linear/Even',
                description: 'Equal distribution',
                baseline: [20, 20, 20, 20, 20],
                pattern: 'equal'
            }
        };

        // Project complexity mapping per project type
        const projectComplexityMap = {
            'Bridge': {
                'Structures': 'High', 'Design PM': 'Medium', 'Civil': 'High',
                'Drainage': 'Medium', 'Electrical': 'Low', 'Environmental': 'Medium',
                'Traffic': 'Low', 'ITS': 'Low', 'Mechanical': 'Medium',
                'Geotechnical': 'High', 'Survey': 'Medium', 'Landscape': 'Low',
                'Utilities': 'Medium', 'Lighting': 'Low', 'Pavement': 'Low',
                'Bridges': 'High', 'H&H': 'Medium', 'Communications': 'Low',
                'Architecture': 'Medium', 'Systems': 'Medium'
            },
            'Highway/Roadway': {
                'Structures': 'Medium', 'Design PM': 'High', 'Civil': 'High',
                'Drainage': 'High', 'Electrical': 'Medium', 'Environmental': 'Medium',
                'Traffic': 'High', 'ITS': 'Medium', 'Mechanical': 'Low',
                'Geotechnical': 'Medium', 'Survey': 'High', 'Landscape': 'Medium',
                'Utilities': 'High', 'Lighting': 'Medium', 'Pavement': 'High',
                'Bridges': 'Medium', 'H&H': 'High', 'Communications': 'Medium',
                'Architecture': 'Low', 'Systems': 'Medium'
            },
            'Drainage/Utilities': {
                'Structures': 'Low', 'Design PM': 'Medium', 'Civil': 'Medium',
                'Drainage': 'High', 'Electrical': 'Medium', 'Environmental': 'High',
                'Traffic': 'Low', 'ITS': 'Low', 'Mechanical': 'Low',
                'Geotechnical': 'Medium', 'Survey': 'Medium', 'Landscape': 'Low',
                'Utilities': 'High', 'Lighting': 'Low', 'Pavement': 'Medium',
                'Bridges': 'Low', 'H&H': 'High', 'Communications': 'Low',
                'Architecture': 'Low', 'Systems': 'Low'
            }
        };

        // Industry standard design fee distribution percentages
        const industryDistribution = {
            'Bridge': {
                'Structures': { Low: 18, Medium: 22, High: 28 },
                'Design PM': { Low: 8, Medium: 10, High: 13 },
                'Civil': { Low: 10, Medium: 12, High: 15 },
                'Drainage': { Low: 3, Medium: 5, High: 7 },
                'Electrical': { Low: 2, Medium: 3, High: 5 },
                'Environmental': { Low: 3, Medium: 4, High: 6 },
                'Traffic': { Low: 2, Medium: 3, High: 4 },
                'ITS': { Low: 1, Medium: 2, High: 3 },
                'Mechanical': { Low: 2, Medium: 3, High: 4 },
                'Geotechnical': { Low: 6, Medium: 8, High: 10 },
                'Survey': { Low: 3, Medium: 4, High: 5 },
                'Landscape': { Low: 1, Medium: 2, High: 3 },
                'Utilities': { Low: 2, Medium: 3, High: 4 },
                'Lighting': { Low: 1, Medium: 2, High: 3 },
                'Pavement': { Low: 2, Medium: 3, High: 4 },
                'Bridges': { Low: 18, Medium: 22, High: 28 },
                'H&H': { Low: 4, Medium: 6, High: 8 },
                'Communications': { Low: 2, Medium: 3, High: 4 },
                'Architecture': { Low: 3, Medium: 4, High: 6 },
                'Systems': { Low: 3, Medium: 5, High: 7 }
            },
            'Highway/Roadway': {
                'Structures': { Low: 10, Medium: 15, High: 20 },
                'Design PM': { Low: 10, Medium: 12, High: 15 },
                'Civil': { Low: 15, Medium: 18, High: 22 },
                'Drainage': { Low: 8, Medium: 10, High: 12 },
                'Electrical': { Low: 4, Medium: 6, High: 8 },
                'Environmental': { Low: 4, Medium: 5, High: 7 },
                'Traffic': { Low: 8, Medium: 10, High: 12 },
                'ITS': { Low: 3, Medium: 5, High: 7 },
                'Mechanical': { Low: 2, Medium: 3, High: 4 },
                'Geotechnical': { Low: 4, Medium: 6, High: 8 },
                'Survey': { Low: 5, Medium: 7, High: 9 },
                'Landscape': { Low: 3, Medium: 4, High: 6 },
                'Utilities': { Low: 6, Medium: 8, High: 10 },
                'Lighting': { Low: 3, Medium: 4, High: 6 },
                'Pavement': { Low: 10, Medium: 12, High: 15 },
                'Bridges': { Low: 8, Medium: 10, High: 12 },
                'H&H': { Low: 6, Medium: 8, High: 10 },
                'Communications': { Low: 3, Medium: 4, High: 6 },
                'Architecture': { Low: 2, Medium: 3, High: 4 },
                'Systems': { Low: 4, Medium: 5, High: 7 }
            },
            'Drainage/Utilities': {
                'Structures': { Low: 5, Medium: 8, High: 10 },
                'Design PM': { Low: 8, Medium: 10, High: 12 },
                'Civil': { Low: 12, Medium: 15, High: 18 },
                'Drainage': { Low: 18, Medium: 22, High: 26 },
                'Electrical': { Low: 4, Medium: 6, High: 8 },
                'Environmental': { Low: 8, Medium: 10, High: 14 },
                'Traffic': { Low: 2, Medium: 3, High: 4 },
                'ITS': { Low: 1, Medium: 2, High: 3 },
                'Mechanical': { Low: 2, Medium: 3, High: 4 },
                'Geotechnical': { Low: 5, Medium: 7, High: 9 },
                'Survey': { Low: 4, Medium: 6, High: 8 },
                'Landscape': { Low: 2, Medium: 3, High: 4 },
                'Utilities': { Low: 16, Medium: 20, High: 24 },
                'Lighting': { Low: 2, Medium: 3, High: 4 },
                'Pavement': { Low: 6, Medium: 8, High: 10 },
                'Bridges': { Low: 4, Medium: 6, High: 8 },
                'H&H': { Low: 8, Medium: 10, High: 12 },
                'Communications': { Low: 2, Medium: 3, High: 4 },
                'Architecture': { Low: 1, Medium: 2, High: 3 },
                'Systems': { Low: 3, Medium: 4, High: 5 }
            }
        };

        // Industry benchmark ranges for variance indicators
        const industryBenchmarks = {
            'Bridge': {
                'Structures': { min: 0.18, max: 0.30, typical: 0.24 },
                'Design PM': { min: 0.08, max: 0.15, typical: 0.11 },
                'Civil': { min: 0.10, max: 0.16, typical: 0.13 },
                'Geotechnical': { min: 0.06, max: 0.12, typical: 0.09 }
            },
            'Highway/Roadway': {
                'Structures': { min: 0.10, max: 0.22, typical: 0.16 },
                'Design PM': { min: 0.10, max: 0.16, typical: 0.13 },
                'Civil': { min: 0.15, max: 0.24, typical: 0.19 },
                'Drainage': { min: 0.08, max: 0.14, typical: 0.11 },
                'Traffic': { min: 0.08, max: 0.14, typical: 0.11 },
                'Pavement': { min: 0.10, max: 0.17, typical: 0.13 }
            },
            'Drainage/Utilities': {
                'Structures': { min: 0.05, max: 0.12, typical: 0.08 },
                'Design PM': { min: 0.08, max: 0.13, typical: 0.10 },
                'Drainage': { min: 0.18, max: 0.28, typical: 0.23 },
                'Utilities': { min: 0.16, max: 0.26, typical: 0.21 },
                'Environmental': { min: 0.08, max: 0.16, typical: 0.12 }
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initDisciplines();
            updateStatus('READY');
        });

        /**
         * Updates the status indicator in the terminal header
         * @param {string} text - Status text to display
         */
        function updateStatus(text) {
            document.getElementById('status-text').textContent = text;
        }

        /**
         * Initializes the discipline selection grid with all available disciplines
         */
        function initDisciplines() {
            const grid = document.getElementById('disciplines-grid');
            grid.innerHTML = allDisciplines.map(d => 
                `<div class="disc-item ${d.selected ? 'selected' : ''}" onclick="toggleDisc(this)" data-name="${d.name}">${d.name}</div>`
            ).join('');
            updateSelectedCount();
        }

        /**
         * Toggles the selection state of a discipline item
         * @param {HTMLElement} el - The discipline element to toggle
         */
        function toggleDisc(el) {
            el.classList.toggle('selected');
            updateSelectedCount();
        }

        /**
         * Selects all disciplines in the grid
         */
        function selectAllDisciplines() {
            document.querySelectorAll('.disc-item').forEach(el => el.classList.add('selected'));
            updateSelectedCount();
        }

        /**
         * Updates the selected discipline count display
         */
        function updateSelectedCount() {
            const count = document.querySelectorAll('.disc-item.selected').length;
            document.getElementById('selected-count').textContent = count;
        }

        /**
         * Adds a custom discipline to the grid from the input field
         */
        function addCustomDiscipline() {
            const input = document.getElementById('custom-discipline');
            const name = input.value.trim();
            if (name) {
                const grid = document.getElementById('disciplines-grid');
                grid.innerHTML += `<div class="disc-item selected" onclick="toggleDisc(this)" data-name="${name}">${name}</div>`;
                exampleBudgets[name] = 100000;
                input.value = '';
                updateSelectedCount();
            }
        }

        /**
         * Adds a phase to the phases input if not already present
         * @param {string} phase - Phase name to add
         */
        function addQuickPhase(phase) {
            const input = document.getElementById('phases-input');
            const phases = input.value.split(',').map(p => p.trim()).filter(p => p);
            if (!phases.includes(phase)) {
                phases.push(phase);
                input.value = phases.join(', ');
            }
        }

        /**
         * Adds a package to the packages input if not already present
         * @param {string} pkg - Package name to add
         */
        function addQuickPackage(pkg) {
            const input = document.getElementById('packages-input');
            const packages = input.value.split(',').map(p => p.trim()).filter(p => p);
            if (!packages.includes(pkg)) {
                packages.push(pkg);
                input.value = packages.join(', ');
            }
        }

        /**
         * Updates the progress bar visual state based on current step
         */
        function updateProgress() {
            document.querySelectorAll('.progress-step').forEach((el, i) => {
                el.classList.remove('active', 'completed');
                if (i + 1 < currentStep) el.classList.add('completed');
                if (i + 1 === currentStep) el.classList.add('active');
            });
        }

        /**
         * Shows the specified wizard step and updates navigation buttons
         * @param {number} step - Step number (1-6)
         */
        function showStep(step) {
            document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`step${step}`).classList.remove('hidden');
            
            document.getElementById('prev-btn').classList.toggle('hidden', step === 1);
            document.getElementById('next-btn').classList.toggle('hidden', step === 6);
            document.getElementById('generate-btn').classList.toggle('hidden', step !== 6);
            
            updateProgress();
            updateStatus(`STEP ${step}/6`);
        }

        /**
         * Navigates to a previous step in the wizard (backward navigation only)
         * @param {number} step - Step number to navigate to
         */
        function goToStep(step) {
            if (step < currentStep) {
                saveCurrentStep();
                currentStep = step;
                showStep(step);
            }
        }

        /**
         * Saves data from the current wizard step to projectData object
         */
        function saveCurrentStep() {
            switch(currentStep) {
                case 1:
                    projectData.phases = document.getElementById('phases-input').value.split(',').map(p => p.trim()).filter(p => p);
                    break;
                case 2:
                    projectData.disciplines = Array.from(document.querySelectorAll('.disc-item.selected')).map(el => el.dataset.name);
                    break;
                case 3:
                    projectData.packages = document.getElementById('packages-input').value.split(',').map(p => p.trim()).filter(p => p);
                    break;
                case 4:
                    document.querySelectorAll('.budget-input').forEach(input => {
                        // Remove commas before parsing
                        const value = parseFloat(input.value.replace(/,/g, '')) || 0;
                        projectData.budgets[input.dataset.disc] = value;
                    });
                    break;
                case 5:
                    document.querySelectorAll('.claiming-input').forEach(input => {
                        projectData.claiming[input.dataset.key] = parseFloat(input.value) || 0;
                    });
                    break;
                case 6:
                    document.querySelectorAll('.date-start').forEach(input => {
                        const key = input.dataset.key;
                        const endInput = document.querySelector(`.date-end[data-key="${key}"]`);
                        projectData.dates[key] = { start: input.value, end: endInput.value };
                    });
                    break;
            }
        }

        /**
         * Validates the current wizard step before allowing progression
         * @returns {boolean} True if validation passes, false otherwise
         */
        function validate() {
            switch(currentStep) {
                case 1:
                    if (!document.getElementById('phases-input').value.trim()) {
                        alert('Enter at least one phase.');
                        return false;
                    }
                    break;
                case 2:
                    if (document.querySelectorAll('.disc-item.selected').length === 0) {
                        alert('Select at least one discipline.');
                        return false;
                    }
                    break;
                case 3:
                    if (!document.getElementById('packages-input').value.trim()) {
                        alert('Enter at least one package.');
                        return false;
                    }
                    break;
            }
            return true;
        }

        /**
         * Advances to the next wizard step after validation
         */
        function nextStep() {
            if (!validate()) return;
            saveCurrentStep();
            
            if (currentStep < 6) {
                currentStep++;
                showStep(currentStep);
                
                if (currentStep === 4) buildBudgetTable();
                if (currentStep === 5) buildClaimingTable();
                if (currentStep === 6) buildDatesTable();
            }
        }

        /**
         * Returns to the previous wizard step
         */
        function prevStep() {
            saveCurrentStep();
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
            }
        }

        /**
         * Builds the budget input table for Step 4
         * Generates rows for each selected discipline with budget inputs and industry indicators
         */
        function buildBudgetTable() {
            const table = document.getElementById('budget-table');
            let html = `
                <thead>
                    <tr>
                        <th>DISCIPLINE</th>
                        <th style="text-align: right; width: 200px;">TOTAL BUDGET</th>
                        <th style="text-align: center; width: 40px;">IND</th>
                    </tr>
                </thead>
                <tbody>
            `;

            projectData.disciplines.forEach(disc => {
                const budget = projectData.budgets[disc] || exampleBudgets[disc] || 100000;
                const formattedBudget = Math.round(budget).toLocaleString('en-US', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                });
                html += `
                    <tr data-disc="${disc}">
                        <td>${disc}</td>
                        <td>
                            <input type="text" class="table-input budget-input" data-disc="${disc}" value="${formattedBudget}">
                        </td>
                        <td class="indicator-cell" style="text-align: center;">‚Ä¢</td>
                    </tr>
                `;
            });

            html += '</tbody>';
            table.innerHTML = html;

            // Add input listeners with manual edit tracking and formatting
            document.querySelectorAll('.budget-input').forEach(input => {
                // Validate input to only allow numbers and commas
                input.addEventListener('keydown', function(event) {
                    const allowedKeys = ['Backspace', 'Delete', 'Tab', 'Escape', 'Enter', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'];
                    if (allowedKeys.includes(event.key)) {
                        return;
                    }
                    if (event.ctrlKey || event.metaKey) {
                        if (['a', 'c', 'v', 'x'].includes(event.key.toLowerCase())) {
                            return;
                        }
                    }
                    if (!/[\d,]/.test(event.key)) {
                        event.preventDefault();
                    }
                });
                
                // Format on blur
                input.addEventListener('blur', function() {
                    const value = parseFloat(this.value.replace(/,/g, '')) || 0;
                    if (value > 0) {
                        this.value = Math.round(value).toLocaleString('en-US', {
                            minimumFractionDigits: 0,
                            maximumFractionDigits: 0
                        });
                    } else {
                        this.value = '';
                    }
                });
                
                // Remove formatting on focus for easier editing
                input.addEventListener('focus', function() {
                    const value = parseFloat(this.value.replace(/,/g, '')) || 0;
                    this.value = value > 0 ? value.toString() : '';
                });
                
                // Track manual edits and update total
                input.addEventListener('input', function() {
                    // Mark as manually edited
                    projectData.calculator.manualEdits[this.dataset.disc] = true;
                    updateTotalBudget();
                });
            });

            // Initialize calculator if first time
            if (!projectData.calculator.isCalculated) {
                initCalculator();
            } else {
                // Re-populate calculator values
                const costInput = document.getElementById('calc-construction-cost');
                const cost = projectData.calculator.totalConstructionCost || 0;
                costInput.value = cost > 0 ? Math.round(cost).toLocaleString('en-US', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }) : '';
                document.getElementById('calc-design-fee-pct').value = projectData.calculator.designFeePercent;
                document.getElementById('calc-project-type').value = projectData.calculator.projectType;
                
                // Re-initialize calculator to set up event listeners
                initCalculator();
                updateIndustryIndicators();
            }

            updateTotalBudget();
        }

        /**
         * Updates the total budget display and triggers industry indicator updates if needed
         */
        function updateTotalBudget() {
            let total = 0;
            document.querySelectorAll('.budget-input').forEach(input => {
                // Remove commas before parsing
                const value = parseFloat(input.value.replace(/,/g, '')) || 0;
                total += value;
            });
            document.getElementById('total-budget').textContent = formatCurrency(total);

            // Update indicators if calculation was performed
            if (projectData.calculator.isCalculated) {
                updateIndustryIndicators();
            }
        }

        // Calculator Functions
        
        /**
         * Toggles the calculator section expand/collapse state
         */
        function toggleCalculator() {
            const body = document.getElementById('calculator-body');
            const header = document.querySelector('.calculator-header span:first-child');

            if (body.classList.contains('collapsed')) {
                body.classList.remove('collapsed');
                header.textContent = '‚ñº COST ESTIMATOR';
            } else {
                body.classList.add('collapsed');
                header.textContent = '‚ñ∫ COST ESTIMATOR';
            }
        }

        function showComplexityOverrides() {
            const overrideSection = document.getElementById('complexity-overrides');

            if (overrideSection.classList.contains('hidden')) {
                buildComplexityOverrideGrid();
                overrideSection.classList.remove('hidden');
            } else {
                overrideSection.classList.add('hidden');
            }
        }

        function buildComplexityOverrideGrid() {
            const grid = document.getElementById('complexity-grid');
            const projectType = document.getElementById('calc-project-type').value;

            let html = '';
            projectData.disciplines.forEach(disc => {
                const autoComplexity = projectComplexityMap[projectType][disc] || 'Medium';
                const savedOverride = projectData.calculator.complexityOverrides[disc];
                const currentValue = savedOverride || autoComplexity;

                html += `
                    <div class="complexity-item">
                        <label>${disc}</label>
                        <select class="complexity-override" data-disc="${disc}" onchange="saveComplexityOverride(this)">
                            <option value="Low" ${currentValue === 'Low' ? 'selected' : ''}>Low</option>
                            <option value="Medium" ${currentValue === 'Medium' ? 'selected' : ''}>Medium</option>
                            <option value="High" ${currentValue === 'High' ? 'selected' : ''}>High</option>
                        </select>
                        ${savedOverride ? '<span style="color: #ffd700;">*</span>' : ''}
                    </div>
                `;
            });

            grid.innerHTML = html;
        }

        function saveComplexityOverride(selectEl) {
            const disc = selectEl.dataset.disc;
            const value = selectEl.value;
            const projectType = document.getElementById('calc-project-type').value;
            const autoValue = projectComplexityMap[projectType][disc];

            // Only save if different from auto-assigned
            if (value !== autoValue) {
                projectData.calculator.complexityOverrides[disc] = value;
            } else {
                delete projectData.calculator.complexityOverrides[disc];
            }
        }

        function updateComplexityDefaults() {
            // Clear overrides when project type changes
            projectData.calculator.complexityOverrides = {};

            // Rebuild override grid if visible
            const overrideSection = document.getElementById('complexity-overrides');
            if (!overrideSection.classList.contains('hidden')) {
                buildComplexityOverrideGrid();
            }

            // Recalculate total design fee
            updateCalculatorTotal();
        }

        /**
         * Calculates and displays the total design fee based on construction cost and design fee percentage
         */
        function updateCalculatorTotal() {
            const costInput = document.getElementById('calc-construction-cost');
            // Remove commas before parsing
            const constructionCost = parseFloat(costInput.value.replace(/,/g, '')) || 0;
            const designFeePct = parseFloat(document.getElementById('calc-design-fee-pct').value) || 0;
            const totalFee = constructionCost * (designFeePct / 100);

            document.getElementById('calc-total-fee').textContent = formatCurrency(totalFee);
            projectData.calculator.totalConstructionCost = constructionCost;
            projectData.calculator.designFeePercent = designFeePct;
            projectData.calculator.totalDesignFee = totalFee;
        }

        /**
         * Formats construction cost input with commas on blur
         */
        function formatConstructionCostInput(event) {
            const input = event ? event.target : document.getElementById('calc-construction-cost');
            const value = parseFloat(input.value.replace(/,/g, '')) || 0;
            if (value > 0) {
                input.value = Math.round(value).toLocaleString('en-US', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                });
            } else {
                input.value = '';
            }
        }

        /**
         * Removes formatting from construction cost input on focus for easier editing
         */
        function unformatConstructionCostInput(event) {
            const input = event ? event.target : document.getElementById('calc-construction-cost');
            const value = parseFloat(input.value.replace(/,/g, '')) || 0;
            input.value = value > 0 ? value.toString() : '';
        }

        /**
         * Validates construction cost input to only allow numbers and commas
         */
        function validateConstructionCostInput(event) {
            const input = event.target;
            // Allow: numbers, commas, backspace, delete, tab, escape, enter, and arrow keys
            const allowedKeys = ['Backspace', 'Delete', 'Tab', 'Escape', 'Enter', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'];
            if (allowedKeys.includes(event.key)) {
                return;
            }
            // Allow Ctrl/Cmd + A, C, V, X
            if (event.ctrlKey || event.metaKey) {
                if (['a', 'c', 'v', 'x'].includes(event.key.toLowerCase())) {
                    return;
                }
            }
            // Only allow numbers and commas
            if (!/[\d,]/.test(event.key)) {
                event.preventDefault();
            }
        }

        /**
         * Initializes calculator event listeners for real-time total updates
         */
        function initCalculator() {
            const costInput = document.getElementById('calc-construction-cost');
            
            // Add event listeners (check if already initialized to prevent duplicates)
            if (!costInput.dataset.initialized) {
                costInput.addEventListener('input', () => {
                    updateCalculatorTotal();
                });
                costInput.addEventListener('blur', formatConstructionCostInput);
                costInput.addEventListener('focus', unformatConstructionCostInput);
                costInput.addEventListener('keydown', validateConstructionCostInput);
                costInput.dataset.initialized = 'true';
            }
            
            // Format initial value if present
            if (costInput.value && parseFloat(costInput.value.replace(/,/g, '')) > 0) {
                const value = parseFloat(costInput.value.replace(/,/g, '')) || 0;
                if (value > 0) {
                    costInput.value = Math.round(value).toLocaleString('en-US', {
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 0
                    });
                }
            }
            
            const feeInput = document.getElementById('calc-design-fee-pct');
            if (!feeInput.dataset.initialized) {
                feeInput.addEventListener('input', updateCalculatorTotal);
                feeInput.dataset.initialized = 'true';
            }
            
            updateCalculatorTotal();
        }

        /**
         * Validates calculator inputs before budget calculation
         * @param {number} constructionCost - Total construction cost
         * @param {number} designFeePct - Design fee percentage
         * @returns {boolean} True if validation passes
         */
        function validateCalculatorInputs(constructionCost, designFeePct) {
            if (!constructionCost || constructionCost <= 0) {
                alert('Enter a valid construction cost.');
                return false;
            }
            if (!designFeePct || designFeePct <= 0 || designFeePct > 30) {
                alert('Design fee must be between 1% and 30%.');
                return false;
            }
            return true;
        }

        /**
         * Calculates raw industry distribution percentages for selected disciplines
         * @param {string} projectType - Project type (Bridge, Highway/Roadway, Drainage/Utilities)
         * @param {Array<string>} disciplines - Selected disciplines
         * @returns {{percentages: Object, total: number}} Raw percentages and total
         */
        function calculateRawPercentages(projectType, disciplines) {
            const rawPercentages = {};
            let totalRawPercentage = 0;

            disciplines.forEach(discipline => {
                // Get complexity (override or auto-assigned)
                const complexity = projectData.calculator.complexityOverrides[discipline] ||
                    projectComplexityMap[projectType][discipline] ||
                    'Medium';

                // Get industry percentage
                const distribution = industryDistribution[projectType];
                const percentage = distribution[discipline] ? distribution[discipline][complexity] : 5;

                rawPercentages[discipline] = percentage;
                totalRawPercentage += percentage;
            });

            return { percentages: rawPercentages, total: totalRawPercentage };
        }

        /**
         * Normalizes raw percentages to sum to 100% and calculates budgets
         * @param {Object} rawPercentages - Raw percentage values per discipline
         * @param {number} totalRawPercentage - Sum of raw percentages
         * @param {number} totalDesignFee - Total design fee amount
         * @param {Array<string>} disciplines - Selected disciplines
         * @returns {Object} Normalized budget amounts per discipline
         */
        function normalizeBudgets(rawPercentages, totalRawPercentage, totalDesignFee, disciplines) {
            const normalizedBudgets = {};
            disciplines.forEach(discipline => {
                const normalizedPct = (rawPercentages[discipline] / totalRawPercentage) * 100;
                normalizedBudgets[discipline] = totalDesignFee * (normalizedPct / 100);
            });
            return normalizedBudgets;
        }

        /**
         * Applies calculated budgets to the budget table inputs
         * @param {Object} normalizedBudgets - Budget amounts per discipline
         * @param {Array<string>} disciplines - Selected disciplines
         */
        function applyBudgetsToTable(normalizedBudgets, disciplines) {
            disciplines.forEach(discipline => {
                const input = document.querySelector(`.budget-input[data-disc="${discipline}"]`);
                if (input && !projectData.calculator.manualEdits[discipline]) {
                    const rounded = Math.round(normalizedBudgets[discipline]);
                    // Format with commas
                    input.value = rounded.toLocaleString('en-US', {
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 0
                    });
                    projectData.budgets[discipline] = normalizedBudgets[discipline];
                }
            });
        }

        /**
         * Updates calculator UI after successful calculation
         * @param {string} projectType - Project type used in calculation
         */
        function updateCalculatorUI(projectType) {
            projectData.calculator.isCalculated = true;
            projectData.calculator.projectType = projectType;

            // Collapse calculator and update status
            document.getElementById('calculator-body').classList.add('collapsed');
            document.querySelector('.calculator-header span:first-child').textContent = '‚ñ∫ COST ESTIMATOR';
            document.getElementById('calculator-status').textContent = 'Estimates applied ‚Ä¢ Click to edit';
            document.getElementById('calculator-status').style.color = '#00ff00';

            updateTotalBudget();
            updateIndustryIndicators();
            updateStatus('BUDGETS CALCULATED');
        }

        /**
         * Main function to calculate discipline budgets based on construction cost and industry standards
         * Validates inputs, calculates normalized budgets, and updates the UI
         */
        function calculateBudgets() {
            const costInput = document.getElementById('calc-construction-cost');
            // Remove commas before parsing
            const constructionCost = parseFloat(costInput.value.replace(/,/g, ''));
            const designFeePct = parseFloat(document.getElementById('calc-design-fee-pct').value);
            const projectType = document.getElementById('calc-project-type').value;

            // Validate inputs
            if (!validateCalculatorInputs(constructionCost, designFeePct)) {
                return;
            }

            const totalDesignFee = constructionCost * (designFeePct / 100);
            const selectedDisciplines = projectData.disciplines;

            // Calculate raw percentages
            const { percentages: rawPercentages, total: totalRawPercentage } = 
                calculateRawPercentages(projectType, selectedDisciplines);

            // Normalize and calculate budgets
            const normalizedBudgets = normalizeBudgets(
                rawPercentages, 
                totalRawPercentage, 
                totalDesignFee, 
                selectedDisciplines
            );

            // Apply to table
            applyBudgetsToTable(normalizedBudgets, selectedDisciplines);

            // Update UI
            updateCalculatorUI(projectType);
        }

        function updateIndustryIndicators() {
            if (!projectData.calculator.isCalculated) return;

            const totalBudget = Object.values(projectData.budgets).reduce((sum, val) => sum + val, 0);
            const projectType = projectData.calculator.projectType;

            projectData.disciplines.forEach(disc => {
                const budget = projectData.budgets[disc] || 0;
                const ratio = budget / totalBudget;

                // Get industry benchmark (if exists)
                const benchmark = industryBenchmarks[projectType] && industryBenchmarks[projectType][disc];

                if (!benchmark) {
                    // No benchmark available, use neutral indicator
                    const cell = document.querySelector(`tr[data-disc="${disc}"] .indicator-cell`);
                    if (cell) cell.innerHTML = '<span class="industry-indicator within">‚Ä¢</span>';
                    return;
                }

                // Determine variance
                let indicator = '';
                let variance = 0;

                if (ratio > benchmark.max) {
                    variance = ((ratio - benchmark.typical) / benchmark.typical * 100).toFixed(1);
                    indicator = `
                        <span class="industry-indicator above tooltip">‚Üë
                            <span class="tooltiptext">
                                Above industry range<br>
                                Your ratio: ${(ratio * 100).toFixed(1)}%<br>
                                Industry range: ${(benchmark.min * 100).toFixed(1)}% - ${(benchmark.max * 100).toFixed(1)}%<br>
                                Variance: +${variance}%
                            </span>
                        </span>
                    `;
                } else if (ratio < benchmark.min) {
                    variance = ((benchmark.typical - ratio) / benchmark.typical * 100).toFixed(1);
                    indicator = `
                        <span class="industry-indicator below tooltip">‚Üì
                            <span class="tooltiptext">
                                Below industry range<br>
                                Your ratio: ${(ratio * 100).toFixed(1)}%<br>
                                Industry range: ${(benchmark.min * 100).toFixed(1)}% - ${(benchmark.max * 100).toFixed(1)}%<br>
                                Variance: -${variance}%
                            </span>
                        </span>
                    `;
                } else {
                    indicator = `
                        <span class="industry-indicator within tooltip">‚Ä¢
                            <span class="tooltiptext">
                                Within industry range<br>
                                Your ratio: ${(ratio * 100).toFixed(1)}%<br>
                                Industry range: ${(benchmark.min * 100).toFixed(1)}% - ${(benchmark.max * 100).toFixed(1)}%
                            </span>
                        </span>
                    `;
                }

                const cell = document.querySelector(`tr[data-disc="${disc}"] .indicator-cell`);
                if (cell) cell.innerHTML = indicator;
            });
        }

        /**
         * Builds the claiming percentage table for Step 5
         * Generates a grid of inputs for each discipline-package combination
         */
        function buildClaimingTable() {
            const table = document.getElementById('claiming-table');
            const numPkgs = projectData.packages.length;
            
            let html = `
                <thead>
                    <tr>
                        <th>DISCIPLINE</th>
                        ${projectData.packages.map(p => `<th style="text-align: center;">${p}</th>`).join('')}
                        <th style="text-align: center;">TOTAL</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            projectData.disciplines.forEach(disc => {
                html += `<tr><td>${disc}</td>`;
                
                projectData.packages.forEach((pkg, i) => {
                    const key = `${disc}-${pkg}`;
                    const defaultVal = defaultClaiming[i] || Math.floor(100 / numPkgs);
                    const val = projectData.claiming[key] !== undefined ? projectData.claiming[key] : defaultVal;
                    
                    html += `
                        <td style="text-align: center;">
                            <input type="number" class="table-input claiming-input" style="text-align: center; width: 60px;" 
                                data-key="${key}" data-disc="${disc}" value="${val}" min="0" max="100">%
                        </td>
                    `;
                });
                
                html += `<td class="claiming-total" data-disc="${disc}" style="text-align: center;">0%</td></tr>`;
            });
            
            html += '</tbody>';
            table.innerHTML = html;
            
            document.querySelectorAll('.claiming-input').forEach(input => {
                input.addEventListener('input', updateClaimingTotals);
            });
            updateClaimingTotals();
        }

        /**
         * Updates claiming percentage totals for each discipline and validates they sum to 100%
         */
        function updateClaimingTotals() {
            projectData.disciplines.forEach(disc => {
                let total = 0;
                document.querySelectorAll(`.claiming-input[data-disc="${disc}"]`).forEach(input => {
                    total += parseFloat(input.value) || 0;
                });

                const cell = document.querySelector(`.claiming-total[data-disc="${disc}"]`);
                cell.textContent = total + '%';
                cell.className = `claiming-total ${total === 100 ? 'status-ok' : 'status-err'}`;
            });
        }

        // ============ CLAIMING PRESET FUNCTIONS ============

        // Normalize array to sum to 100%
        function normalizeToHundred(arr) {
            const sum = arr.reduce((a, b) => a + b, 0);
            if (sum === 0) return arr;

            const normalized = arr.map(val => (val / sum) * 100);
            const rounded = normalized.map(val => Math.round(val));

            // Adjust for rounding errors
            const roundedSum = rounded.reduce((a, b) => a + b, 0);
            if (roundedSum !== 100) {
                const diff = 100 - roundedSum;
                const maxIndex = rounded.indexOf(Math.max(...rounded));
                rounded[maxIndex] += diff;
            }

            return rounded;
        }

        // Linear/Even distribution
        function distributeEvenly(count) {
            if (count <= 0) return [];
            const base = Math.floor(100 / count);
            const remainder = 100 - (base * count);
            const result = new Array(count).fill(base);
            result[result.length - 1] += remainder;
            return result;
        }

        // Front-Loaded (descending) pattern
        function createDescendingPattern(count) {
            if (count === 1) return [100];
            if (count === 2) return [60, 40];

            const maxVal = 30;
            const minVal = 10;
            const step = (maxVal - minVal) / (count - 1);

            const result = [];
            for (let i = 0; i < count; i++) {
                result.push(maxVal - (step * i));
            }

            return normalizeToHundred(result);
        }

        // Back-Loaded (ascending) pattern
        function createAscendingPattern(count) {
            if (count === 1) return [100];
            if (count === 2) return [40, 60];

            const minVal = 10;
            const maxVal = 30;
            const step = (maxVal - minVal) / (count - 1);

            const result = [];
            for (let i = 0; i < count; i++) {
                result.push(minVal + (step * i));
            }

            return normalizeToHundred(result);
        }

        // Bell Curve pattern
        function createBellPattern(count) {
            if (count === 1) return [100];
            if (count === 2) return [50, 50];
            if (count === 3) return [25, 50, 25];

            const result = [];
            const midpoint = (count - 1) / 2;
            const peakValue = 40;
            const edgeValue = 8;

            for (let i = 0; i < count; i++) {
                const distanceFromMid = Math.abs(i - midpoint);
                const maxDistance = midpoint;
                const ratio = 1 - (distanceFromMid / maxDistance);
                const value = edgeValue + (ratio * (peakValue - edgeValue));
                result.push(value);
            }

            return normalizeToHundred(result);
        }

        // Adjust scheme to package count
        function adjustSchemeToPackageCount(schemeKey, packageCount) {
            if (packageCount <= 0) return [];

            const scheme = claimingSchemes[schemeKey];
            if (!scheme) return [];

            switch (scheme.pattern) {
                case 'equal':
                    return distributeEvenly(packageCount);
                case 'descending':
                    return createDescendingPattern(packageCount);
                case 'ascending':
                    return createAscendingPattern(packageCount);
                case 'bell':
                    return createBellPattern(packageCount);
                default:
                    return distributeEvenly(packageCount);
            }
        }

        // Toggle claiming presets panel
        function toggleClaimingPresets() {
            const body = document.getElementById('preset-body');
            const header = document.querySelector('.preset-header span:first-child');

            if (body.classList.contains('hidden')) {
                body.classList.remove('hidden');
                header.textContent = '‚ñº SCHEME PRESETS';
            } else {
                body.classList.add('hidden');
                header.textContent = '‚ñ∂ SCHEME PRESETS';
            }
        }

        // Get selected scheme from radio buttons
        function getSelectedScheme() {
            const selected = document.querySelector('input[name="claiming-scheme"]:checked');
            return selected ? selected.value : null;
        }

        // Preview scheme percentages
        function previewScheme() {
            const schemeKey = getSelectedScheme();
            if (!schemeKey) {
                alert('Please select a claiming scheme first.');
                return;
            }

            const packageCount = projectData.packages.length;
            if (packageCount === 0) {
                alert('Please add packages first (Step 3).');
                return;
            }

            const percentages = adjustSchemeToPackageCount(schemeKey, packageCount);
            const scheme = claimingSchemes[schemeKey];

            const previewDiv = document.getElementById('preview-display');
            let previewHTML = `<strong>Preview: ${scheme.name}</strong><br>`;

            projectData.packages.forEach((pkg, i) => {
                previewHTML += `${pkg}: <strong>${percentages[i]}%</strong>`;
                if (i < projectData.packages.length - 1) {
                    previewHTML += ' | ';
                }
            });

            const total = percentages.reduce((a, b) => a + b, 0);
            previewHTML += `<br>Total: <strong style="color: ${total === 100 ? '#00ff00' : '#ff4444'}">${total}%</strong>`;

            previewDiv.innerHTML = previewHTML;
            previewDiv.classList.remove('hidden');
        }

        // Apply claiming scheme to all disciplines
        function applyClaimingScheme() {
            const schemeKey = getSelectedScheme();
            if (!schemeKey) {
                alert('Please select a claiming scheme first.');
                return;
            }

            if (projectData.disciplines.length === 0) {
                alert('Please add disciplines first (Step 2).');
                return;
            }

            if (projectData.packages.length === 0) {
                alert('Please add packages first (Step 3).');
                return;
            }

            const packageCount = projectData.packages.length;
            const percentages = adjustSchemeToPackageCount(schemeKey, packageCount);
            const scheme = claimingSchemes[schemeKey];

            // Apply to all disciplines
            projectData.disciplines.forEach(disc => {
                percentages.forEach((pct, i) => {
                    const pkg = projectData.packages[i];
                    const key = `${disc}-${pkg}`;
                    projectData.claiming[key] = pct;
                });
            });

            // Update UI
            buildClaimingTable();

            // Update status
            const statusSpan = document.getElementById('preset-status');
            statusSpan.textContent = `Applied: ${scheme.name}`;
            statusSpan.style.color = '#00ff00';

            // Collapse panel
            const body = document.getElementById('preset-body');
            const header = document.querySelector('.preset-header span:first-child');
            body.classList.add('hidden');
            header.textContent = '‚ñ∂ SCHEME PRESETS';

            // Clear preview
            document.getElementById('preview-display').classList.add('hidden');
        }

        /**
         * Builds the schedule dates table for Step 6
         * Generates date inputs for each discipline-package combination with duration calculation
         */
        function buildDatesTable() {
            const table = document.getElementById('dates-table');
            const today = new Date();
            const fmt = d => d.toISOString().split('T')[0];
            
            let html = `
                <thead>
                    <tr>
                        <th>DISCIPLINE</th>
                        <th>PACKAGE</th>
                        <th>START</th>
                        <th>END</th>
                        <th style="text-align: center;">DAYS</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            projectData.disciplines.forEach(disc => {
                projectData.packages.forEach((pkg, i) => {
                    const key = `${disc}-${pkg}`;
                    
                    const startDate = new Date(today);
                    startDate.setDate(startDate.getDate() + (i * 45));
                    const endDate = new Date(startDate);
                    endDate.setDate(endDate.getDate() + 42);
                    
                    const saved = projectData.dates[key] || {};
                    
                    html += `
                        <tr>
                            <td>${i === 0 ? disc : ''}</td>
                            <td style="color: #ffd700;">${pkg}</td>
                            <td><input type="date" class="table-input date-start" data-key="${key}" value="${saved.start || fmt(startDate)}"></td>
                            <td><input type="date" class="table-input date-end" data-key="${key}" value="${saved.end || fmt(endDate)}"></td>
                            <td class="duration-cell" data-key="${key}" style="text-align: center;">--</td>
                        </tr>
                    `;
                });
            });
            
            html += '</tbody>';
            table.innerHTML = html;
            
            document.querySelectorAll('.date-start, .date-end').forEach(input => {
                input.addEventListener('change', updateDurations);
            });
            updateDurations();
        }

        /**
         * Calculates and displays duration in days for each date range in the schedule table
         */
        function updateDurations() {
            document.querySelectorAll('.duration-cell').forEach(cell => {
                const key = cell.dataset.key;
                const start = document.querySelector(`.date-start[data-key="${key}"]`).value;
                const end = document.querySelector(`.date-end[data-key="${key}"]`).value;
                
                if (start && end) {
                    const days = Math.ceil((new Date(end) - new Date(start)) / (1000 * 60 * 60 * 24));
                    cell.textContent = days > 0 ? days : 'ERR';
                    cell.className = `duration-cell ${days > 0 ? 'status-ok' : 'status-err'}`;
                }
            });
        }

        function generateWBS() {
            saveCurrentStep();
            
            // Hide the wizard terminal (keeps header visible)
            document.getElementById('wizard-terminal').style.display = 'none';
            document.getElementById('results-section').classList.remove('hidden');
            
            buildWBSTable();
            populateFilters();
            createChart();
            buildGanttChart();
            updateKPIs();
            updateStatus('WBS GENERATED');
        }

        function updateKPIs() {
            let total = 0;
            let wbsCount = 0;
            let minDate = null, maxDate = null;
            
            projectData.disciplines.forEach(disc => {
                total += projectData.budgets[disc] || 0;
                wbsCount += projectData.packages.length * projectData.phases.length;
                
                projectData.packages.forEach(pkg => {
                    const d = projectData.dates[`${disc}-${pkg}`];
                    if (d) {
                        const s = new Date(d.start), e = new Date(d.end);
                        if (!minDate || s < minDate) minDate = s;
                        if (!maxDate || e > maxDate) maxDate = e;
                    }
                });
            });
            
            const months = minDate && maxDate ? Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24 * 30)) : 0;
            
            document.getElementById('kpi-budget').textContent = '$' + total.toLocaleString();
            document.getElementById('kpi-wbs').textContent = wbsCount;
            document.getElementById('kpi-disc').textContent = projectData.disciplines.length;
            document.getElementById('kpi-months').textContent = months;
        }

        // Track expanded disciplines in WBS table
        const wbsTableState = {
            expandedDisciplines: new Set()
        };

        /**
         * Generates WBS table header HTML
         * @returns {string} HTML string for table header
         */
        function generateWBSTableHeader() {
            return `
                <thead>
                    <tr>
                        <th>WBS#</th>
                        <th>PHASE</th>
                        <th>DISCIPLINE</th>
                        <th>PACKAGE</th>
                        <th style="text-align: right;">BUDGET</th>
                        <th style="text-align: center;">%</th>
                        <th>START</th>
                        <th>END</th>
                        <th style="text-align: right;">ACTUAL</th>
                        <th style="text-align: right;">VAR</th>
                    </tr>
                </thead>
            `;
        }

        /**
         * Generates a discipline summary row (parent row)
         */
        function generateWBSDisciplineRow(wbsPrefix, phase, discipline, totalBudget, startDate, endDate, phaseIndex, disciplineIndex) {
            const rowId = `wbs-disc-${phaseIndex}-${disciplineIndex}`;
            const isExpanded = wbsTableState.expandedDisciplines.has(rowId);
            return `
                <tr class="wbs-discipline-row" data-row-id="${rowId}" onclick="toggleWBSDiscipline('${rowId}')">
                    <td><span class="wbs-expand-icon ${isExpanded ? 'expanded' : ''}">‚ñ∂</span> ${wbsPrefix}</td>
                    <td>${phase}</td>
                    <td>${discipline}</td>
                    <td style="color: #888; font-weight: 400;">${projectData.packages.length} packages</td>
                    <td style="text-align: right;">$${Math.round(totalBudget).toLocaleString()}</td>
                    <td style="text-align: center;">100%</td>
                    <td>${startDate}</td>
                    <td>${endDate}</td>
                    <td style="text-align: right; color: #666;">$0</td>
                    <td style="text-align: right; color: #00ff00;">$${Math.round(totalBudget).toLocaleString()}</td>
                </tr>
            `;
        }

        /**
         * Generates a single WBS package row (child row)
         */
        function generateWBSPackageRow(wbsNumber, phase, discipline, packageName, packageBudget, claimPercent, dates, rowId) {
            const isExpanded = wbsTableState.expandedDisciplines.has(rowId);
            return `
                <tr class="wbs-package-row ${isExpanded ? '' : 'hidden'}" data-parent="${rowId}">
                    <td style="color: #888;">${wbsNumber}</td>
                    <td style="color: #666;">${phase}</td>
                    <td style="color: #666;">${discipline}</td>
                    <td style="color: #ffd700;">${packageName}</td>
                    <td style="text-align: right;">$${Math.round(packageBudget).toLocaleString()}</td>
                    <td style="text-align: center;">${claimPercent}%</td>
                    <td>${dates.start}</td>
                    <td>${dates.end}</td>
                    <td style="text-align: right; color: #666;">$0</td>
                    <td style="text-align: right; color: #00ff00;">$${Math.round(packageBudget).toLocaleString()}</td>
                </tr>
            `;
        }

        /**
         * Generates WBS table footer with grand total
         * @param {number} grandTotal - Total budget across all WBS elements
         * @returns {string} HTML string for table footer
         */
        function generateWBSTableFooter(grandTotal) {
            return `
                <tfoot>
                    <tr>
                        <td colspan="4">GRAND TOTAL</td>
                        <td style="text-align: right;">$${Math.round(grandTotal).toLocaleString()}</td>
                        <td></td>
                        <td colspan="2"></td>
                        <td style="text-align: right;">$0</td>
                        <td style="text-align: right;">$${Math.round(grandTotal).toLocaleString()}</td>
                    </tr>
                </tfoot>
            `;
        }

        /**
         * Toggles a discipline row's expanded state
         */
        function toggleWBSDiscipline(rowId) {
            if (wbsTableState.expandedDisciplines.has(rowId)) {
                wbsTableState.expandedDisciplines.delete(rowId);
            } else {
                wbsTableState.expandedDisciplines.add(rowId);
            }
            
            // Toggle visibility of child rows
            document.querySelectorAll(`.wbs-package-row[data-parent="${rowId}"]`).forEach(row => {
                row.classList.toggle('hidden');
            });
            
            // Toggle expand icon
            const discRow = document.querySelector(`.wbs-discipline-row[data-row-id="${rowId}"]`);
            if (discRow) {
                const icon = discRow.querySelector('.wbs-expand-icon');
                icon.classList.toggle('expanded');
            }
        }

        /**
         * Expands all discipline rows in WBS table
         */
        function expandAllWBS() {
            document.querySelectorAll('.wbs-discipline-row').forEach(row => {
                const rowId = row.dataset.rowId;
                wbsTableState.expandedDisciplines.add(rowId);
            });
            document.querySelectorAll('.wbs-package-row').forEach(row => row.classList.remove('hidden'));
            document.querySelectorAll('.wbs-expand-icon').forEach(icon => icon.classList.add('expanded'));
        }

        /**
         * Collapses all discipline rows in WBS table
         */
        function collapseAllWBS() {
            wbsTableState.expandedDisciplines.clear();
            document.querySelectorAll('.wbs-package-row').forEach(row => row.classList.add('hidden'));
            document.querySelectorAll('.wbs-expand-icon').forEach(icon => icon.classList.remove('expanded'));
        }

        /**
         * Builds the complete WBS table with collapsible discipline groups
         * Generates hierarchical WBS numbering and calculates budget distribution
         */
        function buildWBSTable() {
            const table = document.getElementById('wbs-table');
            let grandTotal = 0;
            let html = generateWBSTableHeader() + '<tbody>';
            
            projectData.phases.forEach((phase, phaseIndex) => {
                projectData.disciplines.forEach((discipline, disciplineIndex) => {
                    const disciplineBudget = projectData.budgets[discipline] || 0;
                    const wbsPrefix = `${phaseIndex + 1}.${disciplineIndex + 1}`;
                    const rowId = `wbs-disc-${phaseIndex}-${disciplineIndex}`;
                    
                    // Calculate discipline date range
                    let minStart = null, maxEnd = null;
                    projectData.packages.forEach(pkg => {
                        const key = `${discipline}-${pkg}`;
                        const dates = projectData.dates[key];
                        if (dates) {
                            if (dates.start && (!minStart || dates.start < minStart)) minStart = dates.start;
                            if (dates.end && (!maxEnd || dates.end > maxEnd)) maxEnd = dates.end;
                        }
                    });
                    
                    // Add discipline summary row
                    html += generateWBSDisciplineRow(
                        wbsPrefix,
                        phase,
                        discipline,
                        disciplineBudget,
                        minStart || '-',
                        maxEnd || '-',
                        phaseIndex,
                        disciplineIndex
                    );
                    
                    // Add package rows (children)
                    projectData.packages.forEach((packageName, packageIndex) => {
                        const key = `${discipline}-${packageName}`;
                        const claimPercent = projectData.claiming[key] || 0;
                        const packageBudget = disciplineBudget * (claimPercent / 100);
                        const dates = projectData.dates[key] || { start: '-', end: '-' };
                        const wbsNumber = `${phaseIndex + 1}.${disciplineIndex + 1}.${packageIndex + 1}`;
                        
                        grandTotal += packageBudget;
                        
                        html += generateWBSPackageRow(
                            wbsNumber, 
                            phase, 
                            discipline, 
                            packageName, 
                            packageBudget, 
                            claimPercent, 
                            dates,
                            rowId
                        );
                    });
                });
            });
            
            html += '</tbody>' + generateWBSTableFooter(grandTotal);
            table.innerHTML = html;
        }

        function populateFilters() {
            document.getElementById('filter-phase').innerHTML = '<option value="all">All Phases</option>' +
                projectData.phases.map(p => `<option value="${p}">${p}</option>`).join('');
            
            document.getElementById('filter-discipline').innerHTML = '<option value="all">All Disciplines</option>' +
                projectData.disciplines.map(d => `<option value="${d}">${d}</option>`).join('');
        }

        /**
         * Creates and configures the Chart.js chart
         * Handles both line charts and stacked bar charts with percentage labels
         */
        function createChart() {
            const ctx = document.getElementById('performance-chart').getContext('2d');
            if (chart) chart.destroy();
            
            const data = getChartData();
            const type = document.getElementById('chart-type').value;
            const isStackedBar = type === 'bar' && data.datasets;
            
            // Configure chart options based on chart type
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        display: isStackedBar,
                        position: 'bottom',
                        labels: {
                            color: '#ffd700',
                            font: { size: 11 },
                            padding: 10,
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        backgroundColor: '#1a1a1a',
                        titleColor: '#ffd700',
                        bodyColor: '#fff',
                        borderColor: '#ffd700',
                        borderWidth: 1,
                        callbacks: {
                            label: (context) => {
                                const label = context.dataset.label || '';
                                const value = '$' + context.raw.toLocaleString();
                                
                                if (isStackedBar && data.totals) {
                                    const total = data.totals[context.dataIndex];
                                    const percentage = total > 0 
                                        ? ((context.raw / total) * 100).toFixed(1) 
                                        : '0.0';
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                                
                                return label + ': ' + value;
                            },
                            footer: (tooltipItems) => {
                                if (isStackedBar && data.totals) {
                                    const index = tooltipItems[0].dataIndex;
                                    return 'Total: $' + data.totals[index].toLocaleString();
                                }
                                return '';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        stacked: isStackedBar,
                        grid: { color: '#333' },
                        ticks: {
                            color: '#888',
                            callback: v => '$' + (v/1000).toFixed(0) + 'K'
                        }
                    },
                    x: {
                        stacked: isStackedBar,
                        grid: { color: '#222' },
                        ticks: { color: '#888' }
                    }
                }
            };
            
            // Store totals for percentage calculation in plugin
            let chartTotals = null;
            if (isStackedBar && data.totals) {
                chartTotals = data.totals;
            }
            
            // Configure datasets based on chart type
            let datasets;
            if (isStackedBar) {
                datasets = data.datasets;
            } else {
                datasets = [
                    {
                        label: 'PLANNED',
                        data: data.planned,
                        borderColor: '#ffd700',
                        backgroundColor: 'rgba(255, 215, 0, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3
                    },
                    {
                        label: 'ACTUAL',
                        data: data.actual,
                        borderColor: '#00ff00',
                        backgroundColor: 'rgba(0, 255, 0, 0.1)',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        fill: false,
                        tension: 0.3
                    }
                ];
            }
            
            chart = new Chart(ctx, {
                type: type,
                data: {
                    labels: data.labels,
                    datasets: datasets
                },
                options: chartOptions,
                plugins: isStackedBar ? [{
                    id: 'percentageLabels',
                    afterDatasetsDraw: (chart) => {
                        if (!chartTotals) return;
                        
                        const ctx = chart.ctx;
                        
                        chart.data.datasets.forEach((dataset, datasetIndex) => {
                            const meta = chart.getDatasetMeta(datasetIndex);
                            meta.data.forEach((bar, index) => {
                                const value = dataset.data[index];
                                const total = chartTotals[index];
                                
                                if (total > 0 && value > 0) {
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    
                                    // Only show label if segment is large enough (>= 5%)
                                    if (percentage >= 5) {
                                        const x = bar.x;
                                        // For stacked bars, bar.y is the top and bar.base is the bottom
                                        const segmentHeight = Math.abs(bar.base - bar.y);
                                        
                                        // Only show if segment is tall enough to be readable
                                        if (segmentHeight > 15) {
                                            const y = bar.y + (segmentHeight / 2);
                                            
                                            ctx.save();
                                            ctx.fillStyle = '#fff';
                                            ctx.strokeStyle = '#000';
                                            ctx.lineWidth = 2;
                                            ctx.font = 'bold 10px JetBrains Mono';
                                            ctx.textAlign = 'center';
                                            ctx.textBaseline = 'middle';
                                            
                                            // Add text stroke for better visibility
                                            ctx.strokeText(percentage + '%', x, y);
                                            ctx.fillText(percentage + '%', x, y);
                                            ctx.restore();
                                        }
                                    }
                                }
                            });
                        });
                    }
                }] : []
            });
        }

        /**
         * Generates a color palette for disciplines with distinct, visible colors
         * @param {number} count - Number of colors needed
         * @returns {Array<string>} Array of color hex codes
         */
        function generateDisciplineColors(count) {
            // Distinct color palette optimized for visibility and contrast
            const colors = [
                '#ffd700', // Gold (primary)
                '#00ff88', // Green
                '#00aaff', // Blue
                '#ff6b6b', // Red
                '#9b59b6', // Purple
                '#f39c12', // Orange
                '#1abc9c', // Turquoise
                '#e74c3c', // Dark Red
                '#3498db', // Light Blue
                '#2ecc71', // Dark Green
                '#e67e22', // Dark Orange
                '#16a085', // Dark Turquoise
                '#c0392b', // Darker Red
                '#8e44ad', // Dark Purple
                '#2980b9', // Dark Blue
                '#27ae60', // Darker Green
                '#d35400', // Very Dark Orange
                '#7f8c8d'  // Gray
            ];
            return colors.slice(0, count);
        }

        /**
         * Collects chart items grouped by discipline
         * @param {string} disciplineFilter - Selected discipline filter ('all' or discipline name)
         * @returns {Object} Object with items per discipline and all dates
         */
        function collectChartItemsByDiscipline(disciplineFilter) {
            const itemsByDiscipline = {};
            const allDates = [];
            const disciplinesToShow = disciplineFilter === 'all' 
                ? projectData.disciplines 
                : [disciplineFilter];

            disciplinesToShow.forEach(discipline => {
                itemsByDiscipline[discipline] = [];
                const disciplineBudget = projectData.budgets[discipline] || 0;
                
                projectData.packages.forEach(packageName => {
                    const key = `${discipline}-${packageName}`;
                    const dates = projectData.dates[key];
                    const claimPct = projectData.claiming[key] || 0;
                    const packageBudget = disciplineBudget * (claimPct / 100);
                    
                    if (dates && dates.start && dates.end) {
                        const startDate = new Date(dates.start);
                        const endDate = new Date(dates.end);
                        itemsByDiscipline[discipline].push({
                            start: startDate,
                            end: endDate,
                            budget: packageBudget
                        });
                        allDates.push(startDate, endDate);
                    }
                });
            });

            return { itemsByDiscipline, allDates };
        }

        /**
         * Collects chart items from project data based on discipline filter
         * @param {string} disciplineFilter - Selected discipline filter ('all' or discipline name)
         * @returns {Array<Object>} Array of items with start, end dates and budget
         */
        function collectChartItems(disciplineFilter) {
            const items = [];
            const allDates = [];

            projectData.disciplines.forEach(discipline => {
                if (disciplineFilter !== 'all' && discipline !== disciplineFilter) return;
                const disciplineBudget = projectData.budgets[discipline] || 0;
                
                projectData.packages.forEach(packageName => {
                    const key = `${discipline}-${packageName}`;
                    const dates = projectData.dates[key];
                    const claimPct = projectData.claiming[key] || 0;
                    const packageBudget = disciplineBudget * (claimPct / 100);
                    
                    if (dates && dates.start && dates.end) {
                        const startDate = new Date(dates.start);
                        const endDate = new Date(dates.end);
                        items.push({
                            start: startDate,
                            end: endDate,
                            budget: packageBudget
                        });
                        allDates.push(startDate, endDate);
                    }
                });
            });

            return { items, allDates };
        }

        /**
         * Calculates the date range for chart display
         * @param {Array<Date>} allDates - Array of all start and end dates
         * @returns {{start: Date, end: Date}} Start and end dates for chart
         */
        function calculateChartDateRange(allDates) {
            if (!allDates.length) return null;

            allDates.sort((a, b) => a - b);
            const startDate = new Date(allDates[0].getFullYear(), allDates[0].getMonth(), 1);
            const endDate = new Date(
                allDates[allDates.length - 1].getFullYear(), 
                allDates[allDates.length - 1].getMonth() + 1, 
                1
            );
            return { start: startDate, end: endDate };
        }

        /**
         * Calculates monthly budget for a given month
         * @param {Date} currentMonth - Current month being calculated
         * @param {Array<Object>} items - Chart items with dates and budgets
         * @returns {number} Monthly budget amount
         */
        function calculateMonthlyBudget(currentMonth, items) {
            let monthly = 0;
            items.forEach(item => {
                const months = Math.max(1, Math.ceil((item.end - item.start) / (1000 * 60 * 60 * 24 * 30)));
                if (currentMonth >= item.start && currentMonth <= item.end) {
                    monthly += item.budget / months;
                }
            });
            return monthly;
        }

        /**
         * Generates chart data points (labels, planned, actual) for the date range
         * @param {Date} startDate - Chart start date
         * @param {Date} endDate - Chart end date
         * @param {Array<Object>} items - Chart items with dates and budgets
         * @param {string} viewType - 'cumulative' or 'monthly'
         * @returns {{labels: Array<string>, planned: Array<number>, actual: Array<number>}}
         */
        function generateChartDataPoints(startDate, endDate, items, viewType) {
            const labels = [];
            const planned = [];
            const actual = [];
            let cumulative = 0;
            const current = new Date(startDate);

            while (current <= endDate) {
                labels.push(current.toLocaleDateString('en-US', { year: '2-digit', month: 'short' }));
                
                const monthly = calculateMonthlyBudget(current, items);
                
                if (viewType === 'cumulative') {
                    cumulative += monthly;
                    planned.push(Math.round(cumulative));
                } else {
                    planned.push(Math.round(monthly));
                }
                actual.push(0);
                
                current.setMonth(current.getMonth() + 1);
            }

            return { labels, planned, actual };
        }

        /**
         * Generates stacked chart data points per discipline
         * @param {Date} startDate - Chart start date
         * @param {Date} endDate - Chart end date
         * @param {Object} itemsByDiscipline - Items grouped by discipline
         * @param {string} viewType - 'cumulative' or 'monthly'
         * @returns {{labels: Array<string>, datasets: Array<Object>}}
         */
        /**
         * Generates stacked chart data with discipline colors
         * @param {Date} startDate - Chart start date
         * @param {Date} endDate - Chart end date
         * @param {Object} itemsByDiscipline - Items grouped by discipline
         * @param {string} viewType - 'cumulative' or 'monthly'
         * @returns {{labels: Array<string>, datasets: Array<Object>, totals: Array<number>}}
         */
        function generateStackedChartData(startDate, endDate, itemsByDiscipline, viewType) {
            const labels = [];
            const disciplines = Object.keys(itemsByDiscipline);
            const colors = generateDisciplineColors(disciplines.length);
            const datasets = disciplines.map((discipline, index) => ({
                label: discipline,
                data: [],
                backgroundColor: colors[index],
                borderColor: colors[index],
                borderWidth: 1
            }));
            
            const totals = []; // Store total for each month to calculate percentages
            let cumulativeByDiscipline = {};
            disciplines.forEach(disc => cumulativeByDiscipline[disc] = 0);
            
            const current = new Date(startDate);
            while (current <= endDate) {
                labels.push(current.toLocaleDateString('en-US', { year: '2-digit', month: 'short' }));
                
                let monthTotal = 0;
                disciplines.forEach((discipline, index) => {
                    const monthly = calculateMonthlyBudget(current, itemsByDiscipline[discipline]);
                    let value = monthly;
                    
                    if (viewType === 'cumulative') {
                        cumulativeByDiscipline[discipline] += monthly;
                        value = cumulativeByDiscipline[discipline];
                    }
                    
                    const rounded = Math.round(value);
                    datasets[index].data.push(rounded);
                    monthTotal += rounded;
                });
                
                totals.push(monthTotal);
                current.setMonth(current.getMonth() + 1);
            }
            
            return { labels, datasets, totals };
        }

        /**
         * Gets chart data based on current filters and view type
         * @returns {{labels: Array<string>, planned: Array<number>, actual: Array<number>} | {labels: Array<string>, datasets: Array<Object>}}
         */
        function getChartData() {
            const disciplineFilter = document.getElementById('filter-discipline').value;
            const viewType = document.getElementById('view-type').value;
            const chartType = document.getElementById('chart-type').value;
            
            // For stacked bar charts, use discipline-grouped data
            if (chartType === 'bar') {
                const { itemsByDiscipline, allDates } = collectChartItemsByDiscipline(disciplineFilter);
                
                if (!allDates.length) {
                    return { labels: ['N/A'], datasets: [] };
                }
                
                const dateRange = calculateChartDateRange(allDates);
                if (!dateRange) {
                    return { labels: ['N/A'], datasets: [] };
                }
                
                return generateStackedChartData(dateRange.start, dateRange.end, itemsByDiscipline, viewType);
            } else {
                // For line charts, use original format
                const { items, allDates } = collectChartItems(disciplineFilter);
                
                if (!allDates.length) {
                    return { labels: ['N/A'], planned: [0], actual: [0] };
                }
                
                const dateRange = calculateChartDateRange(allDates);
                if (!dateRange) {
                    return { labels: ['N/A'], planned: [0], actual: [0] };
                }
                
                return generateChartDataPoints(dateRange.start, dateRange.end, items, viewType);
            }
        }

        function updateChart() {
            createChart();
        }

        function editWBS() {
            document.getElementById('wizard-terminal').style.display = 'block';
            document.getElementById('results-section').classList.add('hidden');
            currentStep = 1;
            showStep(1);
        }

        /**
         * Exports WBS structure to CSV (output format)
         */
        function exportCSV() {
            let csv = 'WBS,Phase,Discipline,Package,Budget,Claim%,Start,End,Actual,Variance\n';
            
            projectData.phases.forEach((phase, pi) => {
                projectData.disciplines.forEach((disc, di) => {
                    const discBudget = projectData.budgets[disc] || 0;
                    
                    projectData.packages.forEach((pkg, ki) => {
                        const key = `${disc}-${pkg}`;
                        const claimPct = projectData.claiming[key] || 0;
                        const pkgBudget = discBudget * (claimPct / 100);
                        const dates = projectData.dates[key] || { start: '', end: '' };
                        
                        csv += `${pi+1}.${di+1}.${ki+1},"${phase}","${disc}","${pkg}",${pkgBudget},${claimPct},${dates.start},${dates.end},0,${pkgBudget}\n`;
                    });
                });
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'wbs_structure.csv';
            a.click();
        }

        /**
         * Exports all input data to CSV in a format that can be imported back
         * Includes: phases, disciplines, packages, budgets, claiming, dates, calculator settings
         */
        function exportAllDataCSV() {
            let csv = '# IPC Builder Project Data Export\n';
            csv += '# This file can be imported to restore project settings\n';
            csv += '# Format: Section,Key,Value\n\n';
            
            // Phases
            csv += '[PHASES]\n';
            projectData.phases.forEach(phase => {
                csv += `Phase,${phase}\n`;
            });
            csv += '\n';
            
            // Disciplines
            csv += '[DISCIPLINES]\n';
            projectData.disciplines.forEach(discipline => {
                csv += `Discipline,${discipline}\n`;
            });
            csv += '\n';
            
            // Packages
            csv += '[PACKAGES]\n';
            projectData.packages.forEach(packageName => {
                csv += `Package,${packageName}\n`;
            });
            csv += '\n';
            
            // Budgets
            csv += '[BUDGETS]\n';
            csv += 'Discipline,Budget\n';
            projectData.disciplines.forEach(discipline => {
                const budget = projectData.budgets[discipline] || 0;
                csv += `${discipline},${budget}\n`;
            });
            csv += '\n';
            
            // Claiming Percentages
            csv += '[CLAIMING]\n';
            csv += 'Discipline,Package,Percentage\n';
            projectData.disciplines.forEach(discipline => {
                projectData.packages.forEach(packageName => {
                    const key = `${discipline}-${packageName}`;
                    const percentage = projectData.claiming[key] || 0;
                    csv += `${discipline},${packageName},${percentage}\n`;
                });
            });
            csv += '\n';
            
            // Dates
            csv += '[DATES]\n';
            csv += 'Discipline,Package,Start,End\n';
            projectData.disciplines.forEach(discipline => {
                projectData.packages.forEach(packageName => {
                    const key = `${discipline}-${packageName}`;
                    const dates = projectData.dates[key] || { start: '', end: '' };
                    csv += `${discipline},${packageName},${dates.start},${dates.end}\n`;
                });
            });
            csv += '\n';
            
            // Calculator Settings
            csv += '[CALCULATOR]\n';
            csv += 'Setting,Value\n';
            csv += `TotalConstructionCost,${projectData.calculator.totalConstructionCost}\n`;
            csv += `DesignFeePercent,${projectData.calculator.designFeePercent}\n`;
            csv += `ProjectType,${projectData.calculator.projectType}\n`;
            csv += `TotalDesignFee,${projectData.calculator.totalDesignFee}\n`;
            csv += `IsCalculated,${projectData.calculator.isCalculated}\n`;
            
            // Complexity Overrides
            if (Object.keys(projectData.calculator.complexityOverrides).length > 0) {
                csv += '\n[COMPLEXITY_OVERRIDES]\n';
                csv += 'Discipline,Complexity\n';
                Object.entries(projectData.calculator.complexityOverrides).forEach(([disc, complexity]) => {
                    csv += `${disc},${complexity}\n`;
                });
            }
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'ipc_builder_project_data.csv';
            a.click();
        }

        /**
         * Imports project data from CSV file
         */
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const csv = event.target.result;
                        parseImportCSV(csv);
                        alert('Data imported successfully! Returning to wizard...');
                        editWBS();
                    } catch (error) {
                        alert('Error importing data: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        /**
         * Parses imported CSV and populates projectData
         * @param {string} csv - CSV file content
         */
        function parseImportCSV(csv) {
            const lines = csv.split('\n').map(line => line.trim()).filter(line => line && !line.startsWith('#'));
            
            let currentSection = '';
            const data = {
                phases: [],
                disciplines: [],
                packages: [],
                budgets: {},
                claiming: {},
                dates: {},
                calculator: {
                    totalConstructionCost: 0,
                    designFeePercent: 15,
                    projectType: 'Highway/Roadway',
                    totalDesignFee: 0,
                    complexityOverrides: {},
                    isCalculated: false,
                    manualEdits: {}
                }
            };
            
            lines.forEach(line => {
                // Check for section headers
                if (line.startsWith('[') && line.endsWith(']')) {
                    currentSection = line.slice(1, -1);
                    return;
                }
                
                const parts = line.split(',').map(p => p.trim());
                if (parts.length < 2) return;
                
                switch (currentSection) {
                    case 'PHASES':
                        if (parts[0] === 'Phase') {
                            data.phases.push(parts[1]);
                        }
                        break;
                    case 'DISCIPLINES':
                        if (parts[0] === 'Discipline') {
                            data.disciplines.push(parts[1]);
                        }
                        break;
                    case 'PACKAGES':
                        if (parts[0] === 'Package') {
                            data.packages.push(parts[1]);
                        }
                        break;
                    case 'BUDGETS':
                        if (parts[0] !== 'Discipline') {
                            data.budgets[parts[0]] = parseFloat(parts[1]) || 0;
                        }
                        break;
                    case 'CLAIMING':
                        if (parts[0] !== 'Discipline') {
                            const key = `${parts[0]}-${parts[1]}`;
                            data.claiming[key] = parseFloat(parts[2]) || 0;
                        }
                        break;
                    case 'DATES':
                        if (parts[0] !== 'Discipline') {
                            const key = `${parts[0]}-${parts[1]}`;
                            data.dates[key] = {
                                start: parts[2] || '',
                                end: parts[3] || ''
                            };
                        }
                        break;
                    case 'CALCULATOR':
                        if (parts[0] !== 'Setting') {
                            const setting = parts[0];
                            const value = parts[1];
                            if (setting === 'TotalConstructionCost') {
                                data.calculator.totalConstructionCost = parseFloat(value) || 0;
                            } else if (setting === 'DesignFeePercent') {
                                data.calculator.designFeePercent = parseFloat(value) || 15;
                            } else if (setting === 'ProjectType') {
                                data.calculator.projectType = value;
                            } else if (setting === 'TotalDesignFee') {
                                data.calculator.totalDesignFee = parseFloat(value) || 0;
                            } else if (setting === 'IsCalculated') {
                                data.calculator.isCalculated = value === 'true';
                            }
                        }
                        break;
                    case 'COMPLEXITY_OVERRIDES':
                        if (parts[0] !== 'Discipline') {
                            data.calculator.complexityOverrides[parts[0]] = parts[1];
                        }
                        break;
                }
            });
            
            // Apply imported data to projectData
            projectData = data;
            
            // Update UI if we're in the wizard
            if (currentStep >= 1 && currentStep <= 6) {
                loadImportedData();
            }
        }

        /**
         * Loads imported data into the wizard forms
         */
        function loadImportedData() {
            // Step 1: Phases
            if (projectData.phases.length > 0) {
                document.getElementById('phases-input').value = projectData.phases.join(', ');
            }
            
            // Step 2: Disciplines - restore selections
            if (projectData.disciplines.length > 0) {
                // Rebuild discipline grid with imported selections
                const grid = document.getElementById('disciplines-grid');
                let html = '';
                
                // First, mark all existing disciplines
                allDisciplines.forEach(d => {
                    const isSelected = projectData.disciplines.includes(d.name);
                    html += `<div class="disc-item ${isSelected ? 'selected' : ''}" onclick="toggleDisc(this)" data-name="${d.name}">${d.name}</div>`;
                });
                
                // Add any custom disciplines that aren't in allDisciplines
                projectData.disciplines.forEach(discipline => {
                    if (!allDisciplines.find(d => d.name === discipline)) {
                        html += `<div class="disc-item selected" onclick="toggleDisc(this)" data-name="${discipline}">${discipline}</div>`;
                    }
                });
                
                grid.innerHTML = html;
                updateSelectedCount();
            }
            
            // Step 3: Packages
            if (projectData.packages.length > 0) {
                document.getElementById('packages-input').value = projectData.packages.join(', ');
            }
            
            // Steps 4-6 will be populated when those steps are shown via buildBudgetTable, etc.
        }

        /**
         * Opens print-friendly report view
         */
        function printReport() {
            const printWindow = window.open('', '_blank');
            const today = new Date().toLocaleDateString();
            
            let html = `
<!DOCTYPE html>
<html>
<head>
    <title>WBS Terminal - Project Report</title>
    <style>
        @media print {
            @page { margin: 1cm; }
        }
        body {
            font-family: 'JetBrains Mono', monospace;
            padding: 20px;
            color: #000;
            background: #fff;
        }
        h1 { color: #000; border-bottom: 3px solid #000; padding-bottom: 10px; }
        h2 { color: #333; margin-top: 30px; border-bottom: 2px solid #333; padding-bottom: 5px; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 11px; }
        th { background: #000; color: #fff; padding: 8px; text-align: left; }
        td { padding: 6px 8px; border: 1px solid #ccc; }
        tr:nth-child(even) { background: #f5f5f5; }
        .kpi { display: flex; gap: 30px; margin: 20px 0; }
        .kpi-item { flex: 1; border: 2px solid #000; padding: 15px; text-align: center; }
        .kpi-value { font-size: 24px; font-weight: bold; }
        .kpi-label { font-size: 12px; margin-top: 5px; }
        .summary { margin: 20px 0; }
        .summary-row { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>
    <h1>WBS TERMINAL - PROJECT REPORT</h1>
    <p><strong>Generated:</strong> ${today}</p>
    
    <div class="kpi">
        <div class="kpi-item">
            <div class="kpi-value">${formatCurrency(calculateTotalBudget())}</div>
            <div class="kpi-label">Total Budget</div>
        </div>
        <div class="kpi-item">
            <div class="kpi-value">${projectData.disciplines.length}</div>
            <div class="kpi-label">Disciplines</div>
        </div>
        <div class="kpi-item">
            <div class="kpi-value">${projectData.phases.length}</div>
            <div class="kpi-label">Phases</div>
        </div>
        <div class="kpi-item">
            <div class="kpi-value">${projectData.packages.length}</div>
            <div class="kpi-label">Packages</div>
        </div>
    </div>
    
    <h2>Project Summary</h2>
    <div class="summary">
        <div class="summary-row"><strong>Phases:</strong> ${projectData.phases.join(', ')}</div>
        <div class="summary-row"><strong>Disciplines:</strong> ${projectData.disciplines.join(', ')}</div>
        <div class="summary-row"><strong>Packages:</strong> ${projectData.packages.join(', ')}</div>
    </div>
    
    <h2>Discipline Budgets</h2>
    <table>
        <thead>
            <tr>
                <th>Discipline</th>
                <th style="text-align: right;">Budget</th>
            </tr>
        </thead>
        <tbody>
`;
            
            projectData.disciplines.forEach(discipline => {
                const budget = projectData.budgets[discipline] || 0;
                html += `
            <tr>
                <td>${discipline}</td>
                <td style="text-align: right;">${formatCurrency(budget)}</td>
            </tr>`;
            });
            
            html += `
        </tbody>
        <tfoot>
            <tr>
                <th>Total</th>
                <th style="text-align: right;">${formatCurrency(calculateTotalBudget())}</th>
            </tr>
        </tfoot>
    </table>
    
    <h2>Work Breakdown Structure</h2>
    <table>
        <thead>
            <tr>
                <th>WBS#</th>
                <th>Phase</th>
                <th>Discipline</th>
                <th>Package</th>
                <th style="text-align: right;">Budget</th>
                <th style="text-align: center;">Claim%</th>
                <th>Start</th>
                <th>End</th>
            </tr>
        </thead>
        <tbody>
`;
            
            let grandTotal = 0;
            projectData.phases.forEach((phase, pi) => {
                projectData.disciplines.forEach((discipline, di) => {
                    const discBudget = projectData.budgets[discipline] || 0;
                    projectData.packages.forEach((packageName, ki) => {
                        const key = `${discipline}-${packageName}`;
                        const claimPct = projectData.claiming[key] || 0;
                        const pkgBudget = discBudget * (claimPct / 100);
                        const dates = projectData.dates[key] || { start: '-', end: '-' };
                        const wbs = `${pi+1}.${di+1}.${ki+1}`;
                        grandTotal += pkgBudget;
                        
                        html += `
            <tr>
                <td>${wbs}</td>
                <td>${phase}</td>
                <td>${discipline}</td>
                <td>${packageName}</td>
                <td style="text-align: right;">${formatCurrency(pkgBudget)}</td>
                <td style="text-align: center;">${claimPct}%</td>
                <td>${dates.start}</td>
                <td>${dates.end}</td>
            </tr>`;
                    });
                });
            });
            
            html += `
        </tbody>
        <tfoot>
            <tr>
                <th colspan="4">Grand Total</th>
                <th style="text-align: right;">${formatCurrency(grandTotal)}</th>
                <th colspan="3"></th>
            </tr>
        </tfoot>
    </table>
</body>
</html>`;
            
            printWindow.document.write(html);
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => {
                printWindow.print();
            }, 250);
        }

        /**
         * Calculates total budget from projectData
         * @returns {number} Total budget amount
         */
        function calculateTotalBudget() {
            return Object.values(projectData.budgets).reduce((sum, val) => sum + (val || 0), 0);
        }

        /**
         * Formats number as currency string
         * @param {number} amount - Amount to format
         * @returns {string} Formatted currency string
         */
        /**
         * Formats currency value with commas and no decimal places
         * @param {number} amount - Currency value to format
         * @returns {string} Formatted currency string (e.g., "$1,234,567")
         */
        function formatCurrency(amount) {
            return '$' + Math.round(amount || 0).toLocaleString('en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
        }

        // ============================================
        // GANTT CHART
        // ============================================

        const ganttState = {
            expandedDisciplines: new Set()
        };

        /**
         * Builds and renders the Gantt chart
         */
        function buildGanttChart() {
            const container = document.getElementById('gantt-container');
            
            // Get all dates to determine timeline range
            const allDates = [];
            Object.values(projectData.dates).forEach(d => {
                if (d.start) allDates.push(new Date(d.start));
                if (d.end) allDates.push(new Date(d.end));
            });
            
            if (allDates.length === 0) {
                container.innerHTML = '<div class="gantt-no-data">No schedule data available. Please set dates in Step 6.</div>';
                return;
            }
            
            // Find min and max dates
            const minDate = new Date(Math.min(...allDates));
            const maxDate = new Date(Math.max(...allDates));
            
            // Extend range by 1 month on each side
            minDate.setDate(1);
            maxDate.setMonth(maxDate.getMonth() + 1);
            maxDate.setDate(0);
            
            // Generate months array
            const months = [];
            const currentDate = new Date(minDate);
            while (currentDate <= maxDate) {
                months.push({
                    date: new Date(currentDate),
                    label: currentDate.toLocaleDateString('en-US', { month: 'short', year: '2-digit' })
                });
                currentDate.setMonth(currentDate.getMonth() + 1);
            }
            
            // Today marker
            const today = new Date();
            const todayMonthIndex = months.findIndex(m => 
                m.date.getMonth() === today.getMonth() && 
                m.date.getFullYear() === today.getFullYear()
            );
            
            // Build discipline schedule data
            const disciplineSchedules = projectData.disciplines.map(discipline => {
                const packages = projectData.packages.map(pkg => {
                    const key = `${discipline}-${pkg}`;
                    const dates = projectData.dates[key] || {};
                    return {
                        name: pkg,
                        start: dates.start ? new Date(dates.start) : null,
                        end: dates.end ? new Date(dates.end) : null,
                        claiming: projectData.claiming[key] || 0
                    };
                }).filter(p => p.start && p.end);
                
                // Calculate discipline overall timeline
                const pkgDates = packages.flatMap(p => [p.start, p.end]).filter(d => d);
                const discStart = pkgDates.length > 0 ? new Date(Math.min(...pkgDates)) : null;
                const discEnd = pkgDates.length > 0 ? new Date(Math.max(...pkgDates)) : null;
                
                return {
                    name: discipline,
                    start: discStart,
                    end: discEnd,
                    packages: packages,
                    budget: projectData.budgets[discipline] || 0
                };
            }).filter(d => d.start && d.end);
            
            // Render
            let html = `
                <div class="gantt-chart">
                    <div class="gantt-header">
                        <div class="gantt-label-col">Discipline / Package</div>
                        <div class="gantt-timeline-header">
                            ${months.map((m, i) => `
                                <div class="gantt-month ${i === todayMonthIndex ? 'current' : ''}">${m.label}</div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="gantt-body">
            `;
            
            disciplineSchedules.forEach(disc => {
                const isExpanded = ganttState.expandedDisciplines.has(disc.name);
                
                // Discipline row
                html += `
                    <div class="gantt-row discipline-row" onclick="toggleGanttDiscipline('${disc.name}')">
                        <div class="gantt-row-label">
                            <span class="gantt-expand-icon ${isExpanded ? 'expanded' : ''}">‚ñ∂</span>
                            <span>${disc.name}</span>
                        </div>
                        <div class="gantt-row-timeline">
                            ${months.map((m, i) => `<div class="gantt-cell ${i === todayMonthIndex ? 'current' : ''}"></div>`).join('')}
                            <div class="gantt-bar-container">
                                ${renderGanttBar(disc, minDate, maxDate, months.length, true)}
                            </div>
                        </div>
                    </div>
                `;
                
                // Package rows
                disc.packages.forEach(pkg => {
                    html += `
                        <div class="gantt-row package-row ${isExpanded ? '' : 'hidden'}" data-discipline="${disc.name}">
                            <div class="gantt-row-label">
                                <span>${pkg.name}</span>
                            </div>
                            <div class="gantt-row-timeline">
                                ${months.map((m, i) => `<div class="gantt-cell ${i === todayMonthIndex ? 'current' : ''}"></div>`).join('')}
                                <div class="gantt-bar-container">
                                    ${renderGanttBar(pkg, minDate, maxDate, months.length, false)}
                                </div>
                            </div>
                        </div>
                    `;
                });
            });
            
            html += `
                    </div>
                </div>
                <div id="gantt-tooltip" class="gantt-tooltip"></div>
            `;
            
            container.innerHTML = html;
            
            // Add tooltip event listeners
            container.querySelectorAll('.gantt-bar').forEach(bar => {
                bar.addEventListener('mouseenter', showGanttTooltip);
                bar.addEventListener('mouseleave', hideGanttTooltip);
                bar.addEventListener('mousemove', moveGanttTooltip);
            });
        }

        /**
         * Renders a Gantt bar for a discipline or package
         */
        function renderGanttBar(item, minDate, maxDate, monthCount, isDiscipline) {
            if (!item.start || !item.end) return '';
            
            const totalDays = (maxDate - minDate) / (1000 * 60 * 60 * 24);
            const startOffset = (item.start - minDate) / (1000 * 60 * 60 * 24);
            const duration = (item.end - item.start) / (1000 * 60 * 60 * 24);
            
            const leftPercent = (startOffset / totalDays) * 100;
            const widthPercent = (duration / totalDays) * 100;
            
            const barClass = isDiscipline ? 'discipline-bar' : 'package-bar';
            const label = isDiscipline ? item.name : `${item.claiming}%`;
            
            const startStr = item.start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const endStr = item.end.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const durationDays = Math.ceil(duration);
            
            return `
                <div class="gantt-bar ${barClass}" 
                     style="left: ${leftPercent}%; width: ${Math.max(widthPercent, 2)}%;"
                     data-name="${item.name}"
                     data-start="${startStr}"
                     data-end="${endStr}"
                     data-duration="${durationDays}"
                     data-budget="${item.budget || ''}"
                     data-claiming="${item.claiming || ''}"
                     data-is-discipline="${isDiscipline}">
                    ${widthPercent > 8 ? label : ''}
                </div>
            `;
        }

        /**
         * Toggles a discipline's expanded state in the Gantt chart
         */
        function toggleGanttDiscipline(discipline) {
            if (ganttState.expandedDisciplines.has(discipline)) {
                ganttState.expandedDisciplines.delete(discipline);
            } else {
                ganttState.expandedDisciplines.add(discipline);
            }
            
            // Toggle visibility of package rows
            document.querySelectorAll(`.package-row[data-discipline="${discipline}"]`).forEach(row => {
                row.classList.toggle('hidden');
            });
            
            // Toggle expand icon
            const discRow = document.querySelector(`.discipline-row .gantt-row-label span:last-child`);
            document.querySelectorAll('.discipline-row').forEach(row => {
                const label = row.querySelector('.gantt-row-label span:last-child');
                if (label && label.textContent === discipline) {
                    const icon = row.querySelector('.gantt-expand-icon');
                    icon.classList.toggle('expanded');
                }
            });
        }

        /**
         * Expands all disciplines in the Gantt chart
         */
        function expandAllGantt() {
            projectData.disciplines.forEach(disc => {
                ganttState.expandedDisciplines.add(disc);
            });
            document.querySelectorAll('.package-row').forEach(row => row.classList.remove('hidden'));
            document.querySelectorAll('.gantt-expand-icon').forEach(icon => icon.classList.add('expanded'));
        }

        /**
         * Collapses all disciplines in the Gantt chart
         */
        function collapseAllGantt() {
            ganttState.expandedDisciplines.clear();
            document.querySelectorAll('.package-row').forEach(row => row.classList.add('hidden'));
            document.querySelectorAll('.gantt-expand-icon').forEach(icon => icon.classList.remove('expanded'));
        }

        /**
         * Shows the Gantt tooltip
         */
        function showGanttTooltip(e) {
            const bar = e.target;
            const tooltip = document.getElementById('gantt-tooltip');
            const isDiscipline = bar.dataset.isDiscipline === 'true';
            
            let content = `<div class="gantt-tooltip-title">${bar.dataset.name}</div>`;
            content += `<div class="gantt-tooltip-row"><span class="gantt-tooltip-label">Start:</span> ${bar.dataset.start}</div>`;
            content += `<div class="gantt-tooltip-row"><span class="gantt-tooltip-label">End:</span> ${bar.dataset.end}</div>`;
            content += `<div class="gantt-tooltip-row"><span class="gantt-tooltip-label">Duration:</span> ${bar.dataset.duration} days</div>`;
            
            if (isDiscipline && bar.dataset.budget) {
                content += `<div class="gantt-tooltip-row"><span class="gantt-tooltip-label">Budget:</span> ${formatCurrency(parseFloat(bar.dataset.budget))}</div>`;
            }
            
            if (!isDiscipline && bar.dataset.claiming) {
                content += `<div class="gantt-tooltip-row"><span class="gantt-tooltip-label">Claiming:</span> ${bar.dataset.claiming}%</div>`;
            }
            
            tooltip.innerHTML = content;
            tooltip.classList.add('visible');
        }

        /**
         * Hides the Gantt tooltip
         */
        function hideGanttTooltip() {
            document.getElementById('gantt-tooltip').classList.remove('visible');
        }

        /**
         * Moves the Gantt tooltip with the cursor
         */
        function moveGanttTooltip(e) {
            const tooltip = document.getElementById('gantt-tooltip');
            const container = document.getElementById('gantt-container');
            const containerRect = container.getBoundingClientRect();
            
            let x = e.clientX - containerRect.left + 15;
            let y = e.clientY - containerRect.top - 10;
            
            // Keep tooltip within container
            const tooltipRect = tooltip.getBoundingClientRect();
            if (x + tooltipRect.width > containerRect.width) {
                x = e.clientX - containerRect.left - tooltipRect.width - 15;
            }
            
            tooltip.style.left = x + 'px';
            tooltip.style.top = y + 'px';
        }

        // ============================================
        // AI CHAT ASSISTANT
        // ============================================

        const chatState = {
            isOpen: false,
            messages: [],
            isLoading: false,
            isDragging: false,
            dragOffset: { x: 0, y: 0 }
        };

        const STEP_NAMES = {
            1: 'Phases',
            2: 'Disciplines', 
            3: 'Packages',
            4: 'Budget',
            5: 'Claiming',
            6: 'Schedule'
        };

        const STEP_DESCRIPTIONS = {
            1: 'Define project phases (e.g., Base, ESDC, TSCD). These represent major project milestones or stages.',
            2: 'Select engineering disciplines involved in the project (e.g., Structures, Civil, Traffic).',
            3: 'Define deliverable packages/milestones (e.g., Preliminary, Interim, Final, RFC).',
            4: 'Set the total budget allocation per discipline. Use the cost estimator to calculate based on construction cost and industry standards.',
            5: 'Set claiming percentages per package for each discipline. Must total 100% per discipline.',
            6: 'Set start and end dates for each package delivery.'
        };

        /**
         * Gathers current application context for the AI assistant
         * @returns {object} Context object with current state information
         */
        function getChatContext() {
            const resultsVisible = !document.getElementById('results-section').classList.contains('hidden');
            
            let context = {
                currentView: resultsVisible ? 'Results/WBS View' : `Step ${currentStep}: ${STEP_NAMES[currentStep]}`,
                stepDescription: resultsVisible ? 'Viewing generated WBS table, Gantt chart, KPIs, and performance chart.' : STEP_DESCRIPTIONS[currentStep],
                projectData: {
                    phases: projectData.phases.length > 0 ? projectData.phases : ['(not yet defined)'],
                    disciplines: projectData.disciplines.length > 0 ? projectData.disciplines : ['(not yet selected)'],
                    packages: projectData.packages.length > 0 ? projectData.packages : ['(not yet defined)'],
                    totalBudget: formatCurrency(calculateTotalBudget()),
                    budgetsByDiscipline: projectData.budgets,
                    claimingScheme: projectData.claiming,
                    scheduleDates: projectData.dates
                }
            };

            // Add results-specific context when viewing WBS output
            if (resultsVisible) {
                context.wbsResults = generateWBSDataForChat();
            }

            // Add step-specific context
            if (!resultsVisible) {
                switch (currentStep) {
                    case 4:
                        context.calculatorSettings = {
                            constructionCost: document.getElementById('calc-construction-cost')?.value || 0,
                            designFeePercent: document.getElementById('calc-design-fee-pct')?.value || 15,
                            projectType: document.getElementById('calc-project-type')?.value || 'Highway/Roadway',
                            complexity: document.getElementById('calc-global-complexity')?.value || 'Medium'
                        };
                        break;
                    case 5:
                        // Check claiming totals
                        const claimingTotals = {};
                        projectData.disciplines.forEach(disc => {
                            let total = 0;
                            projectData.packages.forEach(pkg => {
                                total += projectData.claiming[`${disc}-${pkg}`] || 0;
                            });
                            claimingTotals[disc] = total;
                        });
                        context.claimingTotals = claimingTotals;
                        break;
                }
            }

            return context;
        }

        /**
         * Generates structured WBS data for the chatbot
         * @returns {object} WBS results data
         */
        function generateWBSDataForChat() {
            const wbsElements = [];
            let grandTotal = 0;
            let minDate = null, maxDate = null;
            
            // Generate all WBS elements
            projectData.phases.forEach((phase, pi) => {
                projectData.disciplines.forEach((discipline, di) => {
                    const discBudget = projectData.budgets[discipline] || 0;
                    let discMinDate = null, discMaxDate = null;
                    
                    projectData.packages.forEach((pkg, ki) => {
                        const key = `${discipline}-${pkg}`;
                        const claimPct = projectData.claiming[key] || 0;
                        const pkgBudget = discBudget * (claimPct / 100);
                        const dates = projectData.dates[key] || { start: null, end: null };
                        
                        grandTotal += pkgBudget;
                        
                        // Track dates
                        if (dates.start) {
                            if (!minDate || dates.start < minDate) minDate = dates.start;
                            if (!discMinDate || dates.start < discMinDate) discMinDate = dates.start;
                        }
                        if (dates.end) {
                            if (!maxDate || dates.end > maxDate) maxDate = dates.end;
                            if (!discMaxDate || dates.end > discMaxDate) discMaxDate = dates.end;
                        }
                        
                        wbsElements.push({
                            wbs: `${pi+1}.${di+1}.${ki+1}`,
                            phase,
                            discipline,
                            package: pkg,
                            budget: pkgBudget,
                            claimPercent: claimPct,
                            startDate: dates.start || 'Not set',
                            endDate: dates.end || 'Not set'
                        });
                    });
                });
            });
            
            // Calculate discipline summaries
            const disciplineSummaries = projectData.disciplines.map(disc => {
                const budget = projectData.budgets[disc] || 0;
                const percentage = grandTotal > 0 ? ((budget / grandTotal) * 100).toFixed(1) : 0;
                
                // Get date range for discipline
                let discStart = null, discEnd = null;
                projectData.packages.forEach(pkg => {
                    const key = `${disc}-${pkg}`;
                    const dates = projectData.dates[key];
                    if (dates) {
                        if (dates.start && (!discStart || dates.start < discStart)) discStart = dates.start;
                        if (dates.end && (!discEnd || dates.end > discEnd)) discEnd = dates.end;
                    }
                });
                
                return {
                    name: disc,
                    totalBudget: budget,
                    percentOfTotal: percentage + '%',
                    startDate: discStart || 'Not set',
                    endDate: discEnd || 'Not set',
                    packageCount: projectData.packages.length
                };
            });
            
            // Calculate project duration
            let projectDuration = 0;
            if (minDate && maxDate) {
                projectDuration = Math.ceil((new Date(maxDate) - new Date(minDate)) / (1000 * 60 * 60 * 24));
            }
            
            return {
                kpis: {
                    totalBudget: formatCurrency(grandTotal),
                    totalBudgetRaw: grandTotal,
                    wbsElementCount: wbsElements.length,
                    disciplineCount: projectData.disciplines.length,
                    phaseCount: projectData.phases.length,
                    packageCount: projectData.packages.length,
                    projectStartDate: minDate || 'Not set',
                    projectEndDate: maxDate || 'Not set',
                    projectDurationDays: projectDuration,
                    projectDurationMonths: Math.ceil(projectDuration / 30)
                },
                disciplineSummaries,
                wbsElements: wbsElements.slice(0, 50), // Limit to first 50 to avoid token limits
                totalWbsElements: wbsElements.length
            };
        }

        /**
         * Builds the system prompt for the AI assistant
         * @returns {string} System prompt with context
         */
        function buildSystemPrompt() {
            const context = getChatContext();
            
            let prompt = `You are a helpful AI assistant embedded in WBS Terminal v1.0, a Work Breakdown Structure (WBS) generator for engineering projects.

## Your Role
- Help users understand and use the current screen/step they're viewing
- Answer questions about WBS concepts, engineering project planning, and budgeting
- Provide guidance specific to their current context and data
- Be concise but thorough; use bullet points for lists
- Reference specific values from their project when relevant
- When on the Results page, answer detailed questions about the generated WBS data

## Current User Context
**View:** ${context.currentView}
**Description:** ${context.stepDescription}

## Project Data
- **Phases:** ${context.projectData.phases.join(', ')}
- **Disciplines:** ${context.projectData.disciplines.join(', ')}
- **Packages:** ${context.projectData.packages.join(', ')}
- **Total Budget:** ${context.projectData.totalBudget}
${Object.keys(context.projectData.budgetsByDiscipline).length > 0 ? `- **Budget Breakdown:** ${Object.entries(context.projectData.budgetsByDiscipline).map(([k, v]) => `${k}: ${formatCurrency(v)}`).join(', ')}` : ''}
`;

            // Add WBS Results data when on results page
            if (context.wbsResults) {
                const r = context.wbsResults;
                prompt += `
## PROJECT KPIs (Generated Results)
- **Total Project Budget:** ${r.kpis.totalBudget}
- **Total WBS Elements:** ${r.kpis.wbsElementCount}
- **Disciplines:** ${r.kpis.disciplineCount}
- **Phases:** ${r.kpis.phaseCount}
- **Packages per Discipline:** ${r.kpis.packageCount}
- **Project Start Date:** ${r.kpis.projectStartDate}
- **Project End Date:** ${r.kpis.projectEndDate}
- **Project Duration:** ${r.kpis.projectDurationDays} days (~${r.kpis.projectDurationMonths} months)

## DISCIPLINE BREAKDOWN
${r.disciplineSummaries.map(d => `### ${d.name}
- Budget: ${formatCurrency(d.totalBudget)} (${d.percentOfTotal} of total)
- Timeline: ${d.startDate} to ${d.endDate}
- Packages: ${d.packageCount}`).join('\n\n')}

## WBS ELEMENTS (Sample - ${Math.min(r.wbsElements.length, 20)} of ${r.totalWbsElements} total)
${r.wbsElements.slice(0, 20).map(w => `- **WBS ${w.wbs}**: ${w.phase} > ${w.discipline} > ${w.package} | Budget: ${formatCurrency(w.budget)} (${w.claimPercent}%) | ${w.startDate} - ${w.endDate}`).join('\n')}
${r.totalWbsElements > 20 ? `\n... and ${r.totalWbsElements - 20} more WBS elements` : ''}

## WHAT USERS CAN ASK ABOUT ON RESULTS PAGE
- Budget breakdowns by discipline, phase, or package
- Schedule analysis (which discipline starts first, ends last, overlaps)
- Comparisons between disciplines (which has highest budget, longest duration)
- Claiming percentage analysis
- Timeline questions (what's happening in a specific month)
- Export and print options
- How to edit the WBS (click EDIT button)
`;
            } else {
                prompt += `
## Application Overview (6-Step Wizard)
1. **PHASES** - Define project phases (Base, ESDC, TSCD, etc.)
2. **DISCIPLINES** - Select engineering disciplines (Structures, Civil, Traffic, etc.)
3. **PACKAGES** - Define deliverable milestones (Preliminary, Interim, Final, RFC)
4. **BUDGET** - Set budget per discipline; includes cost estimator with industry percentages
5. **CLAIMING** - Set claiming % per package (must total 100% per discipline)
6. **SCHEDULE** - Set start/end dates for each package

## Tips for Each Step
- Step 1: Phases should represent major project stages or milestones
- Step 2: Select all disciplines that will have budget allocations
- Step 3: Packages are typically deliverable milestones (30%, 60%, 90%, Final)
- Step 4: Use the cost estimator to calculate budgets based on construction cost and industry standards
- Step 5: Claiming percentages determine how budget is distributed across packages; must sum to 100%
- Step 6: Dates help generate the project schedule and performance charts
`;
            }

            if (context.calculatorSettings) {
                prompt += `
## Current Calculator Settings
- Construction Cost: $${parseInt(context.calculatorSettings.constructionCost).toLocaleString()}
- Design Fee: ${context.calculatorSettings.designFeePercent}%
- Project Type: ${context.calculatorSettings.projectType}
- Complexity: ${context.calculatorSettings.complexity}
`;
            }

            if (context.claimingTotals) {
                prompt += `
## Claiming Status
${Object.entries(context.claimingTotals).map(([disc, total]) => `- ${disc}: ${total}% ${total === 100 ? '‚úì' : `(needs ${100 - total}% more)`}`).join('\n')}
`;
            }

            prompt += `
Be helpful, friendly, and context-aware. When users are on the Results page, you have access to all the generated WBS data and can answer specific questions about budgets, schedules, disciplines, and packages.`;

            return prompt;
        }

        /**
         * Toggles the chat panel open/closed
         */
        function toggleChat() {
            chatState.isOpen = !chatState.isOpen;
            const panel = document.getElementById('chat-panel');
            const fab = document.getElementById('chat-fab');
            
            panel.classList.toggle('open', chatState.isOpen);
            fab.classList.remove('has-unread');
            
            if (chatState.isOpen && chatState.messages.length === 0) {
                // Check for API key first
                if (!localStorage.getItem('wbs_openai_key')) {
                    showApiKeyModal();
                } else {
                    addWelcomeMessage();
                }
            }
            
            if (chatState.isOpen) {
                setTimeout(() => {
                    document.getElementById('chat-input').focus();
                }, 300);
            }
        }

        /**
         * Adds the initial welcome message
         */
        function addWelcomeMessage() {
            const context = getChatContext();
            const resultsVisible = !document.getElementById('results-section').classList.contains('hidden');
            
            if (resultsVisible) {
                addMessage('assistant', `üëã Hi! I'm your WBS Terminal assistant. You're viewing the **Generated WBS Results**.\n\nI have access to all your project data! Ask me about:\n‚Ä¢ **Budget analysis** - "Which discipline has the highest budget?"\n‚Ä¢ **Schedule questions** - "When does the project end?"\n‚Ä¢ **Comparisons** - "Compare Civil vs Structures budgets"\n‚Ä¢ **Breakdowns** - "Show me the Preliminary package budgets"\n‚Ä¢ **Export options** - "How do I export to CSV?"\n\nWhat would you like to know about your WBS?`);
            } else {
                addMessage('assistant', `üëã Hi! I'm your WBS Terminal assistant. You're currently on **${context.currentView}**.\n\nAsk me anything about:\n‚Ä¢ This step and what to do\n‚Ä¢ Your project data\n‚Ä¢ WBS concepts & best practices\n\nHow can I help?`);
            }
        }

        /**
         * Shows the API key configuration modal
         */
        function showApiKeyModal() {
            document.getElementById('chat-api-modal').classList.add('open');
            document.getElementById('api-key-input').focus();
        }

        /**
         * Hides the API key modal
         */
        function hideApiKeyModal() {
            document.getElementById('chat-api-modal').classList.remove('open');
        }

        /**
         * Saves the API key to localStorage
         */
        function saveApiKey() {
            const key = document.getElementById('api-key-input').value.trim();
            if (key) {
                localStorage.setItem('wbs_openai_key', key);
                hideApiKeyModal();
                addWelcomeMessage();
            }
        }

        /**
         * Opens settings to change API key
         */
        function openChatSettings() {
            document.getElementById('api-key-input').value = localStorage.getItem('wbs_openai_key') || '';
            showApiKeyModal();
        }

        /**
         * Clears chat history
         */
        function clearChat() {
            chatState.messages = [];
            renderMessages();
            addWelcomeMessage();
        }

        /**
         * Resets chat panel to default position
         */
        function resetChatPosition() {
            const panel = document.getElementById('chat-panel');
            panel.style.right = '24px';
            panel.style.bottom = '96px';
            panel.style.left = 'auto';
            panel.style.top = 'auto';
            localStorage.removeItem('wbs_chat_position');
        }

        /**
         * Loads saved chat position from localStorage
         */
        function loadChatPosition() {
            const saved = localStorage.getItem('wbs_chat_position');
            if (saved) {
                try {
                    const pos = JSON.parse(saved);
                    const panel = document.getElementById('chat-panel');
                    // Validate position is still on screen
                    const maxX = window.innerWidth - 100;
                    const maxY = window.innerHeight - 100;
                    if (pos.x >= 0 && pos.x <= maxX && pos.y >= 0 && pos.y <= maxY) {
                        panel.style.left = pos.x + 'px';
                        panel.style.top = pos.y + 'px';
                        panel.style.right = 'auto';
                        panel.style.bottom = 'auto';
                    }
                } catch (e) {
                    // Invalid saved position, ignore
                }
            }
        }

        /**
         * Saves chat position to localStorage
         */
        function saveChatPosition() {
            const panel = document.getElementById('chat-panel');
            const rect = panel.getBoundingClientRect();
            localStorage.setItem('wbs_chat_position', JSON.stringify({
                x: rect.left,
                y: rect.top
            }));
        }

        /**
         * Handles mouse down on chat header for dragging
         * @param {MouseEvent} e
         */
        function handleChatDragStart(e) {
            // Don't drag if clicking on buttons
            if (e.target.closest('.chat-header-btn') || e.target.closest('.chat-header-actions')) {
                return;
            }
            
            const panel = document.getElementById('chat-panel');
            const rect = panel.getBoundingClientRect();
            
            chatState.isDragging = true;
            chatState.dragOffset = {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top
            };
            
            panel.classList.add('dragging');
            document.addEventListener('mousemove', handleChatDrag);
            document.addEventListener('mouseup', handleChatDragEnd);
            e.preventDefault();
        }

        /**
         * Handles mouse move during drag
         * @param {MouseEvent} e
         */
        function handleChatDrag(e) {
            if (!chatState.isDragging) return;
            
            const panel = document.getElementById('chat-panel');
            const panelRect = panel.getBoundingClientRect();
            
            let newX = e.clientX - chatState.dragOffset.x;
            let newY = e.clientY - chatState.dragOffset.y;
            
            // Constrain to viewport
            const minX = 0;
            const minY = 0;
            const maxX = window.innerWidth - panelRect.width;
            const maxY = window.innerHeight - panelRect.height;
            
            newX = Math.max(minX, Math.min(newX, maxX));
            newY = Math.max(minY, Math.min(newY, maxY));
            
            panel.style.left = newX + 'px';
            panel.style.top = newY + 'px';
            panel.style.right = 'auto';
            panel.style.bottom = 'auto';
        }

        /**
         * Handles mouse up to end drag
         * @param {MouseEvent} e
         */
        function handleChatDragEnd(e) {
            if (!chatState.isDragging) return;
            
            chatState.isDragging = false;
            const panel = document.getElementById('chat-panel');
            panel.classList.remove('dragging');
            
            document.removeEventListener('mousemove', handleChatDrag);
            document.removeEventListener('mouseup', handleChatDragEnd);
            
            saveChatPosition();
        }

        /**
         * Initializes chat drag functionality
         */
        function initChatDrag() {
            const header = document.querySelector('.chat-header');
            if (header) {
                header.addEventListener('mousedown', handleChatDragStart);
            }
            loadChatPosition();
        }

        // Initialize drag when DOM is ready
        document.addEventListener('DOMContentLoaded', initChatDrag);

        /**
         * Adds a message to the chat
         * @param {string} role - 'user', 'assistant', or 'system'
         * @param {string} content - Message content
         */
        function addMessage(role, content) {
            chatState.messages.push({ role, content });
            renderMessages();
        }

        /**
         * Renders all chat messages
         */
        function renderMessages() {
            const container = document.getElementById('chat-messages');
            container.innerHTML = chatState.messages.map(msg => {
                const formattedContent = msg.content
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/`(.*?)`/g, '<code>$1</code>')
                    .replace(/\n/g, '<br>')
                    .replace(/‚Ä¢ /g, '&bull; ');
                return `<div class="chat-message ${msg.role}">${formattedContent}</div>`;
            }).join('');
            
            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        /**
         * Shows/hides the typing indicator
         * @param {boolean} show - Whether to show the indicator
         */
        function showTypingIndicator(show) {
            const container = document.getElementById('chat-messages');
            const existing = container.querySelector('.chat-typing');
            
            if (show && !existing) {
                container.insertAdjacentHTML('beforeend', '<div class="chat-typing"><span></span><span></span><span></span></div>');
                container.scrollTop = container.scrollHeight;
            } else if (!show && existing) {
                existing.remove();
            }
        }

        /**
         * Sends a message to the OpenAI API
         */
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message || chatState.isLoading) return;
            
            const apiKey = localStorage.getItem('wbs_openai_key');
            if (!apiKey) {
                showApiKeyModal();
                return;
            }
            
            // Add user message
            addMessage('user', message);
            input.value = '';
            input.style.height = 'auto';
            
            // Show loading state
            chatState.isLoading = true;
            document.getElementById('chat-send-btn').disabled = true;
            showTypingIndicator(true);
            
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-5-mini',
                        messages: [
                            { role: 'system', content: buildSystemPrompt() },
                            ...chatState.messages.filter(m => m.role !== 'system').slice(-10).map(m => ({
                                role: m.role,
                                content: m.content
                            }))
                        ],
                        max_completion_tokens: 500,
                        temperature: 0.7
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    if (response.status === 401) {
                        throw new Error('Invalid API key. Please check your OpenAI API key in settings.');
                    } else if (response.status === 429) {
                        throw new Error('Rate limit exceeded. Please wait a moment and try again.');
                    } else {
                        throw new Error(errorData.error?.message || `API error: ${response.status}`);
                    }
                }
                
                const data = await response.json();
                const assistantMessage = data.choices[0]?.message?.content || 'Sorry, I could not generate a response.';
                
                addMessage('assistant', assistantMessage);
                
            } catch (error) {
                console.error('Chat error:', error);
                addMessage('system', `‚ö†Ô∏è ${error.message}`);
            } finally {
                chatState.isLoading = false;
                document.getElementById('chat-send-btn').disabled = false;
                showTypingIndicator(false);
            }
        }

        /**
         * Handles Enter key in chat input
         * @param {KeyboardEvent} event
         */
        function handleChatKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        /**
         * Auto-resizes the chat input textarea
         */
        function autoResizeChatInput() {
            const input = document.getElementById('chat-input');
            input.style.height = 'auto';
            input.style.height = Math.min(input.scrollHeight, 100) + 'px';
        }

        /**
         * Updates the context badge in chat header
         */
        function updateChatContextBadge() {
            const badge = document.getElementById('chat-context-badge');
            if (badge) {
                const resultsVisible = !document.getElementById('results-section').classList.contains('hidden');
                badge.textContent = resultsVisible ? 'RESULTS' : `STEP ${currentStep}`;
            }
        }

        // Update context badge when step changes
        const originalShowStep = showStep;
        showStep = function(step) {
            originalShowStep(step);
            updateChatContextBadge();
        };

        // Update context badge when WBS is generated
        const originalGenerateWBS = generateWBS;
        generateWBS = function() {
            originalGenerateWBS();
            updateChatContextBadge();
        };

        // ============================================
        // RFP WIZARD
        // ============================================

        const rfpState = {
            currentStage: 1,
            file: null,
            pageCount: 0,
            extractedText: '',
            extractedData: null,
            wasTruncated: false,
            originalLength: 0,
            analyzedLength: 0,
            chunkCount: 1
        };

        // Initialize PDF.js worker
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }

        /**
         * Opens the RFP Wizard modal
         */
        function openRfpWizard() {
            document.getElementById('rfp-modal').classList.add('open');
            resetRfpWizard();
        }

        /**
         * Closes the RFP Wizard modal
         */
        function closeRfpWizard() {
            document.getElementById('rfp-modal').classList.remove('open');
        }

        /**
         * Resets the RFP Wizard to initial state
         */
        function resetRfpWizard() {
            rfpState.currentStage = 1;
            rfpState.file = null;
            rfpState.pageCount = 0;
            rfpState.extractedText = '';
            rfpState.extractedData = null;
            rfpState.wasTruncated = false;
            rfpState.originalLength = 0;
            rfpState.analyzedLength = 0;
            rfpState.chunkCount = 1;
            
            // Reset UI
            document.getElementById('rfp-file-info').classList.remove('visible');
            document.getElementById('rfp-file-input').value = '';
            document.getElementById('rfp-next-1').disabled = true;
            document.getElementById('rfp-page-range').value = '';
            document.getElementById('rfp-loading').classList.add('visible');
            document.getElementById('rfp-preview').style.display = 'none';
            document.getElementById('rfp-truncation-notice').style.display = 'none';
            
            // Reset preview section
            const previewSection = document.getElementById('rfp-text-preview-section');
            if (previewSection) previewSection.style.display = 'none';
            const previewBtn = document.getElementById('rfp-preview-text-btn');
            if (previewBtn) previewBtn.style.display = 'none';
            
            goToRfpStage(1);
        }

        /**
         * Navigates to a specific stage in the RFP wizard
         */
        function goToRfpStage(stage) {
            rfpState.currentStage = stage;
            
            // Update stage indicators
            document.querySelectorAll('.rfp-stage').forEach((el, i) => {
                el.classList.remove('active', 'completed');
                if (i + 1 < stage) el.classList.add('completed');
                if (i + 1 === stage) el.classList.add('active');
            });
            
            // Show/hide stage content
            document.querySelectorAll('.rfp-stage-content').forEach((el, i) => {
                el.classList.toggle('active', i + 1 === stage);
            });
            
            // Show preview button on stage 2 if file is loaded
            const previewBtn = document.getElementById('rfp-preview-text-btn');
            if (previewBtn) {
                previewBtn.style.display = (stage === 2 && rfpState.file && !rfpState.extractedText) ? 'inline-block' : 'none';
            }
            
            // Hide preview section when leaving stage 2
            if (stage !== 2) {
                const previewSection = document.getElementById('rfp-text-preview-section');
                if (previewSection) previewSection.style.display = 'none';
            }
        }

        /**
         * Handles file selection from input
         */
        function handleRfpFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handleRfpUpload(file);
            }
        }

        /**
         * Handles PDF file upload (from input or drag-drop)
         */
        async function handleRfpUpload(file) {
            if (file.type !== 'application/pdf') {
                alert('Please upload a PDF file.');
                return;
            }
            
            rfpState.file = file;
            
            // Display file info
            document.getElementById('rfp-file-name').textContent = file.name;
            document.getElementById('rfp-file-meta').textContent = formatFileSize(file.size);
            document.getElementById('rfp-file-info').classList.add('visible');
            
            // Get page count
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                rfpState.pageCount = pdf.numPages;
                document.getElementById('rfp-page-count').textContent = pdf.numPages;
                document.getElementById('rfp-next-1').disabled = false;
                
                // Show preview button if on stage 2
                if (rfpState.currentStage === 2) {
                    const previewBtn = document.getElementById('rfp-preview-text-btn');
                    if (previewBtn && !rfpState.extractedText) {
                        previewBtn.style.display = 'inline-block';
                    }
                }
            } catch (error) {
                console.error('Error reading PDF:', error);
                alert('Error reading PDF file. Please try another file.');
                removeRfpFile();
            }
        }

        /**
         * Removes the uploaded file
         */
        function removeRfpFile() {
            rfpState.file = null;
            rfpState.pageCount = 0;
            document.getElementById('rfp-file-info').classList.remove('visible');
            document.getElementById('rfp-file-input').value = '';
            document.getElementById('rfp-next-1').disabled = true;
        }

        /**
         * Formats file size for display
         */
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        /**
         * Formats large numbers with commas
         */
        function formatNumber(num) {
            return num.toLocaleString('en-US');
        }

        /**
         * Parses page range string into array of page numbers
         * e.g., "1-5,8,10-12" ‚Üí [1,2,3,4,5,8,10,11,12]
         */
        function parsePageRange(rangeStr, maxPages) {
            if (!rangeStr || !rangeStr.trim()) {
                // Return all pages if empty
                return Array.from({ length: maxPages }, (_, i) => i + 1);
            }
            
            const pages = new Set();
            const parts = rangeStr.split(',').map(s => s.trim());
            
            for (const part of parts) {
                if (part.includes('-')) {
                    const [start, end] = part.split('-').map(n => parseInt(n.trim()));
                    if (!isNaN(start) && !isNaN(end)) {
                        for (let i = Math.max(1, start); i <= Math.min(maxPages, end); i++) {
                            pages.add(i);
                        }
                    }
                } else {
                    const num = parseInt(part);
                    if (!isNaN(num) && num >= 1 && num <= maxPages) {
                        pages.add(num);
                    }
                }
            }
            
            return Array.from(pages).sort((a, b) => a - b);
        }

        /**
         * Extracts text from PDF using PDF.js
         */
        async function extractPdfText(file, pageNumbers) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            
            let fullText = '';
            
            for (const pageNum of pageNumbers) {
                if (pageNum > pdf.numPages) continue;
                
                const page = await pdf.getPage(pageNum);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += `\n--- Page ${pageNum} ---\n${pageText}\n`;
            }
            
            return fullText;
        }

        // Drag and drop handlers
        document.addEventListener('DOMContentLoaded', () => {
            const dropzone = document.getElementById('rfp-dropzone');
            if (dropzone) {
                dropzone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropzone.classList.add('dragover');
                });
                
                dropzone.addEventListener('dragleave', () => {
                    dropzone.classList.remove('dragover');
                });
                
                dropzone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropzone.classList.remove('dragover');
                    const file = e.dataTransfer.files[0];
                    if (file) handleRfpUpload(file);
                });
            }
        });

        /**
         * Splits text into chunks of approximately MAX_CHUNK_SIZE with overlap
         */
        function splitTextIntoChunks(text, maxChunkSize) {
            const chunks = [];
            const overlapSize = 2000; // 2K char overlap - optimized to reduce redundancy while maintaining context
            
            if (text.length <= maxChunkSize) {
                return [text];
            }
            
            let start = 0;
            while (start < text.length) {
                let end = start + maxChunkSize;
                
                // If not the last chunk, try to break at a sentence boundary
                if (end < text.length) {
                    // Look for sentence endings within last 1000 chars
                    const searchStart = Math.max(start + maxChunkSize - 1000, start);
                    const searchText = text.substring(searchStart, end);
                    const lastPeriod = searchText.lastIndexOf('. ');
                    const lastNewline = searchText.lastIndexOf('\n\n');
                    const breakPoint = Math.max(lastPeriod, lastNewline);
                    
                    if (breakPoint > 0) {
                        end = searchStart + breakPoint + (lastPeriod > lastNewline ? 2 : 2);
                    }
                }
                
                chunks.push(text.substring(start, end));
                
                // Next chunk starts with overlap
                start = end - overlapSize;
                if (start < 0) start = 0;
            }
            
            return chunks;
        }

        /**
         * Analyzes a single text chunk with OpenAI
         */
        async function analyzeChunk(apiKey, chunkText, chunkIndex, totalChunks) {
            const systemPrompt = `Extract WBS info from engineering RFP chunk ${chunkIndex + 1}/${totalChunks}. Return raw JSON only:
{"phases":[],"disciplines":[],"disciplineScopes":{},"packages":[],"budgets":{},"scope":"","schedule":"","confidence":{"phases":"high/medium/low","disciplines":"high/medium/low","packages":"high/medium/low","budgets":"low","scope":"high/medium/low","schedule":"high/medium/low"},"notes":""}

**PHASES**: Project stages (e.g. Base Design, ESDC, TSCD, Preliminary, Final, As-Builts, Closeout, Phase 1/2/3)
**DISCIPLINES**: Use EXACT names: Structures, Design PM, Civil, Drainage, Electrical, Environmental, Traffic, ITS, Mechanical, Geotechnical, Survey, Landscape, Utilities, Lighting, Pavement, Bridges, H&H, Communications, Architecture, Systems
**DISCIPLINE SCOPES**: {"Discipline":"scope description"} - Extract specific tasks/deliverables per discipline
**PACKAGES**: Milestones (e.g. Preliminary, Interim, Final, RFC, As-Built, 30%, 60%, 90%)
**SCOPE**: Project location, type, major work elements, requirements
**SCHEDULE**: Timeline info, durations, milestones, deadlines
Confidence: "high"=explicit, "medium"=inferred, "low"=guessed`;

            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: 'gpt-5.2',
                    messages: [
                        { role: 'system', content: systemPrompt },
                        { role: 'user', content: `Analyze this portion of the RFP document (chunk ${chunkIndex + 1} of ${totalChunks}) and extract WBS information:\n\n${chunkText}` }
                    ],
                    max_completion_tokens: 32000,
                    temperature: 0.3
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error?.message || `API error: ${response.status}`);
            }
            
            const data = await response.json();
            
            // Log full API response structure for debugging
            console.log(`Chunk ${chunkIndex + 1} full API response:`, JSON.stringify(data, null, 2).substring(0, 1000));
            
            const content = data.choices?.[0]?.message?.content || data.output?.message?.content || '';
            
            // Log raw response for debugging
            console.log(`Chunk ${chunkIndex + 1} extracted content:`, content ? content.substring(0, 500) : 'EMPTY CONTENT');
            
            // Parse JSON response - handle various formats
            try {
                // Try to extract JSON from markdown code blocks first
                const codeBlockMatch = content.match(/```(?:json)?\s*([\s\S]*?)```/);
                if (codeBlockMatch) {
                    const jsonContent = codeBlockMatch[1].trim();
                    const jsonMatch = jsonContent.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        return JSON.parse(jsonMatch[0]);
                    }
                }
                
                // Try to find JSON object directly
                const jsonMatch = content.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    return JSON.parse(jsonMatch[0]);
                }
                
                // Last resort: try parsing the whole content
                return JSON.parse(content);
            } catch (e) {
                console.error(`JSON parse error for chunk ${chunkIndex + 1}:`, e.message);
                console.error('Content was:', content);
                throw new Error(`Could not parse AI response as JSON for chunk ${chunkIndex + 1}`);
            }
        }

        /**
         * Locally merges simple array fields (phases, disciplines, packages) to reduce API cost
         */
        function localMergeSimpleFields(chunkResults) {
            const merged = {
                phases: [],
                disciplines: [],
                packages: [],
                budgets: {}
            };

            // Merge phases - deduplicate and preserve order
            const phasesSet = new Set();
            chunkResults.forEach(result => {
                if (result.phases && Array.isArray(result.phases)) {
                    result.phases.forEach(phase => {
                        if (phase && !phasesSet.has(phase)) {
                            phasesSet.add(phase);
                            merged.phases.push(phase);
                        }
                    });
                }
            });

            // Merge disciplines - deduplicate and preserve order
            const disciplinesSet = new Set();
            chunkResults.forEach(result => {
                if (result.disciplines && Array.isArray(result.disciplines)) {
                    result.disciplines.forEach(disc => {
                        if (disc && !disciplinesSet.has(disc)) {
                            disciplinesSet.add(disc);
                            merged.disciplines.push(disc);
                        }
                    });
                }
            });

            // Merge packages - deduplicate and preserve order
            const packagesSet = new Set();
            chunkResults.forEach(result => {
                if (result.packages && Array.isArray(result.packages)) {
                    result.packages.forEach(pkg => {
                        if (pkg && !packagesSet.has(pkg)) {
                            packagesSet.add(pkg);
                            merged.packages.push(pkg);
                        }
                    });
                }
            });

            return merged;
        }

        /**
         * Merges multiple chunk results into a final consolidated result (OPTIMIZED)
         * Uses local merge for simple arrays and AI only for complex fields
         */
        async function mergeChunkResults(apiKey, chunkResults) {
            // Step 1: Local merge of simple fields (no API cost)
            const localMerged = localMergeSimpleFields(chunkResults);
            console.log('Local merge complete:', localMerged);

            // Step 2: Use AI to merge only complex fields (disciplineScopes, scope, schedule, confidence, notes)
            const mergePrompt = `Merge ${chunkResults.length} WBS chunk analyses. Return raw JSON:
{"disciplineScopes":{},"scope":"","schedule":"","confidence":{"phases":"high/medium/low","disciplines":"high/medium/low","packages":"high/medium/low","budgets":"low","scope":"high/medium/low","schedule":"high/medium/low"},"notes":""}

Merge rules:
- disciplineScopes: Combine scope descriptions per discipline from all chunks
- scope: Comprehensive project summary combining all chunks
- schedule: Combined timeline info from all chunks
- confidence: Use highest confidence level found across chunks (high > medium > low)
- notes: Combine all notes

Chunks: ${JSON.stringify(chunkResults, null, 2)}`;

            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: 'gpt-5.2',
                    messages: [
                        { role: 'user', content: mergePrompt }
                    ],
                    max_completion_tokens: 32000,
                    temperature: 0.2
                })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error?.message || `API error: ${response.status}`);
            }

            const data = await response.json();
            const content = data.choices[0]?.message?.content || '';

            console.log('AI merge raw response:', content.substring(0, 500));

            let aiMerged;
            try {
                // Try to extract JSON from markdown code blocks first
                const codeBlockMatch = content.match(/```(?:json)?\s*([\s\S]*?)```/);
                if (codeBlockMatch) {
                    const jsonContent = codeBlockMatch[1].trim();
                    const jsonMatch = jsonContent.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        aiMerged = JSON.parse(jsonMatch[0]);
                    }
                } else {
                    // Try to find JSON object directly
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        aiMerged = JSON.parse(jsonMatch[0]);
                    } else {
                        aiMerged = JSON.parse(content);
                    }
                }
            } catch (e) {
                console.error('Merge JSON parse error:', e.message);
                console.error('Content was:', content);
                throw new Error('Could not parse merged result as JSON');
            }

            // Step 3: Combine local merge (simple arrays) with AI merge (complex fields)
            return {
                phases: localMerged.phases,
                disciplines: localMerged.disciplines,
                packages: localMerged.packages,
                budgets: localMerged.budgets,
                disciplineScopes: aiMerged.disciplineScopes || {},
                scope: aiMerged.scope || '',
                schedule: aiMerged.schedule || '',
                confidence: aiMerged.confidence || {},
                notes: aiMerged.notes || ''
            };
        }

        /**
         * Previews the extracted text before sending to AI
         */
        async function previewExtractedText() {
            if (!rfpState.file) return;
            
            const pageRange = document.getElementById('rfp-page-range').value;
            const pages = parsePageRange(pageRange, rfpState.pageCount);
            
            // Show loading state
            const previewBtn = document.getElementById('rfp-preview-text-btn');
            previewBtn.disabled = true;
            previewBtn.textContent = 'Extracting...';
            
            try {
                const text = await extractPdfText(rfpState.file, pages);
                rfpState.extractedText = text;
                
                // Update stats
                document.getElementById('rfp-preview-page-count').textContent = pages.length;
                document.getElementById('rfp-preview-char-count').textContent = formatNumber(text.length);
                document.getElementById('rfp-preview-token-est').textContent = '~' + formatNumber(Math.ceil(text.length / 4)); // Rough estimate: 1 token ‚âà 4 chars
                
                // Show preview snippet (first 1000 chars)
                const snippet = text.length > 1000 ? text.substring(0, 1000) + '\n\n[... text continues ...]' : text;
                document.getElementById('rfp-text-preview-snippet').textContent = snippet;
                document.getElementById('rfp-text-preview-full').textContent = text;
                
                // Show preview section
                document.getElementById('rfp-text-preview-section').style.display = 'block';
                document.getElementById('rfp-text-preview-content').style.display = 'block';
                document.getElementById('rfp-preview-toggle-text').textContent = 'Hide';
                
                previewBtn.style.display = 'none';
                
            } catch (error) {
                console.error('Text extraction error:', error);
                alert('Error extracting text: ' + error.message);
            } finally {
                previewBtn.disabled = false;
                previewBtn.textContent = 'Preview Text';
            }
        }

        /**
         * Toggles the text preview visibility
         */
        function toggleTextPreview() {
            const content = document.getElementById('rfp-text-preview-content');
            const toggle = document.getElementById('rfp-preview-toggle-text');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = 'Hide';
            } else {
                content.style.display = 'none';
                toggle.textContent = 'Show';
            }
        }

        /**
         * Toggles between snippet and full text view
         */
        function toggleFullTextPreview() {
            const snippet = document.getElementById('rfp-text-preview-snippet');
            const full = document.getElementById('rfp-text-preview-full');
            const toggle = document.getElementById('rfp-full-text-toggle');
            
            if (full.style.display === 'none') {
                snippet.style.display = 'none';
                full.style.display = 'block';
                toggle.textContent = 'Hide';
            } else {
                snippet.style.display = 'block';
                full.style.display = 'none';
                toggle.textContent = 'Show';
            }
        }

        /**
         * Copies extracted text to clipboard
         */
        async function copyExtractedText() {
            if (!rfpState.extractedText) return;
            
            try {
                await navigator.clipboard.writeText(rfpState.extractedText);
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                btn.style.color = '#00ff00';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.color = '';
                }, 2000);
            } catch (error) {
                alert('Failed to copy text. Please select and copy manually.');
            }
        }

        /**
         * Analyzes the RFP document with OpenAI (with chunking support)
         */
        async function analyzeRfpDocument() {
            const apiKey = localStorage.getItem('wbs_openai_key');
            if (!apiKey) {
                alert('Please set your OpenAI API key first. Click the chat button and enter your key.');
                return;
            }
            
            // Go to stage 3 and show loading
            goToRfpStage(3);
            document.getElementById('rfp-loading').classList.add('visible');
            document.getElementById('rfp-preview').style.display = 'none';
            
            try {
                let text;
                
                // Use already-extracted text if available (from preview), otherwise extract now
                if (rfpState.extractedText) {
                    text = rfpState.extractedText;
                    document.querySelector('.rfp-loading-text').textContent = `Using extracted text (${formatNumber(text.length)} chars). Analyzing with AI...`;
                } else {
                    // Extract text from selected pages
                    const pageRange = document.getElementById('rfp-page-range').value;
                    const pages = parsePageRange(pageRange, rfpState.pageCount);
                    
                    document.querySelector('.rfp-loading-text').textContent = `Extracting text from ${pages.length} pages...`;
                    
                    text = await extractPdfText(rfpState.file, pages);
                    rfpState.extractedText = text;
                }
                
                // GPT-4o-mini supports 128K tokens (~500K chars), but we need buffer for system prompt + response
                // Using 400K chars (~100K tokens) leaves room for: system prompt (~1.5K tokens) + response (1.5K tokens) + buffer
                const MAX_TEXT_LENGTH = 400000;
                const needsChunking = text.length > MAX_TEXT_LENGTH;
                
                // Store truncation status for display in preview
                rfpState.wasTruncated = false; // No longer truncating, we chunk instead
                rfpState.originalLength = text.length;
                rfpState.analyzedLength = text.length; // We analyze everything now
                rfpState.chunkCount = 1;
                
                let extracted;
                
                if (needsChunking) {
                    // Split into chunks
                    const chunks = splitTextIntoChunks(text, MAX_TEXT_LENGTH);
                    rfpState.chunkCount = chunks.length;

                    document.querySelector('.rfp-loading-text').textContent = `Document is large (${formatNumber(text.length)} chars). Analyzing ${chunks.length} chunks with optimized processing...`;

                    // Analyze chunks sequentially to avoid HTTP/2 protocol errors
                    const chunkResults = [];
                    const startTime = Date.now();
                    for (let i = 0; i < chunks.length; i++) {
                        const avgTime = i > 0 ? ((Date.now() - startTime) / i / 1000).toFixed(1) : '?';
                        document.querySelector('.rfp-loading-text').textContent = `Analyzing chunk ${i + 1}/${chunks.length} (avg ${avgTime}s/chunk, optimized prompts)...`;

                        // Retry logic for network errors
                        let result = null;
                        let retries = 3;
                        while (retries > 0 && !result) {
                            try {
                                result = await analyzeChunk(apiKey, chunks[i], i, chunks.length);
                            } catch (err) {
                                retries--;
                                if (retries === 0) throw err;
                                console.log(`Chunk ${i + 1} failed, retrying... (${retries} attempts left)`);
                                await new Promise(r => setTimeout(r, 2000)); // Wait 2 seconds before retry
                            }
                        }
                        chunkResults.push(result);
                    }

                    // Merge results - Step 1: Local merge (free, instant)
                    document.querySelector('.rfp-loading-text').textContent = `Merging results: Local merge of arrays (instant)...`;
                    await new Promise(r => setTimeout(r, 100)); // Brief pause to show message

                    // Step 2: AI merge for complex fields only
                    document.querySelector('.rfp-loading-text').textContent = `Merging results: AI merge of complex fields (optimized)...`;
                    extracted = await mergeChunkResults(apiKey, chunkResults);
                    
                } else {
                    // Single chunk - use original approach
                    document.querySelector('.rfp-loading-text').textContent = `Analyzing ${formatNumber(text.length)} characters with AI...`;
                    extracted = await analyzeChunk(apiKey, text, 0, 1);
                }
                
                rfpState.extractedData = extracted;
                displayRfpPreview(extracted);
                
            } catch (error) {
                console.error('RFP analysis error:', error);
                alert('Error analyzing document: ' + error.message);
                goToRfpStage(2);
            }
        }

        /**
         * Displays the extracted data in the preview UI
         */
        function displayRfpPreview(data) {
            document.getElementById('rfp-loading').classList.remove('visible');
            document.getElementById('rfp-preview').style.display = 'block';
            
            // Populate fields
            document.getElementById('rfp-preview-phases').value = (data.phases || []).join(', ');
            document.getElementById('rfp-preview-disciplines').value = (data.disciplines || []).join(', ');
            document.getElementById('rfp-preview-packages').value = (data.packages || []).join(', ');
            
            // Discipline Scopes
            const scopesContainer = document.getElementById('rfp-discipline-scopes-container');
            scopesContainer.innerHTML = '';
            
            if (data.disciplineScopes && Object.keys(data.disciplineScopes).length > 0) {
                // Show scopes for disciplines that have scope info
                Object.entries(data.disciplineScopes).forEach(([disc, scope]) => {
                    const scopeItem = document.createElement('div');
                    scopeItem.className = 'rfp-discipline-scope-item';
                    scopeItem.innerHTML = `
                        <div class="rfp-discipline-scope-name">${disc}</div>
                        <textarea class="rfp-discipline-scope-textarea" data-discipline="${disc}" placeholder="Scope of work for ${disc}...">${scope || ''}</textarea>
                    `;
                    scopesContainer.appendChild(scopeItem);
                });
                
                // Also add disciplines that don't have scope yet (so user can add)
                const disciplinesWithScopes = Object.keys(data.disciplineScopes);
                (data.disciplines || []).forEach(disc => {
                    if (!disciplinesWithScopes.includes(disc)) {
                        const scopeItem = document.createElement('div');
                        scopeItem.className = 'rfp-discipline-scope-item';
                        scopeItem.innerHTML = `
                            <div class="rfp-discipline-scope-name">${disc}</div>
                            <textarea class="rfp-discipline-scope-textarea" data-discipline="${disc}" placeholder="No scope found for ${disc}. Add scope if known..."></textarea>
                        `;
                        scopesContainer.appendChild(scopeItem);
                    }
                });
            } else {
                // No discipline scopes extracted - show disciplines with empty fields
                (data.disciplines || []).forEach(disc => {
                    const scopeItem = document.createElement('div');
                    scopeItem.className = 'rfp-discipline-scope-item';
                    scopeItem.innerHTML = `
                        <div class="rfp-discipline-scope-name">${disc}</div>
                        <textarea class="rfp-discipline-scope-textarea" data-discipline="${disc}" placeholder="No scope found for ${disc}. Add scope if known..."></textarea>
                    `;
                    scopesContainer.appendChild(scopeItem);
                });
            }
            
            // Scope Summary
            document.getElementById('rfp-preview-scope').value = data.scope || '';
            
            // Schedule
            document.getElementById('rfp-preview-schedule').value = data.schedule || '';
            
            // Confidence indicators
            const conf = data.confidence || {};
            setConfidenceIndicator('rfp-conf-phases', conf.phases);
            setConfidenceIndicator('rfp-conf-disciplines', conf.disciplines);
            setConfidenceIndicator('rfp-conf-packages', conf.packages);
            setConfidenceIndicator('rfp-conf-scope', conf.scope);
            setConfidenceIndicator('rfp-conf-schedule', conf.schedule);
            
            // Chunking notice (if document was chunked)
            if (rfpState.chunkCount > 1) {
                const truncationNotice = document.getElementById('rfp-truncation-notice');
                const truncationText = document.getElementById('rfp-truncation-text');
                truncationNotice.style.display = 'block';
                truncationText.textContent = `Large document analyzed in ${rfpState.chunkCount} chunks (${formatNumber(rfpState.originalLength)} total characters). All content was analyzed and merged for comprehensive results.`;
            } else {
                document.getElementById('rfp-truncation-notice').style.display = 'none';
            }
            
            // Notes
            if (data.notes) {
                document.getElementById('rfp-notes').style.display = 'block';
                document.getElementById('rfp-notes-text').textContent = data.notes;
            } else {
                document.getElementById('rfp-notes').style.display = 'none';
            }
        }

        /**
         * Sets the confidence indicator styling
         */
        function setConfidenceIndicator(elementId, level) {
            const el = document.getElementById(elementId);
            if (!el) return;
            
            el.classList.remove('high', 'medium', 'low');
            
            const normalizedLevel = (level || 'low').toLowerCase();
            el.classList.add(normalizedLevel);
            el.textContent = normalizedLevel.toUpperCase();
        }

        /**
         * Applies the extracted RFP data to the project
         */
        function applyRfpData() {
            // Get values from preview fields
            const phasesStr = document.getElementById('rfp-preview-phases').value;
            const disciplinesStr = document.getElementById('rfp-preview-disciplines').value;
            const packagesStr = document.getElementById('rfp-preview-packages').value;
            
            // Parse phases
            const phases = phasesStr.split(',').map(s => s.trim()).filter(s => s);
            
            // Parse disciplines
            const disciplines = disciplinesStr.split(',').map(s => s.trim()).filter(s => s);
            
            // Parse packages
            const packages = packagesStr.split(',').map(s => s.trim()).filter(s => s);
            
            // Update projectData
            projectData.phases = phases.length > 0 ? phases : ['Base'];
            projectData.disciplines = disciplines.length > 0 ? disciplines : [];
            projectData.packages = packages.length > 0 ? packages : ['Preliminary', 'Final'];
            
            // Set all budgets to 0 - user will set via Cost Estimator in Step 4
            projectData.budgets = {};
            disciplines.forEach(disc => {
                projectData.budgets[disc] = 0;
            });
            
            // Initialize claiming (even distribution)
            const claimPerPackage = Math.floor(100 / projectData.packages.length);
            const remainder = 100 - (claimPerPackage * projectData.packages.length);
            
            projectData.claiming = {};
            projectData.disciplines.forEach(disc => {
                projectData.packages.forEach((pkg, i) => {
                    const key = `${disc}-${pkg}`;
                    projectData.claiming[key] = claimPerPackage + (i === projectData.packages.length - 1 ? remainder : 0);
                });
            });
            
            // Initialize dates (placeholder, spread across 6 months)
            const today = new Date();
            projectData.dates = {};
            projectData.disciplines.forEach(disc => {
                projectData.packages.forEach((pkg, i) => {
                    const key = `${disc}-${pkg}`;
                    const startOffset = i * 30;
                    const endOffset = startOffset + 28;
                    
                    const startDate = new Date(today);
                    startDate.setDate(startDate.getDate() + startOffset);
                    const endDate = new Date(today);
                    endDate.setDate(endDate.getDate() + endOffset);
                    
                    projectData.dates[key] = {
                        start: startDate.toISOString().split('T')[0],
                        end: endDate.toISOString().split('T')[0]
                    };
                });
            });
            
            // Update wizard UI
            document.getElementById('phases-input').value = projectData.phases.join(', ');
            document.getElementById('packages-input').value = projectData.packages.join(', ');
            
            // Update disciplines grid
            const grid = document.getElementById('disciplines-grid');
            grid.innerHTML = '';
            
            // First add existing disciplines, marking selected ones
            allDisciplines.forEach(d => {
                const isSelected = projectData.disciplines.includes(d.name);
                grid.innerHTML += `<div class="disc-item ${isSelected ? 'selected' : ''}" onclick="toggleDisc(this)" data-name="${d.name}">${d.name}</div>`;
            });
            
            // Add any custom disciplines from RFP
            projectData.disciplines.forEach(disc => {
                if (!allDisciplines.find(d => d.name === disc)) {
                    grid.innerHTML += `<div class="disc-item selected" onclick="toggleDisc(this)" data-name="${disc}">${disc}</div>`;
                    // Add to example budgets
                    if (!exampleBudgets[disc]) {
                        exampleBudgets[disc] = budgets[disc] || 100000;
                    }
                }
            });
            
            updateSelectedCount();
            
            // Close modal and go to step 1
            closeRfpWizard();
            
            // Reset to step 1
            currentStep = 1;
            showStep(1);
            
            // Show success message
            alert(`RFP data imported successfully!\n\n‚Ä¢ ${projectData.phases.length} phases\n‚Ä¢ ${projectData.disciplines.length} disciplines\n‚Ä¢ ${projectData.packages.length} packages\n\nReview and adjust the data in each step.`);
        }
    </script>

    <!-- RFP Wizard Modal -->
    <div id="rfp-modal" class="rfp-modal" onclick="if(event.target===this)closeRfpWizard()">
        <div class="rfp-modal-content">
            <div class="rfp-modal-header">
                <h2>üìÑ RFP Wizard - Extract Project Data</h2>
                <button class="rfp-modal-close" onclick="closeRfpWizard()">√ó</button>
            </div>
            <div class="rfp-modal-body">
                <!-- Stage Indicator -->
                <div class="rfp-stage-indicator">
                    <div class="rfp-stage active" data-stage="1">1. Upload PDF</div>
                    <div class="rfp-stage" data-stage="2">2. Select Pages</div>
                    <div class="rfp-stage" data-stage="3">3. Review & Apply</div>
                </div>

                <!-- Stage 1: Upload -->
                <div id="rfp-stage-1" class="rfp-stage-content active">
                    <div class="rfp-dropzone" id="rfp-dropzone" onclick="document.getElementById('rfp-file-input').click()">
                        <div class="rfp-dropzone-icon">üìÅ</div>
                        <div class="rfp-dropzone-text">Drag & drop your RFP PDF here</div>
                        <div class="rfp-dropzone-hint">or click to browse</div>
                    </div>
                    <input type="file" id="rfp-file-input" accept=".pdf" style="display: none;" onchange="handleRfpFileSelect(event)">
                    
                    <div id="rfp-file-info" class="rfp-file-info">
                        <div class="rfp-file-icon">üìÑ</div>
                        <div class="rfp-file-details">
                            <div id="rfp-file-name" class="rfp-file-name">document.pdf</div>
                            <div id="rfp-file-meta" class="rfp-file-meta">2.4 MB</div>
                        </div>
                        <button class="rfp-file-remove" onclick="removeRfpFile()">Remove</button>
                    </div>

                    <div class="rfp-modal-actions">
                        <button class="rfp-btn" onclick="closeRfpWizard()">Cancel</button>
                        <button id="rfp-next-1" class="rfp-btn rfp-btn-primary" onclick="goToRfpStage(2)" disabled>Next: Select Pages ‚Üí</button>
                    </div>
                </div>

                <!-- Stage 2: Page Selection -->
                <div id="rfp-stage-2" class="rfp-stage-content">
                    <div class="rfp-page-info">
                        <div class="rfp-page-count" id="rfp-page-count">0</div>
                        <div class="rfp-page-label">Total pages in document</div>
                    </div>

                    <div class="rfp-page-input-group">
                        <label>Which pages contain scope/project information?</label>
                        <input type="text" id="rfp-page-range" placeholder="e.g., 1-10 or 5,7,12-15 or leave blank for all">
                        <div class="rfp-page-hint">
                            Tip: Usually the scope of work, deliverables, and schedule are in the first 10-20 pages. 
                            Leave blank to analyze all pages.
                        </div>
                    </div>

                    <!-- Text Preview Section -->
                    <div id="rfp-text-preview-section" style="display: none; margin-top: 20px;">
                        <div class="rfp-preview-card" style="background: #1a1a1a; border: 1px solid #333;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <h4 style="margin: 0; color: #ffd700;">Extracted Text Preview</h4>
                                <button class="rfp-btn" style="padding: 6px 12px; font-size: 11px;" onclick="toggleTextPreview()">
                                    <span id="rfp-preview-toggle-text">Show</span> Preview
                                </button>
                            </div>
                            <div id="rfp-text-preview-stats" style="display: flex; gap: 16px; margin-bottom: 12px; font-size: 11px; color: #888;">
                                <span>Pages: <strong id="rfp-preview-page-count" style="color: #ffd700;">0</strong></span>
                                <span>Characters: <strong id="rfp-preview-char-count" style="color: #ffd700;">0</strong></span>
                                <span>Est. Tokens: <strong id="rfp-preview-token-est" style="color: #ffd700;">~0</strong></span>
                            </div>
                            <div id="rfp-text-preview-content" style="display: none;">
                                <div style="background: #000; border: 1px solid #444; border-radius: 4px; padding: 12px; max-height: 300px; overflow-y: auto; font-size: 11px; color: #ccc; line-height: 1.6; font-family: 'Courier New', monospace; white-space: pre-wrap; word-wrap: break-word;">
                                    <div id="rfp-text-preview-snippet"></div>
                                    <div id="rfp-text-preview-full" style="display: none;"></div>
                                </div>
                                <div style="margin-top: 8px; display: flex; justify-content: space-between; align-items: center;">
                                    <button class="rfp-btn" style="padding: 6px 12px; font-size: 11px;" onclick="toggleFullTextPreview()">
                                        <span id="rfp-full-text-toggle">Show</span> Full Text
                                    </button>
                                    <button class="rfp-btn" style="padding: 6px 12px; font-size: 11px; background: transparent; border-color: #666; color: #888;" onclick="copyExtractedText()">Copy Text</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="rfp-modal-actions">
                        <button class="rfp-btn" onclick="goToRfpStage(1)">‚Üê Back</button>
                        <button id="rfp-preview-text-btn" class="rfp-btn" onclick="previewExtractedText()" style="display: none;">Preview Text</button>
                        <button class="rfp-btn rfp-btn-primary" onclick="analyzeRfpDocument()">Analyze with AI ‚Üí</button>
                    </div>
                </div>

                <!-- Stage 3: Preview -->
                <div id="rfp-stage-3" class="rfp-stage-content">
                    <!-- Loading State -->
                    <div id="rfp-loading" class="rfp-loading visible">
                        <div class="rfp-spinner"></div>
                        <div class="rfp-loading-text">Analyzing document with AI...</div>
                    </div>

                    <!-- Preview Content -->
                    <div id="rfp-preview" style="display: none;">
                        <div class="rfp-preview-grid">
                            <div class="rfp-preview-card">
                                <h4>Phases <span id="rfp-conf-phases" class="rfp-confidence high">HIGH</span></h4>
                                <textarea id="rfp-preview-phases" placeholder="e.g., Base, ESDC, TSCD"></textarea>
                            </div>
                            <div class="rfp-preview-card">
                                <h4>Disciplines <span id="rfp-conf-disciplines" class="rfp-confidence high">HIGH</span></h4>
                                <textarea id="rfp-preview-disciplines" placeholder="e.g., Structures, Civil, Traffic"></textarea>
                            </div>
                            <div class="rfp-preview-card full-width">
                                <h4>Discipline-Specific Scopes <span id="rfp-conf-disciplines-scope" class="rfp-confidence medium">MED</span></h4>
                                <div style="color: #666; font-size: 10px; margin-bottom: 12px; font-style: italic;">
                                    Detailed scope of work for each discipline. Edit as needed for accuracy.
                                </div>
                                <div id="rfp-discipline-scopes-container" style="display: flex; flex-direction: column; gap: 12px;">
                                    <!-- Discipline scopes will be dynamically added here -->
                                </div>
                            </div>
                            <div class="rfp-preview-card">
                                <h4>Packages <span id="rfp-conf-packages" class="rfp-confidence medium">MED</span></h4>
                                <textarea id="rfp-preview-packages" placeholder="e.g., Preliminary, Interim, Final, RFC"></textarea>
                            </div>
                            <div class="rfp-preview-card">
                                <h4>Budgets</h4>
                                <div style="color: #666; font-size: 11px; padding: 10px; background: #000; border-radius: 4px;">
                                    Budgets will be set to $0 initially. Use the Cost Estimator in Step 4 to calculate budgets based on construction cost.
                                </div>
                            </div>
                            <div class="rfp-preview-card full-width">
                                <h4>Scope Summary <span id="rfp-conf-scope" class="rfp-confidence medium">MED</span></h4>
                                <textarea id="rfp-preview-scope" placeholder="Project scope and work description extracted from RFP..."></textarea>
                            </div>
                            <div class="rfp-preview-card full-width">
                                <h4>Schedule Notes <span id="rfp-conf-schedule" class="rfp-confidence medium">MED</span></h4>
                                <textarea id="rfp-preview-schedule" placeholder="Schedule information extracted from RFP..."></textarea>
                            </div>
                        </div>

                        <div id="rfp-truncation-notice" class="rfp-notes" style="display: none; background: #2a1a00; border-color: #ff8800;">
                            <h4>‚ö†Ô∏è Document Truncated</h4>
                            <p id="rfp-truncation-text">Only the first portion of the document was analyzed due to size limits.</p>
                        </div>

                        <div id="rfp-notes" class="rfp-notes" style="display: none;">
                            <h4>üìù AI Notes</h4>
                            <p id="rfp-notes-text">Analysis notes will appear here...</p>
                        </div>

                        <div class="rfp-modal-actions">
                            <button class="rfp-btn" onclick="goToRfpStage(2)">‚Üê Re-analyze</button>
                            <button class="rfp-btn rfp-btn-primary" onclick="applyRfpData()">Apply to Project ‚úì</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat FAB Button -->
    <button id="chat-fab" class="chat-fab" onclick="toggleChat()" title="AI Assistant">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
        </svg>
    </button>

    <!-- Chat Panel -->
    <div id="chat-panel" class="chat-panel">
        <div class="chat-header">
            <div class="chat-header-title">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                </svg>
                <span>WBS Assistant</span>
            </div>
            <span id="chat-context-badge" class="chat-context-badge">STEP 1</span>
            <div class="chat-header-actions">
                <button class="chat-header-btn" onclick="resetChatPosition()" title="Reset position">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                        <polyline points="9 22 9 12 15 12 15 22"/>
                    </svg>
                </button>
                <button class="chat-header-btn" onclick="clearChat()" title="Clear chat">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"/>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                    </svg>
                </button>
                <button class="chat-header-btn" onclick="openChatSettings()" title="Settings">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                </button>
                <button class="chat-header-btn" onclick="toggleChat()" title="Close">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
        </div>
        <div id="chat-messages" class="chat-messages"></div>
        <div class="chat-input-area">
            <textarea 
                id="chat-input" 
                class="chat-input" 
                placeholder="Ask about this step..." 
                rows="1"
                onkeydown="handleChatKeydown(event)"
                oninput="autoResizeChatInput()"
            ></textarea>
            <button id="chat-send-btn" class="chat-send-btn" onclick="sendMessage()" title="Send">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- API Key Modal -->
    <div id="chat-api-modal" class="chat-api-modal" onclick="if(event.target===this)hideApiKeyModal()">
        <div class="chat-api-modal-content">
            <h3>üîë OpenAI API Key Required</h3>
            <p>Enter your OpenAI API key to enable the AI assistant. Your key is stored locally in your browser and never sent anywhere except OpenAI.</p>
            <input 
                type="password" 
                id="api-key-input" 
                placeholder="sk-..." 
                onkeydown="if(event.key==='Enter')saveApiKey()"
            >
            <div class="chat-api-modal-actions">
                <button class="btn" onclick="hideApiKeyModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveApiKey()">Save Key</button>
            </div>
        </div>
    </div>
</body>
</html>
